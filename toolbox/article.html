<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿»æ°´ï¼æ•˜</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;600&family=Zen+Kaku+Gothic+New:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
       :root {
  --bg-color: #F3F0EB;
  --text-color: #333333;
  --primary-color: #5D5A56; 
  --secondary-color: #77726D;
  --border-color: #C5BEB6; 
  /* ä½¿ç”¨éœè¬è—ä½œç‚ºæ–°çš„å¼·èª¿è‰² */
  --accent-color: #6A7E99; 
  --font-serif: 'Noto Serif JP', serif;
  --font-sans: 'Zen Kaku Gothic New', sans-serif;
}

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8;
            font-weight: 300;
            overflow-x: hidden;
            background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23DCD9D4" fill-opacity="0.2"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 3rem;
        }

        header {
            text-align: center;
            padding: 2rem 0 3rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 3rem;
        }

        header h1 {
            font-family: var(--font-serif);
            font-size: 2.8rem;
            font-weight: 400;
            color: var(--primary-color);
            letter-spacing: 0.2em;
        }

        header p {
            font-size: 1rem;
            color: var(--secondary-color);
            margin-top: 0.5rem;
            letter-spacing: 0.1em;
        }

        main {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 4rem;
            flex-grow: 1;
        }

        .controls {
            padding-right: 2rem;
            border-right: 1px solid var(--border-color);
        }

        .control-group {
            margin-bottom: 2.5rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 1rem;
            font-family: var(--font-serif);
            font-size: 1.2rem;
            font-weight: 400;
            color: var(--primary-color);
        }

        .control-group input[type="text"],
        .control-group textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            background-color: transparent;
            border-radius: 4px;
            font-family: var(--font-sans);
            font-size: 1rem;
            color: var(--text-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .control-group input[type="text"]:focus,
.control-group textarea:focus {
  outline: none;
  border-color: var(--accent-color);
  /* æ›´æ–° box-shadow ä»¥åŒ¹é…æ–°çš„è—è‰²èª¿ */
  box-shadow: 0 0 5px rgba(106, 126, 153, 0.25);
}

        .control-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .word-count-control {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .word-count-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--primary-color);
            width: 30px;
            height: 30px;
            font-size: 1.5rem;
            line-height: 26px;
            text-align: center;
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.3s, color 0.3s;
        }

        .word-count-btn:hover {
            background-color: var(--primary-color);
            color: var(--bg-color);
        }

        #word-count-display {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-color);
            background-color: #FFFFFF;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-width: 80px;
            text-align: center;
        }

        .style-selector {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .style-selector label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.6rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .style-selector input[type="radio"] {
            display: none;
        }

        .style-selector input[type="radio"]:checked + span {
            font-weight: 500;
        }

        .style-selector label:has(input:checked) {
             background-color: var(--accent-color);
             border-color: var(--accent-color);
             color: #FFFFFF;
        }

        .generate-btn {
            width: 100%;
            padding: 1rem;
            margin-top: 1.5rem;
            font-family: var(--font-serif);
            font-size: 1.2rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            background-color: var(--primary-color);
            color: var(--bg-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .generate-btn:hover {
            background-color: #55524e;
        }
        
        .generate-btn:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
        }

        .output {
            position: relative;
        }
        
        .output-toolbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 0;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        #output-word-count {
            font-size: 0.9rem;
            color: var(--secondary-color);
            font-family: var(--font-sans);
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
        }

        .icon-btn:hover {
            background-color: #e8e4dd;
        }

        .icon-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--primary-color);
        }

        .icon-btn .copy-feedback {
            font-size: 0.9rem;
            font-family: var(--font-sans);
        }

        #essay-placeholder, #generated-essay {
            padding: 2rem;
            background-color: #FFFFFF;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-height: 60vh;
            white-space: pre-wrap;
            font-family: var(--font-serif);
            font-size: 1.1rem;
            line-height: 2.2;
            letter-spacing: 0.05em;
        }
        
        #essay-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            font-size: 1.5rem;
        }

        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 5px solid var(--bg-color);
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        @media (max-width: 900px) {
            main {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
            .controls {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding-right: 0;
                padding-bottom: 2rem;
            }
            .container {
                padding: 1.5rem;
            }
        }

    </style>

    <!-- å¼•å…¥ Supabase å’Œ Transformers.js (ä¿®æ­£è¼‰å…¥æ–¹å¼) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0';
        // è¨­å®šä¸ä½¿ç”¨æœ¬åœ°æ¨¡å‹ï¼Œå¼·åˆ¶ä½¿ç”¨ CDN
        env.allowLocalModels = false;
        env.useBrowserCache = true;
        // å°‡ pipeline æ›è¼‰åˆ° window ä»¥ä¾¿å…¨åŸŸä½¿ç”¨
        window.pipeline = pipeline;
    </script>

</head>
<body>

    <!-- æ•™å­¸ç­†è¨˜åŠè©•åˆ†ç³»çµ± (å°ç”¨å®¶éš±è—) -->
    <div id="qczh-notes" style="display: none;"><pre>
[æ–‡ç« é¡å‹] æ•˜äº‹æŠ’æƒ…æ–‡ã€‚

[æ ¸å¿ƒçµæ§‹ï¼šèµ·æ‰¿è½‰åˆåŠæ‰£é¡Œå…§å®¹] ä½ çš„æ–‡ç« å¿…é ˆæ¸…æ™°åœ°å‘ˆç¾ã€Œèµ·ã€æ‰¿ã€è½‰ã€åˆã€å››å¤§çµæ§‹éƒ¨åˆ†ï¼Œä¸¦ç¢ºä¿æ¯å€‹éƒ¨åˆ†éƒ½èˆ‡æ–‡ç« ä¸»é¡Œç·Šå¯†æ‰£è¯ã€‚
1. èµ· (èµ·å› ):
- é–‹ç¯‡äº¤ä»£æ•…äº‹èƒŒæ™¯æˆ–äº‹ä»¶èµ·å› ã€‚
- å¯é‹ç”¨ã€Œæ–‡é¦–æŠ€å·§ã€å¼•å…¥ï¼Œä¾‹å¦‚ï¼š
* æ‡¸å¿µæ³•: è£½é€ æ‡¸å¿µï¼Œæ‹‹å‡ºç–‘åœ˜è€Œä¸ç«‹å³æ­ç¤ºçœŸç›¸ï¼Œä»¥å¸å¼•è®€è€…ã€‚
* ç¤ºç¾æ³•: æ´»éˆæ´»ç¾åœ°æå¯«ç•«é¢ï¼Œå¦‚ã€Œè¿½è¿°ç¤ºç¾ã€ï¼ˆå›æ†¶å¾€æ˜”å¦‚ç¾ä»Šï¼‰ã€ã€Œé è¨€ç¤ºç¾ã€ï¼ˆæå¯«æœªä¾†å¦‚ç¾ä»Šï¼‰ã€ã€Œæ‡¸æƒ³ç¤ºç¾ã€ï¼ˆè™›æ“¬ç•«é¢å¦‚çœŸï¼‰ã€‚
* å¼•ç”¨æ³•: ä»¥äº‹ç‰©æˆ–æ•…äº‹å¼•å…¥ï¼Œç¢ºä¿å…¶èˆ‡ä¸»é¡Œçš„é—œè¯ã€‚

2. æ‰¿ (ç™¼å±•):
- æ•…äº‹çš„ç™¼å±•éƒ¨åˆ†ï¼Œæ‡‰åœç¹ä¸»é¡Œé€²è¡Œè©³ç›¡æå¯«ã€‚
- è‹¥é¡Œç›®æœ‰ã€Œæ‰¿ã€å’Œã€Œåˆã€çš„æ˜ç¢ºæç¤ºï¼ˆå¦‚ã€Œç†±é¬§éå¾Œï¼Œæˆ‘å»æ„Ÿåˆ°å¤±è½ã€ï¼‰ï¼Œå‰‡ã€Œæ‰¿ã€çš„éƒ¨åˆ†æ‡‰èšç„¦æ–¼ã€Œç†±é¬§ã€ã€‚
- è‹¥é¡Œç›®æç¤ºè¼ƒå°‘ï¼Œå¯æ¡ç”¨ã€Œæ‰¿åˆäºŒå…ƒæ³•ã€ï¼Œå°‡ã€Œä¹‹å‰æ˜¯Aã€è¨­å®šç‚ºã€Œæ‰¿ã€çš„å…§å®¹ï¼Œä¸¦è©³å¯«æ­¤éƒ¨åˆ†ã€‚

3. è½‰ (è½‰è®Š):
- æ•…äº‹æˆ–äººç‰©ç†è§£çš„é—œéµè½‰æŠ˜é»ã€‚
- å¯ä»¥æ˜¯æƒ…ç¯€çš„è½‰æŠ˜ï¼Œæˆ–æ˜¯äººç‰©å¿ƒå¢ƒã€æ€æƒ³ä¸Šçš„é‡å¤§è½‰è®Šæˆ–é ˜æ‚Ÿã€‚

4. åˆ (çµæœ):
- æ•…äº‹çš„çµå±€æˆ–æœ€çµ‚çš„é«”æœƒèˆ‡é ˜æ‚Ÿã€‚
- ã€Œç«‹æ„æ®µã€æ‡‰åœ¨æ­¤éƒ¨åˆ†å‘ˆç¾ï¼Œç¯‡å¹…ç´„ä½”å…¨æ–‡çš„å››åˆ†ä¹‹ä¸€ã€‚

[éæ¸¡]
â€¢ ç¢ºä¿æ–‡ç« å„éƒ¨åˆ†ï¼ˆèµ·ã€æ‰¿ã€è½‰ã€åˆï¼‰ä¹‹é–“éæ¸¡æµæš¢ï¼Œé¿å…ç”Ÿç¡¬æ‹¼æ¹Šã€‚
â€¢ å¯ä½¿ç”¨ç¨ç«‹çš„éæ¸¡æ®µè½ï¼Œæˆ–åœ¨æ®µè½æœ«å°¾/é–‹é ­åŠ å…¥éæ¸¡æ€§æ–‡å­—ã€‚

[ä¸»é¡ŒåŠç«‹æ„]
â€¢ ç«‹æ„å…¬å¼: (è¡¨é¢A + å¯¦éš›éA) + åˆç†è§£é‡‹ = å¥½çš„ç«‹æ„ã€‚
â€¢ ç«‹æ„æ‡‰èƒ½ã€Œä»¥å°è¦‹å¤§ã€ï¼Œå¸¶çµ¦è®€è€…æ€è€ƒèˆ‡å…±é³´ï¼Œä¸¦å…·æœ‰ç¤¾æœƒæ€§ã€‚é¿å…è½ä¿—å¥—çš„é™³è…”æ¿«èª¿ã€‚
â€¢ ç«‹æ„æ®µè¦æ±‚:
- ç´„ä½”å…¨æ–‡å››åˆ†ä¹‹ä¸€çš„ç¯‡å¹…ã€‚
- å¯é‹ç”¨ã€Œæ’æ¯”ã€ã€ã€Œä¸‰ä½•æ³•ã€ï¼ˆä¸‰å€‹è¨­å•ï¼‰ç­‰ä¿®è¾­æ‰‹æ³•ä»¥åŠ å¼·èªæ°£å’Œæ„ŸæŸ“åŠ›ã€‚
- çµå°¾éœ€å‘¼æ‡‰ä¸»é¡Œï¼Œç•™æœ‰é¤˜å‘³å’Œè¯æƒ³ç©ºé–“ã€‚

[è¡¨é”æ‰‹æ³•ï¼šç¤ºç¾æ•˜äº‹ (Show, Don't Tell)] æ•˜äº‹æ™‚ï¼Œåˆ‡å‹¿åƒ…ä½œæ—ç™½å¼ã€Œäº¤ä»£ã€(tell) æƒ…ç¯€ï¼Œå¿…é ˆã€Œç¤ºç¾ã€(show) ç•«é¢ï¼Œè®“è®€è€…å¦‚è‡¨å…¶å¢ƒã€‚å››ç¨®æ•˜äº‹æ‰‹æ³•å¿…é ˆäº¤æ›¿ä½¿ç”¨ï¼Œä»¥ä¿æŒæ•˜äº‹å½¢å¼çš„éˆæ´»å¤šè®Šã€‚

1. å°ç‰©ä»¶ (Small Objects/Details):
- ç‰¹é»ï¼šæ•˜äº‹ç¯€å¥æ…¢ï¼Œç´°ç·»ç¨‹åº¦é«˜ï¼Œç›´æ¥ç¨‹åº¦ä½ã€‚
- ç”¨é€”ï¼šæ¸²æŸ“æ°›åœï¼Œå°‡æ•…äº‹å¨“å¨“é“ä¾†ï¼›å´é¢æ˜ è¥¯äººç‰©æƒ…æ„ŸåŠä¸»é¡Œï¼›ä½œç‚ºéæ¸¡ã€‚
- æè¿°éœ€ç´°ç·»ï¼Œä½†ä¸åé›¢ä¸»é¡Œã€‚

2. å‹•ä½œ (Actions):
- ç‰¹é»ï¼šæ•˜äº‹ç¯€å¥ä¸­ç­‰ï¼Œç´°ç·»ç¨‹åº¦é«˜/è¼ƒé«˜ï¼Œç›´æ¥ç¨‹åº¦ä¸­ç­‰ã€‚
- ç”¨é€”ï¼šç‚ºé‡è¦æƒ…ç¯€è£œå……ç´°ç¯€ï¼Œä»¥çªé¡¯ä¸»é¡Œã€‚
- é•·åº¦è¦æ±‚ï¼šæ¯çµ„å‹•ä½œæå¯«æ‡‰é”2è‡³3å¥ï¼Œä»¥ç¢ºä¿æ–‡æ„é€£è²«ã€é¿å…é›¶ç¢ï¼Œä¸¦å¢å¼·æ„ŸæŸ“åŠ›ã€‚
- å¯é‹ç”¨ä¿®è¾­ã€å¤§é‡å½¢å®¹è©ï¼Œä¸¦å°‡ä¸€å€‹å‹•ä½œæ‹†åˆ†ç‚ºå¹¾å€‹å°å‹•ä½œæå¯«ã€‚
- æ‡‰é¸å–å…¸å‹çš„ã€Œå‹•ä½œã€ä¾†è¡¨ç¾äººç‰©æ€§æ ¼ç‰¹å¾µã€‚

3. å°è©± (Dialogue):
- ç‰¹é»ï¼šæ•˜äº‹ç¯€å¥æ…¢ï¼Œç´°ç·»ç¨‹åº¦ä½ï¼Œç›´æ¥ç¨‹åº¦ä¸­ç­‰ã€‚
- ç”¨é€”ï¼šçªé¡¯æƒ…ç¯€é‡é»æˆ–äººç‰©æƒ…æ„Ÿã€‚
- å°è©±å…§å®¹éœ€ç¬¦åˆäººç‰©çš„èº«ä»½å’Œç¶“æ­·ï¼Œç°¡ç…‰ç”Ÿå‹•ï¼Œèƒ½è¡¨ç¾çœŸæƒ…å¯¦æ„Ÿã€‚
- å°ç™½å½¢å¼å¯å¤šè®Šï¼šå¯ã€Œå°è©±åœ¨å‰ã€ã€ã€Œå°è©±åœ¨å¾Œã€ã€ã€Œå°è©±åœ¨å…©é ­ã€ï¼Œç”šè‡³æ¡ç”¨ã€Œæ›è¡Œå…©é ­ç©ºå‹ã€ä»¥å¼·èª¿æƒ…æ„Ÿã€‚

4. å…§å¿ƒç¨ç™½ (Internal Monologue):
- ç‰¹é»ï¼šæ•˜äº‹ç¯€å¥å¿«ï¼Œç´°ç·»ç¨‹åº¦è‡ªç”±ï¼Œç›´æ¥ç¨‹åº¦é«˜ã€‚
- ç”¨é€”ï¼šç•¥å¯«è¼ƒæ¬¡è¦çš„ç‰‡æ®µï¼›å¸¶å‡ºäººç‰©å¿ƒç†ã€æ‰£é¡Œå…§å®¹å’Œç«‹æ„ã€‚

[å¥çµ„çš„é€£çºŒæ€§]
â€¢ ä»¥ã€Œåˆ»åŠƒå°è±¡ã€ä¾†åŠƒåˆ†å¥çµ„ï¼Œç¢ºä¿å¥å­çµ„åˆçš„é€£è²«æ€§ã€‚ä¾‹å¦‚ï¼Œæè¿°ä¸€å€‹å°è±¡æ™‚ï¼Œç›¸é—œçš„å¥å­æ‡‰çµ„ç¹”åœ¨ä¸€èµ·ã€‚
â€¢ é¿å…å¥çµ„çŸ­ä¿ƒè€Œå‰²è£‚ï¼Œè¿½æ±‚æµæš¢çš„è¡Œæ–‡ã€‚

[æ–‡å­—å¯†åº¦]
â€¢ ç¶­æŒé«˜æ–‡å­—å¯†åº¦ï¼šè©å½™è±å¯Œï¼Œç”¨è©ä¸é‡è¤‡ã€‚
â€¢ å¯¦è©èˆ‡è™›è©çš„æ¯”ä¾‹ç´„ç‚ºä¸ƒä¸‰æ¯” (70%å¯¦è©, 30%è™›è©)ã€‚

[äººç‰©æå¯«]
â€¢ è‚–åƒæå¯«: æå¯«äººç‰©çš„å®¹è²Œã€ç¥æƒ…ã€å§¿æ…‹ã€æœé£¾ã€éŸ³èª¿ç­‰ã€‚æ³¨æ„è¦–ç·šç§»å‹•é †åºï¼ˆå¦‚ç”±ä¸Šè€Œä¸‹ï¼‰ï¼Œé¸æ“‡å…¸å‹ç´°ç¯€ï¼Œä»¥çƒ˜æ‰˜äººç‰©æ€§æ ¼ã€èº«ä»½ã€åœ°ä½ã€‚
â€¢ å‹•ä½œæå¯«: é€éå…·é«”çš„è¡Œç‚ºå‹•ä½œä¾†è¡¨ç¾äººç‰©æ€§æ ¼ç‰¹å¾µï¼Œé¸æ“‡å…¸å‹å‹•ä½œã€‚
â€¢ èªè¨€æå¯« (å°è©±): åƒè€ƒä¸Šè¿°ã€Œå°è©±ã€çš„è¦æ±‚ã€‚

[æ¯”å–»çš„é‹ç”¨]
â€¢ å‰µé€ è€äººå°‹å‘³çš„æ¯”å–»ï¼Œé¿å…è½ä¿—å¥—ã€‚
â€¢ éœ€åŒ…å«ä¸‰å€‹æ­¥é©Ÿï¼š
1. ä»¥ä¸€å€‹ç•«é¢ä½œå–»ï¼Œå…¶ä¸­è‡³å°‘åŒ…å«å…©å€‹ç‰©è±¡ã€‚
2. å…·é«”å½¢å®¹è©²äº›ç‰©è±¡ã€‚
3. åŠ å…¥ä¸€æ®µè£œå……è§£é‡‹çš„æ–‡å­—ã€‚

[æƒ…ç¯€èˆ‡é«˜æ½®]
â€¢ å¢åŠ æƒ…ç¯€çš„æ›²æŠ˜æ€§ï¼Œä½¿æ•…äº‹ä¸å¹³å‡¡ã€‚
â€¢ é©ç•¶è¨­ç½®é«˜æ½®ï¼šæ•…äº‹æ°£æ°›æœ€é«˜æ¼²ã€çŸ›ç›¾è¡çªæœ€æ¿€çƒˆã€æœ€é—œéµçš„æ™‚åˆ»ã€‚é«˜æ½®éå¾Œæ°£æ°›æ‡‰è¶¨æ–¼å¹³å’Œã€‚

[çµå°¾æŠ€å·§]
â€¢ å‘¼æ‡‰æ³•: çµå°¾èˆ‡æ–‡ç« é–‹é ­æˆ–å‰æ–‡å…§å®¹å‘¼æ‡‰ï¼Œä»¥çªé¡¯ä¸»é¡Œã€‚
â€¢ æƒ…æ™¯äº¤èæ³•: å°‡æƒ…æ„Ÿèå…¥è‡ªç„¶æ™¯ç‰©æˆ–ç”Ÿæ´»å ´æ™¯ä¸­ï¼Œé€éæå¯«æ™¯ç‰©ä¾†å«è“„æŠ’æƒ…ã€‚
â€¢ æ¯”å–»æ³•: ä»¥åˆ¥å‡ºå¿ƒè£çš„æ¯”å–»ä½œçµï¼Œåœç¹è©²ç‰©è±¡ç™¼æ®ï¼Œå¸¶å‡ºä¸»é¡Œã€‚

[èªè¨€è¦æ±‚]
â€¢ è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡é€²è¡Œç”Ÿæˆï¼Œçµ•ä¸å¯ä»¥é‹ç”¨ç²µèªã€‚
â€¢ èªè¨€å„ªç¾ã€æ–‡ç­†æµæš¢ï¼Œç¬¦åˆæ•˜äº‹æŠ’æƒ…æ–‡çš„é¢¨æ ¼ã€‚

[é¡Œæ]
â€¢ è±å¯Œå¤šè®Šï¼Œä¸è¦å¯«æ¯”è³½ã€æº«ç¿’ã€å·¥ä½œå’Œè€ƒè©¦ï¼Œè¦èƒ½å¤ å¼•èµ·åˆ¥äººçš„æƒ…æ„Ÿå…±é³´ã€‚
â€¢ ä¸»è§’ä¸å¯ä»¥æ˜¯å­¸ç”Ÿï¼Œä¸€å®šè¦æ˜¯æˆå¹´äºº

[é‡è¦æé†’]
1. æ°¸é ä¸è¦å±•ç¤ºæ€è€ƒéç¨‹ï¼Œç”Ÿæˆçµæœåªæ‡‰æœ‰æ–‡ç« ï¼›
2. ä¸è¦éä»½åˆ»åŠƒç•«é¢ä¸­èˆ‡ä¸»é¡Œä¸ç›¸é—œçš„ç´°ç¯€ï¼Œæ¯å€‹çµæ§‹æ®µéƒ½è¦èšç„¦åˆ°èˆ‡ä¸»é¡Œç›¸é—œçš„é‡é»ï¼Œä¸è¦ç”Ÿæˆç´°ç¯€è±å¯Œä½†æƒ…ç¯€å–®è–„çš„æ–‡ç« ï¼›
3. æ‰€æœ‰ã€Œè½‰ã€éƒ½å¿…é ˆæœ‰å…©é»æ”¯æ’ï¼Œä¾‹å¦‚ç”±ç¾å¯¦ä¸­çš„æŸä¸€ä»¶äº‹(200å­—å·¦å³)ç‰½å¼•èµ·å›æ†¶ä¸­çš„å¦ä¸€æ®µå¾€äº‹(200å­—å·¦å³)è§¸ç™¼ï¼Œé€™äº›äº‹ä»¶å¯èƒ½æœƒå°è‡´ä¸»è§’åœ¨å¿ƒæ…‹ä¸Šçš„è½‰è®Šï¼Œäº‹ä»¶çš„ã€Œæ™‚ã€åœ°ã€äººã€äº‹ã€æƒ…ã€ç‰©ã€ç†ã€éƒ½è¦å…·é«”æ¸…æ¥šï¼›
4. æ°¸é ä¸è¦ç”¨èº«é«”ä»»ä½•ä¸€éƒ¨ä»½åšä¸»èªï¼Œä¾‹å¦‚åš´ç¦ä½¿ç”¨ã€ŒæŒ‡å°–ã€ã€ã€Œé¡é ­ã€ã€ã€Œæ‰‹è…•ã€ï¼Œå› ç‚ºæ²’æœ‰äººæœƒè§€å¯Ÿè‡ªå·±çš„ï¼Œé€™æ¨£åˆ»åŠƒéå¸¸ä¸è‡ªç„¶ã€‚ä»¥ä¸‹é€™æ®µæ˜¯åé¢ä¾‹å­:ã€Œé‚£æšä½ˆæ»¿éœ‰æ–‘çš„éº»å¸ƒè¢‹éœè‡¥åœ¨æŠ½å±œæœ€æ·±è™•ï¼Œåƒä¸€å€‹è¢«æ™‚å…‰éºæ£„çš„ç§˜å¯†ã€‚æš—è¤è‰²çš„æ–‘é»å¦‚ç„¡è²æ“´æ•£çš„è¼¿åœ–ï¼Œåå™¬è‘—éº»å¸ƒåŸæœ¬ç²—ç¤ªçš„ç´‹ç†ï¼Œä¹Ÿåå™¬è‘—è¢‹å£æ­ªæ–œçš„å­—è·¡â€”â€”ã€Œå‘æ—¥è‘µç¨®å­ã€ã€‚æ‰‹æŒ‡æ‹‚éï¼Œç´°ç¢çš„é»´ç²‰ç°Œç°Œå‰è½ï¼Œæšèµ·å¡µå°æ­²æœˆå—†äººçš„æ°£æ¯ã€‚ä¸‰å¹´å‰çš„é™½å…‰ï¼Œå»å¿½è€Œç‡™ç¼äº†æˆ‘çš„æŒå¿ƒã€‚ã€ï¼›
5. æ–‡ç« çš„è§’è‰²åœ¨èªªå°ç™½æ™‚ï¼Œåš´ç¦ä½¿ç”¨èªªæ•™å¼çš„å°ç™½ï¼Œä¾‹å¦‚ã€Œæ¯ä¸€é¡†ç¨®å­éƒ½è—è‘—ä¸€å€‹æ•…äº‹ï¼Œæˆ‘å€‘è¦å¥½å¥½è†è½ã€ï¼Œé€™äº›å°ç™½æ²’æœ‰æƒ…ç¯€æ”¯æ’ï¼Œè®€è€…æ ¹æœ¬ä¸çŸ¥é“è§’è‰²èªªå‡ºé€™å¥å°ç™½çš„å‰å› å¾Œæœã€ä¾†é¾å»è„ˆï¼Œæ–‡ä¸­è‹¥åè¦†ç”Ÿæˆé€™äº›å¥å­ï¼Œè®€è€…æœƒå¾ˆå®¹æ˜“å¯Ÿè¦ºæ˜¯AIå¯«çš„ã€‚æ‰€æœ‰å°ç™½éƒ½è¦è²¼è¿‘ç”Ÿæ´»ã€‚é‡è¦ï¼åš´æ¨™ä½¿ç”¨é¡ä¼¼å°ç™½ï¼
6. å…¨ç¯‡æ–‡ç« ä¸èƒ½åªåœç¹ä¸€ä»¶äº‹æƒ…å»æ•˜è¿°ï¼Œæœƒé¡¯å¾—é‡è¤‡è€Œä¹å‘³ï¼Œä¾‹å¦‚æ–‡é¡Œç‚ºã€Šç¨®å­ã€‹ï¼Œä¸èƒ½å…¨ç¯‡éƒ½åœç¹è‘—è¡¨é¢çš„ã€Œç¨®æ¤ã€éç¨‹å»æ•˜äº‹ï¼Œä¾‹å¦‚èˆ‡çˆºçˆºä¸€èµ·å°‡ç¨®å­åŸ‹åœ¨æ³¥åœŸä¸­ï¼Œè¦å–é¡Œç›®çš„è±¡å¾µæ„ç¾©ï¼Œæ˜æš—ç›¸ç”Ÿï¼Œäº’ç›¸æ‰£é€£ã€‚è¡¨é¢ä¸Šï¼Œæœ‰äº›æƒ…ç¯€èˆ‡ã€Œç¨®å­ã€æ²’æœ‰ç›´æ¥é€£ç¹«ï¼Œä½†ç¨®å­å»è±¡å¾µè‘—å¸Œæœ›ã€æœªçŸ¥ï¼Œè©²äº›äº‹æƒ…å¯ä»¥è·Ÿå¸Œæœ›å’ŒæœªçŸ¥é€™äº›ä¸»é¡Œæœ‰æ‰€é€£ç¹«ã€‚
7. æ–‡ç« çš„äººç‰©è¦æœ‰è‡ªå·±çš„ç¶“æ­·å’Œå›æ†¶ï¼Œé‡è¦ï¼æ–‡ç« æ‡‰å´é‡åœ¨äººèˆ‡äººä¹‹é–“çš„äº¤æµåŠä¸»è§’å…§å¿ƒçš„å¿ƒç†åˆ»åŠƒï¼Œäº¦å³æƒ…ç¯€çš„æ•˜å¯«ï¼Œä¸è¦ç”¨ç‰©ä»¶ç´°ç¯€å»å–ä»£æƒ…ç¯€ã€‚ã€Œè½‰ã€çš„éƒ¨ä»½ï¼Œæƒ…ç¯€å¿…é ˆèˆ‡ä¸Šè¿°ä»»ä½•éƒ¨ä»½éƒ½ä¸ä¸€æ¨£ï¼Œã€Œè½‰ã€çš„äº‹ä»¶èˆ‡ã€Œæ‰¿ã€çš„äº‹ä»¶ä¸ä¸€æ¨£ï¼Œä½†åˆèˆ‡ä¸»é¡Œç·Šç·Šæ‰£é€£ï¼Œé€™æ¨£æ‰èƒ½æ‰“é–‹æ•´ç¯‡æ–‡ç« çš„æ ¼å±€ã€‚
8. å–æè¡Œæ–‡å¿…é ˆé¿å…éæ–¼å“²å­¸åŒ–åŠæŠ½è±¡åŒ–ï¼Œå¿…é ˆæ˜¯å…·æœ‰æ–‡å­¸æ€§è€Œåˆæœ‰ç…™ç«æ°£çš„ææ–™åŠæ–‡å¥ã€‚
9. åš´ç¦é€£ç”¨ä¸åŒå°ç‰©ä»¶åšä¸»èªçš„å¥å­ï¼Œå°ç‰©ä»¶ç­‰ä¸»èªä¸å®œé€£çºŒè®Šæ›ï¼Œç¬¬ä¸€æ®µè¦æ¸›å°‘é‹ç”¨å°ç‰©ä»¶åšä¸»èªã€‚
10. é¡Œæè¦è±å¯Œå¤šè®Šï¼Œçµ•ä¸å¯ä»¥å¯«æº«ç¿’ã€å·¥ä½œã€æ¯”è³½ç­‰ä¸»é¡Œã€‚
11. å…¨æ–‡çš„äº‹ä»¶æ™‚é–“é»æ‡‰æœ‰ä¸‰æ¬¡å·¦å³çš„è®Šæ›ï¼Œå³å¯ç”±ç¾å¯¦åˆ°å›æ†¶ï¼Œäº¦å¯å›æ†¶å›åˆ°ç¾å¯¦ï¼Œé€™æ¨£èƒ½å¢åŠ æƒ…ç¯€çš„è®ŠåŒ–ã€‚
12. æ®µèˆ‡æ®µä¹‹é–“çš„è·é›¢ä¸è¦å¤ªé ã€‚
13. äººç‰©å°è©±åš´ç¦é‹ç”¨ç²µèªã€‚
14. ç”Ÿæˆçµæœåªæ‡‰æœ‰æ–‡ç« æ­£æ–‡ï¼Œçµ•ä¸å¯ä»¥åŒ…å«ã€Œèµ·ã€ã€ã€Œæ‰¿ã€ã€ã€Œè½‰ã€ã€ã€Œåˆã€ç­‰ä»»ä½•çµæ§‹æ¨™ç¤ºæˆ–å°æ¨™é¡Œï¼›
    </pre></div>
    <div id="sanxian-notes" style="display: none;"><pre>
[æ–‡ç« é¡å‹] æ•˜äº‹æŠ’æƒ…æ–‡ã€‚

[æ ¸å¿ƒçµæ§‹ï¼šä¸‰ç·šæ•£æ•˜] ä½ çš„æ–‡ç« å¿…é ˆæ¡ç”¨ä¸‰ç·šæ•£æ•˜çµæ§‹ï¼Œåœç¹ä¸»é¡Œç”¨ä¸åŒäº‹ä»¶å»æ•˜å¯«ï¼Œå„ç·šç´¢ä¹‹é–“ç›¸äº’å‘¼æ‡‰ï¼Œå…±åŒæ·±åŒ–ä¸»é¡Œã€‚

1. ç¬¬ä¸€ç·šï¼š
- åœç¹ä¸»é¡Œé¸æ“‡ä¸€å€‹å…·é«”çš„ç”Ÿæ´»äº‹ä»¶æˆ–å ´æ™¯
- è©³ç´°æå¯«è©²äº‹ä»¶çš„ç¶“éå’Œæ„Ÿå—
- é«”ç¾ä¸»é¡Œçš„æŸå€‹å´é¢æˆ–å±¤æ¬¡

2. ç¬¬äºŒç·šï¼š
- é¸æ“‡å¦ä¸€å€‹èˆ‡ä¸»é¡Œç›¸é—œä½†ä¸åŒè§’åº¦çš„äº‹ä»¶
- å¯ä»¥æ˜¯ä¸åŒæ™‚é–“ã€ä¸åŒåœ°é»æˆ–ä¸åŒäººç‰©çš„ç¶“æ­·
- èˆ‡ç¬¬ä¸€ç·šå½¢æˆå°æ¯”æˆ–è£œå……ï¼Œè±å¯Œä¸»é¡Œå…§æ¶µ

3. ç¬¬ä¸‰ç·šï¼š
- ç¬¬ä¸‰å€‹ç›¸é—œäº‹ä»¶ï¼Œé€²ä¸€æ­¥æ‹“å±•ä¸»é¡Œçš„æ·±åº¦å’Œå»£åº¦
- å¯ä»¥æ˜¯æ›´æ·±å±¤çš„æ€è€ƒæˆ–æ›´å»£é—Šçš„è¦–é‡
- ä¸‰ç·šåŒ¯èšï¼Œåœ¨çµå°¾è™•æ˜‡è¯ä¸»é¡Œ

[ç·šç´¢äº¤ç¹”èˆ‡éæ¸¡]
â€¢ ä¸‰æ¢ç·šç´¢ä¸æ˜¯ç°¡å–®çš„ä¸¦åˆ—ï¼Œè€Œè¦å·§å¦™äº¤ç¹”
â€¢ å¯ä»¥é€šéæ™‚é–“è·³èºã€ç©ºé–“è½‰æ›ã€è¯æƒ³ç­‰æ–¹å¼é€£æ¥å„ç·š
â€¢ ç¢ºä¿éæ¸¡è‡ªç„¶æµæš¢ï¼Œé¿å…ç”Ÿç¡¬åˆ‡æ›
â€¢ å„ç·šç´¢ä¹‹é–“è¦æœ‰å…§åœ¨çš„é‚è¼¯è¯ç¹«å’Œæƒ…æ„Ÿå‘¼æ‡‰

[ä¸»é¡ŒåŠç«‹æ„]
â€¢ ç«‹æ„å…¬å¼: (è¡¨é¢A + å¯¦éš›éA) + åˆç†è§£é‡‹ = å¥½çš„ç«‹æ„ã€‚
â€¢ ç«‹æ„æ‡‰èƒ½ã€Œä»¥å°è¦‹å¤§ã€ï¼Œå¸¶çµ¦è®€è€…æ€è€ƒèˆ‡å…±é³´ï¼Œä¸¦å…·æœ‰ç¤¾æœƒæ€§ã€‚é¿å…è½ä¿—å¥—çš„é™³è…”æ¿«èª¿ã€‚
â€¢ ç«‹æ„æ®µè¦æ±‚:
- ç´„ä½”å…¨æ–‡å››åˆ†ä¹‹ä¸€çš„ç¯‡å¹…ã€‚
- å¯é‹ç”¨ã€Œæ’æ¯”ã€ã€ã€Œä¸‰ä½•æ³•ã€ï¼ˆä¸‰å€‹è¨­å•ï¼‰ç­‰ä¿®è¾­æ‰‹æ³•ä»¥åŠ å¼·èªæ°£å’Œæ„ŸæŸ“åŠ›ã€‚
- çµå°¾éœ€å‘¼æ‡‰ä¸»é¡Œï¼Œç•™æœ‰é¤˜å‘³å’Œè¯æƒ³ç©ºé–“ã€‚

[è¡¨é”æ‰‹æ³•ï¼šç¤ºç¾æ•˜äº‹ (Show, Don't Tell)] æ•˜äº‹æ™‚ï¼Œåˆ‡å‹¿åƒ…ä½œæ—ç™½å¼ã€Œäº¤ä»£ã€(tell) æƒ…ç¯€ï¼Œå¿…é ˆã€Œç¤ºç¾ã€(show) ç•«é¢ï¼Œè®“è®€è€…å¦‚è‡¨å…¶å¢ƒã€‚å››ç¨®æ•˜äº‹æ‰‹æ³•å¿…é ˆäº¤æ›¿ä½¿ç”¨ï¼Œä»¥ä¿æŒæ•˜äº‹å½¢å¼çš„éˆæ´»å¤šè®Šã€‚

1. å°ç‰©ä»¶ (Small Objects/Details):
- ç‰¹é»ï¼šæ•˜äº‹ç¯€å¥æ…¢ï¼Œç´°ç·»ç¨‹åº¦é«˜ï¼Œç›´æ¥ç¨‹åº¦ä½ã€‚
- ç”¨é€”ï¼šæ¸²æŸ“æ°›åœï¼Œå°‡æ•…äº‹å¨“å¨“é“ä¾†ï¼›å´é¢æ˜ è¥¯äººç‰©æƒ…æ„ŸåŠä¸»é¡Œï¼›ä½œç‚ºéæ¸¡ã€‚
- æè¿°éœ€ç´°ç·»ï¼Œä½†ä¸åé›¢ä¸»é¡Œã€‚

2. å‹•ä½œ (Actions):
- ç‰¹é»ï¼šæ•˜äº‹ç¯€å¥ä¸­ç­‰ï¼Œç´°ç·»ç¨‹åº¦é«˜/è¼ƒé«˜ï¼Œç›´æ¥ç¨‹åº¦ä¸­ç­‰ã€‚
- ç”¨é€”ï¼šç‚ºé‡è¦æƒ…ç¯€è£œå……ç´°ç¯€ï¼Œä»¥çªé¡¯ä¸»é¡Œã€‚
- é•·åº¦è¦æ±‚ï¼šæ¯çµ„å‹•ä½œæå¯«æ‡‰é”2è‡³3å¥ï¼Œä»¥ç¢ºä¿æ–‡æ„é€£è²«ã€é¿å…é›¶ç¢ï¼Œä¸¦å¢å¼·æ„ŸæŸ“åŠ›ã€‚
- å¯é‹ç”¨ä¿®è¾­ã€å¤§é‡å½¢å®¹è©ï¼Œä¸¦å°‡ä¸€å€‹å‹•ä½œæ‹†åˆ†ç‚ºå¹¾å€‹å°å‹•ä½œæå¯«ã€‚
- æ‡‰é¸å–å…¸å‹çš„ã€Œå‹•ä½œã€ä¾†è¡¨ç¾äººç‰©æ€§æ ¼ç‰¹å¾µã€‚

3. å°è©± (Dialogue):
- ç‰¹é»ï¼šæ•˜äº‹ç¯€å¥æ…¢ï¼Œç´°ç·»ç¨‹åº¦ä½ï¼Œç›´æ¥ç¨‹åº¦ä¸­ç­‰ã€‚
- ç”¨é€”ï¼šçªé¡¯æƒ…ç¯€é‡é»æˆ–äººç‰©æƒ…æ„Ÿã€‚
- å°è©±å…§å®¹éœ€ç¬¦åˆäººç‰©çš„èº«ä»½å’Œç¶“æ­·ï¼Œç°¡ç…‰ç”Ÿå‹•ï¼Œèƒ½è¡¨ç¾çœŸæƒ…å¯¦æ„Ÿã€‚
- å°ç™½å½¢å¼å¯å¤šè®Šï¼šå¯ã€Œå°è©±åœ¨å‰ã€ã€ã€Œå°è©±åœ¨å¾Œã€ã€ã€Œå°è©±åœ¨å…©é ­ã€ï¼Œç”šè‡³æ¡ç”¨ã€Œæ›è¡Œå…©é ­ç©ºå‹ã€ä»¥å¼·èª¿æƒ…æ„Ÿã€‚

4. å…§å¿ƒç¨ç™½ (Internal Monologue):
- ç‰¹é»ï¼šæ•˜äº‹ç¯€å¥å¿«ï¼Œç´°ç·»ç¨‹åº¦è‡ªç”±ï¼Œç›´æ¥ç¨‹åº¦é«˜ã€‚
- ç”¨é€”ï¼šç•¥å¯«è¼ƒæ¬¡è¦çš„ç‰‡æ®µï¼›å¸¶å‡ºäººç‰©å¿ƒç†ã€æ‰£é¡Œå…§å®¹å’Œç«‹æ„ã€‚

[å¥çµ„çš„é€£çºŒæ€§]
â€¢ ä»¥ã€Œåˆ»åŠƒå°è±¡ã€ä¾†åŠƒåˆ†å¥çµ„ï¼Œç¢ºä¿å¥å­çµ„åˆçš„é€£è²«æ€§ã€‚ä¾‹å¦‚ï¼Œæè¿°ä¸€å€‹å°è±¡æ™‚ï¼Œç›¸é—œçš„å¥å­æ‡‰çµ„ç¹”åœ¨ä¸€èµ·ã€‚
â€¢ é¿å…å¥çµ„çŸ­ä¿ƒè€Œå‰²è£‚ï¼Œè¿½æ±‚æµæš¢çš„è¡Œæ–‡ã€‚

[æ–‡å­—å¯†åº¦]
â€¢ ç¶­æŒé«˜æ–‡å­—å¯†åº¦ï¼šè©å½™è±å¯Œï¼Œç”¨è©ä¸é‡è¤‡ã€‚
â€¢ å¯¦è©èˆ‡è™›è©çš„æ¯”ä¾‹ç´„ç‚ºä¸ƒä¸‰æ¯” (70%å¯¦è©, 30%è™›è©)ã€‚

[äººç‰©æå¯«]
â€¢ è‚–åƒæå¯«: æå¯«äººç‰©çš„å®¹è²Œã€ç¥æƒ…ã€å§¿æ…‹ã€æœé£¾ã€éŸ³èª¿ç­‰ã€‚æ³¨æ„è¦–ç·šç§»å‹•é †åºï¼ˆå¦‚ç”±ä¸Šè€Œä¸‹ï¼‰ï¼Œé¸æ“‡å…¸å‹ç´°ç¯€ï¼Œä»¥çƒ˜æ‰˜äººç‰©æ€§æ ¼ã€èº«ä»½ã€åœ°ä½ã€‚
â€¢ å‹•ä½œæå¯«: é€éå…·é«”çš„è¡Œç‚ºå‹•ä½œä¾†è¡¨ç¾äººç‰©æ€§æ ¼ç‰¹å¾µï¼Œé¸æ“‡å…¸å‹å‹•ä½œã€‚
â€¢ èªè¨€æå¯« (å°è©±): åƒè€ƒä¸Šè¿°ã€Œå°è©±ã€çš„è¦æ±‚ã€‚

[æ¯”å–»çš„é‹ç”¨]
â€¢ å‰µé€ è€äººå°‹å‘³çš„æ¯”å–»ï¼Œé¿å…è½ä¿—å¥—ã€‚
â€¢ éœ€åŒ…å«ä¸‰å€‹æ­¥é©Ÿï¼š
1. ä»¥ä¸€å€‹ç•«é¢ä½œå–»ï¼Œå…¶ä¸­è‡³å°‘åŒ…å«å…©å€‹ç‰©è±¡ã€‚
2. å…·é«”å½¢å®¹è©²äº›ç‰©è±¡ã€‚
3. åŠ å…¥ä¸€æ®µè£œå……è§£é‡‹çš„æ–‡å­—ã€‚

[æƒ…ç¯€èˆ‡é«˜æ½®]
â€¢ å¢åŠ æƒ…ç¯€çš„æ›²æŠ˜æ€§ï¼Œä½¿æ•…äº‹ä¸å¹³å‡¡ã€‚
â€¢ é©ç•¶è¨­ç½®é«˜æ½®ï¼šæ•…äº‹æ°£æ°›æœ€é«˜æ¼²ã€çŸ›ç›¾è¡çªæœ€æ¿€çƒˆã€æœ€é—œéµçš„æ™‚åˆ»ã€‚é«˜æ½®éå¾Œæ°£æ°›æ‡‰è¶¨æ–¼å¹³å’Œã€‚

[çµå°¾æŠ€å·§]
â€¢ å‘¼æ‡‰æ³•: çµå°¾èˆ‡æ–‡ç« é–‹é ­æˆ–å‰æ–‡å…§å®¹å‘¼æ‡‰ï¼Œä»¥çªé¡¯ä¸»é¡Œã€‚
â€¢ æƒ…æ™¯äº¤èæ³•: å°‡æƒ…æ„Ÿèå…¥è‡ªç„¶æ™¯ç‰©æˆ–ç”Ÿæ´»å ´æ™¯ä¸­ï¼Œé€éæå¯«æ™¯ç‰©ä¾†å«è“„æŠ’æƒ…ã€‚
â€¢ æ¯”å–»æ³•: ä»¥åˆ¥å‡ºå¿ƒè£çš„æ¯”å–»ä½œçµï¼Œåœç¹è©²ç‰©è±¡ç™¼æ®ï¼Œå¸¶å‡ºä¸»é¡Œã€‚

[èªè¨€è¦æ±‚]
â€¢ è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡é€²è¡Œç”Ÿæˆï¼Œçµ•ä¸å¯ä»¥é‹ç”¨ç²µèªã€‚
â€¢ èªè¨€å„ªç¾ã€æ–‡ç­†æµæš¢ï¼Œç¬¦åˆæ•˜äº‹æŠ’æƒ…æ–‡çš„é¢¨æ ¼ã€‚

[é¡Œæ]
â€¢ è±å¯Œå¤šè®Šï¼Œä¸è¦å¯«æ¯”è³½ã€æº«ç¿’ã€å·¥ä½œå’Œè€ƒè©¦ï¼Œè¦èƒ½å¤ å¼•èµ·åˆ¥äººçš„æƒ…æ„Ÿå…±é³´ã€‚
â€¢ ä¸»è§’ä¸å¯ä»¥æ˜¯å­¸ç”Ÿï¼Œä¸€å®šè¦æ˜¯æˆå¹´äººï¼Œé¡Œæä¸è¦è²¼è¿‘å­¸ç”Ÿçš„ç”Ÿæ´»ç¶“é©—

[é‡è¦æé†’]
1. æ°¸é ä¸è¦å±•ç¤ºæ€è€ƒéç¨‹ï¼Œä¸è¦æœ‰ä»»ä½•å°æ¨™é¡Œæˆ–éä¸­æ–‡çš„ç¬¦è™Ÿï¼Œä¾‹å¦‚ã€Œä¸€ç·šã€ã€ã€ŒäºŒç·šã€ã€ã€Œä¸‰ç·šã€ã€ã€Œ*ã€ç­‰ï¼Œç”Ÿæˆçµæœåªæ‡‰æœ‰æ–‡ç« ï¼›
2. ä¸è¦éä»½åˆ»åŠƒç•«é¢ä¸­èˆ‡ä¸»é¡Œä¸ç›¸é—œçš„ç´°ç¯€ï¼Œæ¯å€‹ç·šç´¢éƒ½è¦èšç„¦åˆ°èˆ‡ä¸»é¡Œç›¸é—œçš„é‡é»ï¼›
3. ä¸‰æ¢ç·šç´¢å¿…é ˆæ˜¯ä¸åŒçš„äº‹ä»¶ï¼Œç›¸äº’å‘¼æ‡‰ï¼Œå…±åŒæ·±åŒ–ä¸»é¡Œï¼›
4. æ°¸é ä¸è¦ç”¨èº«é«”ä»»ä½•ä¸€éƒ¨ä»½åšä¸»èªï¼Œä¾‹å¦‚åš´ç¦ä½¿ç”¨ã€ŒæŒ‡å°–ã€ã€ã€Œé¡é ­ã€ã€ã€Œæ‰‹è…•ã€ï¼›
5. æ–‡ç« çš„è§’è‰²åœ¨èªªå°ç™½æ™‚ï¼Œåš´ç¦ä½¿ç”¨èªªæ•™å¼çš„å°ç™½ï¼Œæ‰€æœ‰å°ç™½éƒ½è¦è²¼è¿‘ç”Ÿæ´»ï¼›
6. ä¸‰æ¢ç·šç´¢ä¸èƒ½åªåœç¹åŒä¸€ä»¶äº‹æƒ…å»æ•˜è¿°ï¼Œè¦æœ‰ä¸åŒçš„äº‹ä»¶å’Œå ´æ™¯ï¼›
7. å„ç·šç´¢ä¹‹é–“è¦æœ‰å…§åœ¨çš„é‚è¼¯è¯ç¹«å’Œæƒ…æ„Ÿå‘¼æ‡‰ï¼Œé€šéå·§å¦™çš„éæ¸¡é€£æ¥ï¼›
8. å–æè¡Œæ–‡å¿…é ˆé¿å…éæ–¼å“²å­¸åŒ–åŠæŠ½è±¡åŒ–ï¼Œå¿…é ˆæ˜¯å…·æœ‰æ–‡å­¸æ€§è€Œåˆæœ‰ç…™ç«æ°£çš„ææ–™åŠæ–‡å¥ï¼›
9. é¡Œæè¦è±å¯Œå¤šè®Šï¼Œçµ•ä¸å¯ä»¥å¯«æº«ç¿’ã€å·¥ä½œã€æ¯”è³½ç­‰ä¸»é¡Œï¼›
10. ä¸»è§’ä¸å¯ä»¥æ˜¯å­¸ç”Ÿï¼Œä¸€å®šè¦æ˜¯æˆå¹´äººï¼Œé¡Œæä¸è¦è²¼è¿‘å­¸ç”Ÿçš„ç”Ÿæ´»ç¶“é©—
11. ä¸€å®šè¦åšå¥½ç·šèˆ‡ç·šä¹‹é–“çš„éæ¸¡æ®µã€‚
12. æ®µèˆ‡æ®µä¹‹é–“çš„è·é›¢ä¸è¦å¤ªé ã€‚
13. äººç‰©å°è©±åš´ç¦é‹ç”¨ç²µèªã€‚
    </pre></div>
    
    <div class="container">
        <header>
            <h1>ç¿»æ°´ï¼æ•˜</h1>
            <p>æˆ‘çš„éˆé­‚è—åœ¨æ–‡å­—çš„èƒŒå¾Œ</p>
        </header>
        <main>
            <div class="controls">
                <div class="control-group">
                    <label for="topic-input">æ–‡ç« é¡Œç›®</label>
                    <input type="text" id="topic-input" placeholder="ä¾‹å¦‚ï¼šã€Šç­‰å¾…ã€‹">
                </div>
                <div class="control-group">
                    <label for="guidelines-input">å‰µä½œæŒ‡å¼•</label>
                    <textarea id="guidelines-input" placeholder="è«‹è¼¸å…¥æ–‡ç« çš„é¢¨æ ¼ã€æƒ…ç¯€å¤§ç¶±æˆ–é—œéµè©..."></textarea>
                </div>
                <div class="control-group">
                    <label>é è¨­å­—æ•¸</label>
                    <div class="word-count-control">
                        <button class="word-count-btn" id="decrease-words">-</button>
                        <span id="word-count-display">1500</span>
                        <button class="word-count-btn" id="increase-words">+</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>æ–‡ç« çµæ§‹</label>
                     <div class="style-selector">
                        <label>
                            <input type="radio" name="structure" value="qczh" checked>
                            <span>èµ·æ‰¿è½‰åˆ</span>
                        </label>
                        <label>
                            <input type="radio" name="structure" value="sanxian">
                            <span>ä¸‰ç·š</span>
                        </label>
                    </div>
                </div>
               <div class="control-group">
    <label>é¸æ“‡æ¨¡å‹</label>
    <div class="style-selector">
        <label>
            <!-- é­šæœ¨è¨­å®šç‚º DeepSeek -->
            <input type="radio" name="model" value="gemini-search" checked>
            <span>é­šæœ¨</span>
        </label>
        <label>
            <!-- æ°´å¿ƒè¨­å®šç‚º Gemini -->
            <input type="radio" name="model" value="gemini-search">
            <span>æ°´å¿ƒ</span>
        </label>
    </div>
</div>
                <button class="generate-btn" id="generate-btn">ç”Ÿæˆæ–‡ç« </button>
            </div>
            <div class="output">
                <div id="essay-placeholder">éœå¾…éˆæ„Ÿ ...</div>
                <div id="output-toolbar" class="output-toolbar" style="display:none;">
                    <span id="output-word-count"></span>
                    <button id="copy-btn" class="icon-btn" title="è¤‡è£½å…¨æ–‡"></button>
                </div>
                <div id="generated-essay" style="display:none;"></div>
                <div id="loader" class="loader" style="display:none;"></div>
            </div>
        </main>
    </div>


    <script>

        // ===============================================================
// === [ç¥æ€é€šç”¨çµ„ä»¶] æ¬Šé™æ””æˆªå™¨ & è«è˜­è¿ªæç¤ºçª— (å«ç™»å…¥é€£çµ) ===
// ===============================================================
(function() {
    // é˜²æ­¢é‡è¤‡æ³¨å…¥
    if (window.SansiInterceptorLoaded) return;
    window.SansiInterceptorLoaded = true;

    // --- 1. è‡ªå‹•æ³¨å…¥è«è˜­è¿ª CSS ---
    const style = document.createElement('style');
    style.textContent = `
        /* è«è˜­è¿ªé®ç½© */
        .sansi-limit-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(253, 252, 248, 0.88); /* ç±³ç™½é«˜æ¨¡ç³Š */
            backdrop-filter: blur(6px);
            z-index: 9999999; /* æœ€é«˜å±¤ç´š */
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .sansi-limit-show { opacity: 1; }

        /* è¦–çª—å¡ç‰‡ */
        .sansi-limit-card {
            background: #fdfcf8;
            border: 1px solid #e0ddd7;
            border-radius: 16px;
            padding: 30px 25px;
            width: 90%; max-width: 380px;
            box-shadow: 0 15px 40px rgba(141, 110, 99, 0.15);
            text-align: center;
            transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            font-family: 'Noto Serif TC', serif;
        }
        .sansi-limit-show .sansi-limit-card { transform: translateY(0); }

        /* åœ–ç¤ºèˆ‡æ–‡å­— */
        .sansi-limit-icon { font-size: 3rem; color: #d69a92; margin-bottom: 15px; } /* è±†æ²™ç´… */
        .sansi-limit-title { color: #5d4037; font-size: 1.4rem; font-weight: bold; margin: 0 0 10px 0; }
        .sansi-limit-desc { color: #888; font-size: 1rem; line-height: 1.6; margin-bottom: 25px; text-align: justify; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .sansi-btn-group { display: flex; gap: 12px; margin-top: 20px; }

        .sansi-limit-btn {
            border: none; padding: 10px 0; border-radius: 50px;
            font-size: 0.95rem; font-weight: bold; cursor: pointer;
            transition: all 0.2s; font-family: 'Noto Serif TC', serif;
            flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px;
            text-decoration: none;
        }

        /* ä¸»æŒ‰éˆ• (å‰å¾€ç™»å…¥) - è«è˜­è¿ªç¶  */
        .btn-primary { 
            background: #8fa398; color: white; 
            box-shadow: 0 4px 12px rgba(143, 163, 152, 0.4);
        }
        .btn-primary:hover { background-color: #7d9186; transform: translateY(-2px); }

        /* æ¬¡æŒ‰éˆ• (é—œé–‰) - æ·ºç° */
        .btn-secondary { 
            background: #f0f0f0; color: #777; 
        }
        .btn-secondary:hover { background-color: #e5e5e5; }
    `;
    document.head.appendChild(style);

    // --- 2. è‡ªå‹•æ³¨å…¥ HTML (å½ˆå‡ºè¦–çª—) ---
    const modalHTML = `
        <div id="sansiLimitModal" class="sansi-limit-overlay">
            <div class="sansi-limit-card">
                <div class="sansi-limit-icon">
                    <i class="fas fa-user-lock"></i>
                </div>
                <div class="sansi-limit-title">éœ€è¦ç™»å…¥</div>
                <div class="sansi-limit-desc">
                    è¨ªå®¢æ¯æ—¥é«”é©—é¡åº¦å·²è€—ç›¡ã€‚<br>
                    è«‹å‰å¾€ã€Œç¥æ€ã€ä¸»é ç™»å…¥å­¸æ ¡å¸³è™Ÿï¼Œå³å¯è§£é–ç„¡é™ä½¿ç”¨æ¬Šé™ã€‚
                </div>
                <div class="sansi-btn-group">
                    <button class="sansi-limit-btn btn-secondary" onclick="closeSansiLimitModal()">
                        ç¨å¾Œ
                    </button>
                    <!-- é»æ“Šç›´æ¥è·³è½‰è‡³ç¥æ€ä¸»é  -->
                    <button class="sansi-limit-btn btn-primary" onclick="window.location.href='https://kenchan20141.github.io/AIChinese/'">
                        <i class="fas fa-sign-in-alt"></i> å‰å¾€ç™»å…¥
                    </button>
                </div>
            </div>
        </div>
    `;
    const div = document.createElement('div');
    div.innerHTML = modalHTML;
    document.body.appendChild(div);

    // --- 3. å®šç¾©é—œé–‰è¦–çª—èˆ‡æ¸…ç†å‡½å¼ ---
    window.closeSansiLimitModal = function() {
        const modal = document.getElementById('sansiLimitModal');
        if (modal) {
            modal.classList.remove('sansi-limit-show');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
            
            // è‡ªå‹•å˜—è©¦é—œé–‰å„ç¨®å·¥å…·çš„ Loading ç‹€æ…‹ï¼Œé˜²æ­¢ç•«é¢å¡æ­»
            if (typeof hideProgress === 'function') hideProgress(); // é¡Œå­³
            if (typeof hideLoading === 'function') hideLoading();   // ç¿»æ°´/å¯«ä½œ
            
            // å¦‚æœæŒ‰éˆ•è¢«ç¦ç”¨ï¼Œå˜—è©¦è§£é– (é‡å°é€šç”¨æŒ‰éˆ• class)
            const disabledBtns = document.querySelectorAll('button:disabled');
            disabledBtns.forEach(btn => btn.disabled = false);
        }
    };

    // --- 4. æ””æˆªå™¨æ ¸å¿ƒé‚è¼¯ ---
    const originalFetch = window.fetch;
    
    window.fetch = async function(url, options) {
        // åƒ…æ””æˆª AI è«‹æ±‚
        if (typeof url === 'string' && url.includes('pollinations.ai')) {
            
            // A. å³æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹ (æ¯æ¬¡è«‹æ±‚éƒ½æœƒé‡æ–°è®€å–ï¼Œé˜²æ­¢ç™»å‡ºå¾Œä»èƒ½ä½¿ç”¨)
            const s = localStorage.getItem('studentProfile');
            
            if (s) {
                // å·²ç™»å…¥ï¼šæ”¾è¡Œ
                return originalFetch(url, options);
            }

            // B. æœªç™»å…¥ï¼šæª¢æŸ¥é¡åº¦
            const today = new Date().toLocaleDateString('zh-HK');
            const toolName = document.title || "UnknownTool"; 
            const storageKey = `sansi_guest_usage_${toolName}_${today}`;
            
            let currentCount = parseInt(localStorage.getItem(storageKey) || "0");

            // C. è¶…éé¡åº¦ -> é˜»æ“‹ä¸¦å½ˆçª—
            if (currentCount >= 1) {
                // é¡¯ç¤ºè¦–çª—
                const modal = document.getElementById('sansiLimitModal');
                modal.style.display = 'flex';
                // å¼·åˆ¶é‡ç¹ªä»¥è§¸ç™¼éæ¸¡å‹•ç•«
                void modal.offsetWidth; 
                modal.classList.add('sansi-limit-show');

                // å›å‚³éŒ¯èª¤ä»¥ä¸­æ–·åŸæœ¬ç¨‹å¼çš„åŸ·è¡Œ
                return Promise.reject(new Error("Guest Limit Exceeded"));
            }

            // D. æœªè¶…é -> è¨˜éŒ„ä¸¦æ”¾è¡Œ
            localStorage.setItem(storageKey, currentCount + 1);
            console.log(`[è¨ªå®¢] ${toolName} ä½¿ç”¨ç¬¬ ${currentCount + 1} æ¬¡`);
        }

        return originalFetch(url, options);
    };
    
    console.log("âœ… ç¥æ€é€šç”¨æ¬Šé™é– (å«ç™»å…¥é€£çµ) å·²å•Ÿå‹•");
})();
</script>

    <script>
        // å‰ç«¯äº’å‹•èˆ‡ API ä¸²æ¥é‚è¼¯
        document.addEventListener('DOMContentLoaded', () => {
            const topicInput = document.getElementById('topic-input');
            const guidelinesInput = document.getElementById('guidelines-input');
            const decreaseBtn = document.getElementById('decrease-words');
            const increaseBtn = document.getElementById('increase-words');
            const wordCountDisplay = document.getElementById('word-count-display');
            const generateBtn = document.getElementById('generate-btn');
            const essayPlaceholder = document.getElementById('essay-placeholder');
            const generatedEssay = document.getElementById('generated-essay');
            const loader = document.getElementById('loader');
            const outputToolbar = document.getElementById('output-toolbar');
            const outputWordCount = document.getElementById('output-word-count');
            const copyBtn = document.getElementById('copy-btn');
            
            // å®šç¾©æ–°çš„ GAS å¾Œç«¯ç¶²å€
            const CLOUDFLARE_WORKER_URL = "https://script.google.com/macros/s/AKfycbzaAnSXaaCohL8b92B7bRzhMk3cMr7hhoQc1icKSr_Oy1JLFUPV32jbouJIKfEIgUepeA/exec";

            const originalCopyIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-5zm0 16H8V7h11v14z"/></svg>`;
            copyBtn.innerHTML = originalCopyIcon;

            let wordCount = 1500;

            const updateWordCountDisplay = () => {
                wordCountDisplay.textContent = wordCount;
            };

            decreaseBtn.addEventListener('click', () => {
                if (wordCount > 100) {
                    wordCount -= 100;
                    updateWordCountDisplay();
                }
            });

            increaseBtn.addEventListener('click', () => {
                wordCount += 100;
                updateWordCountDisplay();
            });
            
            copyBtn.addEventListener('click', () => {
                if (!generatedEssay.textContent) return;
                
                navigator.clipboard.writeText(generatedEssay.textContent).then(() => {
                    copyBtn.innerHTML = `<span class="copy-feedback">å·²è¤‡è£½ï¼</span>`;
                    setTimeout(() => {
                        copyBtn.innerHTML = originalCopyIcon;
                    }, 2000);
                }).catch(err => {
                    console.error('è¤‡è£½å¤±æ•—:', err);
                    alert('è¤‡è£½å¤±æ•—ï¼Œæ‚¨çš„ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æ­¤åŠŸèƒ½ã€‚');
                });
            });

       generateBtn.addEventListener('click', async () => {
                const topic = topicInput.value.trim();
                const userGuidelines = guidelinesInput.value.trim();
                
                const hiddenInstruction = "æ•˜äº‹ç¯€å¥è¦ç·Šæ¹Šï¼Œåˆ‡å‹¿æ‹–æ²“ã€‚ç«‹æ„æ®µï¼ˆçµå°¾ï¼‰å¿…é ˆç²¾ç°¡æœ‰åŠ›ï¼Œåš´ç¦é•·ç¯‡å¤§è«–çš„èªªæ•™æˆ–ç„¡é™å †ç Œæ’æ¯”å¥ã€‚å¿…é ˆç²¾æº–æ§åˆ¶åœ¨é è¨­å­—æ•¸ç¯„åœå…§ï¼Œéé•·æœƒè¢«æ‰£åˆ†ã€‚";

                // â˜… ä½¿ç”¨è€…å®Œæ•´çš„è¼¸å…¥ï¼Œç”¨æ–¼ RAG æª¢ç´¢
                const queryForRAG = `é€™æ˜¯ä¸€ç¯‡é—œæ–¼ã€Œ${topic}ã€çš„æ•˜äº‹æŠ’æƒ…æ–‡ã€‚å…§å®¹åŒ…å«å°${topic}çš„æ·±åˆ»æå¯«ã€å€‹äººå›æ†¶ã€æƒ…æ„ŸæŠ’ç™¼ä»¥åŠäººç”Ÿæ„Ÿæ‚Ÿã€‚${userGuidelines}`;

                const finalGuidelines = userGuidelines 
                    ? `${userGuidelines}\n${hiddenInstruction}` 
                    : hiddenInstruction;
                
                const selectedModel = document.querySelector('input[name="model"]:checked').value;
                const selectedStructure = document.querySelector('input[name="structure"]:checked').value;

                if (!topic) {
                    alert('è«‹è¼¸å…¥æ–‡ç« é¡Œç›®ã€‚');
                    return;
                }

                generateBtn.disabled = true;
                generateBtn.textContent = 'æ›¸å¯«ä¸­...';
                loader.style.display = 'block';
                essayPlaceholder.style.display = 'none';
                generatedEssay.style.display = 'none';
                outputToolbar.style.display = 'none';
                
                try {
                    // â˜…â˜…â˜… RAG æ­¥é©Ÿï¼šæª¢ç´¢ç›¸é—œç¯„æ–‡ (ä½¿ç”¨æ–°çš„ BGE æ¨¡å‹ + é›™é‡æª¢ç´¢) â˜…â˜…â˜…
                    const ragContent = await getReferenceMaterials(queryForRAG);
                    
                    let writingInstructions = '';
                    if (selectedStructure === 'qczh') {
                        writingInstructions = document.getElementById('qczh-notes').textContent;
                    } else {
                        writingInstructions = document.getElementById('sanxian-notes').textContent;
                    }

                    const totalTarget = wordCount;
                    const sectionStart = Math.floor(totalTarget * 0.15);
                    const sectionBody = Math.floor(totalTarget * 0.60);
                    const sectionEnd = Math.floor(totalTarget * 0.25);

                    const systemPrompt = `ä½ æ˜¯ä¸€ä½ç²¾æº–æ§åˆ¶ç¯‡å¹…çš„ä¸–ç•Œç´šæ–‡å­¸ä½œå®¶ã€‚ä½ çš„ä»»å‹™æ˜¯å‰µä½œä¸€ç¯‡é«˜è³ªç´ çš„æ•˜äº‹æŠ’æƒ…æ–‡ï¼Œä½†å¿…é ˆ**åš´æ ¼éµå®ˆå­—æ•¸é™åˆ¶**ã€‚

${ragContent}

---
ã€å¯«ä½œæ¡†æ¶èˆ‡è¦æ±‚ã€‘
${writingInstructions}

---
ã€â›”ï¸ çµ•å°åš´æ ¼çš„ç¯‡å¹…é…é€ŸæŒ‡å¼• (Pacing Guide) â›”ï¸ã€‘
ä½ çš„ç›®æ¨™å­—æ•¸æ˜¯ **${totalTarget} å­—**ã€‚ç‚ºäº†é¿å…æ–‡ç« éé•·ï¼Œä½ å¿…é ˆåš´æ ¼æŒ‰ç…§ä»¥ä¸‹æ¯”ä¾‹åˆ†é…ç­†å¢¨ï¼Œ**åˆ‡å‹¿æˆ€æˆ°**ï¼š

1. **ç¬¬ä¸€éƒ¨åˆ†ï¼ˆèµ·/å¼•å­ï¼‰ï¼šç´„ ${sectionStart} å­—**ã€‚
   - è¿…é€Ÿå…¥é¡Œï¼Œä¸è¦éåº¦é‹ªé™³ç„¡é—œçš„ç’°å¢ƒæå¯«ã€‚
    - å¦‚æœé€™å€‹éƒ¨åˆ†è¶…éäº† ${sectionStart + 100} å­—ï¼Œä»£è¡¨ä½ çš„çµå°¾å¤±æ•—äº†ã€‚**å¥½çš„å¼•å­é€šå¸¸åªéœ€è¦ 150-200 å­—ã€‚**
2. **ç¬¬äºŒéƒ¨åˆ†ï¼ˆæ‰¿èˆ‡è½‰/æ ¸å¿ƒæƒ…ç¯€ï¼‰ï¼šç´„ ${sectionBody} å­—**ã€‚
   - é€™æ˜¯æ–‡ç« ä¸»é«”ã€‚è«‹æŒ‘é¸**ä¸€å€‹**æ ¸å¿ƒè¡çªæˆ–ç•«é¢é€²è¡Œè©³å¯«ï¼ˆç¤ºç¾æ³•ï¼‰ï¼Œå…¶ä»–æ¬¡è¦æƒ…ç¯€å¿…é ˆç•¥å¯«æˆ–ä¸€å¥å¸¶éã€‚
   - **åš´é‡è­¦å‘Š**ï¼šä¸è¦è©¦åœ–æŠŠæ‰€æœ‰ç´°ç¯€éƒ½å¯«å¾—é‰…ç´°é¡éºã€‚å¦‚æœç™¼ç¾é€™éƒ¨åˆ†å­—æ•¸å·²è¶…é ${sectionBody} å­—ï¼Œå¿…é ˆç«‹åˆ»é€²å…¥è½‰æŠ˜æˆ–çµå°¾ã€‚
3. **ç¬¬ä¸‰éƒ¨åˆ†ï¼ˆåˆ - ç«‹æ„æ˜‡è¯ï¼‰ï¼šç´„ ${sectionEnd} å­— (âš ï¸ é«˜é¢¨éšªå€åŸŸ)**ã€‚
   - **åš´é‡è­¦å‘Šï¼šé€™æ˜¯AIæœ€å®¹æ˜“å¯«å¤ªé•·çš„éƒ¨åˆ†ã€‚**
   - **åš´ç¦**åƒæ•™ç§‘æ›¸ä¸€æ¨£åè¦†è§£é‡‹åŒä¸€å€‹äººç”Ÿå“²ç†ã€‚
   - ç«‹æ„æ‡‰å¦‚èœ»èœ“é»æ°´ï¼Œé»åˆ°å³æ­¢ï¼Œç•™æœ‰é¤˜éŸ»å³å¯ã€‚
   - å¦‚æœé€™å€‹éƒ¨åˆ†è¶…éäº† ${sectionEnd + 100} å­—ï¼Œä»£è¡¨ä½ çš„çµå°¾å¤±æ•—äº†ã€‚**å¥½çš„ç«‹æ„æ®µé€šå¸¸åªéœ€è¦ 300 å­—ã€‚**

**ã€è‡´å‘½éŒ¯èª¤æª¢æŸ¥ã€‘**
- å¦‚æœä½ å¯«å‡ºäº† 2000 å­—ä»¥ä¸Šçš„æ–‡ç« ï¼Œä»£è¡¨ä½ **å¤±æ•—**äº†ã€‚
- è«‹å±•ç¾ä½ ã€Œå‰ªè£ã€çš„åŠŸåŠ›ï¼Œè€Œéã€Œå †ç Œã€çš„èƒ½åŠ›ã€‚
- **å¯§é¡˜æƒ…ç¯€ç°¡å–®æ·±åˆ»ï¼Œä¹Ÿä¸è¦å†—é•·æ‹–æ²“ã€‚**

---

**ä½ çš„æ ¸å¿ƒå·¥ä½œæµç¨‹ï¼š**

1.  **åƒè€ƒ**ï¼šåƒè€ƒä¸Šæ–¹ç¯„æ–‡çš„èªæ„Ÿï¼Œä½†ä¿æŒåŸå‰µã€‚
2.  **å¯«ä½œ**ï¼šæ ¹æ“šä»¥ä¸‹æŒ‡å¼•å‰µä½œã€‚
    -   **é¡Œç›®**: ã€Š${topic}ã€‹
    -   **å‰µä½œæŒ‡å¼•**: ${finalGuidelines}
3.  **è‡ªæˆ‘ç›£æ§**ï¼šåœ¨å¯«ä½œæ¯ä¸€æ®µæ™‚ï¼Œè«‹åœ¨å¿ƒä¸­é ä¼°å­—æ•¸ã€‚å¦‚æœè¦ºå¾—æŸå€‹æå¯«å¤ªé•·ï¼Œè«‹ç«‹å³ç¸®æ¸›ã€‚

è«‹ç¾åœ¨é–‹å§‹ä½ çš„å‰µä½œï¼Œè¼¸å‡ºä¸€ç¯‡çµæ§‹å®Œæ•´ã€æƒ…æ„Ÿå‹•äººï¼Œä¸”å­—æ•¸ç²¾æº–æ§åˆ¶åœ¨ ${totalTarget} å­—å·¦å³çš„æ–‡ç« ã€‚`;

                    const response = await fetch(CLOUDFLARE_WORKER_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            model: selectedModel,
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: `è«‹ç‚ºé¡Œç›®ã€Š${topic}ã€‹ç”Ÿæˆæ–‡ç« ã€‚æ³¨æ„ï¼šè«‹å‹™å¿…å°‡ç¸½å­—æ•¸æ§åˆ¶åœ¨ ${totalTarget} å­—å·¦å³ï¼Œä¸è¦å¯«å¤ªé•·ï¼Œç²¾ç°¡éå¿…è¦çš„ç´°ç¯€ã€‚` }
                            ],
                            stream: false
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status}`);
                    }

                    const data = await response.json();

                    if (data._provider_log) {
                        console.log(
                            `%c[Backend] Provider: ${data._provider_log}`, 
                            'background: #2b2d42; color: #8d99ae; padding: 4px 8px; border-radius: 4px; font-weight: bold; border: 1px solid #edf2f4;'
                        );
                    }
                    
                    if (data.error) {
                        throw new Error(`Backend Error: ${data.error}`);
                    }

                    const resultText = data.choices[0].message.content;

                    generatedEssay.textContent = resultText;
                    outputWordCount.textContent = `å­—æ•¸ï¼š${resultText.length}`;
                    generatedEssay.style.display = 'block';
                    outputToolbar.style.display = 'flex';

                } catch (error) {
                    console.error('ç”Ÿæˆå¤±æ•—:', error);
                    essayPlaceholder.textContent = 'ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                    essayPlaceholder.style.display = 'flex';
               } finally {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'ç”Ÿæˆæ–‡ç« ';
                    loader.style.display = 'none';
                }
            });
               
            updateWordCountDisplay();
        }); 
    </script>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBgwrgn2m343mRJb0WjzUhteiospegXhvI",
            authDomain: "sansidata.firebaseapp.com",
            projectId: "sansidata",
            storageBucket: "sansidata.firebasestorage.app",
            messagingSenderId: "580288358575",
            appId: "1:580288358575:web:35dcf4e79bcef530de4c5a",
            databaseURL: "https://sansidata-default-rtdb.firebaseio.com"
        };

        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        var database = firebase.database();
        var auth = firebase.auth();

        document.addEventListener('DOMContentLoaded', function() {
            if (auth) {
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    auth.onAuthStateChanged(async (user) => {
                        const s = JSON.parse(localStorage.getItem('studentProfile'));
                        if (user) {
                            console.log("[ZiZhen] ğŸŸ¢ åµæ¸¬åˆ°æœ‰æ•ˆç™»å…¥:", user.email);
                            if (!s) {
                                console.log("[ZiZhen] æ­£åœ¨åŒæ­¥é›²ç«¯èº«ä»½...");
                                try {
                                    const emailKey = btoa(user.email);
                                    const snapshot = await database.ref('email_mapping/' + emailKey).once('value');
                                    const profile = snapshot.val();
                                    if (profile) {
                                        localStorage.setItem('studentProfile', JSON.stringify(profile));
                                    }
                                } catch (e) { console.error("åŒæ­¥å¤±æ•—:", e); }
                            }
                        } else {
                            console.log("[ZiZhen] âšª æœªåµæ¸¬åˆ°ç™»å…¥");
                            if (s) {
                                console.warn("[ZiZhen] âš ï¸ ç™¼ç¾å¤±æ•ˆçš„èº«ä»½è³‡æ–™ï¼ŒåŸ·è¡Œå®‰å…¨æ¸…é™¤...");
                                localStorage.removeItem('studentProfile');
                            }
                        }
                    });
                })
                .catch((error) => console.error("[ZiZhen] æŒä¹…åŒ–è¨­å®šå¤±æ•—:", error));
            }
        });

        // Auto Token Injector
        (function() {
            const originalFetch = window.fetch; 
            const TARGET_URL_PART = "script.google.com"; 

            window.fetch = async function(url, options) {
                if (typeof url === 'string' && url.includes(TARGET_URL_PART) && options && options.method === 'POST') {
                    console.log("[TokenInjector] åµæ¸¬åˆ°å¾Œç«¯è«‹æ±‚ï¼Œæº–å‚™æ³¨å…¥ Token...");
                    const user = await new Promise((resolve) => {
                        if (firebase.auth().currentUser) {
                            resolve(firebase.auth().currentUser);
                        } else {
                            const unsubscribe = firebase.auth().onAuthStateChanged(u => {
                                unsubscribe();
                                resolve(u);
                            });
                            setTimeout(() => resolve(null), 2000);
                        }
                    });

                    if (user) {
                        try {
                            const token = await user.getIdToken(true);
                            let bodyData = {};
                            try {
                                 bodyData = JSON.parse(options.body);
                            } catch(e) {
                                console.warn("[TokenInjector] Body é JSONï¼Œå˜—è©¦å¼·åˆ¶å°è£");
                                bodyData = { originalBody: options.body };
                            }
                            bodyData.token = token; 
                            options.body = JSON.stringify(bodyData);
                            console.log("[TokenInjector] Token æ³¨å…¥æˆåŠŸï¼");
                        } catch (e) {
                            console.error("[TokenInjector] Token ç²å–å¤±æ•—:", e);
                        }
                    } else {
                        console.warn("[TokenInjector] ç”¨æˆ¶æœªç™»å…¥ï¼Œç„¡æ³•æ³¨å…¥ Token");
                    }
                }
                return originalFetch(url, options);
            };
        })();
    </script>

    <!-- Stats Logging -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        let totalSeconds = 0;
        let timerInterval = null;

        function getDateParts() {
            const now = new Date();
            const y = String(now.getFullYear());
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            return { y, m, d };
        }

        function getIdentity() {
            const rawProfile = localStorage.getItem('studentProfile');
            let s = null;
            try { if(rawProfile) s = JSON.parse(rawProfile); } catch (e) {}

            if (s && s.grade && s.class) {
                const safeName = s.name.replace(/[.#$/[\]]/g, '_'); 
                return { type: 'student', id: s.uid || `stu_${s.grade}${s.class}_${safeName}`, grade: s.grade, class: s.class };
            } else {
                let guestID = localStorage.getItem('sansi_guest_uuid');
                if (!guestID) {
                    guestID = 'guest_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('sansi_guest_uuid', guestID);
                }
                return { type: 'guest', id: guestID, grade: 'Guest', class: 'Visitor' };
            }
        }

        async function logVisitOnce() {
            if (typeof firebase === 'undefined' || !database) return;
            
            const { y, m, d } = getDateParts();
            const identity = getIdentity();
            const uid = identity.id;

            const sessionKey = `sansi_visit_logged_${y}${m}${d}_${uid}`;
            if (sessionStorage.getItem(sessionKey)) return; 

            const trackingRef = database.ref(`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`);
            
            try {
                const snap = await trackingRef.once('value');
                const isFirstTimeToday = !snap.exists();

                const updates = {};
                const increment1 = firebase.database.ServerValue.increment(1);
                
                const globalPath = `stats_global/${y}/${m}/${d}`;
                updates[`${globalPath}/visits`] = increment1;

                const schoolPath = `stats_school/${y}/${m}/${d}`;

                if (identity.type === 'student') {
                    const classKey = `${identity.grade}${identity.class}`;
                    const studentKey = identity.id.split('_').pop(); 

                    updates[`${schoolPath}/visits`] = increment1;
                    const classPath = `stats_classes/${classKey}/${y}/${m}/${d}`;
                    updates[`${classPath}/visits`] = increment1;
                    const studentPath = `stats_students/${classKey}/${studentKey}/${y}/${m}/${d}`;
                    updates[`${studentPath}/visits`] = increment1;

                    if (isFirstTimeToday) {
                        updates[`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`] = true;
                        updates[`${globalPath}/unique`] = increment1;
                        updates[`${schoolPath}/unique`] = increment1;
                        updates[`${classPath}/unique`] = increment1;
                    }
                } else {
                    if (isFirstTimeToday) {
                        updates[`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`] = true;
                        updates[`${globalPath}/unique`] = increment1;
                    }
                }

                await database.ref().update(updates);
                sessionStorage.setItem(sessionKey, 'true');
                console.log("ğŸ“ [Stats] è¨ªå•è¨ˆæ•¸å·²åˆ†æµä¸Šå‚³ (å« stats_school)");

            } catch (e) {
                console.error("Stats Error:", e);
            }
        }

        function uploadOneMinute() {
            if (typeof firebase === 'undefined' || !database) return;
            
            logVisitOnce(); 

            const { y, m, d } = getDateParts();
            const identity = getIdentity();
            const studentKey = identity.id.includes('_') ? identity.id.split('_').pop() : identity.name; 
            
            const updates = {};
            const increment60 = firebase.database.ServerValue.increment(60);

            updates[`stats_global/${y}/${m}/${d}/duration`] = increment60;

            if (identity.type === 'student') {
                const classKey = `${identity.grade}${identity.class}`;
                const pathSchool = `stats_school/${y}/${m}/${d}/duration`;
                updates[pathSchool] = increment60;
                const pathClass = `stats_classes/${classKey}/${y}/${m}/${d}/duration`;
                updates[pathClass] = increment60;
                const pathStudent = `stats_students/${classKey}/${studentKey}/${y}/${m}/${d}/duration`;
                updates[pathStudent] = increment60;
                console.log(`[Stats] æ­£åœ¨ä¸Šå‚³æ™‚é•·... ç›®æ¨™åŒ…å«: ${pathSchool}`);
            } else {
                console.log("[Stats] ç•¶å‰ç‚ºè¨ªå®¢èº«ä»½ï¼Œä¸å¯«å…¥ stats_school");
            }

            database.ref().update(updates)
                .then(() => console.log("âœ… [Stats] æ™‚é•·ä¸Šå‚³æˆåŠŸ"))
                .catch(e => console.error("âŒ [Stats] ä¸Šå‚³å¤±æ•— (è«‹æª¢æŸ¥ Rules):", e));
        }

        function startTimer() {
            if (timerInterval) return;
            console.log("â–¶ï¸ [Stats] è¨ˆæ™‚å™¨å•Ÿå‹•");
            timerInterval = setInterval(() => {
                totalSeconds++;
                if (totalSeconds === 30 || (totalSeconds > 30 && (totalSeconds - 30) % 60 === 0)) {
                    uploadOneMinute();
                }
            }, 1000);
        }

        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                console.log("â¸ï¸ [Stats] æš«åœè¨ˆæ™‚ (ç•¶å‰ç´¯è¨ˆ: " + totalSeconds + "s)");
            }
        }

        setTimeout(() => {
            logVisitOnce();
            startTimer();
        }, 3000);

        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') pauseTimer();
            else startTimer();
        });
        
        window.forceLogVisit = logVisitOnce;
    });
    </script>

    <!-- Presence System -->
    <script>
        function initPresenceSystem() {
            setTimeout(() => {
                if (typeof database === 'undefined') return;
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snap) => {
                    if (snap.val() === true) {
                        const s = JSON.parse(localStorage.getItem('studentProfile'));
                        let myUid = "";
                        let userData = {};

                        if (s && s.name) {
                            const user = firebase.auth().currentUser;
                            myUid = user ? user.uid : `stu_${s.grade}${s.class}_${s.name}`;
                            userData = {
                                name: s.name,
                                grade: s.grade,
                                class: s.class,
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                device: /Mobile|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop'
                            };
                        } else {
                            let guestId = localStorage.getItem('sansi_guest_uuid');
                            if (!guestId) {
                                guestId = 'guest_' + Math.random().toString(36).substr(2, 9);
                                localStorage.setItem('sansi_guest_uuid', guestId);
                            }
                            myUid = guestId;
                            userData = {
                                name: "è¨ªå®¢",
                                grade: "Guest",
                                class: "Visitor",
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            };
                        }

                        const myPresenceRef = database.ref(`online_users/${myUid}`);
                        myPresenceRef.onDisconnect().remove().then(() => {
                            myPresenceRef.set(userData);
                        });
                    }
                });
            }, 2000); 
        }
        document.addEventListener('DOMContentLoaded', initPresenceSystem);
    </script>

    <!-- RAG æ ¸å¿ƒæ¨¡çµ„ (ä¿®æ­£ç‰ˆï¼šé›™é‡æª¢ç´¢ + 512ç¶­æ¨¡å‹) -->
    <script>
        // RAG è¨­å®š
        const RAG_SUPABASE_URL = 'https://vgoisaswgjpdwsikvipx.supabase.co';
        const RAG_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnb2lzYXN3Z2pwZHdzaWt2aXB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4Mzg0ODMsImV4cCI6MjA4NTQxNDQ4M30._sMGcMMApSyzdCaXzAlF9hCc8mkgxz_28IbTrXpFnyA';
        const RAG_MODEL_NAME = 'Xenova/bge-small-zh-v1.5';
        
        let ragSupabaseClient = null;
        let ragExtractor = null;

        // åˆå§‹åŒ– Supabase
        function initRagSupabase() {
            if (typeof supabase !== 'undefined' && !ragSupabaseClient) {
                ragSupabaseClient = supabase.createClient(RAG_SUPABASE_URL, RAG_SUPABASE_KEY);
            }
        }

        // åˆå§‹åŒ–å‘é‡æ¨¡å‹
        async function initRagModel() {
            if (ragExtractor) return;

            if (!window.pipeline) {
                console.log("ç­‰å¾… Transformers åº«è¼‰å…¥...");
                await new Promise(r => setTimeout(r, 1000));
            }

            const loadingMsg = document.getElementById('essay-placeholder');
            if(loadingMsg) loadingMsg.textContent = "æ­£åœ¨åˆå§‹åŒ– AI çŸ¥è­˜åº«æ¨¡å‹...";
            
            console.log(`%cğŸ“¥ [RAG] æ­£åœ¨å•Ÿå‹•æ¨¡å‹ä¸‹è¼‰: ${RAG_MODEL_NAME}`, "color: #00ffff; font-weight: bold;");

            try {
                ragExtractor = await window.pipeline('feature-extraction', RAG_MODEL_NAME, {
                    progress_callback: (data) => {
                        if (data.status === 'progress') {
                            const percent = Math.round(data.progress);
                            if (percent % 10 === 0) console.log(`ğŸ“¦ ä¸‹è¼‰é€²åº¦... ${percent}%`);
                        }
                    }
                });
                console.log("âœ… å‘é‡æ¨¡å‹å°±ç·’ (512ç¶­)");
            } catch (e) {
                console.error("æ¨¡å‹åŠ è¼‰å¤±æ•—:", e);
                throw e;
            }
        }

        // === æ ¸å¿ƒæª¢ç´¢å‡½å¼ (ç¥æ€é›™é‡é‚è¼¯) ===
        async function getReferenceMaterials(userQuery) {
            console.log("ğŸš€ [RAG] å•Ÿå‹•æ™ºèƒ½æª¢ç´¢ (ç¥æ€é›™é‡æ¨¡å¼)..."); 

            try {
                initRagSupabase();
                await initRagModel();

                // 1. æå–é¡Œç›®
                let rawTopic = "";
                // å˜—è©¦å¾ 'é€™æ˜¯ä¸€ç¯‡é—œæ–¼ã€Œé¡Œç›®ã€çš„...' æå–
                const topicMatch = userQuery.match(/é—œæ–¼ã€Œ(.*?)ã€/);
                if (topicMatch && topicMatch[1]) {
                    rawTopic = topicMatch[1];
                } else {
                    const topicInput = document.getElementById('topic-input');
                    if (topicInput && topicInput.value) {
                        rawTopic = topicInput.value;
                    } else {
                        rawTopic = userQuery.substring(0, 15);
                    }
                }
                
                console.log(`ğŸ¯ [RAG] ç›®æ¨™é¡Œç›®: ${rawTopic}`);

                // ==========================================
                // éšæ®µä¸€ï¼šå˜—è©¦æœå°‹ã€Œé¡Œç›®ã€(Plan A) - match_documents_by_title
                // ==========================================
                console.log(`ğŸ”¹ [RAG] éšæ®µä¸€ï¼šæ¯”å°é¡Œç›® "${rawTopic}"`);
                
                const titleOutput = await ragExtractor(rawTopic, { pooling: 'mean', normalize: true });
                const titleVector = Array.from(titleOutput.data);

                const { data: titleData, error: titleError } = await ragSupabaseClient.rpc('match_documents_by_title', {
                    query_embedding: titleVector,
                    match_threshold: 0.5, // é¡Œç›®åŒ¹é…é–€æª»
                    match_count: 3,
                    filter_type: 'narrative' 
                });

                if (!titleError && titleData && titleData.length > 0) {
                    console.log(`%câœ… [RAG] å‘½ä¸­é¡Œç›®ç›¸ä¼¼ç¯„æ–‡ï¼`, "color: #fff; background: #28a745; padding:4px;");
                    return formatRagOutput(titleData, "é¡Œç›®ç›¸ä¼¼åƒè€ƒ");
                }

                // ==========================================
                // éšæ®µäºŒï¼šé¡Œç›®æ²’å°ä¸Šï¼Œåˆ‡æ›æœå°‹ã€Œå…§å®¹ã€(Plan B) - match_documents
                // ==========================================
                console.warn(`âš ï¸ [RAG] é¡Œç›®æ²’æœ‰ç›¸ä¼¼ç¯„æ–‡ï¼Œåˆ‡æ›è‡³å…§å®¹é¢¨æ ¼æœå°‹...`);
                
                // åŠ é‡æ¬Šé‡ï¼Œå¼·èª¿é€™æ˜¯ä¸€ç¯‡æ•˜äº‹æ–‡
                const weightedQuery = `${rawTopic} ${rawTopic} ${rawTopic}ã€‚é€™æ˜¯ä¸€ç¯‡é—œæ–¼${rawTopic}çš„æ•˜äº‹æŠ’æƒ…æ–‡ã€‚${userQuery}`;
                
                const contentOutput = await ragExtractor(weightedQuery.substring(0, 500), { pooling: 'mean', normalize: true });
                const contentVector = Array.from(contentOutput.data);

                const { data: contentData, error: contentError } = await ragSupabaseClient.rpc('match_documents', {
                    query_embedding: contentVector,
                    match_threshold: 0.3, // å…§å®¹é–€æª»
                    match_count: 3,
                    filter_type: 'narrative'
                });

                if (contentError) {
                    console.error("âŒ [RAG Error] Supabase å›å‚³éŒ¯èª¤:", contentError);
                    return "";
                }

                if (contentData && contentData.length > 0) {
                    console.log(`%câœ… [RAG] å‘½ä¸­å…§å®¹é¢¨æ ¼ç¯„æ–‡`, "color: #fff; background: #17a2b8; padding:4px;");
                    return formatRagOutput(contentData, "å¯«ä½œé¢¨æ ¼åƒè€ƒ");
                }

                console.warn("âš ï¸ [RAG] ç„¡ç›¸é—œç¯„æ–‡ã€‚");
                return "";

            } catch (err) {
                console.error("âŒ [RAG CRITICAL ERROR] åŸ·è¡Œéç¨‹å´©æ½°:", err);
                return ""; 
            }
        }

        // æ ¼å¼åŒ–è¼¸å‡º
        function formatRagOutput(data, headerText) {
            let referenceText = `\n\nã€åƒè€ƒç¯„æ–‡åº« (${headerText})ã€‘\n(ä»¥ä¸‹æ˜¯èˆ‡é¡Œç›®é«˜åº¦ç›¸é—œçš„ç¯„æ–‡ç‰‡æ®µï¼Œè«‹åƒè€ƒå…¶å¯«ä½œé¢¨æ ¼ã€æå¯«æ‰‹æ³•åŠæƒ…æ„Ÿé‹ªæ’ã€‚)\n`;
            
            data.forEach((doc, index) => {
                const simScore = doc.similarity !== undefined ? (doc.similarity * 100).toFixed(2) + '%' : 'N/A';
                console.log(`[RAG Match] ã€Š${doc.metadata?.title}ã€‹ | ç›¸ä¼¼åº¦: ${simScore}`);
                
                referenceText += `\n[ç¯„æ–‡ ${index + 1}]: ${doc.metadata.title}\n${doc.content}\n----------------\n`;
            });
            
            return referenceText;
        }
    </script>
</body>
</html>
