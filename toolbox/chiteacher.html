
<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸­æ–‡è€å¸«çš„ä¸€ç”Ÿ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #F2F0EB;
            --panel-bg: rgba(255, 255, 255, 0.98);
            --text-main: #5E5A54;
            --text-sub: #9C9893;
            
            --accent-read: #7C9473;
            --accent-fun: #CF8E8E;
            --accent-plan: #7B9ACC;
            --accent-drill: #C59458;
            --accent-hea: #95a5a6; 
            
            --accent-admin: #8D857F;
            --accent-dse: #A65E5E;
            --accent-night: #2C3E50;
            --accent-holiday: #E67E22;
            --accent-happy: #E91E63;
            
            --color-high: #4E6C50;
            --color-avg: #667C89;
            --color-low: #A67B5B;
            
            --shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: 'Noto Serif TC', serif;
            color: var(--text-main);
            user-select: none;
            touch-action: none; 
        }

        #canvas-container {
            position: absolute;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 1;
        }

        #labels-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .student-label {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            transform: translate(-50%, -100%);
            white-space: nowrap;
            transition: opacity 0.3s;
            border: 1px solid rgba(0,0,0,0.05);
            opacity: 0.9;
            text-align: center;
            line-height: 1.3;
        }

        .speech-bubble {
            position: absolute;
            background: #fff;
            border: 2px solid var(--text-main);
            border-radius: 15px;
            padding: 8px 10px;
            font-size: 13px;
            font-weight: bold;
            color: #333;
            pointer-events: none;
            z-index: 15;
            white-space: normal;
            opacity: 0;
            transform: translate(-50%, -100%) scale(0.8);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-align: center;
            min-width: 80px;
            max-width: 160px;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px; left: 50%; margin-left: -8px;
            border-width: 8px 8px 0; border-style: solid;
            border-color: inherit; border-bottom-color: transparent; border-left-color: transparent; border-right-color: transparent;
        }

        .bubble-high { border-color: var(--color-high); color: var(--color-high); background: #f4fcf4; }
        .bubble-high::after { border-top-color: var(--color-high); }
        .bubble-complaint { border-color: var(--accent-dse); color: var(--accent-dse); background: #fff5f5; }
        .bubble-complaint::after { border-top-color: var(--accent-dse); }
        .bubble-reflect { border-color: var(--color-avg); color: var(--text-main); background: #f7f9fa; }
        .bubble-reflect::after { border-top-color: var(--color-avg); }
        .bubble-hea { border-color: var(--accent-hea); color: var(--text-sub); background: #fdfdfd; }
        .bubble-hea::after { border-top-color: var(--accent-hea); }

        /* é ‚éƒ¨å„€è¡¨æ¿ */
        #top-dashboard {
            position: absolute;
            top: 0; left: 0; width: 100%;
            height: auto; max-height: 50vh;
            background: var(--panel-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            box-shadow: var(--shadow);
            z-index: 20;
            display: none; 
            flex-wrap: wrap; justify-content: center;
            padding: 15px 20px; box-sizing: border-box; gap: 20px;
            overflow-y: auto;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .dash-section {
            display: flex; flex-direction: column; justify-content: flex-start;
            padding-right: 20px; border-right: 1px solid rgba(0,0,0,0.08);
            min-width: 130px;
        }
        .dash-section:last-child { border-right: none; padding-right: 0; }

        .section-title {
            font-size: 12px; color: var(--text-sub);
            text-transform: uppercase; letter-spacing: 1.5px;
            margin-bottom: 10px; font-weight: bold;
        }

        .stat-row { display: flex; gap: 20px; align-items: flex-end; }
        .stat-box { display: flex; flex-direction: column; min-width: 35px; }
        .stat-label { font-size: 11px; color: var(--text-sub); margin-bottom: 2px; }
        .stat-value { font-size: 16px; font-weight: bold; color: var(--text-main); height: 24px; display: flex; align-items: center; }
        
        .badge-workload {
            background: var(--accent-dse);
            color: #fff !important;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(166, 94, 94, 0.4);
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(166, 94, 94, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 6px rgba(166, 94, 94, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(166, 94, 94, 0); }
        }

        .editable { cursor: pointer; border-bottom: 1px solid transparent; }
        .editable:hover { border-bottom: 1px dashed var(--text-sub); }
        
        .inline-input {
            width: 40px; font-family: inherit; font-size: 16px; font-weight: bold;
            color: var(--text-main); border: none; border-bottom: 2px solid var(--accent-dse);
            background: transparent; outline: none; padding: 0; margin: 0;
        }

        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

        button {
            border: none; background: #fff; padding: 8px 12px; border-radius: 10px;
            font-family: inherit; color: var(--text-main); cursor: pointer;
            transition: all 0.2s; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);
            min-width: 90px; position: relative;
        }
        button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 5px 12px rgba(0,0,0,0.1); }
        button:active:not(:disabled) { transform: scale(0.96); }
        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .btn-icon { font-size: 18px; margin-bottom: 4px; }
        .btn-txt { font-size: 11px; font-weight: bold; }
        .btn-cost { font-size: 10px; opacity: 0.7; margin-top: 2px; }

        .btn-read { border-bottom: 3px solid var(--accent-read); }
        .btn-fun { border-bottom: 3px solid var(--accent-fun); }
        .btn-plan { border-bottom: 3px solid var(--accent-plan); }
        .btn-drill { border-bottom: 3px solid var(--accent-drill); }
        .btn-hea { border-bottom: 3px solid var(--accent-hea); background: #fdfdfd; color: #7f8c8d; }
        .btn-admin { border-bottom: 3px solid var(--accent-admin); background: #f9f9f9; }
        
        .btn-grade-work { border-bottom: 3px solid #555; background: #fff; min-width: 60px !important; }
        .btn-system { background: #eee; border: none; }
        .btn-offwork { background: var(--accent-night); color: #fff; border: none; animation: floatBtn 2s infinite ease-in-out; } 

        @keyframes floatBtn { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-3px);} }

        #btn-dse {
            background: var(--accent-dse); color: #fff;
            font-weight: bold; border: none; display: none; width: 100%;
            animation: pulse 2s infinite; margin-top: 8px; padding: 12px; border-radius: 8px;
        }
        @keyframes pulse { 0% { opacity:1; } 50% { opacity:0.85; } 100% { opacity:1; } }

        .admin-box { display: flex; flex-direction: column; gap: 5px; font-size: 11px; margin-bottom: 8px; }
        input[type=range] { width: 100%; accent-color: var(--accent-admin); cursor: pointer; }

        #status-text {
            font-size: 12px; font-weight: bold; color: var(--accent-plan);
            margin-top: 8px; white-space: normal; line-height: 1.4; max-width: 250px;
        }
        .warning-text { color: var(--accent-dse) !important; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        #need-indicator {
            background: #fff; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: bold;
            margin-bottom: 8px; display: flex; align-items: center; gap: 8px;
            border: 1px solid rgba(0,0,0,0.1); color: var(--text-main);
        }
        .need-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

        /* æµ®å‹•æ–‡å­— */
        .floating-bonus {
            position: absolute; font-size: 15px; font-weight: 800; pointer-events: none; z-index: 150; 
            animation: floatUp 1.0s ease-out forwards; white-space: nowrap;
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
            transform-origin: center;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.8); opacity: 0; }
            15% { transform: translateY(-15px) scale(1.1); opacity: 1; }
            100% { transform: translateY(-50px) scale(0.9); opacity: 0; }
        }

       /* === å°é¢è¨­è¨ˆå„ªåŒ– (Start Screen Polish) === */
#start-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    /* ä½¿ç”¨å¾®æ¼¸è®Šå¢åŠ è³ªæ„Ÿ */
    background: radial-gradient(circle at center, #F9F8F6 0%, #F2F0EB 100%);
    z-index: 100;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    overflow: hidden; /* é˜²æ­¢èƒŒæ™¯æ–‡å­—æº¢å‡º */
}

/* æ¨™é¡Œæ¨£å¼ï¼šå¢åŠ è¥¯ç·šæ„Ÿèˆ‡é–“è· */
#start-screen h1 {
    font-family: 'Noto Serif TC', serif;
    font-size: 48px;
    font-weight: 900;
    color: #3e3a36; /* æ·±ç°è¤è‰² */
    margin-bottom: 20px; /* å¢åŠ ä¸€é»ä¸‹æ–¹ç•™ç™½ */
    letter-spacing: 5px;
    z-index: 10;
    text-shadow: 0 2px 10px rgba(0,0,0,0.05);
    position: relative;
    text-align: center;
}

/* åŸæœ¬æ˜¯è‹±æ–‡ï¼Œç¾åœ¨æ”¹æˆä¸€æ¢æ¥µç°¡çš„è£é£¾çŸ­ç·š */
#start-screen h1::after {
    content: '';
    display: block;
    width: 60px;          /* çŸ­ç·šæ¢é•·åº¦ */
    height: 3px;          /* ç·šæ¢åšåº¦ */
    background: #D7D5D0;  /* ä½èª¿çš„æ·ºç°è‰² */
    margin: 20px auto 0;  /* ç½®ä¸­ä¸¦èˆ‡æ¨™é¡Œä¿æŒè·é›¢ */
    border-radius: 2px;   /* åœ“è§’ */
}

#floating-chars-container {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; /* é—œéµï¼šè®“æ»‘é¼ ç©¿é€æ–‡å­—å±¤ï¼Œé»æ“Šä¸‹æ–¹çš„æŒ‰éˆ• */
    z-index: 1;
    overflow: hidden;
}

.float-char {
    position: absolute;
    font-family: 'Noto Serif TC', serif;
    /* é€™è£¡ä¸éœ€è¦å†è¨­ color/opacityï¼Œå› ç‚º JS æœƒè¦†è“‹ï¼Œä½†ä¿ç•™ font-family å¾ˆé‡è¦ */
    transition: transform 0.1s ease-out; /* è®“è·Ÿéš¨ç¨å¾®å¹³æ»‘ä¸€é» */
    pointer-events: none;
}

/* æŒ‰éˆ•å®¹å™¨ */
.menu-btn-group {
    display: flex;
    gap: 20px;
    z-index: 10;
    margin-top: 40px;
}

/* å„ªåŒ–å¾Œçš„æŒ‰éˆ• */
.mode-btn {
    position: relative;
    background: #fff;
    border: none;
    padding: 25px 30px;
    border-radius: 4px; /* æ”¹ç‚ºç¨å¾®éŠ³åˆ©çš„åœ“è§’ï¼Œåƒç´™å¼µ */
    width: 240px;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 10px 20px rgba(0,0,0,0.02);
    text-align: center;
    overflow: hidden;
}

/* æŒ‰éˆ•è£é£¾ç·šæ¢ (åƒè©¦å·é‚Šæ¡†) */
.mode-btn::before {
    content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
    transition: all 0.3s;
}
.mode-partial::before { background: var(--accent-plan); }
.mode-full::before { background: var(--accent-dse); }

.mode-btn:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.08);
}

.btn-title {
    display: block;
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 8px;
    color: #5E5A54;
}

.mode-desc {
    font-size: 12px;
    color: #999;
    line-height: 1.5;
    display: block;
}

/* éš±è—åŸç”Ÿæ¨£å¼ */
.hidden { display: none !important; }

/* æ‰‹æ©Ÿç‰ˆèª¿æ•´ */
@media (max-width: 600px) {
    .menu-btn-group { flex-direction: column; gap: 15px; }
    #start-screen h1 { font-size: 32px; }
    .mode-btn { width: 80vw; padding: 20px; }
}

        /* æ‰‹æ©Ÿé©é… */
     /* æ‰‹æ©Ÿé©é… - ä¿®æ”¹å¾Œ (å„€è¡¨æ¿ä½” 40%) */
        @media (max-width: 800px) {
            #top-dashboard {
                position: absolute; top: 0; left: 0; width: 100%;
                
                /* ä¿®æ”¹ï¼šé«˜åº¦é™åˆ¶ç”± 50vh æ”¹ç‚º 40vh */
                max-height: 40vh; 
                
                display: flex; flex-direction: column; flex-wrap: nowrap; justify-content: flex-start;
                overflow-y: auto; overflow-x: hidden; 
                
                /* ä¿®æ”¹ï¼šæ¸›å°‘ padding èˆ‡ gap è®“ä»‹é¢æ›´ç·Šæ¹Šï¼Œé©æ‡‰è¼ƒå°çš„é«˜åº¦ */
                padding: 10px 12px 20px 12px; 
                gap: 10px; 
                
                box-sizing: border-box; z-index: 20; -webkit-overflow-scrolling: touch;
            }

            .dash-section { 
                flex: 0 0 auto; width: 100%; 
                border-bottom: 1px dashed #ccc; 
                
                /* ä¿®æ”¹ï¼šæ¸›å°‘å€å¡Šé–“è· */
                padding-bottom: 10px; 
                
                margin: 0; border-right: none; 
            }
            
            .dash-section:last-child { border-bottom: none; padding-bottom: 0; }
            .dash-section.action-section { width: 100%; display: block; padding: 0; padding-bottom: 10px;}
            
            .action-section .btn-group {
                display: flex; flex-direction: row; flex-wrap: nowrap !important; overflow-x: auto !important;
                width: 100%; gap: 6px; padding: 2px 2px 5px 2px; align-items: stretch;
                -webkit-overflow-scrolling: touch; scrollbar-width: none;
            }
            .action-section .btn-group::-webkit-scrollbar { display: none; }
            
            /* æŒ‰éˆ•æ¨£å¼å¾®èª¿ */
            .action-section button, #btn-read, #btn-fun, #btn-plan, #btn-drill, #btn-hea {
                flex: 0 0 28vw !important; width: 28vw !important; max-width: 120px !important; min-width: 0 !important;
                margin: 0 !important; padding: 8px 2px !important; height: auto !important;
                transform: none !important; animation: none !important; box-shadow: none !important;
                border: 1px solid #ccc !important; border-bottom: 3px solid #999 !important;
            }
            
            #btn-read {
                background-color: #effcf1 !important; border-color: var(--accent-read) !important; color: var(--color-high) !important;
            }
            
            .btn-icon { font-size: 20px !important; margin-bottom: 2px; }
            .btn-txt { font-size: 12px !important; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            .btn-cost { font-size: 10px !important; transform: scale(0.9); white-space: nowrap; opacity: 0.8; margin-top: 1px; }
            
            #btn-dse { width: 100% !important; }
            #sel-student-count { width: 100%; padding: 8px; }
        }

        /* æ¨¡æ…‹æ¡†èˆ‡è¦†è“‹å±¤ */
        #modal-overlay, #offwork-overlay, #summary-overlay, #report-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 50;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }
        #modal-box, #offwork-box, #summary-box {
            background: #fff; width: 90%; max-width: 500px;
            padding: 30px; border-radius: 20px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.5);
            text-align: center; border: 2px solid var(--text-main);
            position: relative; max-height: 90vh; overflow-y: auto;
        }

        /* çµç®—å ±å‘Šé¢æ¿ */
        #report-box {
            background: rgba(255, 255, 255, 0.95); width: 85%; max-width: 400px;
            padding: 20px; border-radius: 15px; border: 2px solid var(--accent-plan);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: left;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity:0; transform:scale(0.9); } to { opacity:1; transform:scale(1); } }
        .report-header { font-size: 16px; font-weight: bold; margin-bottom: 10px; color: var(--accent-plan); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .report-row { display: flex; justify-content: space-between; font-size: 13px; margin: 5px 0; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        .report-table th, .report-table td { border: 1px solid #eee; padding: 4px; text-align: center; }
        .report-table th { background: #f9f9f9; color: #666; }
        .val-pos { color: green; font-weight: bold; }
        .val-neg { color: #c0392b; font-weight: bold; }
        .val-neu { color: #999; }

        /* DSE æˆç¸¾è¡¨æ¨£å¼ */
        .dse-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        .dse-table th { background: #eee; padding: 8px; border-bottom: 2px solid #ccc; text-align: left; }
        .dse-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; cursor: pointer; transition: background 0.2s; }
        .dse-table td:hover { background: #f0f0f0; }
        .dse-rank { font-weight: bold; color: var(--accent-dse); width: 30px; }
        .dse-grade { font-weight: bold; padding: 2px 5px; border-radius: 4px; }
        
        #offwork-box { background: #F4F6F7; border-color: var(--accent-night); color: #2C3E50; }
        .offwork-header { font-size: 24px; font-weight: bold; margin-bottom: 10px; color: var(--accent-night); display: flex; justify-content: center; align-items: center; gap: 10px; }
        .holiday-header { color: var(--accent-holiday) !important; }
        .offwork-stats { display: flex; justify-content: space-around; background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .ow-stat-val { font-size: 20px; font-weight: bold; }
        .ow-stat-label { font-size: 12px; color: #7f8c8d; }
        .ow-section-title { text-align: left; font-size: 14px; font-weight: bold; margin: 15px 0 8px 0; color: #7f8c8d; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .ow-btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .ow-btn { background: #fff; padding: 15px 5px; border-radius: 10px; border: 1px solid #ddd; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; }
        .ow-btn:hover:not(:disabled) { transform: translateY(-3px); border-color: var(--accent-night); }
        .ow-btn:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
        .ow-icon { font-size: 24px; margin-bottom: 5px; }
        .ow-label { font-size: 12px; font-weight: bold; }
        .homework-panel { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #ddd; margin-top: 10px; }
        .slider-container { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .work-cost-display { font-size: 12px; color: var(--accent-dse); font-weight: bold; margin-top: 5px; }
        .sleep-btn { width: 100%; background: var(--accent-night); color: #fff; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 25px; border: none; cursor: pointer; }
        .sleep-btn:hover:not(:disabled) { background: #1a252f; }
        .sleep-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #95a5a6; }
        .tag-late { background: var(--accent-fun); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; display: none; }
        .summary-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ddd; }
        .summary-val { font-weight: bold; }

        /* ç‰¹æ®ŠæŒ‰éˆ•æ¨£å¼ */
        #btn-read {
            background-color: #effcf1; border: 2px solid var(--accent-read); border-bottom: 5px solid var(--accent-read);
            min-width: 105px; transform: scale(1.05); z-index: 5; box-shadow: 0 5px 15px rgba(78, 108, 80, 0.2);
            animation: pulse-green 2s infinite; margin-right: 5px;
        }
        #btn-read:hover:not(:disabled) { background-color: #dcedc8; transform: scale(1.08) translateY(-3px); box-shadow: 0 8px 20px rgba(78, 108, 80, 0.3); }
        #btn-read .btn-icon { font-size: 24px; margin-bottom: 2px; }
        #btn-read .btn-txt { color: var(--color-high); font-size: 13px; font-weight: 900; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(124, 148, 115, 0.6); }
            70% { box-shadow: 0 0 0 8px rgba(124, 148, 115, 0); }
            100% { box-shadow: 0 0 0 0 rgba(124, 148, 115, 0); }
        }
        .action-section .btn-group { display: flex; flex-wrap: nowrap !important; gap: 5px; width: 100%; overflow-x: auto; }
        .action-section button { flex: 1 1 auto; min-width: 0; padding: 8px 4px; margin: 0; transform: none !important; height: auto; }


/* æ„Ÿè¨€å°ˆç”¨è¦–çª—æ¨£å¼ */
        #sentiment-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 200; /* æ¯”ä¸€èˆ¬ Modal æ›´é«˜å±¤ */
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }
        #sentiment-box {
            background: #fff; width: 85%; max-width: 450px;
            border-radius: 15px; overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transform: scale(0.95); animation: popIn 0.3s forwards;
        }
        @keyframes popIn { to { transform: scale(1); } }
        
        .sent-header {
            padding: 20px; color: #fff; text-align: center;
            position: relative;
        }
        .sent-avatar {
            font-size: 50px; display: block; margin-bottom: 5px;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
        }
        .sent-name { font-size: 18px; font-weight: bold; }
        .sent-type { font-size: 12px; opacity: 0.9; background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 10px; }
        
        .sent-body { padding: 25px; text-align: center; }
        .sent-category { 
            font-size: 12px; font-weight: bold; text-transform: uppercase; 
            letter-spacing: 2px; color: #999; margin-bottom: 15px; display: block;
        }
        .sent-text {
            font-family: 'Noto Serif TC', serif; font-size: 18px; line-height: 1.6;
            color: #333; font-style: italic; position: relative;
        }
        .sent-text::before { content: 'â€œ'; font-size: 60px; color: #eee; position: absolute; top: -20px; left: -10px; z-index: -1; }
        .sent-text::after { content: 'â€'; font-size: 60px; color: #eee; position: absolute; bottom: -40px; right: 0; z-index: -1; }
        
        .sent-footer {
            padding: 15px; border-top: 1px solid #eee; text-align: center; background: #f9f9f9;
        }
        .sent-close-btn {
            background: #333; color: #fff; border: none; padding: 10px 30px;
            border-radius: 20px; font-weight: bold; cursor: pointer;
            transition: transform 0.2s;
        }
        .sent-close-btn:hover { transform: scale(1.05); }

        /* çµç®—å ±å‘Šå„ªåŒ–ï¼šé¡¯ç¤ºç¸½é‡çš„å°å­—æ¨£å¼ */
        .rpt-total { font-size: 11px; color: #777; margin-left: 5px; font-weight: normal; }


/* =========================================
   SVG åœ–ç¤ºå°ˆç”¨æ¨£å¼ (è«‹åŠ å…¥åˆ° CSS æœ€å¾Œé¢)
   ========================================= */
.btn-icon {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 28px;
    width: 100%;
    margin-bottom: 2px;
}

.btn-icon svg {
    width: 24px;
    height: 24px;
    fill: currentColor; /* è®“åœ–ç¤ºé¡è‰²è·Ÿéš¨æ–‡å­—æˆ–è¨­å®š */
    transition: all 0.2s;
}

/* é‡å°ç‰¹å®šæŒ‰éˆ•å¾®èª¿ SVG é¡è‰² */
.btn-read .btn-icon svg { fill: var(--color-high); }
.btn-fun .btn-icon svg { fill: var(--accent-fun); }
.btn-plan .btn-icon svg { fill: var(--accent-plan); }
.btn-drill .btn-icon svg { fill: var(--accent-drill); }
.btn-hea .btn-icon svg { fill: var(--accent-hea); }
.btn-admin .btn-icon svg { fill: var(--accent-admin); }

/* DSE ç«ç„°ç‰¹æ•ˆ */
.dse-fire svg {
    fill: #fff;
    width: 20px;
    height: 20px;
    filter: drop-shadow(0 0 4px rgba(255, 200, 0, 0.8));
    animation: flicker 0.1s infinite alternate;
}
@keyframes flicker { from { opacity: 0.8; } to { opacity: 1; } }

/* ä¸‹ç­ä»‹é¢åœ–ç¤º */
.ow-icon svg {
    width: 32px;
    height: 32px;
    fill: #555;
}
.ow-btn:hover .ow-icon svg {
    fill: var(--accent-night);
    transform: scale(1.1);
}

/* Modal æ¨™é¡Œå¤§åœ–ç¤º */
#modal-icon svg, #ow-icon svg {
    width: 50px;
    height: 50px;
}
#modal-icon svg { margin-bottom: 10px; }

/* éœ€æ±‚æŒ‡ç¤ºå™¨å°åœ–ç¤º */
#need-indicator svg {
    width: 16px;
    height: 16px;
    margin-right: 5px;
    vertical-align: middle;
}


/* æ–°å¢ï¼šå­¸å¹´å…¨å±é€šçŸ¥ */
#year-notification {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.95);
    z-index: 200; /* æœ€é«˜å±¤ç´š */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    pointer-events: none; /* é è¨­ä¸æ“‹æ»‘é¼ ï¼Œé¡¯ç¤ºæ™‚é–‹å•Ÿ */
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
}

.year-title {
    font-size: 80px;
    font-weight: 900;
    color: var(--accent-plan);
    margin-bottom: 20px;
    transform: translateY(20px);
    opacity: 0;
    transition: all 0.5s ease-out;
}

.year-sub {
    font-size: 24px;
    color: var(--text-sub);
    letter-spacing: 5px;
    transform: translateY(20px);
    opacity: 0;
    transition: all 0.5s ease-out 0.2s; /* å»¶é²å‡ºç¾ */
}

/* ç”¨æ–¼é¡¯ç¤ºæ™‚çš„ class */
#year-notification.active {
    opacity: 1;
    pointer-events: auto;
}
#year-notification.active .year-title,
#year-notification.active .year-sub {
    transform: translateY(0);
    opacity: 1;
}

/* =========================================
   é å°¾ç‰ˆæ¬Šå®£å‘Š (Footer)
   ========================================= */
.copyright-footer {
    position: fixed;
    bottom: 0;
    right: 0;
    padding: 5px 10px;
    background-color: #f1f1f1;
    z-index: 15; /* ç¢ºä¿é¡¯ç¤ºåœ¨ Canvas(1) èˆ‡ Labels(10) ä¹‹ä¸Šï¼Œä½†åœ¨ Dashboard(20) ä¹‹ä¸‹ */
    border-top-left-radius: 8px; /* ç¨å¾®å°åœ“è§’æ¯”è¼ƒå¥½çœ‹ (å¯é¸) */
    opacity: 0.8; /* ç¨å¾®é€æ˜ï¼Œæ¸›å°‘å°éŠæˆ²ç•«é¢çš„å¹²æ“¾ (å¯é¸) */
}

.copyright-footer p {
    margin: 0;
    font-size: 14px;
    color: #555; /* é…åˆç¾æœ‰è‰²èª¿ */
}

@media (max-width: 600px) {
    .copyright-footer p {
        font-size: 12px;
    }
}

        /* å€ç‡æé†’æ¨™ç±¤ */
#multiplier-badge {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: bold;
    margin-left: 10px;
    background: #f0f0f0;
    color: #999;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 1px solid #ddd;
    vertical-align: middle;
}
 
/* å•Ÿå‹•å€ç‡æ™‚çš„é‡‘è‰²ç‰¹æ•ˆ */
#multiplier-badge.multiplier-active {
    background: #FFD700; /* é‡‘è‰² */
    color: #5C4033;
    border-color: #DAA520;
    box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
    transform: scale(1.1);
    animation: pulse-gold 1.5s infinite alternate;
}
 
@keyframes pulse-gold {
    from { box-shadow: 0 0 8px rgba(255, 215, 0, 0.5); }
    to { box-shadow: 0 0 18px rgba(255, 215, 0, 0.9); }
}
 
/* å­¸ç”Ÿæ¨™ç±¤ä¸Šçš„ x2 æç¤ºæ–‡å­— */
.x2-indicator {
    color: #e67e22;
    font-size: 13px;
    font-weight: 900;
    margin-left: 4px;
    text-shadow: 1px 1px 0px #fff;
    animation: bounce 0.5s infinite alternate;
    display: inline-block;
}
 
@keyframes bounce {
    from { transform: translateY(0); }
    to { transform: translateY(-2px); }
}


        /* çµç®—å ±å‘Šä¸­çš„å€ç‡å‹³ç«  */
#rpt-multiplier-tag {
    display: none; /* é è¨­éš±è— */
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #5C4033;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 900;
    margin-bottom: 10px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
    border: 2px solid #fff;
    animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
 
@keyframes pop-in {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
 
/* å ±å‘Šè¡¨æ ¼å…§çš„ x2 å­—æ¨£ */
.rpt-x2 {
    background: #e67e22;
    color: #fff;
    font-size: 10px;
    padding: 1px 4px;
    border-radius: 4px;
    margin-left: 4px;
    vertical-align: middle;
}

        /* ç¡è¦ºé®ç½©æ¨£å¼ */
#sleep-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000; z-index: 300; display: none;
    justify-content: center; align-items: center; flex-direction: column;
    color: #fff;
}
.zzz-anim {
    font-size: 60px; font-weight: bold;
    animation: floatZ 2s infinite ease-in-out;
}
.sleep-desc {
    margin-top: 20px; font-size: 16px; color: #888;
    font-family: 'Noto Serif TC', serif; letter-spacing: 2px;
}
@keyframes floatZ {
    0%, 100% { transform: scale(1) translateY(0); opacity: 0.5; }
    50% { transform: scale(1.2) translateY(-10px); opacity: 1; }
}

        /* 2D äº’å‹•æ–‡å­—èˆ‡æ¨™ç±¤æ¨£å¼ */
.interaction-label {
    position: absolute;
    font-family: 'Noto Serif TC', serif;
    font-weight: bold;
    color: #fff;
    font-size: 18px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    pointer-events: none; /* è®“æ»‘é¼ ç©¿é€ */
    transform: translate(-50%, -50%);
    z-index: 100;
    transition: opacity 0.5s;
    background: rgba(0,0,0,0.1); /* æ¥µæ·¡çš„èƒŒæ™¯å¢åŠ å°æ¯” */
    padding: 5px 15px;
    border-radius: 20px;
    backdrop-filter: blur(2px);
}

.floating-text-2d {
    position: absolute;
    font-family: 'Noto Serif TC', serif;
    font-weight: bold;
    font-size: 16px;
    pointer-events: none;
    transform: translate(-50%, -50%);
    z-index: 101;
    animation: floatUpFade 1.5s forwards ease-out;
    text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff; /* æé‚Šæ•ˆæœ */
}

@keyframes floatUpFade {
    0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
    20% { transform: translate(-50%, -80%) scale(1.1); opacity: 1; }
    100% { transform: translate(-50%, -150%) scale(1.0); opacity: 0; }
}

        /* ç¦ç”¨å¨›æ¨‚æŒ‰éˆ•çš„è¦–è¦ºæ¨£å¼ */
/* ç¦ç”¨å¨›æ¨‚æŒ‰éˆ•çš„å¼·åˆ¶è¦–è¦ºæ¨£å¼ */
.disabled-ow-btn {
    background: #f0f0f0 !important;
    border-color: #dcdcdc !important;
    color: #a0a0a0 !important;
    pointer-events: none !important; /* å¾¹åº•ç¦ç”¨æ»‘é¼ é»æ“Š */
    filter: grayscale(1) !important;
    box-shadow: none !important;
    transform: none !important;
}
.disabled-ow-btn .ow-icon svg {
    fill: #a0a0a0 !important;
}


        /* å°ˆå±¬ 2D è“‹ç« ç‰¹æ•ˆ (ä¸å‘ä¸Šé£„ï¼ŒåŸåœ°æ”¾å¤§å£“ä¸‹ä¸¦æ·¡å‡º) */
.fixed-stamp-2d {
    position: absolute;
    font-family: 'Noto Serif TC', serif;
    font-weight: 900;
    font-size: 100px; /* è¶…å¤§å­—é«”ï¼Œéå¸¸é¡¯çœ¼ */
    pointer-events: none;
    transform: translate(-50%, -50%);
    z-index: 101;
    opacity: 0;
    animation: stampDown 1s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
    text-shadow: 0px 0px 10px rgba(192, 57, 43, 0.5); /* ç´…è‰²å…‰æšˆ */
}

@keyframes stampDown {
    0% { transform: translate(-50%, -50%) scale(3) rotate(-15deg); opacity: 0; }
    15% { transform: translate(-50%, -50%) scale(1) rotate(-5deg); opacity: 0.9; }
    80% { transform: translate(-50%, -50%) scale(1) rotate(-5deg); opacity: 0.9; }
    100% { transform: translate(-50%, -50%) scale(1) rotate(-5deg); opacity: 0; }
}


        /* å„ªåŒ–äº’å‹•æç¤ºï¼šæ¯›ç»ç’ƒè† å›Šè¨­è¨ˆ */
        .interaction-label {
            position: absolute;
            font-family: 'Noto Serif TC', serif;
            font-size: 14px;
            letter-spacing: 2px;
            color: #5E5A54; /* é è¨­è«è˜­è¿ªæ·±æ£•ç°è‰² */
            background: rgba(255, 255, 255, 0.85);
            padding: 10px 25px;
            border-radius: 30px; /* è† å›Šå½¢ç‹€ */
            box-shadow: 0 8px 25px rgba(0,0,0,0.08), 0 2px 5px rgba(0,0,0,0.03);
            border: 1px solid rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 100;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            text-align: center;
            white-space: nowrap;
            text-shadow: none !important; /* å¾¹åº•æ‹”é™¤èˆŠç‰ˆçš„é»‘é‚Šé™°å½± */
            font-weight: normal;
        }

        /* è™•ç†å¤±æ•—æ™‚çš„å°ˆå±¬å„ªé›…ç´…åº•æ¨£å¼ */
        .interaction-label.label-error {
            color: #A65E5E !important;
            background: rgba(255, 245, 245, 0.95) !important;
            border-color: rgba(166, 94, 94, 0.3) !important;
            transform: translate(-50%, -50%) scale(1.1);
            font-weight: bold;
        }

        /* é£„æµ®å›é¥‹æ–‡å­—å„ªåŒ–ï¼Œç§»é™¤ç”Ÿç¡¬çš„é»‘é‚Š/ç™½é‚Šï¼Œæ”¹ç”¨æŸ”å’Œå…‰æšˆ */
        .floating-text-2d {
            position: absolute;
            font-family: 'Noto Serif TC', serif;
            font-weight: bold;
            font-size: 16px;
            letter-spacing: 2px;
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 101;
            animation: floatUpFadeElegant 1.5s forwards cubic-bezier(0.165, 0.84, 0.44, 1);
            text-shadow: 0 2px 10px rgba(255,255,255,0.9), 0 0 5px rgba(255,255,255,0.5) !important; 
        }

        @keyframes floatUpFadeElegant {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            15% { transform: translate(-50%, -60%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -120%) scale(0.9); opacity: 0; }
        }


    </style>
</head>
<body>

   <!-- æ¨¡å¼é¸æ“‡ç•«é¢ -->
<div id="start-screen">
    <!-- èƒŒæ™¯ç‰¹æ•ˆå±¤ -->
    <div id="floating-chars-container"></div>

    <h1>ä¸­æ–‡è€å¸«çš„ä¸€ç”Ÿ</h1>
    
    <div class="menu-btn-group">
        <button class="mode-btn mode-partial" onclick="startGame('partial')">
            <span class="btn-title">æ•™å­¸ç¯‡â€”â€”å‚³é“</span>
            <span class="mode-desc">èšç„¦æ•™å­¸ç­–ç•¥<br>æ¢ç´¢é–±è®€èˆ‡å­¸ç¿’æ•ˆç›Šçš„é—œä¿‚</span>
        </button>
        <button class="mode-btn mode-full" onclick="startGame('full')">
            <span class="btn-title">ç”Ÿå­˜ç¯‡â€”â€”æµ®æ²‰</span>
            <span class="mode-desc">ç®¡ç†èº«å¿ƒç‹€æ…‹<br>è¨­èº«è™•ç†æ„Ÿå—è€å¸«çš„è¾›å‹</span>
        </button>
    </div>
</div>

    <div id="canvas-container"></div>
    <div id="labels-container"></div>

    <div id="top-dashboard">
        <div class="dash-section">
            <div class="section-title">æ•™å¸«ç‹€æ…‹</div>
            <div class="stat-row">
                <div class="stat-box">
                    <span class="stat-label">å¹´é½¡</span>
                    <span class="stat-value editable" id="disp-age">22</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">å¿ƒåŠ›</span><span class="stat-value" id="disp-energy" style="color:var(--accent-plan)">10.0</span>
                </div>
                <div class="stat-box mode-partial-el">
                    <span class="stat-label">æ¢å¾©</span><span class="stat-value" id="disp-recover">3/3</span>
                </div>
                <div class="stat-box mode-full-el">
                    <span class="stat-label">å¹¸ç¦</span><span class="stat-value" id="disp-happy" style="color:var(--accent-happy)">60</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">å¹´ç´š</span><span class="stat-value" id="disp-grade">ä¸­ä¸€</span>
                </div>
                <div class="stat-box mode-full-el">
                    <span class="stat-label">é€²åº¦</span><span class="stat-value" id="disp-days">1/3</span>
                </div>
                <div class="stat-box mode-full-el">
                    <span class="stat-label">å¾…æ‰¹æ”¹</span><span class="stat-value" id="disp-workload">0</span>
                </div>
            </div>
            <div id="status-text">æº–å‚™æ•™å­¸...</div>
        </div>

        <div class="dash-section" style="flex:0 0 auto;">
            <div class="section-title">å­¸ç”Ÿäººæ•¸</div>
            <select id="sel-student-count" style="padding:6px; border-radius:6px; font-size:13px;">
                <option value="1">1 äºº</option>
                <option value="2">2 äºº</option>
                <option value="3">3 äºº</option>
                <option value="4">4 äºº</option>
                <option value="5" selected>5 äºº</option>
                <option value="6">6 äºº</option>
                <option value="7">7 äºº</option>
                <option value="8">8 äºº</option>
                <option value="9">9 äºº</option>
                <option value="10">10 äºº</option>
            </select>
        </div>

       <div class="dash-section action-section" style="flex: 2;">
    <div class="section-title">æ•™å­¸æ´»å‹•</div>
    
 <div id="need-indicator">
        <span>å­¸ç”Ÿéœ€æ±‚:</span>
        <span id="need-dot" class="need-dot" style="background:var(--accent-read);"></span>
        <span id="need-text" style="color:var(--accent-read); display:flex; align-items:center;"></span>
        <!-- ç§»é™¤äº†åŸæœ¬åœ¨æ­¤çš„ multiplier-badge -->
    </div>
           
   <div class="btn-group">
        <button id="btn-read" class="btn-read">
            <span class="btn-icon"></span>
            <span class="btn-txt">å¢åŠ é–±è®€é‡</span>
            <span class="btn-cost" id="cost-read">-1 E / -1 Hap</span>
        </button>
        <button id="btn-fun" class="btn-fun">
            <span class="btn-icon"></span>
            <span class="btn-txt">è¶£å‘³æ•™å­¸</span>
            <span class="btn-cost" id="cost-fun">-3 E / -2 Hap</span>
        </button>
        <button id="btn-plan" class="btn-plan">
            <span class="btn-icon"></span>
            <span class="btn-txt">èªçœŸæˆèª²</span>
            <span class="btn-cost" id="cost-plan">-3 E / -2 Hap</span>
        </button>
        <button id="btn-drill" class="btn-drill">
            <span class="btn-icon"></span>
            <span class="btn-txt">è©¦é¡Œæ“ç·´</span>
            <span class="btn-cost" id="cost-drill">-3 E / -2 Hap</span>
        </button>
        <button id="btn-hea" class="btn-hea mode-full-el">
            <span class="btn-icon"></span>
            <span class="btn-txt">è›‡ç‹ (Hea)</span>
            <span class="btn-cost">-0.5 E / +1 Hap</span>
        </button>
    </div>
</div>

<div class="dash-section">
    <div class="section-title">è¡Œæ”¿/ç³»çµ±</div>
    <div class="admin-box">
        <span>è¡Œæ”¿æ¶ˆè€—: <span id="val-admin">3.0</span></span>
        <input type="range" id="rng-admin" min="0.1" max="10" step="0.1" value="3.0">
    </div>
    <div class="btn-group">
        <button id="btn-admin" class="btn-admin">
            <span class="btn-icon"></span><span class="btn-txt">æ‡‰ä»˜è¡Œæ”¿</span>
        </button>
        <button id="btn-recover" class="btn-system mode-partial-el">
            <span class="btn-icon"></span><span class="btn-txt">ä¼‘æ¯æ¢å¾©</span>
        </button>
        <button id="btn-grade-work" class="btn-grade-work mode-full-el">
            <span class="btn-icon"></span><span class="btn-txt">æ‰¹æ”¹èª²æ¥­</span>
            <span class="btn-cost">-1 E / -2 Hap</span>
        </button>
        <button id="btn-offwork" class="btn-offwork mode-full-el" style="display:none;">
            <span class="btn-icon"></span><span class="btn-txt">æ‰“å¡ä¸‹ç­</span>
        </button>
        <button id="btn-next-partial" class="btn-system mode-partial-el">
            <span class="btn-icon"></span><span class="btn-txt">ä¸‹ä¸€å­¸å¹´</span>
        </button>
    </div>
    <button id="btn-dse">
        <span class="dse-fire"></span> å­¸ç”Ÿæ‡‰è€ƒ DSE <span class="dse-fire"></span>
    </button>
</div>
    </div>

    <!-- è©³ç´°çµç®—å ±å‘Š (Action Report Overlay) -->
   <div id="report-overlay" onclick="this.style.display='none'">
    <div id="report-box" onclick="event.stopPropagation()">
        <div class="report-header">ğŸ“‹ æœ¬æ¬¡è¡Œå‹•çµç®—</div>
        
        <!-- æ–°å¢ï¼šå€ç‡å‹³ç« å®¹å™¨ -->
        <div id="rpt-multiplier-tag">ç…§é¡§å­¸ç¿’å·®å·®ç•°ï¼šæ•ˆæœåŠ å€ï¼</div>
 
        <div class="report-row">
            <span>å¿ƒåŠ›æ¶ˆè€—</span>
            <span id="rpt-energy" class="val-neg">-3.0</span>
        </div>
            <div class="report-row mode-full-el">
                <span>å¹¸ç¦åº¦è®ŠåŒ–</span>
                <span id="rpt-happy" class="val-neu">0</span>
            </div>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>å­¸ç”Ÿ</th>
                        <th>å…ƒç´  (ç¾/é™)</th>
                        <th>å¢æ¸›</th>
                    </tr>
                </thead>
                <tbody id="rpt-tbody">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </tbody>
            </table>
            <div style="text-align:center; margin-top:15px; font-size:10px; color:#999;">é»æ“ŠèƒŒæ™¯é—œé–‰</div>
        </div>
    </div>


<!-- å­¸å¹´åˆ‡æ›å…¨å±é€šçŸ¥ -->
<div id="year-notification">
    <div class="year-title" id="notif-title">ä¸­ä¸€</div>
    <div class="year-sub" id="notif-desc">æ–°å­¸å¹´é–‹å§‹</div>
</div>

    <!-- æ¨¡æ…‹æ¡† (å…±ç”¨ï¼šDSEæˆç¸¾ / Game Over) -->
    <div id="modal-overlay">
        <div id="modal-box">
            <div id="modal-icon" style="font-size:50px;">ğŸ‘´</div>
            <h2 id="modal-title" style="color:var(--accent-dse); margin:10px 0;">æ•™è·å“¡æœƒè­°</h2>
            
            <!-- ä¿®æ”¹ï¼šæ ¡é•·å°è©±ç§»åˆ°æˆç¸¾è¡¨ä¸Šæ–¹ï¼Œä¸¦å¢åŠ  padding è®“æ’ç‰ˆæ›´å¥½çœ‹ -->
            <div id="principal-msg" style="text-align:left; line-height:1.6; color:#444; font-size:14px; background:#f0f0f0; padding:15px; border-radius:10px; margin-bottom:15px; border-left: 5px solid var(--accent-dse);"></div>
            
            <div id="dse-results" style="max-height: 40vh; overflow-y: auto; margin: 10px 0;">
                <!-- DSE æˆç¸¾è¡¨å°‡åœ¨æ­¤ç”Ÿæˆ -->
            </div>
            
            <button id="btn-restart" style="width:100%; background:#333; color:#fff; padding:15px; border-radius:10px; font-weight:bold;">é‡æ–°é–‹å§‹</button>
            <button id="btn-close-modal" style="width:100%; background:#eee; color:#333; padding:10px; margin-top:10px; border-radius:10px; display:none;" onclick="document.getElementById('modal-overlay').style.display='none'">é—œé–‰</button>
        </div>
    </div>

    <!-- çµç®—å ±å‘Š Modal (å…¨é¢é«”é©—ç”¨ - æ—¥çµ) -->
    <div id="summary-overlay">
        <div id="summary-box">
            <h2 style="color:var(--accent-night); border-bottom:2px solid #ddd; padding-bottom:10px;">ğŸ“… æ—¥çµå ±å‘Š</h2>
            <div style="text-align:left; margin:15px 0;">
                <div class="summary-row">
                    <span>å·¥ä½œå®Œæˆï¼š</span><span class="summary-val" id="sum-work">è¡Œæ”¿ x1</span>
                </div>
                <div class="summary-row">
                    <span>å¨›æ¨‚æ´»å‹•ï¼š</span><span class="summary-val val-pos" id="sum-fun">ç„¡</span>
                </div>
                <div class="summary-row">
                    <span>å¹¸ç¦æ„Ÿè®ŠåŒ–ï¼š</span><span class="summary-val" id="sum-happy">+5.0</span>
                </div>
                <div class="summary-row">
                    <span>èª²æ¥­å †ç©ï¼š</span><span class="summary-val val-neg" id="sum-pile">+2 ä»½</span>
                </div>
                <div class="summary-row" style="border:none; margin-top:10px; background:#f0f0f0; padding:10px; border-radius:8px;">
                    <span>æ˜æ—¥èµ·å§‹å¿ƒåŠ›ï¼š</span><span class="summary-val" id="sum-energy" style="font-size:18px;">12.0</span>
                </div>
            </div>
            <button id="btn-confirm-summary" style="width:100%; background:var(--accent-plan); color:#fff; padding:15px; border-radius:10px; font-weight:bold;">è¿æ¥æ–°çš„ä¸€å¤©</button>
        </div>
    </div>

    <!-- ä¸‹ç­æ¨¡å¼ Modal -->
    <div id="offwork-overlay">
        <div id="offwork-box">
            <div class="offwork-header">
    <span id="ow-icon"></span> <span id="ow-title">ä¸‹ç­æ™‚é–“</span>
</div>
            <div class="offwork-stats">
                <div class="stat-box">
                    <span class="ow-stat-val" id="ow-energy">1</span><span class="ow-stat-label">ä¸‹ç­å¿ƒåŠ›</span>
                </div>
                <div class="stat-box">
                    <span class="ow-stat-val" id="ow-happy" style="color:var(--accent-happy)">60</span><span class="ow-stat-label">å¹¸ç¦æ„Ÿ</span>
                </div>
                <div class="stat-box">
                    <span class="ow-stat-val" id="ow-pending-work">0</span><span class="ow-stat-label">å¾…æ‰¹æ”¹ä»½æ•¸</span>
                </div>
            </div>
            <div id="holiday-options" style="display:none;">
                <div class="ow-section-title">å‡æœŸè¦åŠƒ (å¢åŠ å¿ƒåŠ›èˆ‡å¹¸ç¦)</div>
                <div class="slider-container" style="margin-bottom:15px;">
                    <span style="font-size:12px; font-weight:bold;">ä¼‘æ¯ç¨‹åº¦:</span>
                    <input type="range" id="rng-holiday-rest" min="1" max="5" step="1" value="3">
                    <span id="val-holiday-rest" style="font-weight:bold;">3</span> é»
                </div>
                <button class="ow-btn" id="btn-holiday-rest" style="width:100%; flex-direction:row; justify-content:center; gap:10px;">
                    <span class="ow-icon">ğŸ›Œ</span><span class="ow-label">å¥½å¥½ä¼‘æ¯ (å›å¾©å¿ƒåŠ›)</span>
                </button>
            </div>
           <!-- å¨›æ¨‚æŒ‰éˆ•å€ -->
<div class="ow-btn-grid">
    <button class="ow-btn" id="btn-ent-dinner" onclick="doEntertainment('dinner', 'btn-ent-dinner')">
        <span class="ow-icon"></span><span class="ow-label">ç´„æœ‹å‹åƒé£¯</span>
    </button>
    <button class="ow-btn" id="btn-ent-movie" onclick="doEntertainment('movie', 'btn-ent-movie')">
        <span class="ow-icon"></span><span class="ow-label">çœ‹é›»å½±</span>
    </button>
    <button class="ow-btn" id="btn-ent-shopping" onclick="doEntertainment('shopping', 'btn-ent-shopping')">
        <span class="ow-icon"></span><span class="ow-label">é€›è¡—</span>
    </button>
    <button class="ow-btn" id="btn-ent-read" onclick="doEntertainment('read', 'btn-ent-read')">
        <span class="ow-icon"></span><span class="ow-label">é–±è®€</span>
    </button>
    <button class="ow-btn" id="btn-ent-sport" onclick="doEntertainment('sport', 'btn-ent-sport')">
        <span class="ow-icon"></span><span class="ow-label">é‹å‹•</span>
    </button>
    <!-- æ³¨æ„é€™è£¡åŠ äº† id="btn-ent-sleep" -->
   <button class="ow-btn" id="btn-ent-travel" onclick="openTravelMenu()">
        <span class="ow-icon"></span><span class="ow-label">æ—…è¡Œ (é•·å‡é™å®š)</span><br>
     
    </button>
</div>
            <div class="homework-panel">
                <div class="ow-section-title" style="margin-top:0; border:none;">
                    æ‰¹æ”¹èª²æ¥­ (-2 å¹¸ç¦/ä»½) <span id="tag-late" class="tag-late">å…ˆç©å¾Œæ”¹ï¼šé›™å€æ¶ˆè€—</span>
                </div>
                <p style="font-size:11px; color:#7f8c8d; text-align:left; margin:0;">å¦‚æœä¸æ‰¹æ”¹ï¼ŒåŠŸèª²å°‡ç´¯ç©è‡³æ˜æ—¥ã€‚</p>
                <div class="slider-container">
                    <span style="font-size:12px; font-weight:bold;">æ‰¹æ”¹æ•¸é‡:</span>
                    <input type="range" id="rng-grading" min="0" max="10" step="1" value="0">
                    <span id="val-grading-count" style="font-weight:bold;">0</span> ä»½
                </div>
                <div class="work-cost-display" id="grading-preview">æ¶ˆè€— 0 å¿ƒåŠ›</div>
                <button id="btn-do-grade" class="ow-btn" style="width:100%; margin-top:10px; flex-direction:row; justify-content:center; gap:10px;">
                    <span class="ow-icon" style="font-size:16px;">âœï¸</span> åŸ·è¡Œæ‰¹æ”¹
                </button>
            </div>
            <button class="sleep-btn" id="btn-end-day">ğŸ’¤ çµæŸé€™ä¸€å¤© (çµç®—)</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>



// ==========================================
// SVG åœ–ç¤ºåº« (å®Œæ•´å®šç¾©)
// ==========================================
const SVGS = {
    // æ•™å­¸æ´»å‹•
    read: `<svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>`,
    fun: `<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>`, // é€™è£¡æ”¹ç”¨é©šå˜†è™Ÿ/è¶£å‘³ç¬¦è™Ÿï¼Œæˆ–ç”¨ç³–æœ
    fun_alt: `<svg viewBox="0 0 24 24"><path d="M11.7 5.6C9.9 3.5 7 3.3 5.4 5.3c-1.5 1.9-1.2 4.7.7 6.4l2.4 2.1L4 18.3 5.7 20l4.5-4.5 2.4 2.1c1.8 1.6 4.6 1.1 6.1-.8 1.5-2 1.3-4.9-.5-6.9l-6.5-4.3z"/></svg>`, // ç³–æœ
    plan: `<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`,
    drill: `<svg viewBox="0 0 24 24"><path d="M19.4 12.6l-7.4-7.4C11.79 4.99 11.53 4.93 11.26 5c-.32-.08-.66-.05-.96.11l-2.67 1.4L4.06 3 3 4.06l3.5 3.5-1.4 2.67c-.16.3-.13.64-.05.96-.07.27-.01.53.2.74l7.4 7.4c.78.78 2.05.78 2.83 0l3.92-3.92c.78-.78.78-2.05 0-2.83zM10.5 13.5l-2-2 4-4 2 2-4 4z"/></svg>`, // åŠ/æ­¦å™¨
    hea: `<svg viewBox="0 0 24 24"><path d="M20 3H4v10c0 2.21 1.79 4 4 4h6c2.21 0 4-1.79 4-4v-3h2c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 5h-2V5h2v3zM4 19h16v2H4z"/></svg>`, // å’–å•¡
    
    // è¡Œæ”¿èˆ‡ç³»çµ±
    admin: `<svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>`,
    recover: `<svg viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>`,
    grade: `<svg viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-2 14l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>`,
    offwork: `<svg viewBox="0 0 24 24"><path d="M9 2c-1.05 0-2.05.16-3 .46 4.06 1.27 7 5.06 7 9.54 0 4.48-2.94 8.27-7 9.54.95.3 1.95.46 3 .46 5.52 0 10-4.48 10-10S14.52 2 9 2z"/></svg>`,
    nextYear: `<svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>`,
    dse: `<svg viewBox="0 0 24 24"><path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/></svg>`,

    // å¨›æ¨‚èˆ‡ç”Ÿæ´»
    food: `<svg viewBox="0 0 24 24"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>`,
    movie: `<svg viewBox="0 0 24 24"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>`,
    shop: `<svg viewBox="0 0 24 24"><path d="M19 6h-2c0-2.76-2.24-5-5-5S7 3.24 7 6H5c-1.1 0-1.99.9-1.99 2L3 20c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-7-3c1.66 0 3 1.34 3 3H9c0-1.66 1.34-3 3-3zm0 14c-2.76 0-5-2.24-5-5h2c0 1.66 1.34 3 3 3s3-1.34 3-3h2c0 2.76-2.24 5-5 5z"/></svg>`,
    read_ent: `<svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm-9 3c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm9-7c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm11 6c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/></svg>`, // ç”¨æ›¸æœ¬æˆ–çœ¼ç›
    sport: `<svg viewBox="0 0 24 24"><path d="M13.49 5.48c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3.6 13.9l1-4.44L5.48 10h5l1.5-4.5h6.01v2h-4.01l-1 3 3 1.5V20h-2v-5l-2.5-1.5-1.5 6.48h-2.49z"/></svg>`,
    bed: `<svg viewBox="0 0 24 24"><path d="M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V5H1v15h2v-3h18v3h2v-9c0-2.21-1.79-4-4-4z"/></svg>`,
    holiday: `<svg viewBox="0 0 24 24"><path d="M13 9h-2L6.6 20.6l1.8.8L11 15h2l2.6 6.4 1.8-.8L13 9zm-2 4l1.2-3.2 1.2 3.2h-2.4zM20.5 4c-2.61.7-5.67 1-8.5 1S6.11 4.7 3.5 4L3 6c1.86.5 4 .83 6 1v13h2V7c2-.17 4.14-.5 6-1l-.5-2z"/></svg>`, // é®é™½å‚˜/å¸³ç¯·
    
    // å…¶ä»–
    door: `<svg viewBox="0 0 24 24"><path d="M19 19V5c0-1.1-.9-2-2-2H7c-1.1 0-2 .9-2 2v14H3v2h18v-2h-2zm-2 0H7V5h10v14zm-4-8h2v2h-2z"/></svg>`,
    tea: `<svg viewBox="0 0 24 24"><path d="M20 3H4v10c0 2.21 1.79 4 4 4h6c2.21 0 4-1.79 4-4v-3h2c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 5h-2V5h2v3zM4 19h16v2H4z"/></svg>`,
    old: `<svg viewBox="0 0 24 24"><path d="M15 4c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2zM6 8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM12 8c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2zm0 6c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2z"/></svg>`, // æŠ½è±¡äººç¾¤
    grad: `<svg viewBox="0 0 24 24"><path d="M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z"/></svg>`,
    plane: `<svg viewBox="0 0 24 24"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>`
};




// ==========================================
// éŸ³æ•ˆç³»çµ± (MP3 ç‰ˆæœ¬)
// ==========================================

// 1. é å…ˆå»ºç«‹åŸºç¤éŸ³æ•ˆç‰©ä»¶
// è«‹ç¢ºä¿ 'æ‰è½.mp3' æª”æ¡ˆä½æ–¼èˆ‡ HTML ç›¸åŒçš„è³‡æ–™å¤¾ä¸­
// ==========================================
// éŸ³æ•ˆç³»çµ± (MP3 ç‰ˆæœ¬)
// ==========================================
const dropSoundBase = new Audio('æ‰è½.mp3');
dropSoundBase.volume = 0.3; 

// æ–°å¢ä¸€å€‹è®Šæ•¸ç´€éŒ„ä¸Šæ¬¡æ’­æ”¾æ™‚é–“
let lastDropSoundTime = 0;

function playLandSound() {
    const now = Date.now();
    // é™åˆ¶æ¯ 80 æ¯«ç§’æœ€å¤šåªèƒ½ç™¼å‡ºä¸€æ¬¡æ‰è½è²ï¼Œé˜²æ­¢æ‰‹æ©Ÿæ•ˆèƒ½å´©æ½°
    if (now - lastDropSoundTime < 80) return; 
    lastDropSoundTime = now;

    const sound = dropSoundBase.cloneNode();
    sound.volume = 0.3;
    sound.play().catch(e => {
        // å¿½ç•¥è‡ªå‹•æ’­æ”¾é˜»æ“‹éŒ¯èª¤
    });
}


        // === æ‰‹æ©Ÿç€è¦½å™¨éŸ³æ•ˆè§£é–æ©Ÿåˆ¶ ===
function unlockAudioContext() {
    // è®“æ‰€æœ‰éŸ³æ•ˆæ‚„æ‚„æ’­ä¸€æ¬¡ç„¶å¾Œç«‹åˆ»æš«åœ
    const soundsToUnlock = [dropSoundBase, keyboardSoundBase, stampSoundBase];
    
    soundsToUnlock.forEach(audio => {
        audio.play().then(() => {
            audio.pause();
            audio.currentTime = 0;
        }).catch(e => {});
    });

    // è§£é–æˆåŠŸå¾Œï¼Œç§»é™¤é€™å€‹ç›£è½å™¨ï¼Œé¿å…æµªè²»æ•ˆèƒ½
    document.removeEventListener('touchstart', unlockAudioContext);
    document.removeEventListener('click', unlockAudioContext);
}

// ç¶å®šåœ¨ç©å®¶çš„ç¬¬ä¸€æ¬¡é»æ“Šæˆ–è§¸æ§ä¸Š
document.addEventListener('touchstart', unlockAudioContext, { once: true });
document.addEventListener('click', unlockAudioContext, { once: true });
// ==================================

// === æ–°å¢ï¼šéµç›¤æ•²æ“ŠéŸ³æ•ˆ ===
const keyboardSoundBase = new Audio('éµç›¤.mp3');
keyboardSoundBase.volume = 0.6; // æ ¹æ“šä½ çš„éŸ³æ•ˆæª”è‡ªè¡Œèª¿æ•´éŸ³é‡ (0.0 ~ 1.0)

function playKeyboardSound() {
    // ä½¿ç”¨ cloneNode ç¢ºä¿é€£çºŒå¿«é€Ÿé»æ“Šæ™‚ï¼Œè²éŸ³å¯ä»¥é‡ç–Šè€Œä¸æœƒè¢«åˆ‡æ–·
    const sound = keyboardSoundBase.cloneNode();
    sound.volume = 0.6;
    sound.play().catch(e => {
        // å¿½ç•¥è‡ªå‹•æ’­æ”¾é™åˆ¶çš„éŒ¯èª¤
    });
}

        // === æ–°å¢ï¼šè½æ¬¾è“‹ç« éŸ³æ•ˆ ===
const stampSoundBase = new Audio('è½æ¬¾.mp3');
stampSoundBase.volume = 0.8; // éŸ³é‡å¯è‡ªè¡Œèª¿æ•´ (0.0 ~ 1.0)

function playStampSound() {
    // ä½¿ç”¨ cloneNode ç¢ºä¿é€£çºŒæ‰¹æ”¹æ™‚è²éŸ³ä¸æœƒè¢«åˆ‡æ–·
    const sound = stampSoundBase.cloneNode();
    sound.volume = 0.8;
    sound.play().catch(e => {
        // å¿½ç•¥è‡ªå‹•æ’­æ”¾é™åˆ¶çš„éŒ¯èª¤
    });
}
        

        // ==========================================
        // 1. è¨­å®šèˆ‡å¸¸é‡
        // ==========================================
        const style = getComputedStyle(document.body);
        const CONFIG = {
            colors: {
                bg: 0xF2F0EB,
                glassRead: parseInt(style.getPropertyValue('--accent-read').trim().replace('#', '0x')),
                pRead: parseInt(style.getPropertyValue('--accent-read').trim().replace('#', '0x')),
                pFun: parseInt(style.getPropertyValue('--accent-fun').trim().replace('#', '0x')),
                pPlan: parseInt(style.getPropertyValue('--accent-plan').trim().replace('#', '0x')),
                pDrill: parseInt(style.getPropertyValue('--accent-drill').trim().replace('#', '0x')),
                pHea: parseInt(style.getPropertyValue('--accent-hea').trim().replace('#', '0x')), 
                pReject: 0xAAAAAA,
                cssRead: style.getPropertyValue('--accent-read').trim(),
                cssFun: style.getPropertyValue('--accent-fun').trim(),
                cssPlan: style.getPropertyValue('--accent-plan').trim(),
                cssDrill: style.getPropertyValue('--accent-drill').trim(),
                cssHappy: style.getPropertyValue('--accent-happy').trim()
            }
        };

        const STUDENT_NAMES = [
            "é™³å­è»’", "é»ƒå˜‰æ¬£", "æå¿—è±ª", "å¼µæ›‰å½¤", "æ¢å‰æ–‡", "æ—ä½©çŠ", "å³ä¿Šå‚‘", "åŠ‰èŠ·æ™´", "æ¥Šæµ©ç„¶", "é„­æ¨‚æ†",
            "è¬ç©å„€", "å‘¨å®¶åº·", "é„§å‡±ç³", "è¨±å“æ¥ ", "æ›¾è© è©©", "é¦®æ€æ•", "è”¡æŸå®‡", "è˜‡æ¨‚å„€", "è‘‰å»ºé‚¦", "ç¾…æ›‰ç³",
            "é™³å®¶è±ª", "é»ƒç¾ç²", "æåœ‹æ¦®", "å¼µç§€ç", "æ¢æ™ºè³¢", "æ—æ¬£æ€¡", "å³å‰åœ‹", "åŠ‰å°ä¾", "æ¥Šå˜‰è±ª", "é„­æ•å§¿",
            "è¬å­è°", "å‘¨æ¨‚ç‘¤", "é„§æ¢“æ†", "è¨±æ›‰å³°", "æ›¾å˜‰å„€", "é¦®ä¿Šç·¯", "è”¡å‡±æ–‡", "è˜‡å©‰å„€", "è‘‰å¿—æ¦®", "ç¾…ç§€è‹±",
            "é™³åœ‹æ¨‘", "é»ƒä½©å„€", "æå˜‰è¼", "å¼µæ›‰è¯", "æ¢å‰å‚‘", "æ—æ…§çŠ", "å³å­å¥", "åŠ‰æ¨‚å¤©", "æ¥Šæ¢“æ™´", "é„­æµ©å®‡",
            "è¬ç©è©©", "å‘¨æŸè³¢", "é„§æ›‰å…‰", "è¨±å‡±å€«", "æ›¾æ™ºå‹‡", "é¦®å¸Œå½¤", "è”¡æ´›é›¯", "è˜‡é Œè³¢", "è‘‰æ›‰æ™´", "ç¾…å®‡è»’",
            "é™³èŠ·å›", "é»ƒæµ©è³¢", "ææ¨‚æ–‡", "å¼µå˜‰é›¯", "æ¢ä¿Šå®", "æ—å‡±ç¨‹", "å³ç©æ©", "åŠ‰å¿—æ†", "æ¥Šç§€é›¯", "é„­åœ‹è¯",
            "è¬ä½©èŠ", "å‘¨å˜‰çª", "é„§æ›‰å…‰", "è¨±å‰æ˜", "æ›¾æ…§å„€", "é¦®å­æœ—", "è”¡æ¨‚å…’", "è˜‡æ¢“è»’", "è‘‰æµ©å¾·", "ç¾…ç©ç³",
            "é™³æŸéœ–", "é»ƒå“ç„¶", "æå‡±æ¬£", "å¼µæ™ºå‰", "æ¢å¸Œæ–‡", "æ—æ´›è»’", "å³é Œæš", "åŠ‰æ›‰æ–‡", "æ¥Šå®‡å³°", "é„­èŠ·çª",
            "è¬æµ©æ–‡", "å‘¨æ¨‚æ¬£", "é„§å˜‰å¯¶", "è¨±ä¿Šè³¢", "æ›¾å‡±æ™´", "é¦®ç©çŠ", "è”¡å¿—è³¢", "è˜‡ç§€è¯", "è‘‰åœ‹è¼", "ç¾…ä½©çª"
        ];

        // æ„Ÿè¨€åº« (Constraint 5)
        const SENTIMENTS = {
            positive: [
                "Yes! ä¸­æ–‡æ”åˆ°å’å¥½æˆç¸¾ï¼Œå…¥åˆ°å¤§å­¸å•¦ï¼", 
                "å¤šè¬è€å¸«ï¼æˆ‘çœŸä¿‚ç„¡è«—éæœƒæ”åˆ°å‘¢å€‹æˆç¸¾ï¼", 
                "é›–ç„¶å…¶ä»–ç§‘å¤±æ‰‹ï¼Œå¥½å½©ä¸­æ–‡æ•‘è¿”æˆ‘å…¨å®¶ã€‚", 
                "åŠªåŠ›ç„¡ç™½è²»å›‰ï¼ä½œæ–‡é¡Œç›®æˆ‘è­˜åšå‘€ï¼", 
                "é›–ç„¶å””ä¿‚ç‹€å…ƒï¼Œä½†å‘¢å€‹åˆ†å°å¾—ä½è‡ªå·±ï¼Œå¤šè¬è€å¸«æ•™å°ã€‚",
                "åŸä¾†é–±è®€å·çœŸä¿‚è¦é å¹³æ™‚ç©ç´¯ï¼Œå¥½å½©ç„¡æ”¾æ£„ã€‚", 
                "æˆ‘å…¥åˆ°å¿ƒå„€å˜…å­¸ç³»å•¦ï¼å¤šè¬è€å¸«å¯«æ¨è–¦ä¿¡ã€‚", 
                "å¦‚æœå””ä¿‚è€å¸«é€¼æˆ‘èƒŒå¤æ–‡ï¼Œæˆ‘ä¸€å®šæœƒæ­»å¾—å¥½æ…˜ã€‚", 
                "æˆ‘å¯ä»¥åŒé˜¿åª½äº¤ä»£å•¦ï¼", 
                "å¤šè¬è€å¸«é€™å¹¾å¹´å˜…å¿è€ï¼Œæˆ‘çµ‚æ–¼ç•¢æ¥­å•¦ï¼",
                "ä¸­æ–‡ç§‘ä¿‚æˆ‘è€ƒå¾—æœ€å¥½å—°ç§‘ï¼Œå¤šè¬é˜¿Sir/Missï¼", 
                "å…¶å¯¦æˆ‘éƒ½å¹¾é¾æ„ä¸­æ–‡ï¼Œä¸Šåˆ°å¤§å­¸æœƒç¹¼çºŒè®€ã€‚", 
                "çœŸä¿‚ã€Œæ›¸ä¸­è‡ªæœ‰é»ƒé‡‘å±‹ã€ï¼Œæˆ‘ä¿¡å•¦ã€‚", 
                "è€å¸«ï¼Œå¾—é–’è¿”é»æ¢ä½ ï¼Œè«‹ä½ é£²èŒ¶ï¼", 
                "é›–ç„¶éç¨‹å¥½è¾›è‹¦ï¼Œä½†è¦‹åˆ°å¼µæˆç¸¾å–®å³åˆ»ç„¡äº‹ã€‚",
                "æˆ‘çµ‚æ–¼æ˜ç™½è€å¸«å¹³æ™‚å˜…è‹¦å¿ƒï¼Œå¤šè¬ä½ ç„¡æ”¾æ£„æˆ‘ã€‚", 
                "å¥½å½©æœ€å¾Œå¹¾å€‹æœˆæœ‰ç™¼åŠ›ï¼ŒçœŸçš„è¿½å¾—è¿”ï¼", 
                "é€™æ˜¯æˆ‘äººç”Ÿæœ€é–‹å¿ƒå˜…ä¸€æ—¥ï¼", 
                "è€å¸«ï¼Œæˆ‘å¾—å’—å•¦ï¼ç„¡ä»¤ä½ å¤±æœ›ï¼", 
                "é›–ç„¶ç¶œåˆå·åšå¾—ä¸€èˆ¬ï¼Œä½†åŸä¾†æ‹‰åˆ†æ‹‰å¾—è¿”ã€‚",
                "æˆ‘æœƒå°‡é€™ä»½æˆç¸¾å–®é‘²èµ·ä½¢ï¼Œå‚³å®¶ä¹‹å¯¶ã€‚", 
                "å¤šè¬è€å¸«ä»¤æˆ‘å°ä¸­æ–‡æ”¹è§€ï¼ŒåŸä¾†æˆ‘éƒ½å¯ä»¥è€ƒå¾—å¥½ã€‚", 
                "è€ƒå®Œè©¦ä¸€èº«è¼•ï¼Œä»²è¦æœ‰å¥½æˆç¸¾ï¼Œçˆ½ï¼", 
                "æˆ‘ä»¥å¾Œå””æ´—å†é©šæ–‡è¨€æ–‡å•¦ï¼Œå› ç‚ºæˆ‘æˆ°å‹å’—ä½¢ã€‚", 
                "å¤šè¬è€å¸«æ•™æœƒæˆ‘åšäººé“ç†ï¼Œå¤šéæ•™è€ƒè©¦æŠ€å·§ã€‚",
                "æˆ‘ä»¥ç‚ºæˆ‘æœƒè‚¥ä½¬ï¼Œé»çŸ¥åŠæ ¼æœ‰é¤˜ï¼å¥‡è¹Ÿå‘€ï¼", 
                "è€å¸«ï¼Œä½ ä¿‚æˆ‘é‡éæœ€å¥½å˜…ä¸­æ–‡è€å¸«ã€‚", 
                "é€™æ®µå¸«ç”Ÿç·£åˆ†ï¼Œæˆ‘æœƒè¨˜ä½ï¼Œæœ‰ç·£å†è¦‹ã€‚", 
                "é›–ç„¶ç•¢æ¥­ï¼Œä½†æˆ‘å””æœƒå¿˜è¨˜è€å¸«å˜…æ•™èª¨ã€‚", 
                "çµ‚æ–¼å¯ä»¥å¤§è²è¬›ï¼šæˆ‘ä¿‚å¤§å­¸ç”Ÿå•¦ï¼"
            ],
            negative: [
                "å¦–ï¼Œå€‹è€ƒè©•å±€ç©é‡å°å’©ï¼Ÿå‡ºåŸ‹å•²å’å˜…é¡Œç›®ã€‚", 
                "å­¸æ ¡æ•™åŸ‹å•²å˜¢éƒ½ç„¡å‡ºå˜…ï¼æµªè²»æˆ‘æ™‚é–“ã€‚", 
                "é˜¿Sirä½ æ•™å¾—å¤ªæ·±å•¦ï¼ŒDSE æ ¹æœ¬å””ä¿‚è€ƒå‘¢å•²ã€‚", 
                "æ—©çŸ¥å‡ºå»è£œç¿’å•¦ï¼Œè½å­¸æ ¡è€å¸«è¬›æ­»å¾—äººå¤šã€‚", 
                "ç©å®Œï¼Œå¤šè¬æ™’å­¸æ ¡å–ã€‚", 
                "é»è§£éš”é›¢ç­å€‹é˜¿Siræ•™å¾—å¥½å’å¤šï¼Ÿå””å…¬å¹³ã€‚", 
                "æˆ‘éƒ½è©±ä¸­æ–‡ä¿‚åƒåœ¾ç§‘ï¼Œæ•¸ç†å¥½éƒ½ç„¡ç”¨ï¼Œä¿¾ä¸­æ–‡ç´¯æ­»ã€‚", 
                "æŠ•è¨´ï¼ä»½å·å’æ·±é»åšå‘€ï¼Ÿæˆ‘è¦å»è€ƒè©•å±€æŠ—è­°ï¼", 
                "è€å¸«ä½ å¹³æ™‚è©±æˆ‘æœƒåŠæ ¼æ¶ï¼Œä¾å®¶é»ç®—å…ˆï¼Ÿ", 
                "æˆ‘è¦ºå¾—ä¿‚å­¸æ ¡æ”¯æ´ä¸è¶³å›‰ï¼Œå””é—œæˆ‘äº‹ã€‚",
                "æ ¹æœ¬ä¿‚å¡«é´¨å¼æ•™è‚²ï¼Œæ‰¼æ®ºå‰µæ„ï¼Œæˆ‘è€ƒå¾—å·®ä¿‚æ­£å¸¸ã€‚", 
                "æˆ‘éƒ½ç„¡å¿ƒæ©Ÿè®€ï¼Œæ˜¯ä½†å•¦ï¼Œåæ­£éƒ½ä¿‚åšåœ°ç›¤ã€‚", 
                "è€ƒå¾—å’å·®ï¼Œé»è¦‹äººå‘€ï¼Ÿéƒ½ä¿‚è€å¸«ä½ å””è­˜æ•™ã€‚", 
                "æˆ‘å¹³æ™‚åšå·éƒ½å¥½åœ°åœ°ï¼Œä¸€å®šä¿‚æ”¹å·å“¡é‡å°æˆ‘ã€‚", 
                "å”‰ï¼Œè®€å’å¤šæ›¸æœ‰é¬¼ç”¨å’©ï¼Œå‡ºé»åšé‡ä»²å¯¦éš›ã€‚", 
                "å­¸æ ¡æ ¹æœ¬ç„¡ä¿¾è¶³å¤ è³‡æºæˆ‘åœ°ï¼Œè¼¸åœ¨èµ·è·‘ç·šã€‚", 
                "æˆ‘æ”¾æ£„æ²»ç™‚å•¦ï¼ŒAsso è¦‹ã€‚", 
                "å¦‚æœä½ æ•™å¾—ç”Ÿå‹•å•²ï¼Œæˆ‘å¯èƒ½æœƒè½æ›¸å›‰ã€‚", 
                "æˆ‘è¦ºå¾—ä»Šæ¬¡è€ƒè©¦å””å…¬å¹³ï¼Œæˆ‘è¦è¦†æ ¸æˆç¸¾ï¼", 
                "ä¸­æ–‡ç§‘æ ¹æœ¬å°±ä¿‚é‹æ°£ç§‘ï¼Œæˆ‘ä»Šæ—¥é»‘ä»”å•«ã€‚", 
                "æ•™ç•œèª¤äººå­å¼Ÿï¼Œæåˆ°æˆ‘ç„¡æ›¸è®€ã€‚", 
                "é»è§£è¦è€ƒç¯„æ–‡ï¼ŸèƒŒæ›¸æ©Ÿå™¨å’©ï¼Ÿç¾ä»£äººéƒ½å””è¬›æ–‡è¨€æ–‡ã€‚", 
                "æˆ‘å””è¦ºå¾—ä¿‚æˆ‘æœ‰å•é¡Œï¼Œä¿‚å€‹åˆ¶åº¦æœ‰å•é¡Œã€‚", 
                "ç®—å§å•¦ï¼Œæˆ‘éƒ½é å’—ä¿‚å’ï¼Œç„¡æœŸæœ›å°±ç„¡å¤±æœ›ã€‚", 
                "å€‹åˆ†å’ä½ï¼Œæˆ‘æƒ³æ’•çˆ›å¼µæˆç¸¾å–®ã€‚", 
                "æ—©çŸ¥è½‰è€ƒ IB å•¦ï¼Œè€ƒ DSE ç©æ­»è‡ªå·±ã€‚", 
                "æˆ‘å””æƒ³å†è¦‹åˆ°ä»»ä½•é—œæ–¼ä¸­æ–‡å˜…é‡ã€‚", 
                "å”‰ï¼Œåˆè¦ä¿¾å±‹ä¼äººé¬§ï¼Œå¤šå¾—è€å¸«å””å°‘ã€‚", 
                "æˆ‘ä»¥å¾Œå””æœƒå†è¸å…¥å‘¢é–“å­¸æ ¡åŠæ­¥ã€‚", 
                "å¿ƒæƒ…æ¥µå·®ï¼Œå””å¥½ç…©æˆ‘ã€‚"
            ],
            reflection: [
                "å”‰ï¼Œæ—©çŸ¥ä»¥å‰ä¸Šå ‚å””è¨“è¦ºå•¦ï¼Œä¾å®¶å¾Œæ‚”éƒ½ç„¡ç”¨ã€‚", 
                "åŸä¾†çœŸçš„è¦å¹³æ™‚ç©ç´¯ï¼Œè‡¨æ€¥æŠ±ä½›è…³çœŸä¿‚ç„¡ç”¨ã€‚", 
                "è¦‹åˆ°å€‹åˆ†ï¼Œæˆ‘ç„¡è©±å¯èªªï¼Œä¿‚æˆ‘è‡ªå·±æ‡¶ï¼ŒæŠµæ­»ã€‚", 
                "å¯èƒ½æˆ‘çœŸä¿‚å””é©åˆè®€æ›¸ï¼Œè€ƒæ…®ä¸‹å‡ºé»åšå­¸å¾’ã€‚", 
                "å¤šè¬è€å¸«ç›¡å’—åŠ›æ•™ï¼Œä¿‚æˆ‘è‡ªå·±ç„¡ç›¡åŠ›å­¸ï¼Œå°å””ä½ã€‚", 
                "æ˜å¹´å†æˆ° DSEï¼Œé€™æ¬¡æˆ‘æœƒèªçœŸï¼Œå””æœƒå†ç©ã€‚", 
                "é›–ç„¶å””åŠæ ¼ï¼Œä½†æˆ‘çŸ¥è€å¸«ä½ å·²ç¶“ç›¡åŠ›å¹«æˆ‘ã€‚", 
                "åŸä¾†é˜¿Sirä»¥å‰é¬§æˆ‘éƒ½ä¿‚ç‚ºæˆ‘å¥½ï¼Œæˆ‘ä¾å®¶å…ˆçŸ¥ã€‚", 
                "ç‡ä½å¼µæˆç¸¾å–®ï¼Œæˆ‘è¦ºå¾—å¥½å°å””ä½çˆ¶æ¯ã€‚", 
                "æˆ‘ä»¥ç‚ºé å¤©æ‰æ³¢å¾—ï¼ŒåŸä¾†ä¸­æ–‡ç§‘çœŸä¿‚è¦æµ¸ã€‚", 
                "å¦‚æœæ™‚å…‰å¯ä»¥å€’æµï¼Œæˆ‘ä¸€å®šæœƒäº¤é½ŠåŠŸèª²ã€‚", 
                "è¦‹åˆ°åŒå­¸è€ƒå¾—å¥½ï¼Œæˆ‘æœ‰å•²ç¾¨æ…•ï¼Œä½†æˆ‘ç„¡è³‡æ ¼å¦’å¿Œã€‚", 
                "ä»Šæ¬¡æ•™è¨“å¥½å¤§ï¼Œæˆ‘ä»¥å¾Œåšäººæœƒè¸å¯¦å•²ã€‚", 
                "é›–ç„¶è€ƒå¾—å·®ï¼Œä½†æˆ‘æµåˆ°è‡ªå·±å˜…å¼±é»ï¼Œæœƒæ”¹ã€‚", 
                "è€å¸«ï¼Œå°å””ä½ï¼Œè¾œè² å’—ä½ å˜…æœŸæœ›ã€‚", 
                "æˆ‘è«—æˆ‘è¦è®€æ¯…é€²/åŸºç¤æ–‡æ†‘ï¼Œé‡æ–°é»éã€‚", 
                "ä»¥å‰è¦ºå¾—è€å¸«é•·æ°£ï¼Œä¾å®¶çŸ¥éŒ¯å•¦ã€‚", 
                "ç„¡å¾—è³´äººï¼Œä¿‚æˆ‘è‡ªå·±æ›ä½æ‰“æ©Ÿã€‚", 
                "é›–ç„¶å¤±æ•—å’—ï¼Œä½†æˆ‘å””æœƒæ”¾æ£„ï¼Œæ¢æ¢å¤§è·¯é€šç¾…é¦¬ã€‚", 
                "å¤šè¬è€å¸«ç„¡æ”¾æ£„éæˆ‘å‘¢å€‹å·®ç”Ÿï¼Œä¿‚æˆ‘å””çˆ­æ°£ã€‚", 
                "æˆ‘çµ‚æ–¼æ˜ç™½ã€Œå°‘å£¯ä¸åŠªåŠ›ï¼Œè€å¤§å¾’å‚·æ‚²ã€ä¿‚å’©æ„æ€ã€‚", 
                "ç¶“ä¸€äº‹é•·ä¸€æ™ºï¼Œæˆ‘æœƒç‚ºè‡ªå·±å‰é€”æ‰“ç®—ã€‚", 
                "æˆ–è€…æˆ‘çœŸä¿‚ç„¡èªæ–‡å¤©ä»½ï¼Œä½†æˆ‘æœƒä¿‚å…¶ä»–æ–¹é¢åŠªåŠ›ã€‚", 
                "å€‹åˆ†ä¿‚é›£ç‡ï¼Œä½†ä¿‚äº‹å¯¦ï¼Œæˆ‘è¦æ¥å—ã€‚", 
                "å””æƒ³å†ä¿¾è—‰å£è‡ªå·±ï¼Œå¤±æ•—å°±ä¿‚å¤±æ•—ã€‚", 
                "è€å¸«ï¼Œå¤šè¬ä½ æœ€å¾Œå€‹å¹¾æœˆé™ªæˆ‘è£œèª²ï¼Œé›–ç„¶éƒ½ä¿‚å””å¾—ã€‚", 
                "æˆ‘æœƒè¨˜ä½ä»Šæ—¥å˜…æ¥è¾±ï¼Œç™¼æ†¤åœ–å¼·ã€‚", 
                "åŸä¾†ä¸–ç•Œç„¡å…è²»åˆé¤ï¼Œç„¡ä»˜å‡ºçœŸä¿‚ç„¡æ”¶ç©«ã€‚", 
                "å¸Œæœ›è€å¸«ä½ ç¹¼çºŒåŠ æ²¹ï¼Œå””å¥½å› ç‚ºæˆ‘è€Œç°å¿ƒã€‚", 
                "å†è¦‹å•¦è€å¸«ï¼Œæˆ‘æœƒåŠªåŠ›åšå€‹å¥½äººã€‚"
            ]
        };

        // å…¨å±€ç‹€æ…‹
        let GAME_MODE = 'full';
        const TEACHER = { 
            age: 22, maxEnergy: 10, currentEnergy: 10, energyDebt: 0,
            recoveriesLeft: 3, happiness: 60, maxHappiness: 100,
            gradingPile: 0, daysInYear: 1, offWorkEnergy: 0, isHoliday: false,
            hasEntertainedTonight: false, bonusEnergyNextDay: 0,
            dailyStats: { happyChange: 0, adminCount: 0, entertained: false, workAdded: 0, complaintLoss: 0 }
        };

        // è¦å‰‡ç›¸é—œè®Šé‡ (Constraint 2)
        let lastActionType = null;
        let consecutiveActionCount = 0;

        // å­¸ç”Ÿé¡å‹å®šç¾©
        const STUDENT_TYPES = {
            HIGH: { id: 'high', name: 'å¤©è³‡è°ç©', color: style.getPropertyValue('--color-high').trim(), growRate: [0.5, 0.8], readGrow: 0.5, baseScale: 2.0, rejectRate: 0.1, canGrow: true, maxHeight: 8.0 },
            AVG:  { id: 'avg', name: 'è³‡è³ªå¹³åº¸', color: style.getPropertyValue('--color-avg').trim(), growRate: [0.15, 0.3], readGrow: 0.2, baseScale: 1.0, rejectRate: 0.3, canGrow: true, maxHeight: 3.0 },
            LOW:  { id: 'low', name: 'è³‡è³ªé§‘éˆ', color: style.getPropertyValue('--color-low').trim(), growRate: [0.05, 0.1], readGrow: 0.05, baseScale: 0.25, rejectRate: 0.6, canGrow: false, maxHeight: 1.5 }
        };

        const GRADES = ["ä¸­ä¸€", "ä¸­äºŒ", "ä¸­ä¸‰", "ä¸­å››", "ä¸­äº”", "ä¸­å…­"];
        let currentNeed = 'read'; 
        let currentGradeIndex = 0;
        let students = [];
        let particles = [];
        let isDseMode = false;
        let hasDoneAdmin = false; 
// === æ–°å¢ï¼šé€£æ“Šçµç®—ç³»çµ±è®Šæ•¸ ===
        let batchTimer = null;          // ç”¨ä¾†å„²å­˜è¨ˆæ™‚å™¨ ID
        let batchSnapshot = null;       // é€£æ“Šé–‹å§‹å‰çš„å­¸ç”Ÿç²’å­æ•¸é‡å¿«ç…§
        let batchTotalCost = 0;         // é€£æ“Šç´¯ç©æ¶ˆè€—çš„å¿ƒåŠ›
        let batchTotalHappy = 0;        // é€£æ“Šç´¯ç©è®ŠåŒ–çš„å¹¸ç¦åº¦

        // ==========================================
        // 2. Three.js å ´æ™¯è¨­ç½®
        // ==========================================
        const scene = new THREE.Scene();
        scene.fog = new THREE.Fog(CONFIG.colors.bg, 20, 90);
        const camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 150);
       // --- ç¬¬ 1 æ­¥ï¼šä¿®æ­£å¾Œçš„æ¸²æŸ“å™¨ï¼ˆä¿ç•™æ•ˆèƒ½ï¼Œæ¢å¾©äº®åº¦ï¼‰ ---
const renderer = new THREE.WebGLRenderer({
    antialias: true,
    alpha: true,
    powerPreference: "high-performance" // è®“ç€è¦½å™¨å„ªå…ˆä½¿ç”¨å¼·å¤§é¡¯å¡
});
 
// ç§»é™¤ç‰©ç†ç‡ˆå…‰å’Œè‰²å½©ç·¨ç¢¼è¨­å®šï¼Œä»¥æ¢å¾©åŸæœ¬çš„ Morandi è‰²èª¿
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
 
// å°‡æ¸²æŸ“ç•«å¸ƒæ”¾å…¥ç¶²é å®¹å™¨
const canvasContainer = document.getElementById('canvas-container');
if (canvasContainer) {
    canvasContainer.appendChild(renderer.domElement);
}
// ------------------------------------
        
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableRotate = false; controls.enableZoom = true; controls.enablePan = true;
        controls.touches = { ONE: THREE.TOUCH.PAN, TWO: THREE.TOUCH.DOLLY_PAN };
        controls.minDistance = 20; controls.maxDistance = 150;

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.9); scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.6); dirLight.position.set(0, 30, 20); scene.add(dirLight);

        const plane = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({ color: CONFIG.colors.bg, roughness: 1 }));
        plane.rotation.x = -Math.PI / 2; plane.position.y = -2; scene.add(plane);

        const matGlassRead = new THREE.MeshPhysicalMaterial({ 
            color: CONFIG.colors.glassRead, metalness: 0, roughness: 0.1, 
            transmission: 0.5, transparent: true, opacity: 0.8, side: THREE.DoubleSide 
        });

// ==========================================
// Student é¡åˆ¥ - ä¿®è¨‚ç‰ˆ (èººå¹³è¦–è¦ºèˆ‡å‹•æ…‹ç‹€æ…‹)
// ==========================================
class Student {
    constructor(id, xPos, typeOverride = null) {
        this.id = id;
        this.xPos = xPos;
        this.isSelected = true; 
        this.name = STUDENT_NAMES[Math.floor(Math.random() * STUDENT_NAMES.length)];
        
        // 1. ç¢ºå®šå­¸ç”Ÿè³‡è³ªé¡å‹
        if (typeOverride) {
            this.type = typeOverride;
        } else {
            const r = Math.random();
            if (r < 0.2) this.type = STUDENT_TYPES.HIGH;
            else if (r < 0.7) this.type = STUDENT_TYPES.AVG;
            else this.type = STUDENT_TYPES.LOW;
        }
 
        // 2. --- å‹•æ©Ÿæ¥µä½ (èººå¹³) è¨­å®š ---
        // isOriginalUltraLow: æ¨™è¨˜è©²å­¸ç”Ÿæ˜¯å¦"å¤©ç”Ÿ"å±¬æ–¼èººå¹³æ—ç¾¤ (ç”¨æ–¼å­¸å¹´è½‰æ›æ™‚åˆ¤å®š)
        // isUltraLow: ç•¶å‰çš„ç‹€æ…‹ (å¯èƒ½æœƒè®Š)
        const isTangping = (Math.random() < 0.3);
        this.isOriginalUltraLow = isTangping; 
        this.isUltraLow = isTangping;
        
        this.soloActionCount = 0; 
 
        // 3. ç‰©ç†å®¹é‡èˆ‡é«˜åº¦è¨­å®š
        if (this.type.id === 'low') {
            this.particleCap = 15;
            this.maxCapLimit = Math.floor(Math.random() * 11) + 25;
        } else {
            this.particleCap = 999;
            this.maxCapLimit = 999;
        }
        
        this.baseHeight = 0.8 * this.type.baseScale;
        this.readingHeight = 0;
        this.landedParticles = [];
        this.bubbleOffsetY = (id % 2 === 0) ? 6.5 : 5.0;
 
        // è¦–è¦ºåç§»è¨­å®š
        this.containerOffset = 1.5;
        this.containerBottom = this.containerOffset - 0.5;
 
        // å»ºç«‹ DOM å…ƒç´ 
        this.labelEl = document.createElement('div');
        this.labelEl.className = 'student-label';
        document.getElementById('labels-container').appendChild(this.labelEl);
 
        this.bubbleEl = document.createElement('div');
        this.bubbleEl.className = 'speech-bubble';
        document.getElementById('labels-container').appendChild(this.bubbleEl);
 
        // Three.js ç¾¤çµ„è¨­å®š
        this.group = new THREE.Group();
        this.group.position.set(xPos, 0, 0);
        scene.add(this.group);
        
        // å»ºç«‹ 3D å½¢è±¡ (Avatar)
        this.avatar = this.createAvatar();
        this.group.add(this.avatar);
 
        // å»ºç«‹å®¹å™¨æè³ª
        const typeColor = new THREE.Color(this.type.color);
        this.glassMaterial = new THREE.MeshPhysicalMaterial({
            color: typeColor,
            metalness: 0.1,
            roughness: 0.1,
            transmission: 0.6,
            transparent: true,
            opacity: 0.8,
            side: THREE.DoubleSide
        });
 
        // å®¹å™¨æ¨¡å‹
        this.baseMesh = new THREE.Mesh(new THREE.CylinderGeometry(2, 2, 1, 64, 1, true), this.glassMaterial);
        this.group.add(this.baseMesh);
 
        const bottomCap = new THREE.Mesh(new THREE.CircleGeometry(2, 64), this.glassMaterial);
        bottomCap.rotation.x = -Math.PI/2;
        bottomCap.position.y = this.containerBottom;
        this.group.add(bottomCap);
 
        // é–±è®€ç¶­åº¦æ¨¡å‹
        this.readGroup = new THREE.Group();
        this.group.add(this.readGroup);
 
        this.readMesh = new THREE.Mesh(new THREE.CylinderGeometry(2, 2, 1, 64, 1, true), matGlassRead);
        this.readGroup.add(this.readMesh);
        
        const ring = new THREE.Mesh(new THREE.TorusGeometry(2.05, 0.05, 16, 100), new THREE.MeshStandardMaterial({color: 0x7f8c8d}));
        ring.rotation.x = Math.PI/2;
        this.readGroup.add(ring);
        
        this.updateVisuals(true);
        this.updateLabelText();
    }
 
 createAvatar() {
        const avatarGroup = new THREE.Group();
 
        // èº«é«” (ä¸Šè¡£é¡è‰²ç”±è³‡è³ªæ±ºå®š)
        const bodyGeo = new THREE.CylinderGeometry(0.5, 0.7, 1.4, 16);
        const bodyMat = new THREE.MeshStandardMaterial({ color: this.type.color });
        const body = new THREE.Mesh(bodyGeo, bodyMat);
        body.position.y = 0.7;
        avatarGroup.add(body);
 
        // è¤²å­
        const legGeo = new THREE.CylinderGeometry(0.7, 0.8, 0.8, 16);
        const legMat = new THREE.MeshStandardMaterial({ color: 0x34495e });
        const legs = new THREE.Mesh(legGeo, legMat);
        legs.position.y = 0.2;
        avatarGroup.add(legs);
 
        // é ˜å¸¶
        const tieGeo = new THREE.BoxGeometry(0.3, 0.6, 0.1);
        const tieMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
        const tie = new THREE.Mesh(tieGeo, tieMat);
        tie.position.set(0, 1.0, 0.45);
        avatarGroup.add(tie);
 
        // é ­éƒ¨
        const headGeo = new THREE.SphereGeometry(0.55, 32, 32);
        const headMat = new THREE.MeshStandardMaterial({ color: 0xffccaa });
        const head = new THREE.Mesh(headGeo, headMat);
        head.position.y = 1.6;
        avatarGroup.add(head);
        
        // --- è¦–è¦ºèººå¹³é‚è¼¯ ---
        if (this.isUltraLow) {
            // æ²¿ Z è»¸æ—‹è½‰ 90 åº¦ (ä½¿é ­éƒ¨å‘å·¦å´ï¼Œè…³å‘å³å´ï¼Œé¢æœå‰æ–¹)
            avatarGroup.rotation.z = Math.PI / 2; 
            
            // ä¿®æ­£é«˜åº¦ï¼šåŸæœ¬ -3.8 æœƒæ‰åˆ°åœ°æ¿ (Y=-2) ä¸‹æ–¹å°è‡´å®Œå…¨éš±å½¢
            // æ”¹ç‚º -1.5ï¼Œè®“èº«é«”å´é‚Šå‰›å¥½è²¼é½Šè™›æ“¬åœ°æ¿è¡¨é¢
            avatarGroup.position.y = -1.5; 
            
            // ç²¾ç¢ºä¿®æ­£ä¸­è»¸å°é½Šï¼š
            // é ­éƒ¨(1.6)èˆ‡è…³éƒ¨(0.2)çš„ä¸­å¿ƒå¤§ç´„åœ¨ Y=0.9ã€‚
            // æ—‹è½‰90åº¦å¾Œï¼ŒåŸæœ¬çš„ä¸Šæ–¹æœƒæœå‘ X è»¸è² å‘ã€‚å› æ­¤æˆ‘å€‘éœ€è¦æŠŠæ•´å€‹ç¾¤çµ„å‘ X è»¸æ­£å‘å¹³ç§» 0.9ï¼Œä½¿å…¶å®Œç¾ç½®ä¸­æ–¼å®¹å™¨ä¸‹æ–¹ã€‚
            avatarGroup.position.x = 0.9;  
        } else {
            // ä¸€èˆ¬ç«™ç«‹ç‹€æ…‹
            avatarGroup.position.y = -2.5;
            avatarGroup.position.x = 0;
            avatarGroup.rotation.y = (Math.random() - 0.5) * 0.5;
        }
 
        return avatarGroup;
    }

    
    // ç”¨æ–¼ç‹€æ…‹æ”¹è®Šæ™‚é‡æ–°ç”Ÿæˆ Avatar (èººå¹³ <-> ç«™ç«‹)
    updateAvatarPose() {
        this.group.remove(this.avatar);
        this.avatar = this.createAvatar();
        this.group.add(this.avatar);
    }
    
    getContainerHeight() {
        return this.baseHeight + this.readingHeight;
    }
    
    getRimY() {
        return this.containerBottom + this.getContainerHeight();
    }
    
    getCurrentCapacity() {
        if (this.type.id === 'low') return this.particleCap;
        return Math.floor(this.getContainerHeight() / 0.006);
    }
    
    tryGrowReading(force = false) {
        if (this.isUltraLow && !force) {
            this.shake();
            return false;
        }
 
        if (this.type.id === 'low') {
            if (this.particleCap < this.maxCapLimit) {
                this.particleCap++;
                this.readingHeight += this.type.readGrow;
                this.updateVisuals();
                return true;
            } else {
                this.shake();
                return false;
            }
        }
        
        if (!this.type.canGrow || this.getContainerHeight() >= this.type.maxHeight) {
            this.shake();
            return false;
        }
        this.readingHeight += this.type.readGrow;
        this.updateVisuals();
        return true;
    }
 
    growGrade() {
        if (this.type.id === 'low') {
            if (this.particleCap < this.maxCapLimit) {
                this.particleCap++;
                this.readingHeight += 0.05;
            }
        }
        if (this.getContainerHeight() >= this.type.maxHeight) return;
        const min = this.type.growRate[0], max = this.type.growRate[1];
        let growth = Math.random() * (max - min) + min;
        if (this.getContainerHeight() + growth > this.type.maxHeight) {
            growth = this.type.maxHeight - this.getContainerHeight();
        }
        this.baseHeight += growth;
        this.updateVisuals();
    }
 
    shake() {
        gsap.to(this.group.position, { x: this.xPos + 0.1, duration: 0.05, yoyo: true, repeat: 3 });
    }
    
    updateLabelText() {
        const selectedCount = students.filter(st => st.isSelected !== false).length;
        const isSmallClass = (selectedCount > 0 && selectedCount <= students.length / 2);
        const isTarget = (this.isSelected !== false);
        const bonusHtml = (isSmallClass && isTarget) ? '<span class="x2-indicator">x2</span>' : '';
        
        let typeName = this.type.name;
        let typeColor = this.type.color;
        let soloProgressHtml = "";
 
        // æ ¹æ“šå³æ™‚ç‹€æ…‹ isUltraLow æ±ºå®šé¡¯ç¤ºæ–‡å­—
        if (this.isUltraLow) {
            typeColor = "#666666";
            if (this.type.id === 'high') typeName = "å¤©è³‡è°ç©(èººå¹³)";
            else if (this.type.id === 'avg') typeName = "å¤©è³‡å¹³åº¸(èººå¹³)";
            else typeName = "å¤©è³‡é§‘éˆ(èººå¹³)";
 
            if (this.soloActionCount > 0) {
                soloProgressHtml = `<br><span style="color:#e67e22; font-size:10px; font-weight:bold;">é—œæ³¨ä¸­: ${this.soloActionCount}/3</span>`;
            }
        }
    
        this.labelEl.innerHTML = `
            <span style="font-size:12px; color:#333;">${this.name}</span>${bonusHtml}
            <br>
            <span style="color:${typeColor}">${typeName}</span>: ${this.landedParticles.length}
            ${soloProgressHtml}
        `;
    }
    
    showBubble(text, className, index) {
        this.bubbleEl.innerText = text;
        this.bubbleEl.className = 'speech-bubble ' + className;
        gsap.killTweensOf(this.bubbleEl);
        gsap.set(this.bubbleEl, { opacity: 0, scale: 0.8, display: 'block' });
        const delay = index * 0.15 + Math.random() * 0.5;
        gsap.to(this.bubbleEl, {
            opacity: 1,
            scale: 1,
            duration: 0.4,
            delay: delay,
            ease: "back.out(1.7)"
        });
        gsap.to(this.bubbleEl, {
            opacity: 0,
            scale: 0.8,
            duration: 0.3,
            delay: 3.5 + delay,
            onComplete: () => { this.bubbleEl.style.display = 'none'; }
        });
    }
    
    updateVisuals(instant = false) {
        const dur = instant ? 0 : 0.8;
        gsap.to(this.baseMesh.scale, { y: this.baseHeight, duration: dur });
        gsap.to(this.baseMesh.position, { y: this.containerBottom + (this.baseHeight / 2), duration: dur });
        
        const readH = Math.max(0.01, this.readingHeight);
        gsap.to(this.readGroup.position, { y: this.containerBottom + this.baseHeight, duration: dur });
        gsap.to(this.readMesh.scale, { y: readH, duration: dur });
        gsap.to(this.readMesh.position, { y: readH / 2, duration: dur });
    }
 
    bump() {
        gsap.killTweensOf(this.group.position, "y");
        gsap.fromTo(this.group.position,
            { y: 0 },
            { y: -0.15, duration: 0.05, yoyo: true, repeat: 1, ease: "power1.out" }
        );
    }
 
    dispose() {
        if (this.labelEl) this.labelEl.remove();
        if (this.bubbleEl) this.bubbleEl.remove();
    }
}



// === åˆå§‹åŒ–åœ–ç¤º (å°‡ SVG å¡«å…¥ HTML) ===
function initIcons() {
    document.querySelector('#btn-read .btn-icon').innerHTML = SVGS.read;
    document.querySelector('#btn-fun .btn-icon').innerHTML = SVGS.fun_alt;
    document.querySelector('#btn-plan .btn-icon').innerHTML = SVGS.plan;
    document.querySelector('#btn-drill .btn-icon').innerHTML = SVGS.drill;
    document.querySelector('#btn-hea .btn-icon').innerHTML = SVGS.hea;
    
    document.querySelector('#btn-admin .btn-icon').innerHTML = SVGS.admin;
    document.querySelector('#btn-recover .btn-icon').innerHTML = SVGS.recover;
    document.querySelector('#btn-grade-work .btn-icon').innerHTML = SVGS.grade;
    document.querySelector('#btn-offwork .btn-icon').innerHTML = SVGS.offwork;
    document.querySelector('#btn-next-partial .btn-icon').innerHTML = SVGS.nextYear;
    
    const dseFires = document.querySelectorAll('.dse-fire');
    dseFires.forEach(el => el.innerHTML = SVGS.dse);
    
    const setIcon = (id, svg) => {
        const el = document.querySelector(`#${id} .ow-icon`);
        if(el) el.innerHTML = svg;
    };
    setIcon('btn-ent-dinner', SVGS.food);
    setIcon('btn-ent-movie', SVGS.movie);
    setIcon('btn-ent-shopping', SVGS.shop);
    setIcon('btn-ent-read', SVGS.read); 
    setIcon('btn-ent-sport', SVGS.sport);
    
    // ç¶å®šé£›æ©Ÿåœ–ç¤ºåˆ°æ—…è¡ŒæŒ‰éˆ•
    setIcon('btn-ent-travel', SVGS.plane);
    
    setIcon('btn-do-grade', SVGS.grade);
    
    const iconModal = document.getElementById('modal-icon');
    if(iconModal) iconModal.innerHTML = SVGS.old;
    
    const sentAvatar = document.querySelector('.sent-avatar');
    if(sentAvatar) {
        sentAvatar.innerHTML = SVGS.grad;
        sentAvatar.style.fill = "#fff";
        sentAvatar.style.width = "60px";
        sentAvatar.style.height = "60px";
    }
}

// å‹™å¿…åŸ·è¡Œåˆå§‹åŒ–
initIcons();


// ==========================================
// å°é¢äº’å‹•ç‰¹æ•ˆ (Floating Characters) - å¢é‡ç‰ˆ
// ==========================================
(function initCoverEffect() {
    const container = document.getElementById('floating-chars-container');
    if (!container) return;

    // æ“´å……å­—åº«ï¼ŒåŠ å…¥æ›´å¤šèˆ‡æ•™å­¸ç¾å ´ç›¸é—œçš„å–®å­— (è‹¦ã€ç´¯ã€æ”¹ã€èƒŒ...)
    const chars = [
        "ä¹‹", "ä¹", "è€…", "ä¹Ÿ", "é–±", "è®€", "å¯«", "ä½œ", 
        "è½", "èªª", "å·", "æ”¹", "ç´¯", "å¿™", "å‹¤", "å­¸",
        "å¸«", "é“", "æ–‡", "è¨€", "è©©", "è©", "æ­Œ", "è³¦",
        "æ•™", "è‚²", "å¿ƒ", "åŠ›", "åˆ†", "æ•¸", "è©•", "æ ¸",
        "è‹¦", "è¾£", "é…¸", "ç”œ", "å‚™", "èª²", "é»˜", "æ›¸",
        "å“‰", "ç·´", "è£œ", "ç¿’", "è©¦", "è€ƒ", "ç†¬", "å¤œ"
    ];

    const elements = [];
    
    // å¤§å¹…å¢åŠ æ•¸é‡ï¼šé›»è…¦ç‰ˆ 120 å€‹ï¼Œæ‰‹æ©Ÿç‰ˆ 50 å€‹
    const count = window.innerWidth < 600 ? 50 : 120;

    for (let i = 0; i < count; i++) {
        const span = document.createElement('span');
        span.classList.add('float-char');
        span.innerText = chars[Math.floor(Math.random() * chars.length)];
        
        // --- éš¨æ©Ÿåƒæ•¸è¨­å®š ---
        
        // å¤§å°ï¼šç¯„åœæ‹‰å¤§ (10px - 60px)ï¼Œè£½é€ é è¿‘æ„Ÿ
        const size = Math.random() * 50 + 10; 
        
        // ä½ç½®ï¼šæ•£ä½ˆåœ¨æ•´å€‹ç•«é¢
        const x = Math.random() * 100;
        const y = Math.random() * 100;
        
        // é€æ˜åº¦ï¼šèˆ‡å¤§å°æ›é‰¤ï¼Œè¶Šå¤§çš„å­—é€šå¸¸è¶Šæ·¡ (èƒŒæ™¯æ„Ÿ)ï¼Œè¶Šå°çš„å­—ç¨å¾®æ¸…æ¥šä¸€é»
        // ç¯„åœæ§åˆ¶åœ¨ 0.03 (æ¥µæ·¡) åˆ° 0.15 (å¾®æ·¡) ä¹‹é–“ï¼Œä¿æŒä½èª¿
        let opacity = Math.random() * 0.12 + 0.03;
        if (size > 40) opacity = 0.04; // å¤§å­—å¼·åˆ¶æ›´æ·¡

        // æ·±åº¦ï¼šç”¨æ–¼è¦–å·®æ»¾å‹• (0.1 - 1.0)
        const depth = Math.random() * 0.9 + 0.1;

        // æ‡‰ç”¨æ¨£å¼
        span.style.fontSize = `${size}px`;
        span.style.left = `${x}%`;
        span.style.top = `${y}%`;
        span.style.opacity = opacity;
        span.style.position = 'absolute';
        span.style.userSelect = 'none';
        span.style.color = '#3e3a36';
        
        // éš¨æ©Ÿæ—‹è½‰ (-30åº¦ åˆ° 30åº¦)
        span.style.transform = `rotate(${Math.random() * 60 - 30}deg)`;

        // å­˜å„²è³‡æ–™ä¾›æ»‘é¼ äº’å‹•ä½¿ç”¨
        span.dataset.depth = depth;
        span.dataset.baseX = x;
        span.dataset.baseY = y;

        container.appendChild(span);
        elements.push(span);
    }

    // æ»‘é¼ äº’å‹•ï¼šè¦–å·®æ•ˆæœ
    document.addEventListener('mousemove', (e) => {
        // å„ªåŒ–æ•ˆèƒ½ï¼šå¦‚æœå°é¢éš±è—äº†å°±ä¸è¨ˆç®—
        if (document.getElementById('start-screen').style.display === 'none') return;

        const mouseX = e.clientX / window.innerWidth;
        const mouseY = e.clientY / window.innerHeight;

        elements.forEach(el => {
            const depth = parseFloat(el.dataset.depth);
            
            // è¨ˆç®—ä½ç§»ï¼šæ·±åº¦è¶Šæ·± (é è¿‘1) ç§»å‹•è¶Šå°‘ï¼Œæ·±åº¦è¶Šæ·ºç§»å‹•è¶Šå¤š (éŒ¯è¦º)
            // ä¿‚æ•¸è¨­ç‚º 40ï¼Œè®“ç§»å‹•æ„Ÿæ˜é¡¯ä¸€é»ä½†ä¸éä»½
            const moveX = (mouseX - 0.5) * (40 * depth);
            const moveY = (mouseY - 0.5) * (40 * depth);

            // ä¿æŒåŸæœ¬çš„éš¨æ©Ÿæ—‹è½‰
            const currentRotation = el.style.transform.match(/rotate\(([^)]+)\)/);
            const rotation = currentRotation ? currentRotation[0] : 'rotate(0deg)';

            el.style.transform = `translate(${moveX}px, ${moveY}px) ${rotation}`;
        });
    });
})();


// ==========================================
// 4. å·¥å…·èˆ‡è¨­å®š (è«è˜­è¿ªè‰²ç³» & ç‹€æ…‹ç®¡ç†)
// ==========================================

// è«è˜­è¿ªè‰²ç¥¨ (Morandi Color Palette) - ä½é£½å’Œåº¦ã€é«˜ç´šæ„Ÿ
const MORANDI = [
    0x8C9E9E, // ç°ç¶ 
    0xD5C4A1, // æš–æ²™è‰²
    0xC89F9C, // é«’ç²‰ç´…
    0x8F9E8B, // æ©„æ¬–ç¶ 
    0x6E7C7C, // éµç°
    0xA89B9D, // è—•ç´«
    0xD3D4D0, // é›²ç°
    0xE0CDCF, // æ·ºç²‰ç°
    0x9FA39A, // é¼ å°¾è‰ç¶ 
    0xB5A89D  // å¥¶èŒ¶è‰²
];

function getMorandiColor() {
    return MORANDI[Math.floor(Math.random() * MORANDI.length)];
}

// å¼·åˆ¶æ¸…é™¤é€£æ“Šçµç®— (é˜²æ­¢äº’å‹•æ™‚è·³å‡ºå ±å‘Š)
function clearPendingReports() {
    // 1. æ¸…é™¤é€£æ“Šè¨ˆæ™‚å™¨
    if (batchTimer) {
        clearTimeout(batchTimer);
        batchTimer = null;
    }
    batchSnapshot = null;
    batchTotalCost = 0;
    batchStartHappy = 0;

    // 2. éš±è—å¯èƒ½å­˜åœ¨çš„å ±å‘Šçª—å£
    document.getElementById('report-overlay').style.display = 'none';
}



        
        // ==========================================
        // 3. éŠæˆ²é‚è¼¯èˆ‡äº¤äº’
        // ==========================================
        function startGame(mode) {
            GAME_MODE = mode;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('top-dashboard').style.display = 'flex';
            if (mode === 'partial') {
                document.querySelectorAll('.mode-full-el').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.mode-partial-el').forEach(el => el.classList.remove('hidden'));
                document.getElementById('btn-read').querySelector('.btn-cost').innerText = "-1.0";
                document.getElementById('btn-fun').querySelector('.btn-cost').innerText = "-3.0";
                document.getElementById('btn-plan').querySelector('.btn-cost').innerText = "-3.0";
                document.getElementById('btn-drill').querySelector('.btn-cost').innerText = "-3.0";
            } else {
                document.querySelectorAll('.mode-partial-el').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.mode-full-el').forEach(el => el.classList.remove('hidden'));
            }
            randomizeStudentNeed(); 
            document.getElementById('sel-student-count').value = "5"; 
            initStudents(5); 
            updateUI(); 
            animate();
        }

        function calcMaxEnergy() {
            let base = 10;
            if (TEACHER.age > 25) { base -= (TEACHER.age - 25) * 0.2; }
            TEACHER.maxEnergy = Math.max(2.0, base);
            if(TEACHER.currentEnergy > TEACHER.maxEnergy) TEACHER.currentEnergy = TEACHER.maxEnergy;
        }

        // ä¿®æ”¹ï¼šæ–°å¢ currentEnergy å’Œ currentHappy åƒæ•¸
    // === ä¿®æ”¹å¾Œçš„ createActionReport ===
function createActionReport(energyCost, totalHappyChange, studentChanges, currentEnergy, currentHappy, multiplier) {
    const rptEnergy = document.getElementById('rpt-energy');
    // å¿ƒåŠ›æ¶ˆè€—æ°¸é é¡¯ç¤ºè² è™Ÿ
    rptEnergy.innerHTML = `${currentEnergy.toFixed(1)} <span class="rpt-total val-neg">(-${energyCost.toFixed(1)})</span>`;
    
    const rptHappy = document.getElementById('rpt-happy');
    if (GAME_MODE === 'full') {
        // totalHappyChange æ˜¯æˆ‘å€‘å¾ä¸Šé¢å‚³é€²ä¾†çš„è®Šé‡ï¼ˆä¾‹å¦‚ -10.0ï¼‰
        let sign = totalHappyChange > 0 ? "+" : ""; // å¦‚æœæ˜¯æ­£æ•¸é¡¯ç¤º +ï¼Œè² æ•¸å‰‡æœ¬èº«å¸¶æœ‰ -
        let colorClass = totalHappyChange > 0 ? "val-pos" : (totalHappyChange < 0 ? "val-neg" : "val-neu");
        
        rptHappy.innerHTML = `${Math.floor(currentHappy)} <span class="rpt-total ${colorClass}">(${sign}${totalHappyChange.toFixed(1)})</span>`;
    } else {
        rptHappy.innerText = "-";
    }
    const tag = document.getElementById('rpt-multiplier-tag');
    tag.style.display = (multiplier > 1) ? 'block' : 'none';
    const tbody = document.getElementById('rpt-tbody');
    tbody.innerHTML = '';
    
    studentChanges.forEach(sc => {
        const tr = document.createElement('tr');
        const capacity = sc.student.getCurrentCapacity();
        const current = sc.student.landedParticles.length;
        
        let changeText = sc.added > 0 ? `+${sc.added}` : (sc.added < 0 ? `${sc.added}` : '0');
        if (multiplier > 1 && sc.added > 0) {
            changeText += `<i class="rpt-x2">x2</i>`;
        }
        tr.innerHTML = `
            <td style="color:${sc.student.type.color}; font-weight:bold;">${sc.student.name}</td>
            <td>${current} / ${capacity}</td>
            <td style="${sc.added > 0 ? 'color:green' : (sc.added<0 ? 'color:red':'color:#999')}">${changeText}</td>
        `;
        tbody.appendChild(tr);
    });
    
    document.getElementById('report-overlay').style.display = 'flex';
}

        // ==========================================
// æŒ‰éˆ•éœ‡å‹•è¼”åŠ©å‡½æ•¸
// ==========================================
function triggerButtonShake(btnId) {
    const btn = document.getElementById(btnId);
    if (!btn) return;

    // 1. æ‰‹æ©Ÿè§¸è¦ºéœ‡å‹• (Haptic Feedback)
    // åªæœ‰æ”¯æ´çš„è£ç½® (Android æ‰‹æ©Ÿç­‰) æœƒè§¸ç™¼ï¼ŒiPhone éœ€è¦–ä¹ç€è¦½å™¨æ”¯æ´åº¦
    if (navigator.vibrate) {
        navigator.vibrate(15); // éœ‡å‹• 15 æ¯«ç§’
    }

    // 2. è¦–è¦ºéœ‡å‹• (Visual Shake)
    // æ®ºæ‰èˆŠå‹•ç•«é¿å…è¡çª
    gsap.killTweensOf(btn);
    
    // å¿«é€Ÿå·¦å³éœ‡å‹• (Xè»¸ä½ç§»)
    gsap.fromTo(btn, 
        { x: 0 }, 
        { 
            x: 4, // å‘å³ç§» 4px
            duration: 0.05, 
            repeat: 3, // é‡è¤‡ 3 æ¬¡
            yoyo: true, // å¾€è¿”
            clearProps: "x", // å‹•ç•«çµæŸå¾Œæ¸…é™¤æ¨£å¼ï¼Œé¿å…ä½ç½®è·‘æ‰
            ease: "power1.inOut"
        }
    );
}

// === åœ¨å…¨å±€ç‹€æ…‹å€æ–°å¢é€™ä¸€å€‹è®Šæ•¸ ===
let batchStartHappy = 0;
 
// === ä¿®æ”¹å¾Œçš„ handleAction ===
function handleAction(actionId, cost, happyCost, baseParticles, name, growReading = false) {
    triggerButtonShake('btn-' + actionId);
 
    if (actionId === lastActionType) { consecutiveActionCount++; }
    else { lastActionType = actionId; consecutiveActionCount = 1; }
 
    const isNeed = (actionId === currentNeed);
    let isBored = (consecutiveActionCount >= 4 && !isNeed);
    let effectiveBase = isNeed ? 14 : baseParticles;
 
    const selectedStudents = students.filter(st => st.isSelected !== false);
    const selectedCount = selectedStudents.length;
    const currentMultiplier = (selectedCount > 0 && selectedCount <= students.length / 2) ? 2 : 1;
 
    if (spendEnergy(cost) > 0) {
        if (batchSnapshot === null) {
            batchSnapshot = students.map(s => s.landedParticles.length);
            batchStartHappy = TEACHER.happiness;
            batchTotalCost = 0;
        }
        if (batchTimer) { clearTimeout(batchTimer); batchTimer = null; }
        batchTotalCost += cost;
 
        if (GAME_MODE === 'full') {
            if (happyCost > 0) { changeHappiness(-happyCost); }
            else if (happyCost < 0) { changeHappiness(Math.abs(happyCost)); }
        }
 
        setStatus(name + (isNeed ? " ã€å›æ‡‰éœ€æ±‚ã€‘" : ""));
        
        students.forEach(s => {
    const isSoloTarget = (selectedCount === 1 && selectedStudents[0] === s);
    
    if (isSoloTarget) {
        if (s.isUltraLow) {
            // --- æ ¸å¿ƒé‚è¼¯ï¼šå¦‚æœå–®ç¨å—çœ¾æ˜¯å‹•æ©Ÿæ¥µä½å­¸ç”Ÿï¼Œä¸”ç›®å‰è¡Œå‹•æ˜¯ã€Œé–±è®€ã€ ---
            if (actionId === 'read') {
                // å¼·åˆ¶å…è¨±å¢åŠ é«˜åº¦ï¼ˆ1æ¬¡é–±è®€ = 1æ¬¡é«˜åº¦å¢åŠ ï¼‰
                s.tryGrowReading(true);
            }
            
            s.soloActionCount++;
            
            if (s.soloActionCount >= 3) {
                s.soloActionCount = 0;
                // 3æ¬¡å¾Œçš„ç‰¹æ®Šçå‹µï¼ˆ5å€‹ç²’å­ï¼‰
                for(let i=0; i<5; i++) {
                    setTimeout(() => spawnDirectLandedParticle(s, true), i * 100);
                }
                s.showBubble("è€å¸«ç«Ÿç„¶ç‰¹åœ°ç‚ºæˆ‘æº–å‚™...", "bubble-high", 0);
                changeHappiness(5);
            }
        }
    } else {
        s.soloActionCount = 0; // è‹¥ä¸æ˜¯å”¯ä¸€å—çœ¾ï¼Œé‡ç½®è¨ˆæ•¸
    }
});
 
        let currentClickMaxDelay = 0;
        const physicsFallTime = 2500;
 
        students.forEach((s, idx) => {
            if (s.isSelected === false) return;
 
            let particlesToSpawn = isBored ? 1 : (isNeed ? Math.ceil(effectiveBase * 1.2) : effectiveBase);
            particlesToSpawn *= currentMultiplier;
 
            // --- ä¿®æ­£é–±è®€é‚è¼¯ï¼šå‹•æ©Ÿæ¥µä½å­¸ç”Ÿä¸å¢åŠ å…ƒç´  ---
            if (actionId === 'read') {
                for(let m=0; m < currentMultiplier; m++) {
                    s.tryGrowReading(); 
                    if (!s.isUltraLow) {
                        spawnDirectLandedParticle(s);
                    }
                }
            }
 
            if (particlesToSpawn > 0) {
                const interval = growReading ? 30 : 0;
                const spawnDuration = (particlesToSpawn - 1) * interval;
                if (spawnDuration + physicsFallTime > currentClickMaxDelay) {
                    currentClickMaxDelay = spawnDuration + physicsFallTime;
                }
                for(let i=0; i < particlesToSpawn; i++) {
                    setTimeout(() => spawnParticle(actionId, s), i * interval);
                }
            }
            triggerStudentDialogue(s, actionId, idx);
        });
 
        if (actionId !== 'hea') randomizeStudentNeed();
 
        batchTimer = setTimeout(() => {
            const studentChanges = students.map((s, index) => ({
                student: s,
                added: s.landedParticles.length - batchSnapshot[index]
            }));
            const totalHappyNetChange = TEACHER.happiness - batchStartHappy;
            createActionReport(batchTotalCost, totalHappyNetChange, studentChanges, TEACHER.currentEnergy, TEACHER.happiness, currentMultiplier);
            batchSnapshot = null; batchTimer = null; batchTotalCost = 0; batchStartHappy = 0;
        }, currentClickMaxDelay);
    }
}
 

        
     function randomizeStudentNeed() {
    const r = Math.random();
    const dot = document.getElementById('need-dot');
    const txt = document.getElementById('need-text');

    if (r < 0.5) {
        currentNeed = 'read'; 
        // æ’å…¥ SVG èˆ‡æ–‡å­—
        txt.innerHTML = `<span style="display:inline-block; width:16px; height:16px; margin-right:5px; vertical-align:middle;">${SVGS.read}</span> å¢åŠ é–±è®€é‡`;
        // è¨­å®šé¡è‰²
        txt.style.color = "var(--accent-read)"; 
        dot.style.background = "var(--accent-read)";
        // å¼·åˆ¶ SVG é¡è‰²
        txt.querySelector('svg').style.fill = "var(--accent-read)";
    } else {
        const choices = [
            { id: 'fun', label: 'è¨­è¨ˆè¶£å‘³æ•™å­¸', color: 'var(--accent-fun)', svg: SVGS.fun_alt },
            { id: 'plan', label: 'èªçœŸæˆèª²', color: 'var(--accent-plan)', svg: SVGS.plan },
            { id: 'drill', label: 'è©¦é¡Œæ“ç·´', color: 'var(--accent-drill)', svg: SVGS.drill }
        ];
        const choice = choices[Math.floor(Math.random() * choices.length)];
        currentNeed = choice.id; 
        
        txt.innerHTML = `<span style="display:inline-block; width:16px; height:16px; margin-right:5px; vertical-align:middle;">${choice.svg}</span> ${choice.label}`;
        txt.style.color = choice.color; 
        dot.style.background = choice.color;
        // å¼·åˆ¶ SVG é¡è‰²
        txt.querySelector('svg').style.fill = choice.color;
    }
}

        // ç¶å®šæŒ‰éˆ•
        document.getElementById('btn-read').addEventListener('click', () => handleAction('read', 1.0, 1, 14, "å¢åŠ é–±è®€é‡ï¼šæå‡ç¶­åº¦ï¼", true));
        document.getElementById('btn-fun').addEventListener('click', () => handleAction('fun', 3.0, 2, 8, "è¨­è¨ˆè¶£å‘³æ•™å­¸ï¼šæ°£æ°›æ´»èºã€‚"));
        document.getElementById('btn-plan').addEventListener('click', () => handleAction('plan', 3.0, 2, 8, "èªçœŸå‚™èª²ï¼šçŸ¥è­˜å‚³éã€‚"));
        document.getElementById('btn-drill').addEventListener('click', () => handleAction('drill', 3.0, 2, 10, "è©¦é¡Œæ“ç·´ï¼šæ©Ÿæ¢°å¼è¨“ç·´ã€‚"));
        document.getElementById('btn-hea').addEventListener('click', () => handleAction('hea', 0.5, -1, 2, "æ‘¸é­šæ•™å­¸ï¼šå¾—éä¸”éã€‚", false));
        
        // DSE æˆç¸¾è¡¨èˆ‡æ„Ÿè¨€é‚è¼¯ (Constraint 5)
       document.getElementById('btn-dse').addEventListener('click', () => {
    isDseMode = true;
    
    // è¨­å®š SVG (è€äºº/æ ¡é•·)
    const iconEl = document.getElementById('modal-icon');
    iconEl.innerHTML = SVGS.old;
    iconEl.querySelector('svg').style.fill = "#333";

    document.getElementById('modal-title').innerText = "æ•™è·å“¡æœƒè­°";
    
    // è¨ˆç®—æˆç¸¾ (å·²ä¿®æ­£ getTotalHeight éŒ¯èª¤)
    let studentsData = students.map(s => {
        const h = s.getContainerHeight(); 
        const score = getDSEScore(h);
        return { student: s, h: h, score: score, knowledge: s.landedParticles.length };
    });
    
    studentsData.sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        return b.knowledge - a.knowledge;
    });

    const dseContainer = document.getElementById('dse-results');
    dseContainer.innerHTML = '';
    const table = document.createElement('table');
    table.className = 'dse-table';
    table.innerHTML = `<thead><tr><th>æ’å</th><th>å§“å</th><th>æˆç¸¾</th><th>ç¶­åº¦</th><th>çŸ¥è­˜</th></tr></thead><tbody></tbody>`;
    const tbody = table.querySelector('tbody');
    
    let totalScore = 0;
    const scoreLabels = ['U', 'LV1', 'LV2', 'LV3', 'LV4', 'LV5', 'LV5*', 'LV5**'];

    studentsData.forEach((d, i) => {
        totalScore += d.score;
        const tr = document.createElement('tr');
        tr.onclick = () => showStudentSentiment(d.student, d.score);
        const gradeLabel = scoreLabels[d.score];
        let gradeColor = d.score <= 2 ? '#c0392b' : (d.score >= 5 ? '#27ae60' : '#333');
        
        tr.innerHTML = `
            <td class="dse-rank">${i+1}</td>
            <td>${d.student.name} <span style="font-size:10px; color:${d.student.type.color}">(${d.student.type.name})</span></td>
            <td><span class="dse-grade" style="color:${gradeColor}; border:1px solid ${gradeColor}">${gradeLabel}</span></td>
            <td>${d.h.toFixed(1)}</td>
            <td>${d.knowledge}</td>
        `;
        tbody.appendChild(tr);
    });
    dseContainer.appendChild(table);
    
    const pMsg = document.createElement('div');
    pMsg.style.fontSize = '12px'; pMsg.style.color = '#7f8c8d'; pMsg.style.marginTop = '5px';
    pMsg.innerText = "(é»æ“Šå­¸ç”Ÿå¯æŸ¥çœ‹æ„Ÿè¨€)";
    dseContainer.prepend(pMsg);

    const avgScore = totalScore / students.length;
    const msg = avgScore >= 4 
        ? "ã€Œåšå¾—å¥½ï¼é€™æ¬¡ DSE æˆç¸¾ååˆ†äº®éº—ï¼Œé€™å……åˆ†è­‰æ˜äº†<b>æˆ‘æ ¡ç­–ç•¥è¡Œä¹‹æœ‰æ•ˆ</b>ï¼åŒäº‹å€‘åªè¦ç·Šéš¨å­¸æ ¡çš„ç™¼å±•æ–¹å‘ï¼Œå®šèƒ½å¸¶é ˜å­¸ç”Ÿå†å‰µé«˜å³°ï¼ä¾†å¹´æˆ‘å€‘ç¹¼çºŒå¢åŠ è£œèª²ï¼ã€" 
        : "ã€Œçœ‹åˆ°é€™æ¨£çš„æˆç¸¾ï¼Œæˆ‘ç¨å¾®æœ‰é»æ“”å¿ƒã€‚<b>æˆ‘çš„æ„æ€ä¸æ˜¯èªªåŒäº‹ä½ æ²’æœ‰ç›¡åŠ›</b>ï¼Œæˆ‘ç›¸ä¿¡å¤§å®¶éƒ½ä»˜å‡ºäº†æ™‚é–“ã€‚ä½†å®¢è§€æ•¸æ“šåæ˜ å‡ºï¼Œ<b>å­¸ç”Ÿçš„æ½›èƒ½å°šæœªè¢«å®Œå…¨ç™¼æ®</b>ã€‚ä¾†å¹´æˆ‘å€‘ç¹¼çºŒå¢åŠ è£œèª²ï¼Œä»¥å›æ‡‰å­¸ç”Ÿçš„å­¸ç¿’éœ€è¦ï¼ã€";
    
    document.getElementById('principal-msg').innerHTML = msg;
    
    const restartBtn = document.getElementById('btn-restart');
    restartBtn.innerText = "é€åˆ¥ç•¢æ¥­ç”Ÿ (è¿æ¥ä¸‹ä¸€å±†)";
    restartBtn.onclick = startNextBatch; 
    restartBtn.style.background = "var(--accent-plan)"; 

    document.getElementById('btn-close-modal').style.display = 'block'; 
    document.getElementById('modal-overlay').style.display = 'flex';
});

        function getDSEScore(totalHeight) {
            const roll = Math.random();
            // ç°¡åŒ–åˆ†æ•¸è¨ˆç®—ï¼š1-7åˆ†
            if (totalHeight < 1.5) { return roll < 0.7 ? 1 : (roll < 0.95 ? 2 : 3); }
            else if (totalHeight < 3.5) { return roll < 0.3 ? 2 : (roll < 0.7 ? 3 : (roll < 0.95 ? 4 : 5)); }
            else { return roll < 0.2 ? 4 : (roll < 0.6 ? 5 : (roll < 0.9 ? 6 : 7)); }
        }

      function showStudentSentiment(student, score) {
            let sentiment = "";
            let category = "";
            const type = student.type.id; 

            if (type === 'high') {
                category = "æ­£é¢æ„Ÿè¨€";
                sentiment = SENTIMENTS.positive[Math.floor(Math.random() * SENTIMENTS.positive.length)];
            } else if (type === 'avg') {
                if (Math.random() < 0.5) {
                    category = "è² é¢æ€¨è¨€";
                    sentiment = SENTIMENTS.negative[Math.floor(Math.random() * SENTIMENTS.negative.length)];
                } else {
                    category = "è‡ªæˆ‘åçœ";
                    sentiment = SENTIMENTS.reflection[Math.floor(Math.random() * SENTIMENTS.reflection.length)];
                }
            } else if (type === 'low') {
                if (Math.random() < 0.8) {
                    category = "è² é¢æ€¨è¨€";
                    sentiment = SENTIMENTS.negative[Math.floor(Math.random() * SENTIMENTS.negative.length)];
                } else {
                    category = "è‡ªæˆ‘åçœ";
                    sentiment = SENTIMENTS.reflection[Math.floor(Math.random() * SENTIMENTS.reflection.length)];
                }
            }

            // æ›´æ–° UI
            document.getElementById('sent-header-bg').style.backgroundColor = student.type.color;
            document.getElementById('sent-name').innerText = student.name;
            document.getElementById('sent-type').innerText = student.type.name;
            document.getElementById('sent-category').innerText = category;
            
            // æ ¹æ“šé¡åˆ¥æ”¹è®Šé¡åˆ¥æ–‡å­—é¡è‰²
            const catEl = document.getElementById('sent-category');
            if(category.includes('è² é¢')) catEl.style.color = '#c0392b';
            else if(category.includes('æ­£é¢')) catEl.style.color = '#27ae60';
            else catEl.style.color = '#f39c12';

            document.getElementById('sent-text').innerText = sentiment;
            
            // é¡¯ç¤ºè¦–çª—
            document.getElementById('sentiment-overlay').style.display = 'flex';
        }

        // åˆå§‹åŒ–èˆ‡å…¶ä»–å¿…è¦å‡½æ•¸ (ä¿æŒåŸçµæ§‹)
       // ==========================================
// ==========================================
// æ›¿æ› 1ï¼šå­¸ç”Ÿåˆå§‹åŒ– (ç§»é™¤å¼·åˆ¶é è¨­è³‡è³ªå·®å­¸ç”Ÿçš„è¨­å®š)
// ==========================================
function initStudents(count) {
    students.forEach(s => { scene.remove(s.group); s.dispose(); });
    students = []; 
    particles.forEach(p => scene.remove(p)); 
    particles = [];
    
    const spacing = 5.0, startX = -((count - 1) * spacing) / 2;
    let types = [];
    
    // å®Œå…¨æ ¹æ“šæ©Ÿç‡éš¨æ©Ÿç”Ÿæˆï¼Œä¸å†å¼·åˆ¶é è¨­æœ€å°‘ 2 å€‹ LOW
    for(let k = 0; k < count; k++) {
        const r = Math.random();
        // 20% é«˜è³‡è³ª, 40% ä¸­ç­‰è³‡è³ª, 40% å·®è³‡è³ª (å¯è‡ªç”±èª¿æ•´æ©Ÿç‡)
        if (r < 0.2) types.push(STUDENT_TYPES.HIGH); 
        else if (r < 0.6) types.push(STUDENT_TYPES.AVG); 
        else types.push(STUDENT_TYPES.LOW);
    }
    
    for (let i = 0; i < count; i++) { 
        students.push(new Student(i, startX + i * spacing, types.length > i ? types[i] : null)); 
    }
    
    updateCamera(count);
}


        function updateCamera(count) {
            const isMobile = window.innerWidth < 800;
            const targetY = isMobile ? 13.0 : 9.0;
            const zDist = (isMobile ? 40 : 28) + (count * 5.5); 
            gsap.to(controls.target, { x: 0, y: targetY, z: 0, duration: 1.0 });
            gsap.to(camera.position, { x: 0, y: 15, z: zDist, duration: 1.0, onUpdate: () => controls.update() });
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight); updateCamera(students.length);
        });

        function spawnParticle(type, student) {
    // --- ä¿®æ”¹ï¼šå‹•æ©Ÿæ¥µä½çš„å­¸ç”Ÿ 100% æ’æ–¥æ‰€æœ‰å…ƒç´  ---
    const isRejected = student.isUltraLow ? true : (Math.random() < student.type.rejectRate);
    
    let color = CONFIG.colors.pPlan; let geo = new THREE.BoxGeometry(0.22, 0.22, 0.22);
    if (type === 'read') { color = CONFIG.colors.pRead; geo = new THREE.IcosahedronGeometry(0.18, 0); }
    else if (type === 'fun') { color = CONFIG.colors.pFun; geo = new THREE.DodecahedronGeometry(0.20, 0); }
    else if (type === 'drill') { color = CONFIG.colors.pDrill; geo = new THREE.TetrahedronGeometry(0.25); }
    else if (type === 'hea') { color = CONFIG.colors.pHea; geo = new THREE.SphereGeometry(0.15, 8, 8); }
    
    if (isRejected) color = CONFIG.colors.pReject;
    
    const p = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ color: color, roughness: 0.4 }));
    p.position.set(student.xPos + (Math.random()-0.5)*0.8, student.getRimY() + 8 + Math.random()*3, (Math.random()-0.5)*0.8);
    let vx = (Math.random()-0.5)*0.05, vz = (Math.random()-0.5)*0.05;
    p.userData = { vel: new THREE.Vector3(vx, -0.25, vz), student: student, state: 'falling', rejected: isRejected };
    scene.add(p); particles.push(p);
}

     function spawnDirectLandedParticle(student, isSpecialReward = false) {
    const rimY = student.getRimY();
    
    // åªæœ‰ç‰¹æ®Šçå‹µ (é—œæ³¨ 3 æ¬¡æˆ–è€å¸«æ¢å¾©å¿ƒåŠ›) æ‰èƒ½çªç ´å‹•æ©Ÿæ¥µä½å­¸ç”Ÿçš„é˜²ç·š
    if (student.isUltraLow && !isSpecialReward) return;
    
    // LOW é¡å‹çš„å®¹é‡é™åˆ¶
    if (student.type.id === 'low' && student.landedParticles.length >= student.particleCap) return;
    
    const currentFillHeight = student.containerBottom + (student.landedParticles.length * 0.006);
    if (currentFillHeight > rimY) return;
    
    const colors = [CONFIG.colors.pPlan, CONFIG.colors.pDrill, CONFIG.colors.pFun];
    const p = new THREE.Mesh(
        new THREE.BoxGeometry(0.22, 0.22, 0.22),
        new THREE.MeshStandardMaterial({ color: colors[Math.floor(Math.random() * colors.length)] })
    );
    
    const r = Math.random() * 1.5, theta = Math.random() * Math.PI * 2;
    const landY = student.containerBottom + (student.landedParticles.length * 0.006) + Math.random() * 0.1;
    
    p.position.set(student.xPos + r * Math.cos(theta), landY, r * Math.sin(theta));
    p.userData = { student: student, state: 'landed' };
    
    scene.add(p);
    particles.push(p);
    student.landedParticles.push(p);
    student.updateLabelText();
}
        // è¼”åŠ© UI å‡½æ•¸
        function setStatus(text, isError=false) {
            const el = document.getElementById('status-text');
            el.innerText = text; el.className = isError ? "warning-text" : "";
            el.style.color = isError ? 'var(--accent-dse)' : 'var(--accent-plan)';
        }
       // === ä¿®æ”¹å¾Œçš„ changeHappiness ===
function changeHappiness(amount) {
    if (GAME_MODE === 'partial') return;
    TEACHER.happiness += amount;
    if (TEACHER.happiness > TEACHER.maxHappiness) TEACHER.happiness = TEACHER.maxHappiness;
    TEACHER.dailyStats.happyChange += amount;
    
    updateUI(); // æ›´æ–°ä¸»ç•Œé¢
    
    // å¦‚æœä¸‹ç­/æš‘å‡çª—å£é–‹å•Ÿä¸­ï¼ŒåŒæ­¥æ›´æ–°
    if (document.getElementById('offwork-overlay').style.display === 'flex') {
        const owHappy = document.getElementById('ow-happy');
        if(owHappy) {
            owHappy.innerText = Math.floor(TEACHER.happiness);
            owHappy.style.color = TEACHER.happiness < 30 ? 'var(--accent-dse)' : 'var(--accent-happy)';
        }
    }
}
 
// ==========================================
// 1. ä¸‹ç­ç‹€æ…‹æ›´æ–°èˆ‡å¨›æ¨‚å…¥å£
// ==========================================

// ==========================================
// 1. ä¸‹ç­ç‹€æ…‹æ›´æ–°èˆ‡å¨›æ¨‚å…¥å£
// ==========================================

// ==========================================
// 1. ä¸‹ç­ç‹€æ…‹æ›´æ–°èˆ‡å¨›æ¨‚å…¥å£ (ä¿®å¾©ç‰ˆ)
// ==========================================

function updateOffWorkUI() {
    document.getElementById('ow-energy').innerText = TEACHER.offWorkEnergy;
    document.getElementById('ow-happy').innerText = Math.floor(TEACHER.happiness);
    document.getElementById('ow-happy').style.color = TEACHER.happiness < 30 ? 'var(--accent-dse)' : 'var(--accent-happy)';
    
    document.getElementById('tag-late').style.display = TEACHER.hasEntertainedTonight ? 'inline-block' : 'none';
    
    const entButtons = document.querySelectorAll('.ow-btn-grid .ow-btn');
    const isOutOfEnergy = (TEACHER.offWorkEnergy < 1);
    
    entButtons.forEach(btn => {
        // é‡å°æ—…è¡ŒæŒ‰éˆ•ï¼šéœ€è¦ 5 é»å¿ƒåŠ›æ‰èƒ½å‡ºç™¼ (å³æš‘å‡å°ˆå±¬)
        if (btn.id === 'btn-ent-travel') {
            if (TEACHER.offWorkEnergy < 5 || TEACHER.hasEntertainedTonight) btn.classList.add('disabled-ow-btn');
            else btn.classList.remove('disabled-ow-btn');
            return;
        }

        if (isOutOfEnergy || TEACHER.hasEntertainedTonight) {
            btn.classList.add('disabled-ow-btn');
        } else {
            btn.classList.remove('disabled-ow-btn');
        }
    });

    const slider = document.getElementById('rng-grading');
    if(slider) {
        slider.max = TEACHER.gradingPile;
        slider.value = 0;
        slider.disabled = TEACHER.gradingPile === 0;
    }
    
    updateGradingPreview();
}

        
       function spendEnergy(maxCost) {
            // å¦‚æœå·²ç¶“å®Œå…¨æ²’åŠ› (å°æ–¼ 0.05 è¦–ç‚º 0)ï¼Œå‰‡ç¦æ­¢è¡Œå‹•ï¼Œå›å‚³ 0 è¡¨ç¤ºå¤±æ•—
            if (TEACHER.currentEnergy <= 0.05) return 0;

            let actualCost = maxCost;

            // åˆ¤æ–·æ˜¯å¦é€æ”¯
            if (TEACHER.currentEnergy < maxCost) {
                // è¨ˆç®—å·®é¡ (é€æ”¯é‡)
                const deficit = maxCost - TEACHER.currentEnergy;
                
                // ç´¯ç©å‚µå‹™
                TEACHER.energyDebt += deficit;
                
                // å¿ƒåŠ›æ­¸é›¶
                TEACHER.currentEnergy = 0;
                
                // é¡¯ç¤ºè­¦å‘Š
                setStatus(`ç²¾åŠ›é€æ”¯ï¼æ–°å¢æ¬ å‚µ ${deficit.toFixed(1)} (ç¸½æ¬ : ${TEACHER.energyDebt.toFixed(1)})`, true);
            } else {
                // è¶³å¤ æ”¯ä»˜ï¼Œæ­£å¸¸æ‰£é™¤
                TEACHER.currentEnergy -= maxCost;
            }

            // é‚Šç•Œæª¢æŸ¥
            if(TEACHER.currentEnergy < 0) TEACHER.currentEnergy = 0;
            
            updateUI();
            
            // å›å‚³åŸæœ¬çš„æ¶ˆè€—é‡ï¼Œå‘Šè¨´ç³»çµ±ã€Œè¡Œå‹•å·²åŸ·è¡Œã€(å³ä½¿æ˜¯é€æ”¯åŸ·è¡Œ)
            return actualCost;
        }
   function updateUI() {
    // 1. é¡¯ç¤ºå¹´é½¡
    if (!document.getElementById('disp-age').querySelector('input')) {
        document.getElementById('disp-age').innerText = TEACHER.age;
    }
    
    // 2. é¡¯ç¤ºå¿ƒåŠ›èˆ‡å‚µå‹™
    const energyEl = document.getElementById('disp-energy');
    if (TEACHER.energyDebt > 0) {
        energyEl.innerHTML = `0.0 <span style="font-size:11px; color:var(--accent-dse);">(-${TEACHER.energyDebt.toFixed(1)})</span>`;
        energyEl.style.color = 'var(--accent-dse)';
    } else {
        energyEl.innerText = TEACHER.currentEnergy.toFixed(1);
        energyEl.style.color = 'var(--accent-plan)';
    }
 
    // 3. é¡¯ç¤ºå¹´ç´šèˆ‡è¡Œæ”¿æˆæœ¬
    document.getElementById('disp-grade').innerText = GRADES[currentGradeIndex];
    const adminCost = parseFloat(document.getElementById('rng-admin').value);
    document.getElementById('val-admin').innerText = adminCost.toFixed(1);
    
    // 4. æ›´æ–°æ¯ä½å­¸ç”Ÿçš„æ¨™ç±¤ (ä¾‹å¦‚é€æ˜åº¦æˆ–å…§å®¹)
    students.forEach(s => s.updateLabelText());
 
    // 5. æŒ‰éˆ•ç‹€æ…‹æ§åˆ¶
    const canAct = TEACHER.currentEnergy > 0.05;
    document.getElementById('btn-read').disabled = !canAct;
    document.getElementById('btn-fun').disabled = !canAct;
    document.getElementById('btn-plan').disabled = !canAct;
    document.getElementById('btn-drill').disabled = !canAct;
    document.getElementById('btn-admin').disabled = hasDoneAdmin;
    
    const isS6 = (currentGradeIndex === 5);
    const isEnergyDepleted = (TEACHER.currentEnergy <= 0.05);
    document.getElementById('btn-dse').style.display = (isS6 && isEnergyDepleted) ? 'block' : 'none';
 
    if (GAME_MODE === 'partial') {
        document.getElementById('disp-recover').innerText = `${TEACHER.recoveriesLeft}/3`;
        const needsRecover = (TEACHER.currentEnergy < TEACHER.maxEnergy) || (TEACHER.energyDebt > 0);
        document.getElementById('btn-recover').disabled = TEACHER.recoveriesLeft <= 0 || !needsRecover || (isS6 && isEnergyDepleted);
        const canNextYear = hasDoneAdmin && (TEACHER.recoveriesLeft <= 0) && (currentGradeIndex < 5) && !isDseMode;
        document.getElementById('btn-next-partial').disabled = !canNextYear;
    } else {
        document.getElementById('disp-workload').innerText = TEACHER.gradingPile;
        document.getElementById('disp-days').innerText = `${TEACHER.daysInYear}/3`;
        const happyEl = document.getElementById('disp-happy');
        happyEl.innerText = Math.floor(TEACHER.happiness);
        happyEl.style.color = TEACHER.happiness < 30 ? 'var(--accent-dse)' : 'var(--accent-happy)';
        
        if (TEACHER.happiness <= 0) { showGameOver("ä½ å› ç‚ºå£“åŠ›éå¤§ï¼Œå¿ƒç†å´©æ½°è€Œè¾­è·äº†ã€‚"); return; }
        
        document.getElementById('btn-offwork').style.display = (TEACHER.currentEnergy < 1.0 && !isDseMode) ? 'flex' : 'none';
        document.getElementById('btn-grade-work').disabled = (TEACHER.gradingPile <= 0) || !canAct;
        document.getElementById('btn-hea').disabled = !canAct;
    }
}
        // å°è©±ç³»çµ±
        const DIALOGUES = {
            read: { positive: ["è€å¸«æ¨è–¦å‘¢æœ¬æ›¸å¥½æœ‰æ·±åº¦ï¼", "åŸä¾†é–±è®€å¯ä»¥å’æœ‰è¶£ï¼", "æˆ‘è¦ºå¾—æˆ‘å˜…èªæ–‡æ ¹åŸºç´®å¯¦å’—ã€‚"], complaint: ["å¥½å¤šå­—å‘€ï¼Œç‡åˆ°çœ¼èŠ±...", "é˜¿sirï¼Œå¥½æ‚¶å‘€...", "ç‡å‘¢å•²æœ‰åˆ†åŠ å’©ï¼Ÿ"], reflection: ["é›–ç„¶å­—å¤šï¼Œä½†åŸä¾†å¹¾æœ‰é“ç†ã€‚", "å¿è€ä¸‹ç‡å®Œä½¢ï¼Œå¯èƒ½æœ‰ç”¨ã€‚", "è©¦ä¸‹éœå¿ƒç‡ä¸‹..."] },
            fun: { positive: ["å’æ¨£å­¸ä¸­æ–‡çœŸä¿‚å¥½æ­£ï¼", "å°è±¡æ·±åˆ»ï¼", "è€å¸«å¥½æœ‰å‰µæ„ï¼"], complaint: ["ç©å®Œå°±ç®—ï¼Œå­¸å””åˆ°å˜¢ã€‚", "å¥½å˜ˆå‘€ï¼Œæ ¹æœ¬å°ˆå¿ƒå””åˆ°ã€‚", "ç›´æ¥æ•™æ›¸å•¦ï¼Œæå’å¤šèŠ±è‡£ã€‚"], reflection: ["é›–ç„¶ä¼¼ç©ï¼Œä½†éƒ½æœ‰å­¸åˆ°å˜¢ã€‚", "è¼•é¬†ä¸‹éƒ½å¥½å˜…ã€‚", "éƒ½å¥½éç¡¬é‚¦é‚¦åå–ºåº¦ã€‚"] },
            plan: { positive: ["ç­†è¨˜å¥½è©³ç›¡ï¼Œå¤šè¬è€å¸«ï¼", "è€å¸«è§£é‡‹å¾—å¥½æ¸…æ™°ï¼", "ä¸€ç†é€šç™¾ç†æ˜ã€‚"], complaint: ["è¬›å’å¿«é‚Šå€‹æŠ„å¾—åˆ‡å‘€ï¼Ÿ", "å¥½é•·æ°£å‘€...", "è¬›å®Œæœªå‘€ï¼Ÿ"], reflection: ["é›–ç„¶æ‚¶ï¼Œä½†å‘¢å•²ä¿‚ä¹¾è²¨ã€‚", "æŠ„ä½å…ˆï¼Œè€ƒè©¦å¯èƒ½å‡ºã€‚", "è€å¸«éƒ½ä¿‚æƒ³æˆ‘åœ°æ˜ã€‚"] },
            drill: { positive: ["é€™æ¢é¡Œç›®å¾ˆæœ‰æŒ‘æˆ°æ€§ï¼", "æˆ‘çµ‚æ–¼æ˜ç™½DSEå‡ºé¡Œæ¨¡å¼ã€‚", "ç†Ÿèƒ½ç”Ÿå·§ï¼Œåšå¤šå¹¾æ¢ï¼"], complaint: ["åˆä¿‚åšå·ï¼Ÿå¥½æ‚¶å‘€...", "é€™æ¢é¡Œç›®é›£åˆ°ç™²ã€‚", "åšå®Œéƒ½å””çŸ¥å•±å®šéŒ¯ï¼Œå¹¾æ™‚æ”¹ï¼Ÿ"], reflection: ["é›–ç„¶ä¸æƒ³åšï¼Œä½†ç‚ºäº†è€ƒè©¦...", "åšå¤šæ¢å¯èƒ½åŠ å¤šä¸€åˆ†ã€‚", "å”¯æœ‰æ­»æ“çˆ›æ“ã€‚"] },
            hea: { positive: ["é˜¿Sirä»Šæ—¥å¿ƒæƒ…å¥½ä¼¼å¹¾è¼•é¬†ã€‚", "ç„¡åŠŸèª²ï¼Ÿæ­£å‘€ï¼", "è‡ªä¿®æœ€å¥½ï¼Œæˆ‘å¯ä»¥æº«å…¶ä»–ç§‘ã€‚"], complaint: ["é˜¿Sirä½ ä¿‚å’ªç„¡å‚™èª²ï¼Ÿ", "äº¤å­¸è²»é»è‡ªä¿®ï¼Ÿ", "å­¸å””åˆ°é‡å›‰..."], reflection: ["è€å¸«å¯èƒ½å¤ªæ”°å•¦ã€‚", "è‡ªå·±æº«æ›¸ç®—æ•¸ã€‚", "å’æ¨£éä¸€å ‚éƒ½å¹¾å¥½ã€‚"] }
        };

        function triggerStudentDialogue(student, actionId, index) {
            let text = "", bubbleClass = "";
            const opts = DIALOGUES[actionId];
            let isPositive = false, isComplaint = false;
            if (actionId === 'hea') {
                const r = Math.random();
                if (r < 0.3) { text = opts.positive[Math.floor(Math.random()*opts.positive.length)]; bubbleClass = "bubble-hea"; }
                else if (r < 0.6) { text = opts.reflection[Math.floor(Math.random()*opts.reflection.length)]; bubbleClass = "bubble-hea"; }
                else { text = opts.complaint[Math.floor(Math.random()*opts.complaint.length)]; bubbleClass = "bubble-hea"; }
            } else {
                if (student.type === STUDENT_TYPES.HIGH) { text = opts.positive[Math.floor(Math.random()*opts.positive.length)]; bubbleClass = "bubble-high"; isPositive = true; }
                else if (student.type === STUDENT_TYPES.LOW) { text = opts.complaint[Math.floor(Math.random()*opts.complaint.length)]; bubbleClass = "bubble-complaint"; isComplaint = true; }
                else { if (Math.random() < 0.7) { text = opts.complaint[Math.floor(Math.random()*opts.complaint.length)]; bubbleClass = "bubble-complaint"; isComplaint = true; } else { text = opts.reflection[Math.floor(Math.random()*opts.reflection.length)]; bubbleClass = "bubble-reflect"; } }
            }
            student.showBubble(text, bubbleClass, index);
            if(GAME_MODE === 'full') {
                if(isPositive) changeHappiness(1);
                else if (isComplaint && TEACHER.dailyStats.complaintLoss < 15) { changeHappiness(-2); TEACHER.dailyStats.complaintLoss += 2; }
            }
        }

        // å…¶é¤˜é‚è¼¯ (Age, Admin, Grade Work, OffWork...)
        document.getElementById('disp-age').addEventListener('click', function() {
            if (this.querySelector('input')) return; 
            const currentVal = this.innerText; this.innerHTML = '';
            const input = document.createElement('input'); input.type = 'number'; input.value = currentVal; input.className = 'inline-input';
            const save = () => {
                let val = parseInt(input.value);
                if (!isNaN(val) && val > 0 && val <= 60) { TEACHER.age = val; calcMaxEnergy(); this.innerText = val; updateUI(); }
                else { this.innerText = TEACHER.age; if(val > 60) alert("æ³•å®šé€€ä¼‘å¹´é½¡ç‚º 60 æ­²ã€‚"); }
            };
            input.addEventListener('blur', save); input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); });
            this.appendChild(input); input.focus();
        });

       // --- ä¿®æ”¹ï¼šæ•™å­¸æ™‚æ®µçš„æ‰¹æ”¹æŒ‰éˆ• ---
document.getElementById('btn-grade-work').addEventListener('click', () => {
    // æª¢æŸ¥æ¢ä»¶
    if (TEACHER.gradingPile <= 0) {
        setStatus("æš«ç„¡èª²æ¥­éœ€è¦æ‰¹æ”¹ã€‚", true);
        return;
    }
    if (TEACHER.currentEnergy <= 0.05) return; // æ²’åŠ›æ°£

    // æ¸…é™¤çµç®—å¹²æ“¾
    clearPendingReports();

    // å•Ÿå‹• 3D äº’å‹•ï¼šæ‰¹æ”¹ 1 ä»½
    startInteractiveSession('grading', () => {
        const energyCost = 1.0;
        const happyCost = 2.0;

        // åŸ·è¡Œæ‰£æ¸›
        if (spendEnergy(energyCost) > 0) {
            TEACHER.gradingPile--; 
            changeHappiness(-happyCost); 
            
            setStatus("ä»”ç´°æ‰¹æ”¹äº† 1 ä»½èª²æ¥­ (è“‹ç« èªè­‰ï¼)ã€‚");
            
            // --- æ–°å¢ï¼šå½ˆå‡ºæœ¬æ¬¡è¡Œå‹•çµç®—å ±å‘Š ---
            createActionReport(
                energyCost,          // æ¶ˆè€—å¿ƒåŠ›
                -happyCost,          // å¹¸ç¦æ„Ÿè®ŠåŒ– (è² æ•¸)
                [],                  // é€™è£¡æ²’æœ‰å­¸ç”Ÿç¶­åº¦è®ŠåŒ–ï¼Œå‚³ç©ºé™£åˆ—
                TEACHER.currentEnergy, 
                TEACHER.happiness, 
                1                    // å€ç‡
            );

            updateUI();
        }
    }, 1); // å‚³å…¥ 1 ä»£è¡¨æ‰¹æ”¹æ•¸é‡
});

// --- ä¿®æ”¹ï¼šä¸‹ç­æ™‚æ®µçš„æ‰¹æ”¹æŒ‰éˆ• ---
document.getElementById('btn-do-grade').addEventListener('click', () => {
    const papersToGrade = parseInt(document.getElementById('rng-grading').value);
    if (papersToGrade > 0) {
        const costPerPaper = TEACHER.hasEntertainedTonight ? 2 : 1;
        const totalCost = papersToGrade * costPerPaper;

        // å•Ÿå‹• 3D äº’å‹•ï¼šé€£çºŒæ‰¹æ”¹
        startInteractiveSession('grading', () => {
            if (TEACHER.offWorkEnergy >= totalCost) TEACHER.offWorkEnergy -= totalCost;
            else { 
                const diff = totalCost - TEACHER.offWorkEnergy; 
                TEACHER.offWorkEnergy = 0; 
                TEACHER.energyDebt += diff; 
            }
            TEACHER.gradingPile = Math.max(0, TEACHER.gradingPile - papersToGrade);
            const happyLoss = 2 * papersToGrade; 
            changeHappiness(-happyLoss);
            updateOffWorkUI(); 
            updateUI(); 
        }, papersToGrade); // å‚³å…¥æ‰¹æ”¹æ•¸é‡ï¼Œæ±ºå®šå‹•ç•«æ¬¡æ•¸
    }
});

    document.getElementById('btn-recover').addEventListener('click', () => {
    triggerButtonShake('btn-recover');
 
    if (TEACHER.recoveriesLeft > 0) {
        let recoverAmount = TEACHER.maxEnergy;
        let msg = "";
 
        // è™•ç†å‚µå‹™
        if (TEACHER.energyDebt > 0) {
            if (recoverAmount >= TEACHER.energyDebt) {
                recoverAmount -= TEACHER.energyDebt;
                msg = `ä¼‘æ¯æ¢å¾©ç²¾åŠ›ï¼Œä¸¦å„Ÿé‚„äº† ${TEACHER.energyDebt.toFixed(1)} é€æ”¯ã€‚`;
                TEACHER.energyDebt = 0;
            } else {
                TEACHER.energyDebt -= recoverAmount;
                recoverAmount = 0;
                msg = `ä¼‘æ¯åƒ…å¤ å„Ÿé‚„éƒ¨åˆ†é€æ”¯ï¼Œä»æ¬  ${TEACHER.energyDebt.toFixed(1)} å¿ƒåŠ›...`;
            }
        } else {
            msg = "è€å¸«é€šéä¼‘æ¯èˆ‡ç ”ç¿’æå‡äº†è‡ªå·±ã€‚";
        }
 
        // --- æ–°å¢ï¼šè³‡è³ªè¼ƒå¥½çš„å­¸ç”Ÿè‡ªå‹•ç²å¾—å…ƒç´  (ç„¡è«–å‹•æ©Ÿæ˜¯å¦æ¥µä½) ---
        students.forEach(s => {
            if (s.type.id === 'high') {
                // å¤©è³‡å¥½ï¼šè‡ªå‹• +2
                for(let i=0; i<2; i++) {
                    setTimeout(() => spawnDirectLandedParticle(s, true), i * 150);
                }
            } else if (s.type.id === 'avg') {
                // å¤©è³‡ä¸­ç­‰ï¼šè‡ªå‹• +1
                setTimeout(() => spawnDirectLandedParticle(s, true), 150);
            }
        });
 
        TEACHER.currentEnergy = recoverAmount;
        TEACHER.recoveriesLeft--;
        
        updateUI();
        setStatus(msg + " (å„ªç§€å­¸ç”Ÿå—è€å¸«å•Ÿç™¼è‡ªç™¼é€²æ­¥)", TEACHER.currentEnergy === 0);
    }
});
        document.getElementById('btn-next-partial').addEventListener('click', () => { if (!hasDoneAdmin) { setStatus("å¿…é ˆå…ˆå®Œæˆè¡Œæ”¿å·¥ä½œï¼", true); return; } startNewYear(); });
    // === ä¿®æ”¹ï¼šè¡Œæ”¿æŒ‰éˆ•ç›£è½å™¨ (åŠ å…¥ 3D äº’å‹•èˆ‡ç‰¹å®šçµç®—èª) ===
document.getElementById('btn-admin').addEventListener('click', () => {
    triggerButtonShake('btn-admin');

    // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆ
    if (hasDoneAdmin) {
        setStatus("è¡Œæ”¿å·¥ä½œå·²å®Œæˆï¼Œç„¡éœ€é‡è¤‡ã€‚", true);
        return;
    }

    // å–å¾—æ¶ˆè€—æ•¸å€¼
    const eCost = parseFloat(document.getElementById('rng-admin').value);
    
    // è¨ˆç®—å¹¸ç¦åº¦æ¶ˆè€— (è¡Œæ”¿å·¥ä½œé€šå¸¸ä»¤äººç…©èº)
    // é€™è£¡è¨­å®šï¼šè‹¥å¿ƒåŠ›æ¶ˆè€—é«˜ï¼Œå¹¸ç¦æ„Ÿæ‰£æ›´å¤šï¼Œä½†è‡³å°‘æ‰£ 3 é»
    let hCost = Math.max(3.0, eCost * 2.5);

    // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„èˆŠå ±å‘Šï¼Œé¿å…å¹²æ“¾ 3D ä»‹é¢
    clearPendingReports();

    // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šå•Ÿå‹• 'admin' é¡å‹çš„ 3D äº’å‹•å ´æ™¯ â˜…â˜…â˜…
    startInteractiveSession('admin', () => {
        // --- é€™æ˜¯äº’å‹•çµæŸå¾Œçš„å›èª¿å‡½æ•¸ (Callback) ---
        
        // åŸ·è¡Œæ•¸å€¼æ‰£æ¸›é‚è¼¯
        if (TEACHER.currentEnergy >= eCost) {
            // æ­£å¸¸æ”¯ä»˜
            TEACHER.currentEnergy -= eCost;
            if (GAME_MODE === 'full') changeHappiness(-hCost);
            
            // â˜…â˜…â˜… æ‚¨çš„è¦æ±‚ï¼šé¡¯ç¤ºç‰¹å®šè¨Šæ¯ â˜…â˜…â˜…
            setStatus("å¾’å‹ç„¡åŠŸï¼Œæ¯«ç„¡æ”¶ç©«ã€‚", true); // true è®“æ–‡å­—è®Šç´…/å¼·èª¿
            
            // å‚³é€çµç®—å ±å‘Š
            // æ³¨æ„ï¼šé€™è£¡ happiness å‚³å…¥ -hCost ä»£è¡¨æ‰£æ¸›
            createActionReport(eCost, -hCost, [], TEACHER.currentEnergy, TEACHER.happiness, 1);
        } else {
            // ç²¾åŠ›é€æ”¯é‚è¼¯
            const overdraft = eCost - TEACHER.currentEnergy;
            const totalPenalty = hCost + 5; // é€æ”¯é¡å¤–æ‡²ç½°
            
            TEACHER.energyDebt += overdraft;
            TEACHER.currentEnergy = 0;
            
            if (GAME_MODE === 'full') changeHappiness(-totalPenalty);
            
            // é€æ”¯æ™‚çš„è¨Šæ¯
            setStatus(`å¼·è¡Œè™•ç†è¡Œæ”¿ (å¾’å‹ç„¡åŠŸ)ï¼Œé€æ”¯ ${overdraft.toFixed(1)} å¿ƒåŠ›ï¼`, true);
            
            createActionReport(eCost, -totalPenalty, [], TEACHER.currentEnergy, TEACHER.happiness, 1);
        }
        
        // æ¨™è¨˜ç‚ºå·²å®Œæˆï¼Œé–å®šæŒ‰éˆ•
        hasDoneAdmin = true;
        updateUI();
    });
});
        
        // ä¸‹ç­ç›¸é—œ (OffWork)
        document.getElementById('btn-offwork').addEventListener('click', startOffWork);
     function startOffWork() {
    TEACHER.offWorkEnergy = 1; TEACHER.hasEntertainedTonight = false; TEACHER.bonusEnergyNextDay = 0;
    TEACHER.dailyStats.entertained = false; TEACHER.dailyStats.adminCount = hasDoneAdmin ? 1 : 0;
    
    document.getElementById('offwork-overlay').style.display = 'flex';
    document.getElementById('ow-title').innerText = `ä¸‹ç­æ™‚é–“ (Day ${TEACHER.daysInYear})`;
    
    const iconEl = document.getElementById('ow-icon');
    iconEl.innerHTML = SVGS.offwork;
    iconEl.querySelector('svg').style.fill = "var(--accent-night)";
    
    document.getElementById('offwork-box').style.borderColor = "var(--accent-night)";
    document.getElementById('holiday-options').style.display = 'none'; 
    
    // åˆå§‹åŒ–ä¸‹æ–¹è—è‰²æŒ‰éˆ• (å›ºå®šé¡¯ç¤º +1 å¿ƒåŠ›)
    const endBtn = document.getElementById('btn-end-day'); 
    endBtn.disabled = false; 
    endBtn.innerText = "ğŸ’¤ ç¡è¦º (æ˜æ—¥ +1 å¿ƒåŠ›)"; 
    
    // ç¢ºä¿ä¹å®®æ ¼å…§çš„ã€Œç›´æ¥ç¡è¦ºã€æ–‡å­—æ­£ç¢ºé¡¯ç¤ºç‚º +3 å¿ƒåŠ›
    const sleepGridBtn = document.getElementById('btn-ent-sleep');
    if(sleepGridBtn) {
        sleepGridBtn.innerHTML = `<span class="ow-icon">${SVGS.bed}</span><span class="ow-label">ç›´æ¥ç¡è¦º</span><br><span style="font-size:10px;color:#27ae60;font-weight:bold;">+3 å¿ƒåŠ›</span>`;
    }

    updateOffWorkUI();
}
    function startHoliday() {
    TEACHER.isHoliday = true;
    TEACHER.offWorkEnergy = 5; // æš‘å‡çµ¦äºˆ 5 é»å¿ƒåŠ›ï¼Œå‰›å¥½å¤ å»æ—…è¡Œ
    TEACHER.hasEntertainedTonight = false;
    TEACHER.bonusEnergyNextDay = 0;
    
    // --- 1. é¡¯ç¤ºã€Œæš‘å‡é–‹å§‹ã€å…¨å±éæ¸¡å‹•ç•« ---
    const notifEl = document.getElementById('year-notification');
    const titleEl = document.getElementById('notif-title');
    const descEl = document.getElementById('notif-desc');

    // æš«æ™‚éš±è—èƒŒæ™¯ UIï¼Œè®“ç•«é¢æ›´ç´”ç²¹
    document.getElementById('top-dashboard').style.display = 'none';

    // è¨­å®šæš‘å‡å°ˆå±¬æ–‡æ¡ˆèˆ‡æ¨£å¼
    titleEl.innerText = "æš‘å‡é–‹å§‹";
    titleEl.style.color = "var(--accent-holiday)"; // æ©˜è‰²å­—é«”
    notifEl.style.background = "linear-gradient(135deg, #FFF9E6 0%, #F2F0EB 100%)"; // æº«æš–çš„é™½å…‰æ¼¸å±¤èƒŒæ™¯
    
    descEl.innerHTML = "æ¼«é•·çš„å­¸å¹´çµ‚æ–¼çµæŸäº†...<br><span style='font-size:16px'>æº–å‚™å¥½å»æ—…è¡Œï¼Œå¾¹åº•æ”¾é¬†èº«å¿ƒäº†å—ï¼Ÿ</span>";
    descEl.style.fontSize = "20px";
    descEl.style.lineHeight = "1.8";
    
    // è§¸ç™¼æ·¡å…¥å‹•ç•«
    notifEl.classList.add('active');

    // --- 2. å‹•ç•«åœç•™ 3 ç§’å¾Œï¼Œé¡¯ç¤ºå‡æœŸé¸å–® ---
    setTimeout(() => {
        notifEl.classList.remove('active'); // æ·¡å‡ºéæ¸¡ç•«é¢
        
        setTimeout(() => {
            // é‚„åŸæ¨£å¼ï¼Œé¿å…å½±éŸ¿ä¹‹å¾Œçš„ã€Œæ–°å­¸å¹´ã€é€šçŸ¥
            titleEl.style.color = ""; 
            descEl.style.fontSize = "";
            notifEl.style.background = "";
            
            // æ¢å¾©èƒŒæ™¯ UI
            document.getElementById('top-dashboard').style.display = 'flex';

            // æ­£å¼é–‹å•Ÿå‡æœŸ(ä¸‹ç­)é¸å–®
            document.getElementById('offwork-overlay').style.display = 'flex';
            document.getElementById('ow-title').innerText = "æš‘å‡é•·å‡";
            
            const iconEl = document.getElementById('ow-icon');
            if(iconEl) {
                iconEl.innerHTML = SVGS.holiday;
                if(iconEl.querySelector('svg')) iconEl.querySelector('svg').style.fill = "var(--accent-holiday)";
            }

            document.getElementById('ow-title').className = "offwork-header holiday-header";
            document.getElementById('offwork-box').style.borderColor = "var(--accent-holiday)";
            
            // ç¢ºä¿çµæŸæŒ‰éˆ•æ–‡æ¡ˆæ­£ç¢º
            const endBtn = document.getElementById('btn-end-day');
            endBtn.disabled = false;
            endBtn.innerText = "ğŸ’¤ çµæŸå‡æœŸ (å‰å¾€æ–°å­¸å¹´)";
            
            updateOffWorkUI();
        }, 500); // ç­‰å¾…æ·¡å‡ºå‹•ç•«å®Œæˆ (0.5ç§’)
    }, 3000); // ç•«é¢åœç•™ 3 ç§’
}
     
        document.getElementById('rng-holiday-rest').addEventListener('input', updateOffWorkUI);
        document.getElementById('rng-grading').addEventListener('input', updateGradingPreview);

        function updateGradingPreview() {
            const papersToGrade = parseInt(document.getElementById('rng-grading').value);
            document.getElementById('val-grading-count').innerText = papersToGrade;
            const costPerPaper = TEACHER.hasEntertainedTonight ? 2 : 1;
            const totalCost = papersToGrade * costPerPaper;
            let debt = 0; if (totalCost > TEACHER.offWorkEnergy) debt = totalCost - TEACHER.offWorkEnergy;
            const previewEl = document.getElementById('grading-preview');
            if (papersToGrade === 0) { previewEl.innerText = "æ¶ˆè€— 0 å¿ƒåŠ›"; previewEl.style.color = "var(--text-sub)"; }
            else { let msg = `æ¶ˆè€— ${totalCost} å¿ƒåŠ›`; if (TEACHER.hasEntertainedTonight) msg += " (é›™å€)"; if (debt > 0) msg += `ï¼Œå°‡é€æ”¯æ˜æ—¥ ${debt} å¿ƒåŠ›`; previewEl.innerText = msg; previewEl.style.color = debt > 0 ? "var(--accent-dse)" : "var(--accent-night)"; }
            document.getElementById('btn-do-grade').disabled = papersToGrade === 0;
        }
      // ==========================================
// äº’å‹•å¨›æ¨‚ç³»çµ± (Three.js äº’å‹•åé¥‹)
// ==========================================
// ==========================================
// äº’å‹•å¨›æ¨‚ç³»çµ± (æœ€çµ‚å®Œæ•´ä¿®å¾©ç‰ˆ)
// åŒ…å«äº†ï¼šdoEntertainment å®šç¾©ã€2Dæ–‡å­—ã€ç¡è¦ºå‹•ç•«ã€é«˜æ“¬çœŸé£Ÿç‰©ã€éŸ¿æ‡‰å¼ç›¸æ©Ÿ
// ==========================================

// --- å…¨å±€è®Šé‡ ---
let entGroup = null;
let isInteracting = false;
let savedCameraState = { pos: new THREE.Vector3(), target: new THREE.Vector3() };
let activeLabels = []; // è¿½è¹¤è¢å¹•ä¸Šçš„æ¨™ç±¤ä»¥ä¾¿æ¸…é™¤

// ==========================================
// 1. å…¥å£å‡½æ•¸èˆ‡ UI ç‹€æ…‹ç®¡ç† (ä¿®å¾©ç‰ˆ)
// ==========================================

function doEntertainment(type, btnId) {
    clearPendingReports();

    // ç‰¹æ®Šæƒ…æ³ï¼šè™•ç†ä¹å®®æ ¼å…§çš„ã€Œç›´æ¥ç¡è¦ºã€å¿«æ·éµ
    // é€™å€‹æŒ‰éˆ•ä¾ç„¶æœƒç›´æ¥è§¸ç™¼çµç®—
    if (type === 'sleep_early') {
        if (TEACHER.hasEntertainedTonight) return; 
        TEACHER.bonusEnergyNextDay = 3; 
        showSummary(); 
        return;
    }
    
    // ä¸€èˆ¬å¨›æ¨‚æ´»å‹• (åƒé£¯ã€çœ‹æˆ²ã€é€›è¡—...)
    if (TEACHER.offWorkEnergy >= 1) {
        startInteractiveSession(type, () => {
            // 1. æ‰£é™¤ä¸‹ç­å¿ƒåŠ›
            TEACHER.offWorkEnergy -= 1; 
            
            // 2. æ¨™è¨˜ã€Œä»Šæ™šå·²å¨›æ¨‚ã€(é€™æœƒå½±éŸ¿æ˜å¤©çš„å›è¡€é‡å¾ +3 è®Š +1)
            TEACHER.hasEntertainedTonight = true; 
            TEACHER.dailyStats.entertained = true;
            
            // 3. å¢åŠ å¹¸ç¦æ„Ÿ
            const happyGain = Math.floor(Math.random() * 3) + 6; 
            changeHappiness(happyGain); 
            
            // 4. é¡¯ç¤ºæµ®å‹•æ–‡å­— (åœ¨ä¸‹ç­ä»‹é¢é‡æ–°å‡ºç¾å¾Œé¡¯ç¤º)
            // ç”±æ–¼ startInteractiveSession æœƒè² è²¬æ¢å¾©ä»‹é¢ï¼Œé€™è£¡æˆ‘å€‘å»¶é²ä¸€é»é¡¯ç¤ºæ–‡å­—
            const btn = document.getElementById(btnId);
            // æª¢æŸ¥ä»‹é¢æ˜¯å¦å·²é¡¯ç¤ºï¼Œæˆ–è€…ç›´æ¥é™„åŠ åˆ° body
            if(btn) {
                const rect = btn.getBoundingClientRect();
                const floatEl = document.createElement('div');
                floatEl.className = 'floating-bonus';
                floatEl.innerText = `+${happyGain} å¹¸ç¦`;
                // ç¨å¾®åç§»ä½ç½®ä»¥å…é®æ“‹
                floatEl.style.left = `${rect.left + 20}px`;
                floatEl.style.top = `${rect.top}px`;
                floatEl.style.color = '#E91E63';
                document.body.appendChild(floatEl);
                setTimeout(() => floatEl.remove(), 1000);
            }
            
            // æ³¨æ„ï¼šé€™è£¡ä¸å‘¼å« sleep() æˆ– showSummary()
            // startInteractiveSession çš„ finish() æœƒè‡ªå‹•æŠŠç©å®¶å¸¶å›ä¸‹ç­ä»‹é¢
            // ç©å®¶éœ€è¦æ‰‹å‹•é»æ“Šè—è‰²çš„ã€ŒçµæŸé€™ä¸€å¤©ã€æŒ‰éˆ•
        });
    }
}
// ç¡è¦ºéæ¸¡é»‘å±å‹•ç•«
function playSleepAnimation(onComplete) {
    const overlay = document.getElementById('sleep-overlay');
    const offwork = document.getElementById('offwork-overlay');
    const summary = document.getElementById('summary-overlay');
    
    if(offwork) offwork.style.display = 'none';
    if(summary) summary.style.display = 'none';
    
    if(overlay) {
        overlay.style.display = 'flex';
        overlay.style.opacity = 0;
        gsap.to(overlay, { opacity: 1, duration: 1.0, onComplete: () => {
            setTimeout(() => {
                gsap.to(overlay, { opacity: 0, duration: 0.5, onComplete: () => {
                    overlay.style.display = 'none';
                    if(onComplete) onComplete();
                }});
            }, 1500); // åœç•™é»‘å± 1.5 ç§’
        }});
    } else {
        if(onComplete) onComplete();
    }
}


// --------------------------------------------------------
// 2. 2D æ–‡å­—å·¥å…·å‡½æ•¸
// --------------------------------------------------------

function create2DLabel(text, worldPos) {
    const div = document.createElement('div');
    div.className = 'interaction-label';
    div.innerText = text;
    document.body.appendChild(div);
    activeLabels.push({ el: div, pos: worldPos });
    return div;
}

function create2DFeedback(text, worldPos, color = "#E91E63") {
    const div = document.createElement('div');
    div.className = 'floating-text-2d';
    div.innerText = text;
    div.style.color = color;
    update2DPosition(div, worldPos);
    document.body.appendChild(div);
    setTimeout(() => { div.remove(); }, 1500);
}

function update2DPosition(el, worldPos) {
    const vec = worldPos.clone();
    vec.project(camera);
    const x = (vec.x * .5 + .5) * window.innerWidth;
    const y = (vec.y * -.5 + .5) * window.innerHeight;
    el.style.left = `${x}px`;
    el.style.top = `${y}px`;
}

function clear2DLabels() {
    activeLabels.forEach(item => item.el.remove());
    activeLabels = [];
}




// æ–°å¢ï¼šåŸåœ°é‡æ“Šè“‹ç« ç‰¹æ•ˆ (ä¸æœƒå‘ä¸Šé£„)
function create2DStamp(text, worldPos, color = "#C0392B") {
    const div = document.createElement('div');
    div.className = 'fixed-stamp-2d';
    div.innerText = text;
    div.style.color = color;
    div.style.border = `8px solid ${color}`;
    div.style.borderRadius = "20px";
    div.style.padding = "10px 20px";
    
    update2DPosition(div, worldPos);
    document.body.appendChild(div);
    
    // å‹•ç•«çµæŸå¾Œç§»é™¤
    setTimeout(() => { div.remove(); }, 1000);
}







        
// --------------------------------------------------------
// 3. äº’å‹•å ´æ™¯ç®¡ç†å™¨
// --------------------------------------------------------



function startInteractiveSession(type, onComplete, param = null) {
    if (isInteracting) return;
    isInteracting = true;

    savedCameraState.pos.copy(camera.position);
    savedCameraState.target.copy(controls.target);

    // â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šæš«æ™‚é—œé–‰å ´æ™¯éœ§æ°£ï¼Œé˜²æ­¢æ—…è¡Œå ´æ™¯è¢«ç™½éœ§æ´—ç™½è®Šæˆç©ºç™½ â˜…â˜…â˜…
   if (scene.fog) { scene.fog.near = 9999; scene.fog.far = 10000; }

    const wasOffWork = document.getElementById('offwork-overlay').style.display === 'flex';

    document.getElementById('top-dashboard').style.display = 'none';
    document.getElementById('labels-container').style.display = 'none';
    document.getElementById('offwork-overlay').style.display = 'none';
    document.getElementById('report-overlay').style.display = 'none'; 
    document.querySelector('.copyright-footer').style.display = 'none';

    entGroup = new THREE.Group();
    entGroup.position.set(0, 500, 0); 
    scene.add(entGroup);

    const isMobile = window.innerWidth < 800;
    const camTargetY = 504; 
    const camY = isMobile ? 525 : 518; 
    const camZ = isMobile ? 18 : 12;   
    
    gsap.to(camera.position, { x: 0, y: camY, z: camZ, duration: 1.0, ease: "power2.inOut" });
    gsap.to(controls.target, { x: 0, y: camTargetY, z: 0, duration: 1.0, ease: "power2.inOut" });

    let interactionLogic = null;
    if (type === 'read') interactionLogic = setupReadingInteraction(entGroup, finish);
    else if (type === 'sport') interactionLogic = setupSportInteraction(entGroup, finish);
    else if (type === 'movie') interactionLogic = setupMovieInteraction(entGroup, finish);
    else if (type === 'shopping') interactionLogic = setupShoppingInteraction(entGroup, finish);
    else if (type === 'dinner') interactionLogic = setupDinnerInteraction(entGroup, finish);
    else if (type === 'grading') interactionLogic = setupGradingInteraction(entGroup, finish, param);
    else if (type === 'admin') interactionLogic = setupAdminInteraction(entGroup, finish);
    else if (type === 'travel') interactionLogic = setupTravelInteraction(entGroup, finish, param);

    const updateLabelsLoop = () => {
        if (!isInteracting) return;
        activeLabels.forEach(item => update2DPosition(item.el, item.pos));
        requestAnimationFrame(updateLabelsLoop);
    };
    updateLabelsLoop();

    const handler = (e) => {
        if (!interactionLogic) return;
        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(entGroup.children, true);
        if (intersects.length > 0) {
            interactionLogic(intersects[0].object);
        }
    };
    window.addEventListener('pointerup', handler);

    function finish() {
        window.removeEventListener('pointerup', handler);
        clear2DLabels(); 
        
        gsap.to(entGroup.scale, { x: 0, y: 0, z: 0, duration: 0.5, onComplete: () => {
            scene.remove(entGroup);
            entGroup = null;
            
            // â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šäº’å‹•çµæŸï¼Œæ¢å¾©åŸæœ¬çš„å ´æ™¯éœ§æ°£ â˜…â˜…â˜…
           if (scene.fog) { scene.fog.near = 20; scene.fog.far = 90; }

            if (!wasOffWork) { 
                document.getElementById('top-dashboard').style.display = 'flex';
                document.getElementById('labels-container').style.display = 'block';
                document.querySelector('.copyright-footer').style.display = 'block';
            }

            gsap.to(camera.position, { 
                x: savedCameraState.pos.x, 
                y: savedCameraState.pos.y, 
                z: savedCameraState.pos.z, 
                duration: 1.0 
            });
            gsap.to(controls.target, { 
                x: savedCameraState.target.x, 
                y: savedCameraState.target.y, 
                z: savedCameraState.target.z, 
                duration: 1.0, 
                onComplete: () => {
                    isInteracting = false;
                    if (onComplete) onComplete();
                    if (wasOffWork) {
                        document.getElementById('offwork-overlay').style.display = 'flex';
                        updateOffWorkUI();
                    }
                }
            });
        }});
    }
}



function openTravelMenu() {
    if (TEACHER.offWorkEnergy >= 5 && !TEACHER.hasEntertainedTonight) {
        document.getElementById('travel-overlay').style.display = 'flex';
    }
}

function startTravel(country) {
    document.getElementById('travel-overlay').style.display = 'none';
    clearPendingReports();
    
    startInteractiveSession('travel', () => {
        // 1. è€—ç›¡æ‰€æœ‰ä¸‹ç­/å‡æœŸå¿ƒåŠ›
        TEACHER.offWorkEnergy = 0; 
        
        // 2. æ¨™è¨˜ç‚ºå·²å¨›æ¨‚
        TEACHER.hasEntertainedTonight = true; 
        TEACHER.dailyStats.entertained = true;
        
        // 3. å¢åŠ å¿ƒåŠ›ä¸Šé™ (æ—…è¡Œæ“´é—Šè¦–é‡)
        TEACHER.maxEnergy += 2.5; 
        
        // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šé•·å‡æ—…è¡Œå¾Œï¼Œæ–°å­¸å¹´ç²å¾— +10 å¿ƒåŠ›ç´…åˆ© â˜…â˜…â˜…
        TEACHER.bonusEnergyNextDay = 10; 
        
        // 4. å¤§å¹…å¢åŠ å¹¸ç¦æ„Ÿ
        changeHappiness(35); 
        
        updateOffWorkUI(); 
        
        // é¡¯ç¤ºæµ®å‹•æ–‡å­—æç¤º
        const floatEl = document.createElement('div');
        floatEl.className = 'floating-bonus';
        floatEl.innerHTML = `èº«å¿ƒå¤§è§£æ”¾ï¼<br>+35 å¹¸ç¦`; 
        floatEl.style.left = `50%`;
        floatEl.style.top = `50%`;
        floatEl.style.color = '#E67E22';
        floatEl.style.textAlign = 'center';
        document.body.appendChild(floatEl);
        setTimeout(() => floatEl.remove(), 2500);

    }, country);
}

  function setupTravelInteraction(group, onDone, country) {
    const isMobile = window.innerWidth < 800;
    if (isMobile && country !== 'korea') group.scale.set(0.75, 0.75, 0.75);

    const validCountry = country || 'japan';

    // --- 1. åŸºæœ¬ç’°å¢ƒ (å¤©ç©ºèˆ‡åœ°æ¿) ---
    const skyColors = {
        japan: 0xFFB7C5,
        uk: 0x7F8C8D,
        korea: 0xF39C12,
        china: 0x87CEEB,
        finland: 0x0A192F
    };
    const skybox = new THREE.Mesh(
        new THREE.SphereGeometry(validCountry === 'china' ? 150 : 45, 32, 32), 
        new THREE.MeshBasicMaterial({ color: skyColors[validCountry], side: THREE.BackSide, fog: false })
    );
    group.add(skybox);

    const floorColors = {
        japan: 0x7C9473,
        uk: 0x95A5A6,
        korea: 0xD35400, // éŸ“åœ‹çš„åœ°æ¿æœƒåœ¨ä¸‹æ–¹è¢«ç¨ç«‹å±±ä¸˜è¦†è“‹
        china: 0x4E6C50,
        finland: 0x8DA5B8
    };
    const floor = new THREE.Mesh(
        new THREE.CylinderGeometry(validCountry === 'china' ? 60 : 35, validCountry === 'china' ? 60 : 35, 2, 64), 
        new THREE.MeshStandardMaterial({ color: floorColors[validCountry], roughness: 0.9 })
    );
    floor.position.y = -1;
    group.add(floor);

    // --- 2. é£›æ©Ÿé£›è¶Šå‹•ç•« ---
    const planeGroup = new THREE.Group();
    const body = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.8, 6, 16), new THREE.MeshStandardMaterial({color: 0xffffff}));
    body.rotation.z = Math.PI / 2;
    const wing = new THREE.Mesh(new THREE.BoxGeometry(2.5, 0.2, 7), new THREE.MeshStandardMaterial({color: 0xeeeeee}));
    const tailWing = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.2, 3), new THREE.MeshStandardMaterial({color: 0xeeeeee}));
    tailWing.position.set(-2.5, 0, 0);
    const tail = new THREE.Mesh(new THREE.BoxGeometry(1, 1.8, 0.2), new THREE.MeshStandardMaterial({color: 0xE91E63})); 
    tail.position.set(-2.5, 0.9, 0);
    planeGroup.add(body, wing, tailWing, tail);
    planeGroup.position.set(-35, 15, -8);
    planeGroup.rotation.x = 0.2;
    planeGroup.rotation.z = 0.1;
    group.add(planeGroup);

    gsap.to(planeGroup.position, { x: 35, y: 18, duration: 6, ease: "power1.inOut" });

    // --- 3. å„åœ‹å°ˆå±¬ç²¾ç·»åœ°æ™¯ ---
    const scenery = new THREE.Group();
    group.add(scenery);

    if (validCountry === 'japan') {
        const japanContent = new THREE.Group();
        japanContent.scale.set(0.55, 0.55, 0.55); 
        scenery.add(japanContent);

        const fuji = new THREE.Mesh(new THREE.CylinderGeometry(2, 18, 15, 64), new THREE.MeshStandardMaterial({color: 0x2C3E50}));
        fuji.position.set(0, 7.5, -20);
        const snow = new THREE.Mesh(new THREE.CylinderGeometry(1.8, 6, 5, 64), new THREE.MeshStandardMaterial({color: 0xFFFFFF}));
        snow.position.set(0, 12.5, -20);
        japanContent.add(fuji, snow); 

        const water = new THREE.Mesh(new THREE.PlaneGeometry(60, 25), new THREE.MeshStandardMaterial({color: 0x3498DB, transparent:true, opacity:0.8}));
        water.rotation.x = -Math.PI/2; 
        water.position.set(0, 0.1, -8);
        japanContent.add(water);

        const torii = new THREE.Group();
        const tMat = new THREE.MeshStandardMaterial({color: 0xC0392B}); 
        const tBlack = new THREE.MeshStandardMaterial({color: 0x222222});
        const p1 = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.8, 8, 16), tMat); p1.position.set(-4, 4, 0);
        const p2 = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.8, 8, 16), tMat); p2.position.set(4, 4, 0);
        const bar1 = new THREE.Mesh(new THREE.BoxGeometry(11, 0.8, 1), tMat); bar1.position.set(0, 6.5, 0);
        const bar2 = new THREE.Mesh(new THREE.BoxGeometry(12, 1, 1.2), tMat); bar2.position.set(0, 8, 0);
        const roof1 = new THREE.Mesh(new THREE.BoxGeometry(12.5, 0.4, 1.4), tBlack); roof1.position.set(0, 8.7, 0);
        const centerPlaque = new THREE.Mesh(new THREE.BoxGeometry(1.5, 2, 0.5), tBlack); centerPlaque.position.set(0, 6.5, 0);
        torii.add(p1, p2, bar1, bar2, roof1, centerPlaque);
        torii.position.set(0, 0, -3);
        japanContent.add(torii);

        const createSakura = (x, z, scale) => {
            const tree = new THREE.Group();
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.5, 3), new THREE.MeshStandardMaterial({color: 0x5C4033}));
            trunk.position.y = 1.5;
            const leavesMat = new THREE.MeshStandardMaterial({color: 0xFFB7C5, flatShading: true});
            const l1 = new THREE.Mesh(new THREE.DodecahedronGeometry(1.8), leavesMat); l1.position.set(0, 3.5, 0);
            const l2 = new THREE.Mesh(new THREE.DodecahedronGeometry(1.5), leavesMat); l2.position.set(1, 2.8, 0.5);
            const l3 = new THREE.Mesh(new THREE.DodecahedronGeometry(1.5), leavesMat); l3.position.set(-1, 2.8, -0.5);
            tree.add(trunk, l1, l2, l3);
            tree.position.set(x, 0, z);
            tree.scale.set(scale, scale, scale);
            japanContent.add(tree);
        };
        createSakura(-12, -2, 1.5); createSakura(12, -4, 1.2);
        createSakura(-8, -8, 1.0); createSakura(10, 2, 1.4);
    }
    else if (validCountry === 'uk') {
        const ukContent = new THREE.Group();
        ukContent.scale.set(0.55, 0.55, 0.55);
        scenery.add(ukContent);

        const river = new THREE.Mesh(new THREE.PlaneGeometry(100, 30), new THREE.MeshStandardMaterial({color: 0x2C3E50, roughness: 0.1}));
        river.rotation.x = -Math.PI/2; 
        river.position.set(0, 0.1, -10);
        ukContent.add(river);

        const cloudMat = new THREE.MeshBasicMaterial({color: 0xBDC3C7, transparent: true, opacity: 0.6, depthWrite: false});
        for(let i = 0; i < 8; i++){
            const cloud = new THREE.Mesh(new THREE.SphereGeometry(10, 16, 16), cloudMat);
            cloud.scale.set(2, 0.2, 1);
            cloud.position.set((Math.random()-0.5)*80, 20 + Math.random()*5, -15 - Math.random()*20);
            ukContent.add(cloud);
        }

        const road = new THREE.Mesh(new THREE.BoxGeometry(100, 0.2, 14), new THREE.MeshStandardMaterial({color: 0x333333, roughness: 0.9}));
        road.position.set(0, 0.15, 6);
        ukContent.add(road);

        const pavement = new THREE.Mesh(new THREE.BoxGeometry(100, 0.4, 8), new THREE.MeshStandardMaterial({color: 0x7F8C8D}));
        pavement.position.set(0, 0.2, 15);
        ukContent.add(pavement);

        const bridge = new THREE.Group();
        const bridgeRoad = new THREE.Mesh(new THREE.BoxGeometry(14, 1, 30), new THREE.MeshStandardMaterial({color: 0x555555}));
        bridgeRoad.position.set(16, 2, -10);
        bridge.add(bridgeRoad);
        for(let i = -10; i <= 10; i += 10) {
            const arch = new THREE.Mesh(new THREE.CylinderGeometry(4, 4, 14, 32, 1, false, 0, Math.PI), new THREE.MeshStandardMaterial({color: 0x777777}));
            arch.rotation.z = Math.PI/2;
            arch.position.set(16, -1, -10 + i);
            bridge.add(arch);
        }
        ukContent.add(bridge);

        const bigBen = new THREE.Group();
        const stoneMat = new THREE.MeshStandardMaterial({color: 0xD4C4A8, roughness: 1}); 
        const goldMat = new THREE.MeshStandardMaterial({color: 0xD4A017, metalness: 0.8});
        const darkRoofMat = new THREE.MeshStandardMaterial({color: 0x2C3E50});
        
        const towerBody = new THREE.Mesh(new THREE.BoxGeometry(5, 22, 5), stoneMat); towerBody.position.y = 11;
        const clockSection = new THREE.Mesh(new THREE.BoxGeometry(5.2, 5.2, 5.2), stoneMat); clockSection.position.y = 24.6;
        
        for(let i = 0; i < 4; i++){
            const clockFace = new THREE.Mesh(new THREE.CylinderGeometry(1.8, 1.8, 0.2, 16), new THREE.MeshStandardMaterial({color: 0xFFFFFF}));
            clockFace.rotation.x = Math.PI/2;
            clockFace.position.set(0, 24.6, 2.65);
            const pivot = new THREE.Group();
            pivot.rotation.y = i * (Math.PI/2);
            pivot.add(clockFace);
            bigBen.add(pivot);
        }
        
        const roofBase = new THREE.Mesh(new THREE.BoxGeometry(5.5, 1.5, 5.5), darkRoofMat); roofBase.position.y = 27.8;
        const spire = new THREE.Mesh(new THREE.ConeGeometry(2.5, 8, 4), darkRoofMat); spire.position.y = 32.5; spire.rotation.y = Math.PI/4;
        const tip = new THREE.Mesh(new THREE.SphereGeometry(0.4), goldMat); tip.position.y = 36.5;
        
        bigBen.add(towerBody, clockSection, roofBase, spire, tip);
        bigBen.position.set(20, 0, -22);
        ukContent.add(bigBen);

        const londonEye = new THREE.Group();
        const wheelMat = new THREE.MeshStandardMaterial({color: 0xBDC3C7, wireframe: true}); 
        const wheel = new THREE.Mesh(new THREE.TorusGeometry(12, 0.6, 16, 48), wheelMat);
        wheel.position.y = 15;
        
        const legMat = new THREE.MeshStandardMaterial({color: 0xEEEEEE});
        const leg1 = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 20), legMat);
        leg1.position.set(-4, 7.5, 5); leg1.rotation.x = -0.4; leg1.rotation.z = -0.2;
        const leg2 = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 20), legMat);
        leg2.position.set(4, 7.5, 5); leg2.rotation.x = -0.4; leg2.rotation.z = 0.2;
        
        londonEye.add(wheel, leg1, leg2);
        londonEye.position.set(-20, 0, -25);
        londonEye.rotation.y = 0.3;
        ukContent.add(londonEye);
        gsap.to(wheel.rotation, { z: Math.PI * 2, duration: 60, repeat: -1, ease: "none" });

        const createPhoneBox = (x, z) => {
            const box = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(2, 4.5, 2), new THREE.MeshStandardMaterial({color: 0xC0392B, roughness: 0.7}));
            body.position.y = 2.25;
            const roof = new THREE.Mesh(new THREE.BoxGeometry(2.2, 0.5, 2.2), new THREE.MeshStandardMaterial({color: 0xC0392B}));
            roof.position.y = 4.75;
            const dome = new THREE.Mesh(new THREE.SphereGeometry(1, 16, 16), new THREE.MeshStandardMaterial({color: 0xC0392B}));
            dome.position.y = 5; dome.scale.y = 0.5;
            
            const glass = new THREE.Mesh(new THREE.BoxGeometry(1.8, 3, 2.1), new THREE.MeshStandardMaterial({color: 0x111111}));
            glass.position.y = 2.5;
            const glass2 = new THREE.Mesh(new THREE.BoxGeometry(2.1, 3, 1.8), new THREE.MeshStandardMaterial({color: 0x111111}));
            glass2.position.y = 2.5;
            
            box.add(body, glass, glass2, roof, dome);
            box.position.set(x, 0.4, z);
            ukContent.add(box);
        };
        createPhoneBox(-12, 13);
        createPhoneBox(6, 13);

        const bus = new THREE.Group();
        const busMat = new THREE.MeshStandardMaterial({color: 0xC0392B, roughness: 0.5});
        const busBody = new THREE.Mesh(new THREE.BoxGeometry(4, 5.5, 11), busMat); busBody.position.y = 3.5;
        const windows = new THREE.Mesh(new THREE.BoxGeometry(4.2, 1.2, 10.4), new THREE.MeshStandardMaterial({color: 0x222222}));
        windows.position.y = 2.5;
        const windowsUpper = new THREE.Mesh(new THREE.BoxGeometry(4.2, 1.2, 10.4), new THREE.MeshStandardMaterial({color: 0x222222}));
        windowsUpper.position.y = 5.0;
        bus.add(busBody, windows, windowsUpper);
        
        const tireMat = new THREE.MeshStandardMaterial({color: 0x111111});
        const t1 = new THREE.Mesh(new THREE.CylinderGeometry(0.9, 0.9, 4.4, 16), tireMat); t1.rotation.z=Math.PI/2; t1.position.set(0, 0.9, 3.5);
        const t2 = new THREE.Mesh(new THREE.CylinderGeometry(0.9, 0.9, 4.4, 16), tireMat); t2.rotation.z=Math.PI/2; t2.position.set(0, 0.9, -3.5);
        bus.add(t1, t2);
        
        bus.position.set(-45, 0.2, 6);
        bus.rotation.y = Math.PI/2;
        ukContent.add(bus);
        
        gsap.to(bus.position, { x: 45, duration: 15, repeat: -1, ease: "none" });
    }
    else if (validCountry === 'korea') {
        // â˜… éŸ“åœ‹ï¼š100% å®Œç¾å¾®ç¸®æ˜Ÿçƒå…¨æ™¯
        const koreaContent = new THREE.Group();
        const kScale = 0.13; 
        koreaContent.scale.set(kScale, kScale, kScale);
        koreaContent.position.set(0, 1, isMobile ? -5 : -10);
        scenery.add(koreaContent);

        const namsan = new THREE.Mesh(
            new THREE.SphereGeometry(38, 32, 16),
            new THREE.MeshStandardMaterial({color: 0x5C4033, roughness: 1}) 
        );
        namsan.scale.y = 0.6; 
        koreaContent.add(namsan);

        const treeColors =[0xE74C3C, 0xD35400, 0xF1C40F, 0xFF7F50]; 
        for(let i = 0; i < 70; i++) {
            const angle = Math.random() * Math.PI * 2;
            const r = 12 + Math.random() * 24; 
            const tx = Math.cos(angle) * r;
            const tz = Math.sin(angle) * r;
            
            if (tz > 0 && Math.abs(tx) < 14) continue;
            
            const surfaceY = Math.sqrt(Math.max(0, 38*38 - r*r)) * 0.6;
            
            const tree = new THREE.Mesh(
                new THREE.DodecahedronGeometry(1.8 + Math.random() * 2.5),
                new THREE.MeshStandardMaterial({
                    color: treeColors[Math.floor(Math.random() * treeColors.length)],
                    flatShading: true
                })
            );
            tree.position.set(tx, surfaceY + Math.random() * 1.5, tz);
            tree.rotation.set(Math.random(), Math.random(), Math.random());
            koreaContent.add(tree);
        }

        const tower = new THREE.Group();
        
        const basePlaza = new THREE.Mesh(new THREE.CylinderGeometry(8, 10, 3, 32), new THREE.MeshStandardMaterial({color: 0xECF0F1}));
        basePlaza.position.y = 1.5;
        const lowerBldg = new THREE.Mesh(new THREE.BoxGeometry(8, 6, 8), new THREE.MeshStandardMaterial({color: 0xFFFFFF}));
        lowerBldg.position.y = 6;
        
        const stripeDark = new THREE.Mesh(new THREE.BoxGeometry(8.2, 0.8, 8.2), new THREE.MeshStandardMaterial({color: 0x2C3E50}));
        stripeDark.position.y = 5;
        const stripeRed = new THREE.Mesh(new THREE.BoxGeometry(8.2, 0.5, 8.2), new THREE.MeshStandardMaterial({color: 0xE74C3C}));
        stripeRed.position.y = 4;
        tower.add(basePlaza, lowerBldg, stripeDark, stripeRed);

        const shaft = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 3.5, 30, 32), new THREE.MeshStandardMaterial({color: 0xFFFFFF, roughness: 0.5}));
        shaft.position.y = 21;

        const deckBase = new THREE.Mesh(new THREE.ConeGeometry(5.5, 4, 32), new THREE.MeshStandardMaterial({color: 0xFFFFFF}));
        deckBase.rotation.x = Math.PI; 
        deckBase.position.y = 36;

        const deckGlass = new THREE.Mesh(new THREE.CylinderGeometry(5.5, 5.5, 5, 32), new THREE.MeshStandardMaterial({color: 0x111111, metalness: 0.5, roughness: 0.2}));
        deckGlass.position.y = 40.5;
        
        const ringLight = new THREE.Mesh(new THREE.TorusGeometry(5.6, 0.2, 8, 32), new THREE.MeshBasicMaterial({color: 0x3498DB}));
        ringLight.rotation.x = Math.PI/2;
        ringLight.position.y = 39.5;

        const deckTop = new THREE.Mesh(new THREE.CylinderGeometry(4.5, 5.5, 2.5, 32), new THREE.MeshStandardMaterial({color: 0xFFFFFF}));
        deckTop.position.y = 44.25;

        const antenna1 = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 12, 8), new THREE.MeshStandardMaterial({color: 0xE74C3C}));
        antenna1.position.y = 51;
        const antenna2 = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 10, 8), new THREE.MeshStandardMaterial({color: 0xECF0F1}));
        antenna2.position.y = 62;

        tower.add(shaft, deckBase, deckGlass, ringLight, deckTop, antenna1, antenna2);
        tower.position.set(0, 22.5, 0); 
        koreaContent.add(tower);

        const cableGroup = new THREE.Group();
        const wire = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 120), new THREE.MeshBasicMaterial({color: 0x333333}));
        wire.rotation.z = 1.0;
        wire.position.set(-30, 10, 5); 
        cableGroup.add(wire);

        const cabin = new THREE.Group();
        const cBody = new THREE.Mesh(new THREE.BoxGeometry(3, 2.2, 3), new THREE.MeshStandardMaterial({color: 0xE74C3C}));
        const cGlass = new THREE.Mesh(new THREE.BoxGeometry(3.2, 1.2, 3.2), new THREE.MeshStandardMaterial({color: 0x111111}));
        cGlass.position.y = 0.2;
        const cArm = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 3.5), new THREE.MeshStandardMaterial({color: 0x222222}));
        cArm.position.y = 2.4;
        cabin.add(cBody, cGlass, cArm);
        cableGroup.add(cabin);
        koreaContent.add(cableGroup);
        
        gsap.fromTo(cabin.position, 
            { x: -65, y: -43, z: 5 },
            { x: 5, y: 63, z: 5, duration: 18, repeat: -1, yoyo: true, ease: "sine.inOut" }
        );
    }
    else if (validCountry === 'china') {
        const goldenSky = new THREE.Mesh(
            new THREE.SphereGeometry(150, 32, 32), 
            new THREE.MeshBasicMaterial({ color: 0xFAD6A5, side: THREE.BackSide, fog: false }) 
        );
        const brightFloor = new THREE.Mesh(
            new THREE.CylinderGeometry(60, 60, 2, 64), 
            new THREE.MeshStandardMaterial({ color: 0x8A9A75, roughness: 0.9 }) 
        );
        brightFloor.position.y = -1;
        scenery.add(goldenSky, brightFloor);

        const chinaContent = new THREE.Group();
        chinaContent.scale.set(0.55, 0.55, 0.55); 
        scenery.add(chinaContent);

        const mountMatDark = new THREE.MeshStandardMaterial({color: 0x557A66, roughness: 1, flatShading: true});
        const mountMatLight = new THREE.MeshStandardMaterial({color: 0x739E82, roughness: 1, flatShading: true});
        
        const createMountain = (x, z, h, r, isDark) => {
            const mGroup = new THREE.Group();
            const mainPeak = new THREE.Mesh(new THREE.ConeGeometry(r, h, 8), isDark ? mountMatDark : mountMatLight);
            mainPeak.position.y = h/2 - 2;
            const subPeak = new THREE.Mesh(new THREE.ConeGeometry(r*0.7, h*0.6, 8), isDark ? mountMatDark : mountMatLight);
            subPeak.position.set(r*0.5, h*0.3 - 2, r*0.3);
            mGroup.add(mainPeak, subPeak);
            mGroup.position.set(x, 0, z);
            chinaContent.add(mGroup); 
        };
        createMountain(-20, -22, 28, 10, true);
        createMountain(15, -28, 35, 14, false);
        createMountain(28, -15, 20, 8, true);
        createMountain(-28, -12, 18, 7, false);
        createMountain(0, -35, 40, 18, true); 

        const cloudMat = new THREE.MeshBasicMaterial({color: 0xFFFAFA, transparent: true, opacity: 0.7, depthWrite: false});
        for(let i=0; i<8; i++){
            const cloud = new THREE.Mesh(new THREE.SphereGeometry(15, 16, 16), cloudMat);
            cloud.scale.set(1, 0.2, 0.6);
            cloud.position.set((Math.random()-0.5)*50, 4 + Math.random()*5, -15 - Math.random()*15);
            chinaContent.add(cloud); 
        }

        const wallGroup = new THREE.Group();
        const brickMat = new THREE.MeshStandardMaterial({color: 0xCBBDAA, roughness: 0.9}); 
        const pathMat = new THREE.MeshStandardMaterial({color: 0xA39586, roughness: 1.0});  
        const roofMat = new THREE.MeshStandardMaterial({color: 0x4A5054, roughness: 0.8});  
        
        for(let i = -28; i <= 28; i += 2) {
            const zPos = Math.sin(i * 0.25) * 6 - 8;
            const yPos = Math.cos(i * 0.2) * 2.5 + 4; 
            
            const wallSegment = new THREE.Mesh(new THREE.BoxGeometry(2.1, yPos * 2, 3), brickMat);
            wallSegment.position.set(i, 0, zPos);
            wallGroup.add(wallSegment);
            
            const path = new THREE.Mesh(new THREE.BoxGeometry(2.1, 0.2, 1.8), pathMat);
            path.position.set(i, yPos + 0.1, zPos);
            wallGroup.add(path);
            
            const crenelFront = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1, 0.4), brickMat);
            crenelFront.position.set(i, yPos + 0.6, zPos + 1.3);
            const crenelBack = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1, 0.4), brickMat);
            crenelBack.position.set(i, yPos + 0.6, zPos - 1.3);
            wallGroup.add(crenelFront, crenelBack);
            
            if (i % 12 === 0) {
                const tower = new THREE.Group();
                tower.position.set(i, yPos, zPos);
                
                const tBase = new THREE.Mesh(new THREE.BoxGeometry(4.5, 6, 4.5), brickMat);
                tBase.position.y = 1;
                const arch = new THREE.Mesh(new THREE.CylinderGeometry(1, 1, 4.6, 16), new THREE.MeshBasicMaterial({color: 0x554B41})); 
                arch.rotation.x = Math.PI/2;
                arch.position.set(0, -0.5, 0);
                const archBase = new THREE.Mesh(new THREE.BoxGeometry(2, 1.5, 4.6), new THREE.MeshBasicMaterial({color: 0x554B41}));
                archBase.position.set(0, -1.25, 0);
                
                const tTop = new THREE.Mesh(new THREE.BoxGeometry(3.5, 2, 3.5), brickMat);
                tTop.position.y = 5;
                const roof = new THREE.Mesh(new THREE.ConeGeometry(3.8, 2.5, 4), roofMat);
                roof.rotation.y = Math.PI/4;
                roof.position.y = 7;
                
                tower.add(tBase, arch, archBase, tTop, roof);
                wallGroup.add(tower);
            }
        }
        chinaContent.add(wallGroup); 

        const lanternGeo = new THREE.CylinderGeometry(0.9, 0.6, 1.6, 16); 
        const lanternMat = new THREE.MeshStandardMaterial({
            color: 0xE74C3C, emissive: 0x992211, transparent: true, opacity: 0.95, roughness: 0.3
        });
        const frameMat = new THREE.MeshStandardMaterial({color: 0x3E2723}); 
        const glowMat = new THREE.MeshBasicMaterial({color: 0xFFEAA7});     

        for(let i = 0; i < 15; i++) {
            const lantern = new THREE.Group();
            
            const body = new THREE.Mesh(lanternGeo, lanternMat);
            const baseRing = new THREE.Mesh(new THREE.TorusGeometry(0.6, 0.05, 8, 16), frameMat);
            baseRing.rotation.x = Math.PI/2;
            baseRing.position.y = -0.8;
            
            const fire = new THREE.Mesh(new THREE.SphereGeometry(0.35, 16, 16), glowMat);
            fire.position.y = -0.5;
            
            const halo = new THREE.Mesh(
                new THREE.SphereGeometry(1.5, 16, 16), 
                new THREE.MeshBasicMaterial({color: 0xF39C12, transparent: true, opacity: 0.3, depthWrite: false})
            );
            
            lantern.add(body, baseRing, fire, halo);
            
            const startX = (Math.random()-0.5) * 45;
            const startZ = (Math.random()-0.5) * 20 - 5;
            const startY = Math.random() * 15;
            lantern.position.set(startX, startY, startZ);
            
            lantern.rotation.z = (Math.random()-0.5)*0.2;
            lantern.rotation.x = (Math.random()-0.5)*0.2;
            
            chinaContent.add(lantern); 
            
            gsap.to(lantern.position, {
                y: lantern.position.y + 15 + Math.random()*15,
                x: lantern.position.x + (Math.random()-0.5)*8,
                duration: 12 + Math.random()*8,
                repeat: -1,
                ease: "none"
            });
        }
    }
    else if (validCountry === 'finland') {
        const nightSnowMat = new THREE.MeshStandardMaterial({color: 0x8DA5B8, roughness: 0.9}); 
        
        const snowHill1 = new THREE.Mesh(new THREE.SphereGeometry(15, 32, 16), nightSnowMat);
        snowHill1.position.set(-15, -10, -10); snowHill1.scale.y = 0.5;
        const snowHill2 = new THREE.Mesh(new THREE.SphereGeometry(20, 32, 16), nightSnowMat);
        snowHill2.position.set(15, -12, -15); snowHill2.scale.y = 0.6;
        scenery.add(snowHill1, snowHill2);

        const cabin = new THREE.Group();
        const woodMat = new THREE.MeshStandardMaterial({color: 0x4A2E1B, roughness: 0.9}); 
        
        const cBody = new THREE.Mesh(new THREE.BoxGeometry(8, 5, 6), woodMat); cBody.position.y = 2.5;
        const cRoof = new THREE.Mesh(new THREE.ConeGeometry(6.5, 4.5, 4), nightSnowMat); 
        cRoof.rotation.y = Math.PI/4; cRoof.position.y = 7.25;
        
        const windowMat = new THREE.MeshBasicMaterial({color: 0xFFD700}); 
        const w1 = new THREE.Mesh(new THREE.PlaneGeometry(1.5, 1.5), windowMat); w1.position.set(-2, 2.5, 3.01);
        const w2 = new THREE.Mesh(new THREE.PlaneGeometry(1.5, 1.5), windowMat); w2.position.set(2, 2.5, 3.01);
        
        const chimney = new THREE.Mesh(new THREE.BoxGeometry(1, 3, 1), new THREE.MeshStandardMaterial({color: 0x222222}));
        chimney.position.set(-2, 7, -1);
        
        const smoke = new THREE.Mesh(new THREE.SphereGeometry(0.8), new THREE.MeshBasicMaterial({color:0xdddddd, transparent:true, opacity:0.5, depthWrite: false}));
        smoke.position.set(-2, 9, -1);
        gsap.to(smoke.position, {y: 13, x: 1, duration: 2.5, repeat: -1});
        gsap.to(smoke.material, {opacity: 0, duration: 2.5, repeat: -1});

        const cabinLight = new THREE.PointLight(0xFFA500, 1.5, 15);
        cabinLight.position.set(0, 3, 4);

        cabin.add(cBody, cRoof, w1, w2, chimney, smoke, cabinLight);
        cabin.position.set(0, 0, -5);
        scenery.add(cabin);

        const createPine = (x, z, scale) => {
            const tree = new THREE.Group();
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 2), woodMat); trunk.position.y = 1;
            const needleMat = new THREE.MeshStandardMaterial({color: 0x1E4D2B, flatShading: true}); 
            const t1 = new THREE.Mesh(new THREE.ConeGeometry(2.5, 3, 8), needleMat); t1.position.y = 3;
            const t2 = new THREE.Mesh(new THREE.ConeGeometry(2.0, 3, 8), needleMat); t2.position.y = 4.5;
            const t3 = new THREE.Mesh(new THREE.ConeGeometry(1.5, 3, 8), nightSnowMat); t3.position.y = 6; 
            tree.add(trunk, t1, t2, t3);
            tree.position.set(x, 0, z);
            tree.scale.set(scale, scale, scale);
            scenery.add(tree);
        };
        
        createPine(-10, 2, 1.2); 
        createPine(12, -2, 1.5);
        createPine(-15, -8, 1.8); 
        createPine(18, -10, 1.3);
        createPine(8, 4, 1.0);     
        createPine(-6, 6, 0.9);    
        createPine(6, -6, 1.1);    
        createPine(0, -12, 1.6);   
        createPine(-9, -14, 1.5);  
        createPine(8, -15, 1.4);   
    }

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ‹ç…§ç³»çµ± - ç§»é™¤æ–‡å­—æç¤ºï¼ŒåŠ å…¥çœŸå¯¦æ¸²æŸ“ç›¸ç‰‡èˆ‡æ‹ç«‹å¾—é¡¯å½±å‹•ç•« â˜…â˜…â˜…

    // åŠ ä¸Šé€æ˜æ¥æ”¶å±¤ï¼Œç¢ºä¿é»æ“Šåˆ°ä»»ä½•åœ°æ–¹éƒ½èƒ½æ‹ç…§
    const hitBox = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshBasicMaterial({visible: false}));
    hitBox.position.set(0, 5, 0);
    group.add(hitBox);

    // ç”¨ä¾†å€åˆ†ä½¿ç”¨è€…æ˜¯ã€Œé»æ“Šæ‹ç…§ã€é‚„æ˜¯ã€Œæ‹–æ›³è¦–è§’ã€
    let isDragging = false;
    let downX = 0, downY = 0;
    
    const onDown = (e) => { 
        downX = e.clientX; 
        downY = e.clientY; 
        isDragging = false; 
    };
    const onUp = (e) => { 
        if(Math.abs(e.clientX - downX) > 5 || Math.abs(e.clientY - downY) > 5) {
            isDragging = true; 
        } else {
            isDragging = false;
        }
    };
    
    window.addEventListener('pointerdown', onDown);
    // ä½¿ç”¨ capture éšæ®µç¢ºä¿åœ¨è§¸ç™¼ interactionLogic å‰åŸ·è¡Œ
    window.addEventListener('pointerup', onUp, true); 

    let photosTaken = 0;
    const maxPhotos = 3; // æ‹ 3 å¼µå¾ŒçµæŸæ—…è¡Œ
    let isDeveloping = false; // é˜²æ­¢é€£çºŒé»æ“Š

    const countryNames = {
        japan: "ğŸ‡¯ğŸ‡µ Memories in Japan",
        uk: "ğŸ‡¬ğŸ‡§ Memories in UK",
        korea: "ğŸ‡°ğŸ‡· Memories in Korea",
        china: "ğŸ‡¨ğŸ‡³ Memories in China",
        finland: "ğŸ‡«ğŸ‡® Memories in Finland"
    };

    return (obj) => {
        // å¦‚æœæ­£åœ¨æ‹–æ›³ç•«é¢ã€æˆ–è€…ç…§ç‰‡æ­£åœ¨æ²–æ´—ä¸­ï¼Œå°±å¿½ç•¥é»æ“Š
        if (isDragging || isDeveloping) return;
        
        isDeveloping = true;
        photosTaken++;

        // 1. é–ƒå…‰ç‡ˆç‰¹æ•ˆ (å–®ç´”ç•«é¢é–ƒç™½)
        const flash = document.createElement('div');
        flash.style.position = 'fixed';
        flash.style.top = '0'; flash.style.left = '0';
        flash.style.width = '100vw'; flash.style.height = '100vh';
        flash.style.backgroundColor = 'white';
        flash.style.zIndex = '9999';
        flash.style.pointerEvents = 'none';
        document.body.appendChild(flash);
        gsap.to(flash, {opacity: 0, duration: 0.5, onComplete: () => flash.remove()});

        // 2. â˜… æ“·å–çœŸå¯¦ç•«é¢ï¼šå…ˆå¼·åˆ¶æ¸²æŸ“ä¸€å¹€ï¼Œå†è½‰æˆ Base64 åœ–ç‰‡
        renderer.render(scene, camera);
        const imgData = renderer.domElement.toDataURL('image/png');

        // 3. å»ºç«‹æ‹ç«‹å¾— (Polaroid) UI æ¡†æ¶
        const polaroid = document.createElement('div');
        polaroid.style.position = 'fixed';
        polaroid.style.bottom = '-60%'; // è—åœ¨ç•«é¢ä¸‹æ–¹
        polaroid.style.left = '50%';
        const rot = (Math.random() - 0.5) * 8; // éš¨æ©Ÿå¾®å‚¾æ–œ
        polaroid.style.transform = `translateX(-50%) rotate(${rot}deg)`;
        polaroid.style.width = '260px';
        polaroid.style.padding = '15px 15px 60px 15px';
        polaroid.style.backgroundColor = '#FAFAFA';
        polaroid.style.boxShadow = '0 15px 35px rgba(0,0,0,0.4)';
        polaroid.style.zIndex = '9998';
        polaroid.style.borderRadius = '3px';

        // ç›¸ç‰‡é»‘åº•å€åŸŸ
        const photoContainer = document.createElement('div');
        photoContainer.style.width = '100%';
        photoContainer.style.height = '230px';
        photoContainer.style.backgroundColor = '#111'; 
        photoContainer.style.overflow = 'hidden';

        // çœŸæ­£çš„åœ–ç‰‡
        const photoImg = document.createElement('img');
        photoImg.src = imgData;
        photoImg.style.width = '100%';
        photoImg.style.height = '100%';
        photoImg.style.objectFit = 'cover';
        photoImg.style.opacity = '0'; // åˆå§‹ç‚ºé€æ˜
        // åˆå§‹æ¿¾é¡ï¼šå…¨ç°éšã€ä½å°æ¯”ã€é«˜äº®åº¦ (æ¨¡æ“¬åº•ç‰‡éæ›æ„Ÿ)
        photoImg.style.filter = 'grayscale(100%) contrast(0.5) brightness(2)';
        
        photoContainer.appendChild(photoImg);
        polaroid.appendChild(photoContainer);

        // æ‹ç«‹å¾—ä¸‹æ–¹çš„æ‰‹å¯«å­—
        const caption = document.createElement('div');
        caption.innerText = countryNames[validCountry];
        caption.style.fontFamily = "'Caveat', 'Comic Sans MS', cursive";
        caption.style.fontSize = '18px';
        caption.style.color = '#333';
        caption.style.position = 'absolute';
        caption.style.bottom = '18px';
        caption.style.width = '100%';
        caption.style.textAlign = 'center';
        caption.style.left = '0';
        polaroid.appendChild(caption);

        document.body.appendChild(polaroid);

        // 4. GSAP æ²–æ´—å‹•ç•«åºåˆ—
        const tl = gsap.timeline();
        
        // æ‹ç«‹å¾—å¾ä¸‹æ–¹æ»‘å…¥ç•«é¢ä¸­å¤®
        tl.to(polaroid, { bottom: '15%', duration: 0.8, ease: 'back.out(1.1)' });
        
        // åœ–ç‰‡æ¼¸æ¼¸æµ®ç¾
        tl.to(photoImg, { opacity: 1, duration: 1.0 }, "+=0.2");
        
        // â˜… åº•ç‰‡é¡¯å½±æ•ˆæœ (åˆ©ç”¨è‡ªè¨‚ç‰©ä»¶ proxy æ§åˆ¶æ¿¾é¡)
        const filterObj = { progress: 0 };
        tl.to(filterObj, {
            progress: 100,
            duration: 2.2,
            onUpdate: () => {
                const p = filterObj.progress / 100;
                const gray = 100 - (p * 100);       // ç°éš -> å½©è‰²
                const cont = 0.5 + (p * 0.6);       // å°æ¯”å¢å¼·
                const bright = 2.0 - (p * 1.0);     // äº®åº¦æ¢å¾©æ­£å¸¸
                photoImg.style.filter = `grayscale(${gray}%) contrast(${cont}) brightness(${bright})`;
            }
        }, "<"); // èˆ‡é€æ˜åº¦åŒæ™‚é€²è¡Œ

        // å±•ç¤ºä¸€æœƒå…’å¾Œï¼Œå‘ä¸‹æ»‘å‡ºç•«é¢
        tl.to(polaroid, { bottom: '-60%', opacity: 0, duration: 0.8, ease: 'power2.in', delay: 1.2 });
        
        // å‹•ç•«çµæŸæ¸…ç†
        tl.call(() => {
            polaroid.remove();
            
            if (photosTaken >= maxPhotos) {
                // çµæŸæ—…è¡Œ
                window.removeEventListener('pointerdown', onDown);
                window.removeEventListener('pointerup', onUp, true);
                onDone();
            } else {
                // å…è¨±æ‹ä¸‹ä¸€å¼µ
                isDeveloping = false;
            }
        });
    };
}
        
// --------------------------------------------------------
// 4. å„äº’å‹•å ´æ™¯å¯¦ä½œ
// --------------------------------------------------------

// 1. é–±è®€ (Constraint 5: æŠ½è±¡æ–‡å­—é é¢ + æ˜é¡¯ç¿»é )
function setupReadingInteraction(group, onDone) {
    const isMobile = window.innerWidth < 800;
    
    // æ‰‹æ©Ÿç‰ˆä¸åƒ…ç¸®å°ï¼Œé‚„æŠŠæ•´å€‹æˆ¿é–“å‘å·¦ç§»ï¼Œè®“å³å´çš„æ›¸æ¡Œé€²å…¥ç•«é¢ä¸­å¤®
    if (isMobile) {
        group.scale.set(0.85, 0.85, 0.85);
        group.position.x = -2.5; 
    }

    // --- 1. è‡¥å®¤ç©ºé–“åŸºç¤ ---
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(40, 40), new THREE.MeshStandardMaterial({color: 0xB5A89D, roughness: 1}));
    floor.rotation.x = -Math.PI / 2; floor.position.y = -0.5;
    group.add(floor);

    const wallMat = new THREE.MeshStandardMaterial({color: 0xA89B9D, roughness: 0.9});
    const backWall = new THREE.Mesh(new THREE.BoxGeometry(40, 20, 1), wallMat);
    backWall.position.set(0, 9.5, -12);
    group.add(backWall);
    const sideWall = new THREE.Mesh(new THREE.BoxGeometry(1, 20, 40), wallMat);
    sideWall.position.set(-15, 9.5, 0);
    group.add(sideWall);

    // æ›ç•«
    const frame = new THREE.Mesh(new THREE.BoxGeometry(6, 4, 0.2), new THREE.MeshStandardMaterial({color: 0xD5C4A1}));
    const canvasMesh = new THREE.Mesh(new THREE.PlaneGeometry(5, 3), new THREE.MeshStandardMaterial({color: 0xFFFAFA}));
    frame.position.set(-6, 8, -11.4);
    canvasMesh.position.set(-6, 8, -11.29);
    group.add(frame, canvasMesh);

    // --- 2. å·¦å´åºŠé‹ªå€ ---
    const bedGroup = new THREE.Group();
    bedGroup.position.set(-6.5, 0, -4);
    const bedFrame = new THREE.Mesh(new THREE.BoxGeometry(8, 2, 12), new THREE.MeshStandardMaterial({color: 0x6E7C7C}));
    bedFrame.position.y = 0.5;
    const mattress = new THREE.Mesh(new THREE.BoxGeometry(7.6, 1.2, 11.6), new THREE.MeshStandardMaterial({color: 0xC89F9C, roughness: 1}));
    mattress.position.y = 2.1;
    const pillow = new THREE.Mesh(new THREE.BoxGeometry(4, 0.6, 2.5), new THREE.MeshStandardMaterial({color: 0xFFFAFA}));
    pillow.position.set(0, 2.9, -4);
    pillow.rotation.x = 0.2;
    bedGroup.add(bedFrame, mattress, pillow);
    group.add(bedGroup);

    // --- 3. å³å´æ›¸æ¡Œå€ ---
    const deskGroup = new THREE.Group();
    deskGroup.position.set(3.5, 0, -5); 
    group.add(deskGroup);

    // æ›¸æ¡Œæœ¬é«”
    const deskTop = new THREE.Mesh(new THREE.BoxGeometry(9, 0.4, 6), new THREE.MeshStandardMaterial({color: 0x8F775B}));
    deskTop.position.y = 4; // æ¡Œé¢é«˜åº¦ 4.2
    const deskLeg1 = new THREE.Mesh(new THREE.BoxGeometry(0.4, 4, 5), new THREE.MeshStandardMaterial({color: 0x333333}));
    deskLeg1.position.set(-4, 2, 0);
    const deskLeg2 = new THREE.Mesh(new THREE.BoxGeometry(0.4, 4, 5), new THREE.MeshStandardMaterial({color: 0x333333}));
    deskLeg2.position.set(4, 2, 0);
    
    // æ›¸æ¡Œæ¤…
    const chairGroup = new THREE.Group();
    chairGroup.position.set(0, 0, 4);
    const seat = new THREE.Mesh(new THREE.BoxGeometry(3, 0.3, 3), new THREE.MeshStandardMaterial({color: 0x6E7C7C}));
    seat.position.y = 2.2;
    const chairLegs = new THREE.Mesh(new THREE.BoxGeometry(2.5, 2.2, 2.5), new THREE.MeshStandardMaterial({color: 0x333333, wireframe:true}));
    chairLegs.position.y = 1.1;
    const backrest = new THREE.Mesh(new THREE.BoxGeometry(3, 2, 0.3), new THREE.MeshStandardMaterial({color: 0x6E7C7C}));
    backrest.position.set(0, 3.3, 1.3);
    chairGroup.add(seat, chairLegs, backrest);

    // â˜… é‡æ–°è¨­è¨ˆçš„æª¯ç‡ˆ (å¾©å¤è«è˜­è¿ªç¶  + éœ§é¢é»ƒéŠ…)
   const lampGroup = new THREE.Group();
    lampGroup.position.set(3, 4.2, -1.5); 
    
    // æè³ªè¨­å®š
    const matteBlackMat = new THREE.MeshStandardMaterial({color: 0x2C2C2C, roughness: 0.8}); // å•é»‘é‡‘å±¬
    const creamShadeMat = new THREE.MeshStandardMaterial({color: 0xF5E6D3, side: THREE.DoubleSide, roughness: 0.9}); // éœ§é¢ç±³ç™½
    
    // 1. åº•åº§ (è¼•è–„æ‰å¹³åœ“ç›¤)
    const lampBase = new THREE.Mesh(new THREE.CylinderGeometry(0.9, 0.9, 0.1, 32), matteBlackMat);
    
    // 2. æ”¯æ¶ (å¸¶æœ‰ç¾ä»£æ„Ÿçš„å‰å‚¾æ–œè§’)
    const lampPole = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.08, 2.2, 16), matteBlackMat);
    lampPole.position.set(-0.3, 1.1, 0);
    lampPole.rotation.z = -0.25; // å¾€å‰å‚¾æ–œ
    
    // 3. ç‡ˆç½© (åŠåœ“é ‚ç½©å­ï¼ŒBauhaus åŒ…æµ©æ–¯é¢¨æ ¼)
    // SphereGeometry åƒæ•¸è¨­ç½®ç‚ºåŠåœ“
    const lampShade = new THREE.Mesh(new THREE.SphereGeometry(1.1, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2), creamShadeMat);
    lampShade.position.set(-0.55, 2.1, 0); // é…åˆæ”¯æ¶å‚¾æ–œçš„ä½ç½®
    lampShade.rotation.z = 0.2; // è®“ç‡ˆç½©å¾®å¾®å›æ­£ï¼Œå…‰ç·šç…§å‘æ¡Œé¢
    
    // 4. ç‡ˆæ³¡å…‰æšˆ (æº«æš–çš„ç‡ˆæ³¡è‰²)
    const lampGlow = new THREE.Mesh(new THREE.SphereGeometry(0.4, 16, 16), new THREE.MeshBasicMaterial({color: 0xFFE4B5, transparent: true, opacity: 0.8}));
    lampGlow.position.set(-0.55, 1.8, 0);
    
    lampGroup.add(lampBase, lampPole, lampShade, lampGlow);

    deskGroup.add(deskTop, deskLeg1, deskLeg2, chairGroup, lampGroup);

    // --- 4. æ›¸æœ¬ ---
    const bookGroup = new THREE.Group();
    bookGroup.position.set(0, 4.2, 0); 
    bookGroup.scale.set(0.55, 0.55, 0.55); 
    deskGroup.add(bookGroup);

    const coverMat = new THREE.MeshStandardMaterial({ color: 0x4A6B6B, roughness: 0.8 });
    const cover = new THREE.Mesh(new THREE.BoxGeometry(6.2, 0.2, 4.2), coverMat);
    bookGroup.add(cover);

    const createPageTex = () => {
        const cvs = document.createElement('canvas'); cvs.width=256; cvs.height=256;
        const ctx = cvs.getContext('2d');
        ctx.fillStyle = '#FFF8EB'; ctx.fillRect(0,0,256,256); 
        ctx.fillStyle = '#333';
        for(let y=20; y<240; y+=18) {
            let x=20;
            while(x<230) {
                let w = Math.random()*30+5; if(x+w>236) break;
                ctx.fillRect(x, y, w, 4); x+=w+8;
            }
        }
        return new THREE.CanvasTexture(cvs);
    };
    const pageMat = new THREE.MeshStandardMaterial({ map: createPageTex(), side: THREE.DoubleSide });
    const sideMat = new THREE.MeshStandardMaterial({ color: 0xEEEEEE });
    const bookMaterials = [sideMat, sideMat, pageMat, sideMat, sideMat, sideMat];

    const leftStack = new THREE.Mesh(new THREE.BoxGeometry(2.9, 0.3, 3.8), bookMaterials);
    leftStack.position.set(-1.5, 0.25, 0); bookGroup.add(leftStack);
    const rightStack = new THREE.Mesh(new THREE.BoxGeometry(2.9, 0.3, 3.8), bookMaterials);
    rightStack.position.set(1.5, 0.25, 0); bookGroup.add(rightStack);

    const pagePivot = new THREE.Group();
    pagePivot.position.set(0, 0.25, 0); 
    bookGroup.add(pagePivot);
    const flyPage = new THREE.Mesh(new THREE.BoxGeometry(2.9, 0.02, 3.8), [sideMat, sideMat, pageMat, pageMat, sideMat, sideMat]);
    flyPage.position.set(1.45, 0, 0); 
    pagePivot.add(flyPage);

    // é»æ“Šæ¡†é˜²è­·
    const hitBox = new THREE.Mesh(new THREE.BoxGeometry(16, 12, 12), new THREE.MeshBasicMaterial({visible: false}));
    hitBox.position.set(0, 2, 0);
    hitBox.userData = { isBook: true };
    bookGroup.add(hitBox);

    // 2D æç¤ºæ–‡å­—ä½ç½®é˜²æº¢å‡º
    const labelPos = new THREE.Vector3();
    bookGroup.getWorldPosition(labelPos);
    labelPos.y += 6; // å°‡ 3 æ”¹æˆ 6 (æ•¸å­—è¶Šå¤§ï¼Œæ–‡å­—ä½ç½®å°±è¶Šé«˜)
    if (isMobile) {
        labelPos.x -= 2.0; 
    }
    const instruction = create2DLabel("é»æ“Šæ›¸æœ¬ç¿»é  (3æ¬¡)", labelPos, "#6E7C7C");

    let flips = 0;
    let isAnimating = false;

    return (obj) => {
        if (isAnimating) return;
        
        let isHit = false;
        let target = obj;
        while(target) {
            if(target.userData && target.userData.isBook) isHit = true;
            if(target === bookGroup) isHit = true;
            target = target.parent;
        }
        if(!isHit) return;

        isAnimating = true;
        pagePivot.rotation.z = 0;
        
        gsap.to(pagePivot.rotation, { 
            z: Math.PI - 0.1, 
            duration: 0.6, 
            ease: "power2.inOut",
            onComplete: () => {
                pagePivot.rotation.z = 0;
                isAnimating = false;
                flips++;
                
                const textPos = new THREE.Vector3();
                bookGroup.getWorldPosition(textPos);
                create2DFeedback("çŸ¥è­˜ +1", new THREE.Vector3(textPos.x-1, textPos.y+2, textPos.z), "#8F9E8B");
                
                if (flips >= 3) {
                    instruction.innerText = "é–±ç•¢åˆå·";
                    instruction.style.color = "#8F9E8B";
                    setTimeout(onDone, 800);
                }
            }
        });
    };
}
// ==========================================
// 3. åƒé£¯äº’å‹• (é«˜æ“¬çœŸå£½å¸å®šé£Ÿ)
// ==========================================
function setupDinnerInteraction(group, onDone) {
    const isMobile = window.innerWidth < 800;
    if (isMobile) group.scale.set(0.9, 0.9, 0.9);

    // --- 1. å±…é…’å±‹ç©ºé–“ ---
    // æ¦»æ¦»ç±³æ„Ÿåœ°æ¿ (è«è˜­è¿ªé¼ å°¾è‰ç¶ )
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(40, 40), new THREE.MeshStandardMaterial({color: 0x9FA39A, roughness: 1}));
    floor.rotation.x = -Math.PI / 2; floor.position.y = -0.5;
    group.add(floor);

    // æœ¨è³ªèƒŒç‰†
    const woodMat = new THREE.MeshStandardMaterial({color: 0x8B7355, roughness: 0.9});
    const backWall = new THREE.Mesh(new THREE.BoxGeometry(40, 20, 1), woodMat);
    backWall.position.set(0, 9.5, -12);
    group.add(backWall);

    // éšœå­æ‹‰é–€ (å´ç‰†) - ç”¨å¹¾ä½•äº¤éŒ¯è£½ä½œ
    const shojiGroup = new THREE.Group();
    shojiGroup.position.set(-15, 0, 0);
    const shojiPaper = new THREE.Mesh(new THREE.BoxGeometry(0.5, 20, 40), new THREE.MeshStandardMaterial({color: 0xFFFAFA, transparent: true, opacity: 0.8}));
    shojiPaper.position.y = 9.5;
    shojiGroup.add(shojiPaper);
    const gridMat = new THREE.MeshStandardMaterial({color: 0x5C4033});
    for(let y=1; y<=18; y+=3) {
        const hGrid = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.2, 40), gridMat);
        hGrid.position.y = y; shojiGroup.add(hGrid);
    }
    for(let z=-18; z<=18; z+=4) {
        const vGrid = new THREE.Mesh(new THREE.BoxGeometry(0.8, 20, 0.2), gridMat);
        vGrid.position.set(0, 9.5, z); shojiGroup.add(vGrid);
    }
    group.add(shojiGroup);

    // å’Œé¢¨åŠç‡ˆ
    const lampCord = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 6, 8), new THREE.MeshStandardMaterial({color: 0x333333}));
    lampCord.position.set(0, 12, 0);
    const lampShade = new THREE.Mesh(new THREE.CylinderGeometry(2, 2.5, 2, 8, 1, true), new THREE.MeshStandardMaterial({color: 0xFFFAFA, side: THREE.DoubleSide}));
    lampShade.position.set(0, 9, 0);
    const lampLight = new THREE.Mesh(new THREE.SphereGeometry(1, 16, 16), new THREE.MeshBasicMaterial({color: 0xFFD700, transparent: true, opacity: 0.7}));
    lampLight.position.set(0, 8.8, 0);
    group.add(lampCord, lampShade, lampLight);

    // --- 2. å‚¢ä¿±èˆ‡æ¡Œé¢ä½ˆç½® ---
    // æ—¥å¼çŸ®æ¡Œ
    const tableTop = new THREE.Mesh(new THREE.BoxGeometry(12, 0.6, 8), new THREE.MeshStandardMaterial({color: 0x6E5C47, roughness: 0.8}));
    tableTop.position.set(0, 2.3, 0);
    const tableLeg1 = new THREE.Mesh(new THREE.BoxGeometry(9, 2.5, 0.6), new THREE.MeshStandardMaterial({color: 0x4A3728}));
    tableLeg1.position.set(-4, 1, 0); tableLeg1.rotation.y = Math.PI/2;
    const tableLeg2 = new THREE.Mesh(new THREE.BoxGeometry(9, 2.5, 0.6), new THREE.MeshStandardMaterial({color: 0x4A3728}));
    tableLeg2.position.set(4, 1, 0); tableLeg2.rotation.y = Math.PI/2;
    group.add(tableTop, tableLeg1, tableLeg2);

    // åº§å¢Š (å°é¢æœ‹å‹çš„èˆ‡ä½ çš„)
    const cushionMat = new THREE.MeshStandardMaterial({color: 0x8C9E9E}); // ç°ç¶ è‰²åº§å¢Š
    const c1 = new THREE.Mesh(new THREE.BoxGeometry(3, 0.4, 3), cushionMat); c1.position.set(0, -0.3, -6);
    const c2 = new THREE.Mesh(new THREE.BoxGeometry(3, 0.4, 3), cushionMat); c2.position.set(0, -0.3, 6);
    group.add(c1, c2);

    // èŒ¶æ¯
    const cup = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.25, 0.6, 16), new THREE.MeshStandardMaterial({color: 0xD3D4D0}));
    cup.position.set(4, 2.9, 2);
    group.add(cup);

    // å£½å¸æœ¨æ¿
    const board = new THREE.Mesh(new THREE.BoxGeometry(7, 0.2, 4), new THREE.MeshStandardMaterial({color: 0xDEB887}));
    board.position.set(0, 2.7, 0);
    group.add(board);

    // å»ºç«‹å–®ä»¶å£½å¸
    const createSushi = (x, z, color, name) => {
        const sushiGroup = new THREE.Group();
        sushiGroup.position.set(x, 2.8, z);

        const rice = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.6, 0.7), new THREE.MeshStandardMaterial({color: 0xFFFAFA, roughness: 1.0}));
        rice.position.y = 0.3;
        const topping = new THREE.Mesh(new THREE.BoxGeometry(1.3, 0.2, 0.8), new THREE.MeshStandardMaterial({color: color}));
        topping.position.y = 0.7;

        sushiGroup.add(rice, topping);
        
        // éš±å½¢é»æ“Šæ¡†
        const hitBox = new THREE.Mesh(new THREE.BoxGeometry(3, 3, 3), new THREE.MeshBasicMaterial({visible: false}));
        hitBox.position.y = 0.5;
        hitBox.userData = { isFood: true, name: name };
        sushiGroup.add(hitBox);

        return sushiGroup;
    };

    // æ“ºæ”¾ä¸‰ä»¶è«è˜­è¿ªè‰²ç³»å£½å¸ (é®­é­šã€ç‰å­ã€é®ªé­š)
    const s1 = createSushi(-2.2, 0, 0xE08A8A, "é®­é­šå£½å¸");
    const s2 = createSushi(0, 0, 0xD4A017, "ç‰å­ç‡’å£½å¸");
    const s3 = createSushi(2.2, 0, 0xC47B7B, "é®ªé­šå£½å¸");
    group.add(s1, s2, s3);

    // --- 3. äº’å‹•é‚è¼¯ ---
    const labelPos = new THREE.Vector3(0, 509, -2);
    const instruction = create2DLabel("é»æ“Šå£½å¸äº«ç”¨", labelPos, "#D5C4A1");

    let eatenCount = 0;
    return (obj) => {
        let target = obj;
        let isHit = false;
        while(target && target.parent && target.parent !== group) {
            if (target.userData && target.userData.isFood) {
                isHit = true; break;
            }
            target = target.parent;
        }

        if (isHit) {
            const sushiGroup = target.parent;
            // ç¸®å°åƒæ‰
            gsap.to(sushiGroup.scale, { x: 0, y: 0, z: 0, duration: 0.3, ease: "back.in" });
            
            const pos = new THREE.Vector3();
            sushiGroup.getWorldPosition(pos);
            create2DFeedback("Oishii!", new THREE.Vector3(pos.x, pos.y + 502, pos.z), "#E08A8A");
            
            target.userData.isFood = false; // é¿å…é‡è¤‡é»æ“Š
            eatenCount++;
            
            if (eatenCount >= 3) {
                instruction.innerText = "å¤šè¬æ¬¾å¾…ï¼ŒèŠå¾—çœŸé–‹å¿ƒ";
                instruction.style.color = "#8F9E8B";
                setTimeout(onDone, 1000);
            }
        }
    };
}

// 3. é›»å½±
// æ›¿æ›åŸæœ‰çš„ setupMovieInteraction
function setupMovieInteraction(group, onDone) {
    const room = new THREE.Mesh(new THREE.BoxGeometry(20, 20, 20), new THREE.MeshBasicMaterial({color: 0x111111, side: THREE.BackSide}));
    group.add(room);

    // 1. å»ºç«‹ Canvas ä½œç‚ºé›»å½±åº•ç‰‡
    const canvas = document.createElement('canvas');
    canvas.width = 800;
    canvas.height = 480;
    const ctx = canvas.getContext('2d');
    
    // åˆå§‹é»‘å±
    ctx.fillStyle = '#000000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const screenTex = new THREE.CanvasTexture(canvas);
    const screenGeo = new THREE.PlaneGeometry(10, 6);
    const screenMat = new THREE.MeshBasicMaterial({ map: screenTex });
    const screen = new THREE.Mesh(screenGeo, screenMat);
    screen.position.set(0, 2, -5);
    screen.rotation.x = 0.1;
    group.add(screen);

    const seatGeo = new THREE.BoxGeometry(1.5, 2, 1.5);
    const seatMat = new THREE.MeshStandardMaterial({color: 0x6E7C7C});
    for(let x=-4; x<=4; x+=2) {
        const seat = new THREE.Mesh(seatGeo, seatMat);
        seat.position.set(x, -2, 2);
        group.add(seat);
    }

    const labelPos = new THREE.Vector3(0, 505, 0);
    const instruction = create2DLabel("é»æ“Šè¢å¹•è§€è³", labelPos, "#AAAAAA");

    const beamGeo = new THREE.ConeGeometry(8, 15, 32, 1, true);
    const beamMat = new THREE.MeshBasicMaterial({ 
        color: 0xFFFFFF, transparent: true, opacity: 0.1, side: THREE.DoubleSide, blending: THREE.AdditiveBlending, depthWrite: false
    });
    const beam = new THREE.Mesh(beamGeo, beamMat);
    beam.rotation.x = -Math.PI / 2;
    beam.position.set(0, 2, 2.5); 
    group.add(beam);

    let isWatching = false;
    let animFrame;

    return (obj) => {
        if (isWatching) return;
        isWatching = true;
        instruction.innerText = "æ”¾æ˜ ä¸­...";

        const startTime = Date.now();
        const totalDuration = 7000; // é›»å½±ç¸½é•·æ”¹ç‚º 7 ç§’

        // 2. é›»å½±ç¹ªè£½å¾ªç’°å‡½æ•¸
        function drawMovie() {
            const elapsed = Date.now() - startTime;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // éšæ®µä¸€ï¼šç¶“å…¸å€’æ•¸è¨ˆæ™‚ (0~2ç§’)
            if (elapsed < 2000) {
                ctx.fillStyle = Math.random() > 0.5 ? '#222' : '#333';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 4; ctx.beginPath();
                ctx.moveTo(canvas.width/2, 0); ctx.lineTo(canvas.width/2, canvas.height);
                ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2);
                ctx.stroke();

                const count = Math.ceil(3 - (elapsed / 666));
                if (count > 0) {
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 200px Arial';
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText(count, canvas.width/2, canvas.height/2);
                }
            } 
            // éšæ®µäºŒï¼šæŠ½è±¡è«è˜­è¿ªé¢¨æ™¯å‹•ç•« (2~5.5ç§’)
            else if (elapsed < 5500) {
                const playTime = elapsed - 2000;
                
                // å¤©ç©º
                ctx.fillStyle = `hsl(${200 + playTime * 0.01}, 30%, 60%)`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // å¤ªé™½
                ctx.beginPath();
                ctx.arc(100 + playTime * 0.1, 150 + Math.sin(playTime * 0.002) * 50, 80, 0, Math.PI * 2);
                ctx.fillStyle = '#D5C4A1'; ctx.fill();

                // å±±è„ˆ
                const offset = (playTime * 0.1) % canvas.width;
                ctx.fillStyle = '#8C9E9E'; ctx.beginPath();
                ctx.moveTo(-offset, canvas.height); ctx.lineTo(-offset + 300, 200);
                ctx.lineTo(-offset + 600, canvas.height); ctx.lineTo(800 - offset + 300, 200);
                ctx.lineTo(800 - offset + 600, canvas.height); ctx.fill();

                // åˆ®ç—•
                if (Math.random() < 0.3) {
                    ctx.fillStyle = 'rgba(255,255,255,0.2)';
                    ctx.fillRect(Math.random() * canvas.width, 0, 2 + Math.random() * 5, canvas.height);
                }
            }
            // â˜… éšæ®µä¸‰ï¼šç¶“å…¸ã€ŒåŠ‡çµ‚ã€ç•«é¢ (5.5~7ç§’)
            else {
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // å¾©å¤é–ƒçˆå­—é«”
                if (Math.random() > 0.05) {
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 120px "Noto Serif TC", serif'; // ä½¿ç”¨éŠæˆ²æ¨™é¡ŒåŒæ¬¾å­—é«”
                    ctx.textAlign = 'center'; 
                    ctx.textBaseline = 'middle';
                    ctx.fillText('åŠ‡ çµ‚', canvas.width/2, canvas.height/2);
                }

                // æ’­æ”¾åˆ°åº•éƒ¨é‚„æ˜¯æœ‰ä¸€é»é»åˆ®ç—•
                if (Math.random() < 0.3) {
                    ctx.fillStyle = 'rgba(255,255,255,0.1)';
                    ctx.fillRect(Math.random() * canvas.width, 0, 2, canvas.height);
                }
            }

            // æ›´æ–°æè³ª
            screenTex.needsUpdate = true;

            // æ§åˆ¶é›»å½±é€²åº¦
            if (elapsed < totalDuration) {
                animFrame = requestAnimationFrame(drawMovie);
            } else {
                // æ”¾æ˜ å®Œå…¨çµæŸï¼Œæ”¶èµ·å…‰æŸä¸¦é€€å ´
                cancelAnimationFrame(animFrame);
                
                // è¢å¹•é—œé–‰è®Šé»‘
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                screenTex.needsUpdate = true;
                
                beam.visible = false;
                instruction.innerText = "æ”¾æ˜ çµæŸ";
                instruction.style.color = "#D5C4A1";
                setTimeout(onDone, 800); // å»¶é²ä¸€ä¸‹å†åˆ‡æ›å›ä¸»ç•«é¢
            }
        }

        // é–‹å§‹æ”¾æ˜ 
        drawMovie();
    };
}

// 4. è³¼ç‰©
// 4. è³¼ç‰© (ä¿®æ”¹ç‚ºæ‰å¹³ç´™è¢‹è¨­è¨ˆ)
function setupShoppingInteraction(group, onDone) {
    const isMobile = window.innerWidth < 800;
    if (isMobile) group.scale.set(0.9, 0.9, 0.9);

    // --- 1. ç²¾å“åº—ç©ºé–“èˆ‡è£æ½¢ ---
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(40, 40), new THREE.MeshStandardMaterial({color: 0xD3D4D0, roughness: 0.3}));
    floor.rotation.x = -Math.PI / 2; floor.position.y = -0.5;
    group.add(floor);

    const rug = new THREE.Mesh(new THREE.CylinderGeometry(8, 8, 0.1, 32), new THREE.MeshStandardMaterial({color: 0xC89F9C, roughness: 1}));
    rug.position.set(0, -0.4, 0);
    rug.scale.z = 0.7; 
    group.add(rug);

    const wallMat = new THREE.MeshStandardMaterial({color: 0xE0CDCF, roughness: 0.9});
    const backWall = new THREE.Mesh(new THREE.BoxGeometry(40, 20, 1), wallMat);
    backWall.position.set(0, 9.5, -12);
    group.add(backWall);
    const sideWall = new THREE.Mesh(new THREE.BoxGeometry(1, 20, 40), wallMat);
    sideWall.position.set(-15, 9.5, 0);
    group.add(sideWall);

    // --- 2. è±å¯Œçš„åº—å…§è¨­æ–½ ---
    const goldMat = new THREE.MeshStandardMaterial({color: 0xD4A017, metalness: 0.8, roughness: 0.2});
    const darkWoodMat = new THREE.MeshStandardMaterial({color: 0x4A3728, roughness: 0.8});

    // A. å±•ç¤ºæ«ƒ
    const shelfGroup = new THREE.Group();
    shelfGroup.position.set(6, 0, -11);
    const shelfBack = new THREE.Mesh(new THREE.BoxGeometry(10, 14, 0.5), darkWoodMat);
    shelfBack.position.y = 7;
    shelfGroup.add(shelfBack);
    const itemColors = [0x8C9E9E, 0x8B7355, 0xFFFAFA, 0x333333];
    for(let i=1; i<=3; i++) {
        const board = new THREE.Mesh(new THREE.BoxGeometry(9.6, 0.2, 2), goldMat);
        board.position.set(0, i * 4, 1);
        shelfGroup.add(board);
        
        const item1 = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), new THREE.MeshStandardMaterial({color: itemColors[i]}));
        item1.position.set(-2.5, i*4 + 0.85, 1);
        const item2 = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 1), new THREE.MeshStandardMaterial({color: itemColors[(i+1)%4]}));
        item2.position.set(2.5, i*4 + 0.6, 1);
        shelfGroup.add(item1, item2);
    }
    group.add(shelfGroup);

    // B. å…¨èº«ç«‹é¡
    const mirrorGroup = new THREE.Group();
    mirrorGroup.position.set(-5, 0, -11);
    mirrorGroup.rotation.y = Math.PI / 8; 
    const mirrorFrame = new THREE.Mesh(new THREE.BoxGeometry(4.5, 12, 0.4), goldMat);
    mirrorFrame.position.y = 6;
    const mirrorGlass = new THREE.Mesh(new THREE.PlaneGeometry(4, 11.5), new THREE.MeshStandardMaterial({color: 0x7B9ACC, metalness: 0.8, roughness: 0.1}));
    mirrorGlass.position.set(0, 6, 0.21);
    mirrorGroup.add(mirrorFrame, mirrorGlass);
    group.add(mirrorGroup);

    // C. æ›è¡£æ¡¿
    const rackPole = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 10, 16), goldMat);
    rackPole.rotation.x = Math.PI/2; rackPole.position.set(-14, 7, -2);
    group.add(rackPole);
    for(let i=0; i<4; i++) {
        const cloth = new THREE.Mesh(new THREE.CylinderGeometry(1.2, 1.5, 4, 4), new THREE.MeshStandardMaterial({color: itemColors[i]}));
        cloth.rotation.y = Math.PI/4; cloth.scale.z = 0.2; 
        cloth.position.set(-13.5, 4.5, -6 + i*2.5);
        group.add(cloth);
    }

    // D. æ›´è¡£å®¤å¸ƒç°¾
    const curtain = new THREE.Mesh(new THREE.CylinderGeometry(4, 4, 14, 16, 1, true, 0, Math.PI * 1.2), new THREE.MeshStandardMaterial({color: 0x8C9E9E, side: THREE.DoubleSide}));
    curtain.position.set(-11, 7, -11);
    group.add(curtain);

    // â˜… E. é‡æ–°è¨­è¨ˆçš„å±•ç¤ºä¸­å³¶æ¡Œ (æ·±èƒ¡æ¡ƒæœ¨è‰²æ¡Œé¢ + é‡‘è‰²é‡‘å±¬è…³)
    const tableTop = new THREE.Mesh(new THREE.BoxGeometry(10, 0.6, 6), new THREE.MeshStandardMaterial({color: 0x3E2723, roughness: 0.6}));
    tableTop.position.set(0, 3.3, 0); // æ¡Œé¢é«˜åº¦ 3.6
    
    // é‡‘è‰²é‡‘å±¬æ”¯æ¶
    const legGeo = new THREE.CylinderGeometry(0.15, 0.15, 3, 16);
    const leg1 = new THREE.Mesh(legGeo, goldMat); leg1.position.set(-4.5, 1.5, -2.5);
    const leg2 = new THREE.Mesh(legGeo, goldMat); leg2.position.set(4.5, 1.5, -2.5);
    const leg3 = new THREE.Mesh(legGeo, goldMat); leg3.position.set(-4.5, 1.5, 2.5);
    const leg4 = new THREE.Mesh(legGeo, goldMat); leg4.position.set(4.5, 1.5, 2.5);
    
    group.add(tableTop, leg1, leg2, leg3, leg4);

    // --- 3. è³¼ç‰©ç´™è¢‹æ‰è½é‚è¼¯ ---
    const labelPos = new THREE.Vector3(0, 510, -3);
    const instruction = create2DLabel("é»æ“Šæ¶è³¼ç´™è¢‹", labelPos);

    let caught = 0;
    const maxBags = 4;
    const bagColors = [0xA65E5E, 0x4E6C50, 0x667C89, 0xD4A017, 0xB5A89D];

    const spawnBag = () => {
        if (caught >= maxBags) return;
        const bagGroup = new THREE.Group();
        
        const bagGeo = new THREE.CylinderGeometry(1.2, 1.0, 1.8, 4);
        bagGeo.rotateY(Math.PI / 4); 
        bagGeo.scale(1.2, 1.0, 0.3); 
        
        const colorHex = bagColors[Math.floor(Math.random() * bagColors.length)];
        const bagMat = new THREE.MeshStandardMaterial({ color: colorHex, roughness: 0.8, flatShading: true });
        const bag = new THREE.Mesh(bagGeo, bagMat);
        
        const handle = new THREE.Mesh(new THREE.TorusGeometry(0.4, 0.04, 8, 16, Math.PI), new THREE.MeshStandardMaterial({color: 0x222222}));
        handle.position.y = 0.9;
        bagGroup.add(bag, handle);
        
        bagGroup.position.set((Math.random()-0.5)*7, 15, (Math.random()-0.5)*3);
        
        // â˜… æ”¾å¤§ç´™è¢‹çš„é»æ“Šåˆ¤å®šæ¡†
        const hitBox = new THREE.Mesh(new THREE.BoxGeometry(8, 8, 8), new THREE.MeshBasicMaterial({visible: false}));
        hitBox.userData = { isBag: true };
        bagGroup.add(hitBox);
        group.add(bagGroup);

        // â˜… ç´™è¢‹è½åœ¨æ¡Œé¢ä¸Š (æ¡Œé¢y=3.6ï¼Œç´™è¢‹ä¸­å¿ƒç´„è·åº•0.9ï¼Œæ‰€ä»¥ 3.6+0.9 = 4.5)
        gsap.to(bagGroup.position, { y: 4.5, duration: 2.0, ease: "bounce.out", onComplete: () => {
            if (group.children.includes(bagGroup)) {
                group.remove(bagGroup);
                if (caught < maxBags) spawnBag();
            }
        }});
        gsap.to(bagGroup.rotation, { y: (Math.random()-0.5), z: (Math.random()-0.5)*0.4, duration: 2.0 });
    };

    spawnBag();

    return (obj) => {
        let target = obj;
        while(target && target.parent && target.parent !== group) {
            if (target.userData && target.userData.isBag) break;
            target = target.parent;
        }

        if (target && target.userData && target.userData.isBag) {
            const bagGroup = target.parent;
            const pos = new THREE.Vector3();
            bagGroup.getWorldPosition(pos);
            create2DFeedback("çµå¸³ï¼", new THREE.Vector3(pos.x, pos.y + 502, pos.z), "#D4A017");
            
            group.remove(bagGroup);
            caught++;
            if (caught >= maxBags) {
                instruction.innerText = "æ»¿è¼‰è€Œæ­¸";
                instruction.style.color = "#D4A017";
                setTimeout(onDone, 800);
            } else {
                spawnBag();
            }
        }
    };
}
// 1. æ‰¹æ”¹ (è¶…é¡¯çœ¼ç´…è‰²ã€Œé–±ã€å­—è“‹ç« )
// === ä¿®è¨‚ç‰ˆï¼šæ‰¹æ”¹äº’å‹• (ä¿®æ­£æ–‡å­—æ¸…æ™°åº¦) ===
// === å„ªåŒ–ç‰ˆï¼šæ‰¹æ”¹äº’å‹• (ç§»é™¤ç”Ÿç¡¬çš„å­—é«”ä»£ç¢¼ï¼Œå¥—ç”¨æ¯›ç»ç’ƒ) ===
function setupGradingInteraction(group, onDone, count = 1) {
    const table = new THREE.Mesh(new THREE.BoxGeometry(12, 0.5, 8), new THREE.MeshStandardMaterial({color: 0x6E7C7C}));
    table.position.y = -0.5;
    group.add(table);

    const paperGroup = new THREE.Group();
    group.add(paperGroup);

    const papers =[];
    for(let i=0; i<count; i++) {
        const paper = new THREE.Mesh(new THREE.PlaneGeometry(3, 4), new THREE.MeshStandardMaterial({color: 0xFFFFFF, side: THREE.DoubleSide}));
        paper.rotation.x = -Math.PI / 2;
        paper.position.set(0, i * 0.05, 0);
        paper.rotation.z = (Math.random() - 0.5) * 0.2;
        paperGroup.add(paper);
        papers.push(paper);
    }

    const woodMat = new THREE.MeshStandardMaterial({ color: 0x8B5A2B, roughness: 0.9 });
    const stampGroup = new THREE.Group();
    const base = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 0.4, 32), woodMat);
    const handle = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 1.2, 16), woodMat);
    handle.position.y = 0.8;
    const topNode = new THREE.Mesh(new THREE.SphereGeometry(0.3, 16, 16), woodMat);
    topNode.position.y = 1.4;
    
    stampGroup.add(base, handle, topNode);
    stampGroup.position.set(4, 2, 0); 
    stampGroup.rotation.z = 0.5; 
    group.add(stampGroup);

    // â˜… åŒæ¨£ä½¿ç”¨ä¹¾æ·¨çš„å‘¼å«æ–¹å¼
    const labelPos = new THREE.Vector3(0, 503, -3);
    const instruction = create2DLabel("é»æ“Šè“‹ç« ", labelPos);

    let currentIndex = count - 1;
    let isStamping = false;

    return (obj) => {
        if (isStamping || currentIndex < 0) return;
        isStamping = true;

        const targetPaper = papers[currentIndex];
        
        const tl = gsap.timeline({
            onComplete: () => {
                gsap.to(targetPaper.position, { x: -8, y: targetPaper.position.y + 2, z: -5, opacity: 0, duration: 0.5 });
                gsap.to(targetPaper.rotation, { z: Math.random(), duration: 0.5 });
                
                currentIndex--;
                isStamping = false;
                
                if (currentIndex < 0) {
                    instruction.innerText = "å®Œæˆ";
                    setTimeout(onDone, 800);
                }
            }
        });

      tl.to(stampGroup.position, { x: 0, y: 1.5, z: 0, duration: 0.2 });
        tl.to(stampGroup.rotation, { z: 0, duration: 0.2 }, "<");
        tl.to(stampGroup.position, { y: 0.2 + (currentIndex * 0.05), duration: 0.1, ease: "power1.in" });
        
        // --- ä¿®æ”¹è™•é–‹å§‹ ---
        tl.call(() => {
            const stampWorldPos = new THREE.Vector3();
            targetPaper.getWorldPosition(stampWorldPos);
            stampWorldPos.y = 502; 
            
            // æ’­æ”¾è½æ¬¾éŸ³æ•ˆ
            playStampSound();
            
            create2DStamp("é–±", stampWorldPos, "#C0392B");
        });
        // --- ä¿®æ”¹è™•çµæŸ ---

        tl.to(stampGroup.position, { x: 4, y: 2, z: 0, duration: 0.3, ease: "back.out" });
        tl.to(stampGroup.rotation, { z: 0.5, duration: 0.3 }, "<");
    };
}

// ==========================================
// æ›¿æ› 2ï¼šè¡Œæ”¿äº’å‹•å ´æ™¯ (æ¸…ç†èªæ³•éŒ¯èª¤ã€è§£æ±ºç–Šè‰²èˆ‡æ‰‹æ©Ÿé©é…å•é¡Œ)
// ==========================================
function setupAdminInteraction(group, onDone) {
    const isMobile = window.innerWidth < 800;
    
    // --- 0. éŸ¿æ‡‰å¼å ´æ™¯ç¸®æ”¾ ---
    if (isMobile) {
        group.scale.set(0.85, 0.85, 0.85);
    }
 
    // --- 1. æ•™å“¡å®¤ç©ºé–“åŸºç¤ ---
    const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(30, 30),
        new THREE.MeshStandardMaterial({ color: 0xD3D4D0, roughness: 1 })
    );
    floor.rotation.x = -Math.PI / 2;
    floor.position.y = -0.51;
    group.add(floor);
 
    // å±é¢¨
    const partitionMat = new THREE.MeshStandardMaterial({ color: 0x7A8B8B, roughness: 0.9 });
    const backWall = new THREE.Mesh(new THREE.BoxGeometry(16, 8, 0.4), partitionMat);
    backWall.position.set(0, 3.5, -4.5);
    group.add(backWall);
 
    const sideWall = new THREE.Mesh(new THREE.BoxGeometry(0.4, 8, 10), partitionMat);
    sideWall.position.set(7.5, 3.5, 0);
    group.add(sideWall);
 
    // --- 2. è¾¦å…¬æ¡Œ ---
    const table = new THREE.Mesh(
        new THREE.BoxGeometry(15, 0.6, 9),
        new THREE.MeshStandardMaterial({ color: 0xD5C4A1, roughness: 0.8 }) // æš–æ²™æœ¨è‰²
    );
    table.position.y = -0.2;
    group.add(table);
 
    // --- 3. è£é£¾ç‰©ä»¶ ---
    // æ–‡ä»¶å¤¾ç§»è‡³ã€å·¦å¾Œæ–¹ã€‘è§’è½
    const folderColors = [0xC89F9C, 0x8D857F, 0x7B9ACC, 0x95a5a6];
    for (let i = 0; i < 5; i++) {
        const folder = new THREE.Mesh(
            new THREE.BoxGeometry(0.6, 2.5, 1.8),
            new THREE.MeshStandardMaterial({ color: folderColors[i % 4] })
        );
        folder.position.set(-6.5, 1.25, -3.2 + (i * 0.65));
        group.add(folder);
        // æ¨™ç±¤
        const label = new THREE.Mesh(new THREE.PlaneGeometry(0.4, 0.8), new THREE.MeshBasicMaterial({color:0xffffff}));
        label.position.set(-6.19, 1.5, -3.2 + (i * 0.65));
        label.rotation.y = Math.PI / 2;
        group.add(label);
    }
 
    // ã€æ–°ç‰©ä»¶ã€‘ç™‚ç™’å°ç›†æ ½ (å„ªåŒ–æ¤ç‰©å½¢ç‹€ç‚ºç¾ä»£ä½å¤šé‚Šå½¢é¢¨æ ¼)
    const plantGroup = new THREE.Group();
    // ç¨å¾®å¾€å·¦æ”¾ä¸€é»ï¼Œå¡«è£œå’–å•¡æ¯ç§»èµ°å¾Œçš„ç©ºä½
    plantGroup.position.set(4.5, 0.1, -2.5); 
    
    // èŠ±ç›†
    const potGeo = new THREE.CylinderGeometry(0.8, 0.5, 1.2, 16);
    const potMat = new THREE.MeshStandardMaterial({color: 0xE0CDCF, roughness: 0.9}); // è«è˜­è¿ªç²‰ç°
    const pot = new THREE.Mesh(potGeo, potMat);
    pot.position.y = 0.6;
    
    // æ³¥åœŸ
    const soil = new THREE.Mesh(new THREE.CylinderGeometry(0.75, 0.75, 0.1, 16), new THREE.MeshStandardMaterial({color: 0x4a3728}));
    soil.position.y = 1.2;
    
    // æ¤ç‰©æå¹¹
    const stemGeo = new THREE.CylinderGeometry(0.1, 0.15, 0.8, 8);
    const stemMat = new THREE.MeshStandardMaterial({color: 0x6b5344, roughness: 0.9});
    const stem = new THREE.Mesh(stemGeo, stemMat);
    stem.position.y = 1.5;

    // æ¤ç‰©è‘‰ç‰‡å† ç¾¤ (åˆ©ç”¨ Dodecahedron è£½ä½œæœ‰è¨­è¨ˆæ„Ÿçš„ç«‹é«”åˆ‡é¢)
    const leafGeoMain = new THREE.DodecahedronGeometry(0.9);
    const leafGeoSide1 = new THREE.DodecahedronGeometry(0.5);
    const leafGeoSide2 = new THREE.DodecahedronGeometry(0.4);
    const leafMat = new THREE.MeshStandardMaterial({color: 0x7C9473, roughness: 0.8, flatShading: true}); 
    
    const leafMain = new THREE.Mesh(leafGeoMain, leafMat);
    leafMain.position.set(0, 2.3, 0);
    
    const leafSide1 = new THREE.Mesh(leafGeoSide1, leafMat);
    leafSide1.position.set(0.6, 1.9, 0.4);
    
    const leafSide2 = new THREE.Mesh(leafGeoSide2, leafMat);
    leafSide2.position.set(-0.6, 2.0, -0.3);
    
    plantGroup.add(pot, soil, stem, leafMain, leafSide1, leafSide2);
    group.add(plantGroup);
 
    // --- 4. è¢å¹•çµ„ä»¶ ---
    const monitorGroup = new THREE.Group();
    group.add(monitorGroup);
    
    const monitorBase = new THREE.Mesh(new THREE.BoxGeometry(3, 0.2, 2), new THREE.MeshStandardMaterial({color: 0x333333}));
    monitorBase.position.set(0, 0.1, -2);
    
    const monitorStand = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 1.5), new THREE.MeshStandardMaterial({color: 0x555555}));
    monitorStand.position.set(0, 0.8, -2);
    
    const monitorScreen = new THREE.Mesh(new THREE.BoxGeometry(7, 4, 0.4), new THREE.MeshStandardMaterial({color: 0x222222}));
    monitorScreen.position.set(0, 2.8, -1.5);
    
    const screenFace = new THREE.Mesh(new THREE.PlaneGeometry(6.6, 3.6), new THREE.MeshBasicMaterial({color: 0x0a192f}));
    screenFace.position.set(0, 2.8, -1.29);
    
    monitorGroup.add(monitorBase, monitorStand, monitorScreen, screenFace);
 
    // --- 5. é›™è‰²ç«‹é«”éµç›¤ ---
    const keyboardBase = new THREE.Mesh(
        new THREE.BoxGeometry(4.8, 0.35, 2.2),
        new THREE.MeshStandardMaterial({color: 0x3d3d3d, roughness: 0.8})
    );
    keyboardBase.position.set(0, 0.1, 1.5);
    keyboardBase.rotation.x = 0.12;
    keyboardBase.userData = { isKeyboard: true };
    group.add(keyboardBase);
 
    const keyGeo = new THREE.BoxGeometry(0.36, 0.18, 0.36);
    const keyMat = new THREE.MeshStandardMaterial({color: 0xbcbcbc, roughness: 0.5});
    for (let r = 0; r < 4; r++) {
        for (let c = 0; c < 10; c++) {
            const key = new THREE.Mesh(keyGeo, keyMat);
            key.position.set((c - 4.5) * 0.44, 0.22, (r - 1.5) * 0.46);
            key.position.y += Math.random() * 0.02; // å¾®å°é«˜ä½å·®å¢åŠ æ“¬çœŸæ„Ÿ
            keyboardBase.add(key);
        }
    }
 
    // --- 6. å¸¶æ–‡å­—è¡Œæ”¿æ–‡ä»¶å † ---
    const paperStack = new THREE.Group();
    const sheetGeo = new THREE.BoxGeometry(2, 0.02, 2.8);
    const sheetMat = new THREE.MeshStandardMaterial({ color: 0xFFFFFF, roughness: 0.9 });
    const textMat = new THREE.MeshBasicMaterial({ color: 0xbbbbbb });
 
    for(let i = 0; i < 22; i++) {
        const sheet = new THREE.Mesh(sheetGeo, sheetMat);
        sheet.position.y = i * 0.04;
        sheet.position.x = (Math.random() - 0.5) * 0.15;
        sheet.position.z = (Math.random() - 0.5) * 0.15;
        sheet.rotation.y = (Math.random() - 0.5) * 0.15;
        if (i > 14) { // é ‚éƒ¨å¹¾å¼µåŠ ä¸Šä»¿æ–‡å­—
            for (let l = 0; l < 5; l++) {
                const textLine = new THREE.Mesh(new THREE.PlaneGeometry(1.4, 0.1), textMat);
                textLine.rotation.x = -Math.PI / 2;
                textLine.position.set(0, 0.011, -0.8 + (l * 0.4));
                sheet.add(textLine);
            }
        }
        paperStack.add(sheet);
    }
    paperStack.position.set(-4.2, 0.1, 1.2);
    paperStack.rotation.y = 0.1;
    group.add(paperStack);
 
    // --- 7. äº’å‹•é‚è¼¯ ---
    const labelPos = new THREE.Vector3(0, 506, -5);
    const instruction = create2DLabel("è™•ç†ç¹ç‘£è¡Œæ”¿...", labelPos);
 
    let clicks = 0;
    let isTyping = false;
    const requiredClicks = 6;
 
    return (obj) => {
        let target = obj;
        while(target.parent && !target.userData.isKeyboard && target.parent !== group) target = target.parent;
 
        if (target.userData.isKeyboard) {
            if (isTyping) return;
            isTyping = true;
            clicks++;
            playKeyboardSound();
 
            gsap.to(keyboardBase.position, {
                y: 0.05, duration: 0.05, yoyo: true, repeat: 1,
                onComplete: () => isTyping = false
            });
 
            // å±å¹•é€²åº¦ç·š (å®‰å…¨ Y å€é–“)
            const safeLocalY = 1.4 - (clicks * 0.5);
            if (safeLocalY > -1.7) {
                const line = new THREE.Mesh(
                    new THREE.PlaneGeometry(4.8, 0.15),
                    new THREE.MeshBasicMaterial({color: 0x64ffda, transparent: true, opacity: 0.8})
                );
                line.position.set(0, safeLocalY, 0.01);
                screenFace.add(line);
                line.scale.set(0, 1, 1);
                gsap.to(line.scale, { x: 1, duration: 0.25 });
            }
 
            create2DFeedback("ç”Ÿå‘½èª å¯è²´...", new THREE.Vector3(0, 503, 1.5), "#D5C4A1");
 
            // æ–‡ä»¶é£›æ•£
            if (paperStack.children.length > 0) {
                const topSheet = paperStack.children[paperStack.children.length - 1];
                gsap.to(topSheet.position, {
                    x: -2 + (Math.random()*2),
                    y: topSheet.position.y + 2,
                    z: -3,
                    duration: 0.5,
                    ease: "power1.out"
                });
                gsap.to(topSheet.rotation, { x: Math.random(), y: Math.random(), duration: 0.5 });
                gsap.to(topSheet.scale, { x: 0, y: 0, z: 0, duration: 0.5, onComplete: () => paperStack.remove(topSheet) });
            }
 
            if (clicks >= requiredClicks) {
                instruction.innerText = "å¾’å‹ç„¡åŠŸï¼Œæ¯«ç„¡æ”¶ç©«ã€‚";
                instruction.classList.add('label-error');
                setTimeout(onDone, 2500); // ç­‰å¾…é£›ç´™å‹•ç•«çµæŸ
            }
        }
    };
}
        
// 6. é‹å‹•
function setupSportInteraction(group, onDone) {
    const mat = new THREE.Mesh(new THREE.BoxGeometry(4, 0.2, 8), new THREE.MeshStandardMaterial({color: 0x8C9E9E}));
    mat.position.y = -0.5;
    group.add(mat);

    const dumbbell = new THREE.Group();
    const bar = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 5, 16), new THREE.MeshStandardMaterial({color: 0x6E7C7C}));
    bar.rotation.z = Math.PI / 2;
    const wGeo = new THREE.CylinderGeometry(1.2, 1.2, 0.4, 32);
    const wMat = new THREE.MeshStandardMaterial({color: 0x333333});
    const w1 = new THREE.Mesh(wGeo, wMat); w1.rotation.z = Math.PI/2; w1.position.x = -2;
    const w2 = new THREE.Mesh(wGeo, wMat); w2.rotation.z = Math.PI/2; w2.position.x = 2;
    dumbbell.add(bar, w1, w2);
    group.add(dumbbell);

    const labelPos = new THREE.Vector3(0, 503, -2);
    const instruction = create2DLabel("é»æ“Šèˆ‰é‡", labelPos, "#D5C4A1");

    let reps = 0;
    let isLifting = false;

    return (obj) => {
        if (isLifting) return;
        isLifting = true;
        reps++;

        gsap.to(dumbbell.position, { y: 3, duration: 0.4, ease: "power2.out", yoyo: true, repeat: 1, onComplete: () => {
            isLifting = false;
            create2DFeedback(reps.toString(), new THREE.Vector3(0, 504, 0), "#fff");
            
            if (reps >= 5) {
                instruction.innerText = "ç‡ƒç‡’ï¼";
                instruction.style.color = "#C0392B";
                setTimeout(onDone, 600);
            }
        }});
    };
}



// 6. ç¡è¦º (è‡ªå‹•æ’­æ”¾ä¿®å¾©ç‰ˆ - Critique 4)
function setupSleepInteraction(group, onDone) {
    // å…¨é»‘é®ç½© (å›ºå®šåœ¨ç›¸æ©Ÿå‰)
    const veilGeo = new THREE.PlaneGeometry(100, 100);
    const veilMat = new THREE.MeshBasicMaterial({color: 0x000000, transparent: true, opacity: 0, depthTest: false});
    const veil = new THREE.Mesh(veilGeo, veilMat);
    // è®“é®ç½©å§‹çµ‚é¢å°ç›¸æ©Ÿä¸¦å¡«æ»¿è¦–é‡
    veil.position.set(0, 5, 5); 
    veil.lookAt(camera.position);
    group.add(veil); // æ³¨æ„ï¼šé€™è£¡é‚„æ˜¯åŠ åœ¨ groupï¼Œä½†é ä½ç½®è¦†è“‹

    // Zzz æ–‡å­— (åˆå§‹éš±è—)
    const zText = create3DText("Z z z ...", group, 0, 2, 0, 0xFFFFFF);
    zText.material.opacity = 0;
    zText.position.y += 500; // ä¿®æ­£é«˜åº¦

    // è‡ªå‹•åŸ·è¡Œåºåˆ—
    const tl = gsap.timeline({
        onComplete: onDone
    });

    // 1. æ¼¸é»‘
    tl.to(veil.material, { opacity: 1, duration: 1.5 });
    // 2. å‡ºç¾ Zzz
    tl.to(zText.material, { opacity: 1, duration: 0.5, yoyo: true, repeat: 3 }); // é–ƒçˆ Zzz
    // 3. åœé “
    tl.to({}, { duration: 1.0 });

    // å›å‚³ç©ºå‡½æ•¸ï¼Œå› ç‚ºæ˜¯è‡ªå‹•æ’­æ”¾ï¼Œä¸æ¥å—é»æ“Š
    return () => {};
}

// 7. é‹å‹• (èˆ‰å•éˆ´)
// æ›¿æ›åŸæœ‰çš„ setupSportInteraction
function setupSportInteraction(group, onDone) {
    const isMobile = window.innerWidth < 800;
    
    // --- 0. éŸ¿æ‡‰å¼å ´æ™¯å¾®èª¿ ---
    if (isMobile) {
        group.scale.set(0.9, 0.9, 0.9);
    }

    // --- 1. å¥èº«å®¤ç©ºé–“åŸºç¤ ---
    // æ·±ç°æ©¡è† åœ°æ¿
    const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(40, 40), 
        new THREE.MeshStandardMaterial({color: 0x4F5454, roughness: 0.9})
    );
    floor.rotation.x = -Math.PI / 2;
    floor.position.y = -0.5;
    group.add(floor);

    // è«è˜­è¿ªç‰†é¢ (èƒŒç‰†èˆ‡å´ç‰†ï¼Œç‡Ÿé€ è§’è½é€è¦–æ„Ÿ)
    const wallMat = new THREE.MeshStandardMaterial({color: 0xD3D4D0, roughness: 0.8});
    const backWall = new THREE.Mesh(new THREE.BoxGeometry(40, 20, 1), wallMat);
    backWall.position.set(0, 9.5, -12);
    group.add(backWall);

    const sideWall = new THREE.Mesh(new THREE.BoxGeometry(1, 20, 40), wallMat);
    sideWall.position.set(-15, 9.5, 0);
    group.add(sideWall);

    // å¤§é¢åŠåå°„é¡å­ (è²¼åœ¨èƒŒç‰†ä¸Šï¼Œå¥èº«å®¤å¿…å‚™)
    const mirror = new THREE.Mesh(
        new THREE.PlaneGeometry(24, 10), 
        new THREE.MeshStandardMaterial({color: 0x7B9ACC, metalness: 0.6, roughness: 0.2})
    );
    mirror.position.set(0, 6, -11.4);
    group.add(mirror);

    // é¡å­é»‘è‰²é‚Šæ¡†
    const frame = new THREE.Mesh(new THREE.BoxGeometry(24.5, 10.5, 0.2), new THREE.MeshStandardMaterial({color: 0x333333}));
    frame.position.set(0, 6, -11.45);
    group.add(frame);

    // --- 2. èƒŒæ™¯è£é£¾ç‰© ---
    // å•éˆ´æ¶ (æ”¾ç½®æ–¼å·¦å¾Œæ–¹)
    const rackGroup = new THREE.Group();
    rackGroup.position.set(-8, 0, -8);
    const rackLegMat = new THREE.MeshStandardMaterial({color: 0x222222});
    
    const leg1 = new THREE.Mesh(new THREE.BoxGeometry(0.5, 6, 2), rackLegMat); leg1.position.set(-4, 2.5, 0);
    const leg2 = new THREE.Mesh(new THREE.BoxGeometry(0.5, 6, 2), rackLegMat); leg2.position.set(4, 2.5, 0);
    const shelf1 = new THREE.Mesh(new THREE.BoxGeometry(8, 0.3, 1.5), rackLegMat); shelf1.position.set(0, 2, 0.2); shelf1.rotation.x = 0.2;
    const shelf2 = new THREE.Mesh(new THREE.BoxGeometry(8, 0.3, 1.5), rackLegMat); shelf2.position.set(0, 4, 0.2); shelf2.rotation.x = 0.2;
    rackGroup.add(leg1, leg2, shelf1, shelf2);
    
    // æ”¾å¹¾å€‹å°å•éˆ´åœ¨æ¶å­ä¸Š
    const smallDbMat = new THREE.MeshStandardMaterial({color: 0x111111});
    for(let i=0; i<4; i++) {
        const sd1 = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 0.8, 16), smallDbMat); 
        sd1.rotation.z = Math.PI/2; sd1.position.set(-3 + i*2, 2.3, 0.2);
        
        const sd2 = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 0.8, 16), smallDbMat); 
        sd2.rotation.z = Math.PI/2; sd2.position.set(-3 + i*2, 4.3, 0.2);
        
        rackGroup.add(sd1, sd2);
    }
    group.add(rackGroup);

    // ç™‚ç™’ç›†æ ½ (æ”¾ç½®æ–¼å³å¾Œæ–¹)
    const plantPot = new THREE.Mesh(new THREE.CylinderGeometry(1, 0.7, 2, 16), new THREE.MeshStandardMaterial({color: 0xE0CDCF}));
    plantPot.position.set(10, 0.5, -9);
    const plantLeaf = new THREE.Mesh(new THREE.DodecahedronGeometry(1.5), new THREE.MeshStandardMaterial({color: 0x7C9473, flatShading: true}));
    plantLeaf.position.set(10, 3, -9);
    group.add(plantPot, plantLeaf);

    // --- 3. äº’å‹•ä¸»é«”ï¼šè‡¥æ¨æ¤…èˆ‡å¤§æ§“éˆ´ ---
    // è‡¥æ¨æ¤… (Bench)
    const benchGroup = new THREE.Group();
    // è«è˜­è¿ªé«’ç²‰ç´…å¢Šå­
    const benchPad = new THREE.Mesh(new THREE.BoxGeometry(2.5, 0.8, 8), new THREE.MeshStandardMaterial({color: 0xC89F9C, roughness: 0.9})); 
    benchPad.position.set(0, 1.5, 0);
    const benchLeg1 = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), rackLegMat); benchLeg1.position.set(0, 0.25, 2.5);
    const benchLeg2 = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), rackLegMat); benchLeg2.position.set(0, 0.25, -2.5);
    
    // è‡¥æ¨æ¶æŸ±å­
    const upright1 = new THREE.Mesh(new THREE.BoxGeometry(0.5, 5, 0.5), rackLegMat); upright1.position.set(-2, 2, -2.5);
    const upright2 = new THREE.Mesh(new THREE.BoxGeometry(0.5, 5, 0.5), rackLegMat); upright2.position.set(2, 2, -2.5);
    benchGroup.add(benchPad, benchLeg1, benchLeg2, upright1, upright2);
    group.add(benchGroup);

    // æ§“éˆ´ (Barbell)
    const barbell = new THREE.Group();
    const bar = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.12, 8, 16), new THREE.MeshStandardMaterial({color: 0xAAAAAA, metalness: 0.8}));
    bar.rotation.z = Math.PI / 2;
    
    const plateMat = new THREE.MeshStandardMaterial({color: 0x333333, roughness: 0.8});
    const wL1 = new THREE.Mesh(new THREE.CylinderGeometry(1.4, 1.4, 0.3, 32), plateMat); wL1.rotation.z = Math.PI/2; wL1.position.x = -2.5;
    const wL2 = new THREE.Mesh(new THREE.CylinderGeometry(1.4, 1.4, 0.3, 32), plateMat); wL2.rotation.z = Math.PI/2; wL2.position.x = 2.5;
    const wM1 = new THREE.Mesh(new THREE.CylinderGeometry(1.0, 1.0, 0.3, 32), plateMat); wM1.rotation.z = Math.PI/2; wM1.position.x = -2.9;
    const wM2 = new THREE.Mesh(new THREE.CylinderGeometry(1.0, 1.0, 0.3, 32), plateMat); wM2.rotation.z = Math.PI/2; wM2.position.x = 2.9;
    
    const lockMat = new THREE.MeshStandardMaterial({color: 0xCC0000}); // ç´…è‰²å®‰å…¨é–æ‰£
    const lock1 = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 0.2, 16), lockMat); lock1.rotation.z = Math.PI/2; lock1.position.x = -3.2;
    const lock2 = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 0.2, 16), lockMat); lock2.rotation.z = Math.PI/2; lock2.position.x = 3.2;

    barbell.add(bar, wL1, wL2, wM1, wM2, lock1, lock2);
    barbell.position.set(0, 4.6, -2.5); // åˆå§‹æ”¾åœ¨æŸ±å­ä¸Š
    group.add(barbell);

    // é»æ“Šåˆ¤å®šéš±å½¢æ¡† (é¿å…æ§“éˆ´å¤ªç´°é»ä¸åˆ°)
    const hitBox = new THREE.Mesh(new THREE.BoxGeometry(9, 4, 4), new THREE.MeshBasicMaterial({visible: false}));
    hitBox.position.copy(barbell.position);
    hitBox.userData = { isBarbell: true };
    group.add(hitBox);

    // --- 4. äº’å‹•é‚è¼¯èˆ‡ 2D æ¨™ç±¤ ---
    const labelPos = new THREE.Vector3(0, 508, -2.5);
    const instruction = create2DLabel("é»æ“Šè‡¥æ¨ (5ä¸‹)", labelPos, "#D5C4A1");

    let reps = 0;
    let isLifting = false;

    return (obj) => {
        if (isLifting) return;
        
        // æª¢æŸ¥æ˜¯å¦é»æ“Šåˆ°æ§“éˆ´æˆ–å…¶é€æ˜åˆ¤å®šæ¡†
        let isHit = false;
        let target = obj;
        while(target) {
            if(target.userData && target.userData.isBarbell) isHit = true;
            if(target === barbell) isHit = true;
            target = target.parent;
        }

        if (!isHit) return;

        isLifting = true;
        reps++;

        // ç¬¬ä¸€ä¸‹ï¼šå…ˆæŠŠæ§“éˆ´ç§»å‡ºæ¶å­ï¼Œå°æº–èƒ¸å£ä½ç½®
        if (reps === 1) {
            gsap.to([barbell.position, hitBox.position], { z: 0, y: 3.8, duration: 0.3, ease: "power1.inOut" });
        }

        // è‡¥æ¨å‹•ä½œï¼šä¸‹é™ -> æ¨èµ·
        const tl = gsap.timeline({
            onComplete: () => {
                isLifting = false;
                
                const textPos = new THREE.Vector3();
                barbell.getWorldPosition(textPos);
                create2DFeedback(reps.toString(), new THREE.Vector3(textPos.x, textPos.y + 502, textPos.z), "#fff");
                
                if (reps >= 5) {
                    // æ”¾å›æ¶ä¸Š
                    gsap.to([barbell.position, hitBox.position], { z: -2.5, y: 4.6, duration: 0.4, ease: "power1.inOut" });
                    instruction.innerText = "åŠ›ç«­ç‡ƒç‡’ï¼";
                    instruction.style.color = "#C0392B";
                    setTimeout(onDone, 800);
                }
            }
        });

        // é›¢å¿ƒä¸‹é™ (æ…¢)
        tl.to([barbell.position, hitBox.position], { y: 2.2, duration: 0.5, ease: "power1.inOut" });
        // å‘å¿ƒæ¨èµ· (å¿«)
        tl.to([barbell.position, hitBox.position], { y: 3.8, duration: 0.3, ease: "power2.out" });
    };
}

// --- è¼”åŠ©ï¼š3D æ–‡å­—ç”Ÿæˆ (ä½¿ç”¨ Canvas) ---
function create3DText(text, parent, x, y, z, color = 0xFFFFFF) {
    const canvas = document.createElement('canvas');
    canvas.width = 512; canvas.height = 128;
    const ctx = canvas.getContext('2d');
    
    // æ¸…ç©º
    ctx.clearRect(0, 0, 512, 128);
    
    ctx.font = 'bold 80px "Noto Serif TC", serif'; // é…åˆéŠæˆ²å­—é«”
    ctx.fillStyle = '#' + new THREE.Color(color).getHexString();
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.shadowColor = "rgba(0,0,0,0.3)";
    ctx.shadowBlur = 4;
    ctx.fillText(text, 256, 64);
    
    const tex = new THREE.CanvasTexture(canvas);
    const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true, side: THREE.DoubleSide });
    const mesh = new THREE.Mesh(new THREE.PlaneGeometry(10, 2.5), mat);
    
    // é¢å‘ç›¸æ©Ÿ (æ³¨æ„ï¼šç›¸æ©Ÿç¾åœ¨æ˜¯æ–œè¦–ï¼Œæ‰€ä»¥æ–‡å­—è¦ç«‹èµ·ä¾†æˆ–èª¿æ•´è§’åº¦)
    // ç°¡å–®åšæ³•ï¼šè®“æ–‡å­— billboarding æˆ–è€…å›ºå®šè§’åº¦
    // é€™è£¡æˆ‘å€‘å›ºå®šè§’åº¦ï¼Œç¨å¾®å¾Œä»°
    mesh.rotation.x = -0.2; 
    mesh.position.set(x, y, z);
    parent.add(mesh);
    return mesh;
}

function createFloatingText(text, parent, x, y, z) {
    const mesh = create3DText(text, parent, x, y, z, 0xFFD700);
    gsap.to(mesh.position, { y: y + 3, duration: 0.8 });
    gsap.to(mesh.material, { opacity: 0, duration: 0.8, onComplete: () => parent.remove(mesh) });
}

        
        document.getElementById('btn-holiday-rest').addEventListener('click', () => {
            const amount = parseInt(document.getElementById('rng-holiday-rest').value);
            TEACHER.maxEnergy += amount * 0.5; TEACHER.bonusEnergyNextDay = amount; changeHappiness(amount * 8);
            document.getElementById('btn-end-day').click();
        });
       document.getElementById('btn-do-grade').addEventListener('click', () => {
    // å–å¾—æ»‘æ¡¿æ•¸å€¼
    const papersToGrade = parseInt(document.getElementById('rng-grading').value);
    
    if (papersToGrade > 0) {
        // è¨ˆç®—ç¸½æ¶ˆè€—ï¼šå¦‚æœæœ‰å¨›æ¨‚éï¼Œæ¯ä»½æ¶ˆè€— 2ï¼Œå¦å‰‡æ¶ˆè€— 1
        const costPerPaper = TEACHER.hasEntertainedTonight ? 2 : 1;
        const totalCost = papersToGrade * costPerPaper;

        // å•Ÿå‹• 3D äº’å‹•ï¼šé€£çºŒæ‰¹æ”¹
        // æ³¨æ„ï¼šé€™è£¡ä¸ç›´æ¥æ‰£æ•¸å€¼ï¼Œè€Œæ˜¯å‚³å…¥å›èª¿å‡½æ•¸ï¼Œåœ¨å‹•ç•«çµæŸå¾ŒåŸ·è¡Œ
        startInteractiveSession('grading', () => {
            
            // â˜…â˜…â˜… æ ¸å¿ƒé‚è¼¯ä¿®æ”¹ï¼šå¿ƒåŠ›å„Ÿé‚„é †åº â˜…â˜…â˜…
            
            // 1. è¨ˆç®—èƒ½ç”¨ã€Œç•¶å‰ä¸‹ç­å¿ƒåŠ› (TEACHER.offWorkEnergy)ã€æ”¯ä»˜å¤šå°‘
            // ä¾‹å¦‚ï¼šä¸‹ç­å¿ƒåŠ›å‰© 1ï¼Œç¸½æ¶ˆè€— 3 -> paidWithCurrent = 1
            const paidWithCurrent = Math.min(TEACHER.offWorkEnergy, totalCost);
            
            // 2. è¨ˆç®—å‰©é¤˜æ¬ æ¬¾ (é€æ”¯é‡)
            // ä¾‹å¦‚ï¼š3 - 1 = 2 (é€æ”¯)
            const overdraft = totalCost - paidWithCurrent;

            // 3. åŸ·è¡Œæ‰£é™¤
            TEACHER.offWorkEnergy -= paidWithCurrent; // æ‰£é™¤ç¾æœ‰çš„ï¼Œè‹¥é€æ”¯å‰‡æ­¸é›¶
            TEACHER.energyDebt += overdraft;          // å‰©é¤˜çš„åŠ åˆ°æ˜å¤©å‚µå‹™
            
            // 4. æ›´æ–°æ‰¹æ”¹å †ç©æ•¸é‡
            TEACHER.gradingPile = Math.max(0, TEACHER.gradingPile - papersToGrade);
            
            // 5. æ‰£é™¤å¹¸ç¦æ„Ÿ (æ¯ä»½ -2)
            const happyLoss = 2 * papersToGrade; 
            changeHappiness(-happyLoss);
            
            // 6. ç„¡éœ€å‘¼å« showSummary()ï¼ŒstartInteractiveSession æœƒè‡ªå‹•æ¢å¾©ä¸‹ç­ä»‹é¢
            
        }, papersToGrade); // å‚³å…¥æ‰¹æ”¹æ•¸é‡ï¼Œæ§åˆ¶å‹•ç•«æ’­æ”¾æ¬¡æ•¸
    }
});
       function showGameOver(reason) {
    document.getElementById('offwork-overlay').style.display = 'none';
    
    // è¨­å®š SVG (é–€)
    const iconEl = document.getElementById('modal-icon');
    iconEl.innerHTML = SVGS.door;
    iconEl.querySelector('svg').style.fill = "#c0392b";
    
    document.getElementById('modal-title').innerText = "éŠæˆ²çµæŸ";
    
    document.getElementById('dse-results').innerHTML = `<div style="color:#c0392b; font-weight:bold; font-size:16px;">GAME OVER</div><div style="margin-top:10px;">${reason}</div>`;
    
    const restartBtn = document.getElementById('btn-restart');
    restartBtn.innerText = "é‡æ–°é–‹å§‹";
    restartBtn.style.background = "#333"; 
    restartBtn.onclick = function() { location.reload(); }; 

    document.getElementById('principal-msg').innerText = "ä½ çš„æ•™æ›¸ç”Ÿæ¶¯åˆ°æ­¤çµæŸã€‚";
    document.getElementById('modal-overlay').style.display = 'flex';
}
       function showSummary() {
    if(!TEACHER.isHoliday) {
        let base = TEACHER.maxEnergy; 
        
        // æ ¸å¿ƒé‚è¼¯ï¼šç›´æ¥è®€å–å·²ç¶“è¨­å®šå¥½çš„ bonusEnergyNextDay (+1 æˆ– +3)
        let bonus = TEACHER.bonusEnergyNextDay; 
        let debt = TEACHER.energyDebt;
        let startEnergy = base + bonus - debt; 
        if (startEnergy < 0) startEnergy = 0;
        
        document.getElementById('sum-work').innerText = `è¡Œæ”¿ x${TEACHER.dailyStats.adminCount}, æ‰¹æ”¹é¤˜ ${TEACHER.gradingPile}`;
        document.getElementById('sum-fun').innerText = TEACHER.dailyStats.entertained ? "æœ‰" : "ç„¡";
        
        const hChange = TEACHER.dailyStats.happyChange; 
        const hEl = document.getElementById('sum-happy');
        hEl.innerText = (hChange > 0 ? "+" : "") + hChange.toFixed(1);
        hEl.className = hChange > 0 ? "summary-val val-pos" : (hChange < 0 ? "summary-val val-neg" : "summary-val val-neu");
        
        document.getElementById('sum-pile').innerText = `+${TEACHER.dailyStats.workAdded} ä»½`;
        document.getElementById('sum-energy').innerText = startEnergy.toFixed(1);
        
        document.getElementById('offwork-overlay').style.display = 'none'; 
        document.getElementById('summary-overlay').style.display = 'flex';
    } else { 
        // å‡æœŸçµæŸï¼Œç›´æ¥æ’­é»‘å±å‹•ç•«
        document.getElementById('offwork-overlay').style.display = 'none'; 
        playSleepAnimation(() => {
            performNextDayLogic(); 
        });
    }
}

// ----------------------------------------------------
// æŒ‰éˆ•ç›£è½å™¨è¦†å¯« (å¿…é ˆæ›¿æ›åŸæœ‰çš„ onclick)
// ----------------------------------------------------

// 1. ä¸‹æ–¹è—è‰²ã€Œç¡è¦ºã€å¤§æŒ‰éµ (å›ºå®šåªåŠ  1 é»å¿ƒåŠ›)
document.getElementById('btn-end-day').onclick = () => {
    if (!TEACHER.isHoliday) {
        // æª¢æŸ¥æ˜¯å¦æœ‰æœªæ‰¹æ”¹èª²æ¥­çš„è­¦å‘Šé‚è¼¯ (ä¿ç•™)
        if (TEACHER.daysInYear >= 3 && TEACHER.gradingPile > 0) { 
            if (!confirm(`è­¦å‘Šï¼å­¸å¹´å³å°‡çµæŸï¼Œä½ é‚„æœ‰ ${TEACHER.gradingPile} ä»½èª²æ¥­æœªæ‰¹æ”¹ã€‚å¦‚æœä¸ç¾åœ¨æ‰¹æ”¹ï¼Œä½ å°‡è¢«å­¸æ ¡è§£åƒ±ã€‚ç¢ºå®šè¦ç¡è¦ºå—ï¼Ÿ`)) return; 
        }

        // --- ä¿®æ”¹é–‹å§‹ï¼šåˆ¤æ–·æ˜¯å¦æœ‰å¨›æ¨‚æ´»å‹• ---
        if (TEACHER.hasEntertainedTonight) {
            // å¦‚æœä»Šæ™šæœ‰é€²è¡Œå¨›æ¨‚ (åƒé£¯/çœ‹æˆ²/è³¼ç‰©...)ï¼Œæ˜æ—¥å¿ƒåŠ› +1
            TEACHER.bonusEnergyNextDay = 1;
        } else {
            // å¦‚æœæ²’æœ‰å¨›æ¨‚ç›´æ¥ç¡è¦º (ä½›ç³»é¤Šç”Ÿ)ï¼Œæ˜æ—¥å¿ƒåŠ› +3
            TEACHER.bonusEnergyNextDay = 3;
        }
        // --- ä¿®æ”¹çµæŸ ---

    } else {
        TEACHER.bonusEnergyNextDay = 0; // æ”¾å‡è‡ªç„¶æ¨é€²
    }
    
    showSummary(); // æ‰“é–‹çµç®—è¡¨
};

// 2. çµç®—å ±å‘Šä¸Šçš„ã€Œè¿æ¥æ–°çš„ä¸€å¤©ã€ (åŠ å…¥é»‘å±ç¡è¦ºéæ¸¡)
document.getElementById('btn-confirm-summary').onclick = () => { 
    document.getElementById('summary-overlay').style.display = 'none'; 
    // å¼·åˆ¶æ’­æ”¾é»‘å±å‹•ç•«ï¼Œæ’­å®Œå†æ¨é€²æ–°çš„ä¸€å¤©
    playSleepAnimation(() => {
        performNextDayLogic(); 
    });
};

// 3. å‡æœŸã€Œå¥½å¥½ä¼‘æ¯ã€æŒ‰éˆ• (ä¿®å¾©åŸæœ¬æœƒéŒ¯èª¤è¦†è“‹å¿ƒåŠ›çš„ BUG)
document.getElementById('btn-holiday-rest').onclick = () => {
    // å–å¾—æ»‘æ¡¿æ•¸å€¼ (1~5)
    const amount = parseInt(document.getElementById('rng-holiday-rest').value);
    
    // æå‡æœ€å¤§å¿ƒåŠ›ä¸Šé™ (ä¿ç•™åŸæœ¬é‚è¼¯)
    TEACHER.maxEnergy += amount * 0.5; 
    
    // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šç„¡è«–æ»‘æ¡¿é¸å¤šå°‘ï¼Œé•·å‡ä¼‘æ¯å¾Œæ–°å­¸å¹´å›ºå®š +10 å¿ƒåŠ› â˜…â˜…â˜…
    TEACHER.bonusEnergyNextDay = 10; 
    
    // å¢åŠ å¹¸ç¦æ„Ÿ (ä¾ä¼‘æ¯ç¨‹åº¦æ±ºå®š)
    changeHappiness(amount * 8);
    
    // ç›´æ¥é€²å…¥çµç®—èˆ‡é»‘å±
    showSummary(); 
};
       // ==========================================
// æ ¸å¿ƒæµç¨‹ä¿®å¾©ï¼šç¢ºä¿æ–°ä¸€å¤© UI èˆ‡ç›¸æ©Ÿé‡ç½®
// ==========================================

function performNextDayLogic() {
    // ç¢ºä¿æ‰€æœ‰é®ç½©é—œé–‰
    document.getElementById('offwork-overlay').style.display = 'none';
    document.getElementById('sleep-overlay').style.display = 'none';
    document.getElementById('summary-overlay').style.display = 'none';

    // å¼·åˆ¶æ¢å¾©ä¸»ä»‹é¢ (ä¿®å¾© BUG çš„é—œéµ)
    document.getElementById('top-dashboard').style.display = 'flex';
    document.getElementById('labels-container').style.display = 'block';
    document.querySelector('.copyright-footer').style.display = 'block';

    if (TEACHER.isHoliday) { 
        TEACHER.isHoliday = false; 
        startNewYear(); 
    } else { 
        if (TEACHER.daysInYear >= 3) { 
            if (TEACHER.gradingPile > 0) { 
                showGameOver(`æœ¬å­¸å¹´çµæŸæ™‚ï¼Œä½ ä»ç©å£“äº† ${TEACHER.gradingPile} ä»½èª²æ¥­æœªæ‰¹æ”¹ã€‚ä½ è¢«è§£åƒ±äº†ã€‚`); 
                return; 
            } 
            startHoliday(); 
        } else { 
            TEACHER.daysInYear++; 
            startNextDay(); 
        } 
    }
}

function startNextDay() {
    const newWork = Math.floor(Math.random() * 3) + 1; 
    TEACHER.gradingPile += newWork;
    TEACHER.dailyStats = { happyChange: 0, adminCount: 0, entertained: false, workAdded: newWork, complaintLoss: 0 };
    changeHappiness(-5);
    
    let netEnergy = TEACHER.maxEnergy + TEACHER.bonusEnergyNextDay; 
    TEACHER.bonusEnergyNextDay = 0; 
    
    if (TEACHER.energyDebt > 0) { 
        netEnergy -= TEACHER.energyDebt; 
        setStatus(`æ–°çš„ä¸€å¤©ï¼š${TEACHER.daysInYear}/3ã€‚å„Ÿé‚„æ˜¨æ—¥é€æ”¯ ${TEACHER.energyDebt.toFixed(1)} å¿ƒåŠ›ã€‚`, true); 
        TEACHER.energyDebt = 0; 
        if (netEnergy < 0) netEnergy = 0; 
    } else { 
        setStatus(`æ–°çš„ä¸€å¤©ï¼š${TEACHER.daysInYear}/3ã€‚ç²¾åŠ›å……æ²›ï¼`); 
    }
    
    TEACHER.currentEnergy = netEnergy; 
    updateUI();

    // â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šå¼·åˆ¶ç›¸æ©Ÿå›åˆ°æ•™å®¤è¦–è§’ â˜…â˜…â˜…
    updateCamera(students.length);
}

// ==========================================
// ä¿®æ”¹å¾Œçš„ startNewYear å‡½æ•¸
// ==========================================
function startNewYear() {
    // é˜²æ­¢é‡è¤‡è§¸ç™¼
    if (document.getElementById('modal-overlay').style.display === 'flex') return;
    
    // ç¢ºä¿ UI é¡¯ç¤º
    document.getElementById('top-dashboard').style.display = 'flex';
    document.getElementById('labels-container').style.display = 'block';

    // 1. å¹´é½¡å¢é•·èˆ‡é€€ä¼‘æª¢æŸ¥
    TEACHER.age++; 
    if (TEACHER.age > 60) { 
        document.getElementById('disp-age').innerText = TEACHER.age; 
        showRetirement(); 
        return; 
    }
    
    // 2. æ•¸å€¼é‡ç½®
    calcMaxEnergy(); 
    if (currentGradeIndex < 5) currentGradeIndex++;
    TEACHER.daysInYear = 1; 
    
    if (GAME_MODE === 'partial') TEACHER.recoveriesLeft = 3;
    
    // è¨ˆç®—æ–°å­¸å¹´èµ·å§‹å¿ƒåŠ›
    let netEnergy = TEACHER.maxEnergy + TEACHER.bonusEnergyNextDay; 
    
    if (GAME_MODE === 'full') { 
        TEACHER.gradingPile += 2; 
        TEACHER.dailyStats = { happyChange: 0, adminCount: 0, entertained: false, workAdded: 2, complaintLoss: 0 }; 
    }
    
    // å‚µå‹™è¨ˆç®—èˆ‡é¡¯ç¤ºè¨Šæ¯
    let statusMsg = `æ–°å­¸å¹´ï¼š${GRADES[currentGradeIndex]}ã€‚`;
    if (TEACHER.energyDebt > 0) { 
        if (netEnergy >= TEACHER.energyDebt) {
            netEnergy -= TEACHER.energyDebt; 
            statusMsg += ` (å·²æ‰£é™¤ ${TEACHER.energyDebt.toFixed(1)} é€æ”¯)`;
            TEACHER.energyDebt = 0; 
        } else {
            TEACHER.energyDebt -= netEnergy;
            netEnergy = 0;
            statusMsg += ` (ä»æ¬  ${TEACHER.energyDebt.toFixed(1)} å¿ƒåŠ›...)`;
        }
    }
    
    TEACHER.currentEnergy = netEnergy; 
    TEACHER.bonusEnergyNextDay = 0; 
    hasDoneAdmin = false; 
    randomizeStudentNeed();
    
    // 3. å­¸ç”Ÿç‹€æ…‹è®ŠåŒ–èˆ‡å­¸åŠ›å¢æ¸›é‚è¼¯
    let awakenedNames = [];
    let relapsedNames = [];
    let newYearChanges = []; // ç”¨æ–¼å„²å­˜å ±å‘Šæ•¸æ“š

    students.forEach(s => {
        // --- èººå¹³/è¦ºé†’ é‚è¼¯ ---
        if (s.isOriginalUltraLow) {
            if (Math.random() < 0.5) {
                s.isUltraLow = !s.isUltraLow;
                s.updateAvatarPose();
                if (s.isUltraLow) relapsedNames.push(s.name);
                else awakenedNames.push(s.name);
            }
        }
        
        // å®¹å™¨é«˜åº¦æˆé•· (è‡ªç„¶æˆé•·)
        s.growGrade();
        
        // --- æ ¸å¿ƒï¼šæš‘æœŸå­¸åŠ›è®ŠåŒ–é‚è¼¯ (ç™¾åˆ†æ¯”åˆ¶) ---
        let change = 0;
        const currentParticles = s.landedParticles.length; 

        if (s.type === STUDENT_TYPES.HIGH) {
            // å¤©è³‡è°ç©ï¼š60% æ©Ÿç‡å¢åŠ  3-5%ï¼Œ40% æ©Ÿç‡éºå¤± 1-3%
            if (Math.random() < 0.6) {
                // å¢åŠ 
                let gain = Math.ceil(currentParticles * (0.03 + Math.random() * 0.02));
                change = Math.max(1, gain); // è‡³å°‘åŠ  1
            } else {
                // éºå¤±
                let loss = Math.ceil(currentParticles * (0.01 + Math.random() * 0.02));
                change = -Math.max(1, loss); // è‡³å°‘æ¸› 1
            }
        } 
        else if (s.type === STUDENT_TYPES.AVG) {
            // å¤©è³‡å¹³åº¸ï¼šå¿…å®šéºå¤±ï¼Œéºå¤± 10-30%
            let loss = Math.ceil(currentParticles * (0.10 + Math.random() * 0.20));
            // å¦‚æœèº«ä¸Šæœ‰ç²’å­ï¼Œè‡³å°‘æ‰£ 1ï¼›å¦‚æœæ˜¯ 0 å°±ä¸æ‰£
            change = currentParticles > 0 ? -Math.max(1, loss) : 0;
        } 
        else {
            // å¤©è³‡é§‘éˆï¼šå›ºå®šéºå¤± 6-10 ç²’
            change = -Math.floor(Math.random() * 5 + 6);
        }

        // æ”¶é›†æ•¸æ“šå‚³çµ¦å ±å‘Š
        newYearChanges.push({ student: s, change: change });
        
        // --- åŸ·è¡Œ 3D ç²’å­å¢æ¸› ---
        if (change < 0) { 
            // ç§»é™¤ç²’å­
            for(let i=0; i<Math.abs(change); i++) { 
                const p = s.landedParticles.pop(); 
                if(p) { scene.remove(p); particles = particles.filter(x=>x!==p); } 
            } 
        } else { 
            // å¢åŠ ç²’å­
            for(let i=0; i<change; i++) spawnDirectLandedParticle(s); 
        }
        s.updateLabelText();
    });
    
    // 4. å…¨å±é€šçŸ¥èˆ‡å ±å‘Šé¡¯ç¤º
    const gradeText = GRADES[currentGradeIndex];
    const notifEl = document.getElementById('year-notification');
    
    if (notifEl) {
        const titleEl = document.getElementById('notif-title');
        const descEl = document.getElementById('notif-desc');
        titleEl.innerText = gradeText;
        
        let changeMsg = "æ–°å­¸å¹´é–‹å§‹";
        if (awakenedNames.length > 0 || relapsedNames.length > 0) {
            changeMsg = "";
            if (awakenedNames.length > 0) changeMsg += `[è¦ºé†’] ${awakenedNames.join(', ')} æ±ºå®šç™¼æ†¤åœ–å¼·ï¼<br>`;
            if (relapsedNames.length > 0) changeMsg += `[èººå¹³] ${relapsedNames.join(', ')} å¤±å»äº†å‹•åŠ›...`;
        } else {
            changeMsg += "<br><span style='font-size:14px'>å­¸ç”Ÿå­¸ç¿’å‹•æ©Ÿç¶­æŒä¸è®Š</span>";
        }
        
        descEl.innerHTML = changeMsg;
        descEl.style.fontSize = "18px";
        descEl.style.lineHeight = "1.5";
        
        // é¡¯ç¤ºå…¨å±é€šçŸ¥
        notifEl.classList.add('active');
        
        // 3ç§’å¾Œæ·¡å‡ºé€šçŸ¥ï¼Œä¸¦ç·Šæ¥è‘—é¡¯ç¤ºæ•¸æ“šå ±å‘Š
        setTimeout(() => { 
            notifEl.classList.remove('active'); 
            
            // å»¶é² 500ms è®“é€šçŸ¥æ·¡å‡ºå¾Œå†å½ˆå‡ºå ±å‘Š
            setTimeout(() => {
                createNewYearReport(newYearChanges);
            }, 500);
            
        }, 3000); 
    }
    
    // 5. æ›´æ–° UI ç‹€æ…‹
    setStatus(statusMsg, TEACHER.currentEnergy === 0);
    updateUI();
    
    // å¼·åˆ¶ç›¸æ©Ÿå›åˆ°æ•™å®¤è¦–è§’
    updateCamera(students.length);
}
// ç¢ºä¿ updateCamera èƒ½æ­£ç¢ºé‹ä½œ
function updateCamera(count) {
    const isMobile = window.innerWidth < 800;
    const targetY = isMobile ? 13.0 : 9.0;
    const zDist = (isMobile ? 40 : 28) + (count * 5.5); 
    
    // åœæ­¢ä»»ä½•å¯èƒ½æ­£åœ¨é€²è¡Œçš„ GSAP å‹•ç•«ï¼Œå¼·åˆ¶è¦†è“‹
    gsap.killTweensOf(controls.target);
    gsap.killTweensOf(camera.position);

    gsap.to(controls.target, { x: 0, y: targetY, z: 0, duration: 1.0 });
    gsap.to(camera.position, { x: 0, y: 15, z: zDist, duration: 1.0, onUpdate: () => controls.update() });
}
      function showRetirement() {
    document.getElementById('offwork-overlay').style.display = 'none'; 
    document.getElementById('summary-overlay').style.display = 'none';
    
    // è¨­å®š SVG (èŒ¶)
    const iconEl = document.getElementById('modal-icon');
    iconEl.innerHTML = SVGS.tea;
    iconEl.querySelector('svg').style.fill = "var(--color-high)";

    document.getElementById('modal-title').innerText = "å…‰æ¦®é€€ä¼‘";
    document.getElementById('modal-title').style.color = "var(--color-high)";
    
    let endMsg = ""; 
    if (TEACHER.happiness > 80) endMsg = "ä½ å¸¶è‘—æ»¿æ»¿çš„å¹¸ç¦å›æ†¶å‘Šåˆ¥æ ¡åœ’ï¼Œå­¸ç”Ÿå€‘éƒ½æ¨ä¸å¾—ä½ ã€‚"; 
    else if (TEACHER.happiness > 40) endMsg = "é›–ç„¶æ•™å­¸ç”Ÿæ¶¯æœ‰è‹¦æœ‰æ¨‚ï¼Œä½†ä½ ç¸½ç®—å¹³å®‰è‘—é™¸ï¼Œç„¡æ‚”æ­¤ç”Ÿã€‚"; 
    else endMsg = "çµ‚æ–¼æ±åˆ°äº†é€™ä¸€å¤©ï¼Œä½ å¦‚é‡‹é‡è² ï¼Œç™¼èª“ä»¥å¾Œä¸å†æ”¹æ–‡ã€‚";
    
    document.getElementById('dse-results').innerHTML = `<div style="font-size:18px; font-weight:bold; color:#333; margin-bottom:15px;">æ­²æœˆå¦‚æ¢­ï¼Œä½ å·²å¹´æ»¿ 60 æ­²ã€‚</div><div style="text-align:left; font-size:14px; line-height:1.8; color:#555; padding:10px;"><p><strong>é€€ä¼‘å¹¸ç¦æ„Ÿï¼š</strong> ${Math.floor(TEACHER.happiness)} / 100</p><hr style="border:0; border-top:1px dashed #ccc; margin:10px 0;"><p>${endMsg}</p></div>`;
    
    document.getElementById('principal-msg').innerText = "";
    document.getElementById('btn-close-modal').style.display = 'none';
    
    const restartBtn = document.getElementById('btn-restart');
    restartBtn.innerText = "é‡æ–°é–‹å§‹";
    restartBtn.style.background = "#333";
    restartBtn.onclick = function() { location.reload(); };

    document.getElementById('modal-overlay').style.display = 'flex';
}
       
        document.getElementById('sel-student-count').addEventListener('change', (e) => initStudents(parseInt(e.target.value)));
        document.getElementById('rng-admin').addEventListener('input', updateUI);



// === æ–°å¢å‡½æ•¸ï¼šé–‹å•Ÿæ–°ä¸€å±†å­¸ç”Ÿ ===
function startNextBatch() {
    // 1. é—œé–‰æ¨¡æ…‹æ¡†
    document.getElementById('modal-overlay').style.display = 'none';

    // 2. è€å¸«å¹´é½¡å¢é•·
    TEACHER.age++;
    
    // 3. æª¢æŸ¥æ˜¯å¦é€€ä¼‘ (è¶…é 60 æ­²)
    if (TEACHER.age > 60) {
        document.getElementById('disp-age').innerText = TEACHER.age;
        showRetirement();
        return;
    }

    // 4. é‡ç½®å­¸å¹´èˆ‡ç‹€æ…‹è®Šæ•¸
    currentGradeIndex = 0; // å›åˆ°ä¸­ä¸€
    TEACHER.daysInYear = 1; // å›åˆ°ç¬¬ä¸€å¤©
    isDseMode = false;      // é—œé–‰ DSE æ¨¡å¼
    hasDoneAdmin = false;   // é‡ç½®è¡Œæ”¿ç‹€æ…‹
    TEACHER.gradingPile = 0; // æ¸…ç©ºèˆŠå­¸ç”Ÿçš„ä½œæ¥­å †ç©
    TEACHER.energyDebt = 0;  // æ¸…ç©ºé«”åŠ›é€æ”¯
    TEACHER.offWorkEnergy = 0;
    TEACHER.bonusEnergyNextDay = 0;
    TEACHER.dailyStats = { happyChange: 0, adminCount: 0, entertained: false, workAdded: 0, complaintLoss: 0 };

    // 5. é‡æ–°è¨ˆç®—é«”åŠ›ä¸Šé™ (äººè€äº†é«”åŠ›ä¸Šé™æœƒè®Š) ä¸¦è£œæ»¿ç•¶å‰é«”åŠ›
    calcMaxEnergy();
    TEACHER.currentEnergy = TEACHER.maxEnergy;

    // 6. é‡ç½® UI æŒ‰éˆ•ç‹€æ…‹
    document.getElementById('btn-dse').style.display = 'none'; // éš±è— DSE æŒ‰éˆ•
    document.getElementById('btn-admin').disabled = false;     // è§£é–è¡Œæ”¿æŒ‰éˆ•
    
    if (GAME_MODE === 'full') {
        document.getElementById('btn-grade-work').disabled = false;
        document.getElementById('btn-offwork').style.display = 'none'; // éš±è—ä¸‹ç­æŒ‰éˆ•
    }
    
    if (GAME_MODE === 'partial') {
        TEACHER.recoveriesLeft = 3;
        document.getElementById('btn-recover').disabled = false;
        document.getElementById('btn-next-partial').disabled = true; // éœ€å…ˆåšè¡Œæ”¿
    }

    // 7. ç”Ÿæˆæ–°ä¸€æ‰¹å­¸ç”Ÿ (è®€å–ä¸‹æ‹‰é¸å–®çš„äººæ•¸)
    // initStudents å…§éƒ¨æœƒè‡ªå‹•æ¸…é™¤èˆŠçš„ 3D æ¨¡å‹
    const count = parseInt(document.getElementById('sel-student-count').value) || 5;
    initStudents(count);
    
    // 8. éš¨æ©Ÿç”Ÿæˆæ–°çš„å­¸ç”Ÿéœ€æ±‚èˆ‡æ›´æ–° UI
    randomizeStudentNeed();
    setStatus(`é€èµ°äº†ç•¢æ¥­ç”Ÿï¼Œä½ è¿ä¾†äº†æ–°ä¸€å±†çš„ä¸­ä¸€å­¸ç”Ÿã€‚æ•™å­¸ç†±èª ä¾èˆŠå—ï¼Ÿ`);
    updateUI();
}


 function animate() {
    requestAnimationFrame(animate);
    controls.update();
    
    // 1. é™åˆ¶ç›¸æ©Ÿé‚Šç•Œ
    if (controls.target) {
        const boundary = (students.length * 2.5);
        controls.target.x = Math.max(-boundary, Math.min(boundary, controls.target.x));
    }
    
    const time = Date.now() * 0.002;
    const isMobile = window.innerWidth < 800;
 
    // 2. æ‰¹é‡è™•ç†å­¸ç”Ÿç‹€æ…‹èˆ‡æ¨™ç±¤æŠ•å½±
    // é å…ˆè¨ˆç®—æŠ•å½±çŸ©é™£ï¼Œæ¸›å°‘æ¯å¹€é‡è¤‡è¨ˆç®—
    for (let i = 0; i < students.length; i++) {
        const s = students[i];
        if (s.avatar) {
            if (s.isUltraLow) {
                s.avatar.position.y = -1.5 + Math.sin(time + i) * 0.015;
                s.avatar.position.x = 0.9;
                s.avatar.rotation.z = Math.PI / 2;
            } else {
                s.avatar.position.y = -2.5 + Math.sin(time + i) * 0.03;
                s.avatar.position.x = 0;
                s.avatar.rotation.z = Math.sin(time * 0.5 + i) * 0.02;
            }
        }
 
        // æ¨™ç±¤æŠ•å½±å„ªåŒ–ï¼šåƒ…åœ¨è¦–å£å…§æ›´æ–°
        const rimY = s.getRimY();
        const pos = new THREE.Vector3(s.xPos, rimY + 2.0, 0).project(camera);
        
        // åªæœ‰åœ¨å±å¹•ç¯„åœå…§çš„ Label æ‰é€²è¡Œ DOM æ“ä½œï¼Œç¯€çœæ¸²æŸ“é–‹éŠ·
        if (Math.abs(pos.z) <= 1 && Math.abs(pos.x) < 1.1) {
            const x = (pos.x * 0.5 + 0.5) * window.innerWidth;
            const y = (pos.y * -0.5 + 0.5) * window.innerHeight;
            
            s.labelEl.style.transform = `translate(-50%, -100%) translate(${x}px, ${y}px)`;
            s.labelEl.style.opacity = (s.isSelected === false) ? "0.3" : "0.9";
            s.labelEl.style.display = "block";
 
            const bPos = new THREE.Vector3(s.xPos, rimY + s.bubbleOffsetY, 0).project(camera);
            const bx = (bPos.x * 0.5 + 0.5) * window.innerWidth;
            const by = (bPos.y * -0.5 + 0.5) * window.innerHeight;
            s.bubbleEl.style.transform = `translate(-50%, -100%) translate(${bx}px, ${by}px)`;
        } else {
            s.labelEl.style.display = "none";
            s.bubbleEl.style.display = "none";
        }
    }
 
    // 3. ç²’å­ç‰©ç†ç³»çµ± (æ€§èƒ½ç“¶é ¸å„ªåŒ–)
    // å¦‚æœæœªä¾†ä½¿ç”¨ WebGPU Compute Shaderï¼Œé€™æ®µå°‡ç§»è‡³ GPU
    const gravity = 0.008;
    const friction = 0.98;
 
    for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        const data = p.userData;
        const s = data.student;
        
        if (data.state === 'falling') {
            // æ›´æ–°ä½ç½®
            p.position.add(data.vel);
            p.rotation.x += 0.05;
            p.rotation.y += 0.05;
            data.vel.y -= gravity;
            
            // æ¨¡æ“¬ç‰©ç†å¸å¼•åŠ›
            let attraction = (s.type.id === 'high') ? 0.15 : (s.type.id === 'low' ? 0.005 : 0.05);
            if (!data.rejected) {
                p.position.x += (s.xPos - p.position.x) * attraction;
                p.position.z += (0 - p.position.z) * attraction;
            }
            
            // ç¢°æ’æª¢æ¸¬å„ªåŒ–ï¼šé å…ˆè¨ˆç®—å¹³æ–¹è·é›¢ï¼Œé¿å… Math.sqrt
            const dx = p.position.x - s.xPos;
            const dz = p.position.z;
            const distSq = dx * dx + dz * dz;
 
            if (p.position.y < s.getRimY() + 0.5 && p.position.y > s.containerBottom) {
                if (distSq < 3.8) { // 2.0^2 = 4, ç•¥å°æ–¼é‚Šç·£
                    if (data.rejected || (s.isUltraLow && data.state !== 'landed')) {
                        let eject = s.isUltraLow ? 0.4 : 0.15;
                        data.vel.x = dx * eject + (Math.random() - 0.5) * 0.1;
                        data.vel.z = dz * eject + (Math.random() - 0.5) * 0.1;
                        data.vel.y = 0.2;
                        data.state = 'spilling';
                    } else {
                        const fillY = s.containerBottom + (s.landedParticles.length * 0.006);
                        if (fillY < s.getRimY() && p.position.y <= Math.max(fillY + 0.2, s.containerBottom + 0.2)) {
                            // è‘—é™¸é‚è¼¯
                            p.position.y = fillY + Math.random() * 0.1;
                            data.state = 'landed';
                            s.landedParticles.push(p);
                            s.updateLabelText();
                            s.bump();
                          playLandSound(); 
 
                            const r = Math.random() * 1.5;
                            const t = Math.random() * Math.PI * 2;
                            p.position.x = s.xPos + r * Math.cos(t);
                            p.position.z = r * Math.sin(t);
                        }
                    }
                }
            }
        } else if (data.state === 'spilling') {
            p.position.add(data.vel);
            data.vel.y -= 0.02;
            if (p.position.y < -5) {
                scene.remove(p);
                particles.splice(i, 1);
                continue;
            }
        }
 
        // ç§»é™¤æ‰è½éé çš„ç²’å­
        if (p.position.y < -5) {
            scene.remove(p);
            particles.splice(i, 1);
        }
    }
    
    renderer.render(scene, camera);
}
// === æ–°å¢ï¼šé»æ“Šé¸æ“‡å—çœ¾é‚è¼¯ ===
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

// === ä¿®æ”¹å¾Œï¼šé¸æ“‡å—çœ¾é‚è¼¯ (ç›¸å®¹æ‰‹æ©Ÿèˆ‡é›»è…¦) ===
window.addEventListener('pointerup', (event) => {
    const target = event.target;
    if (target.closest('#top-dashboard') || target.closest('#start-screen') ||
        target.closest('#modal-overlay') || target.closest('#summary-overlay') ||
        target.closest('#offwork-overlay') || target.closest('#report-overlay') ||
        target.closest('#sentiment-overlay') || target.closest('.copyright-footer') ||
        ['button', 'input', 'select'].includes(target.tagName.toLowerCase())) {
        return;
    }
 
    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
 
    const groups = students.map(s => s.group);
    const intersects = raycaster.intersectObjects(groups, true);
 
    if (intersects.length > 0) {
        const clickedObject = intersects[0].object;
        const student = students.find(s => {
            let found = false;
            s.group.traverse(child => { if (child === clickedObject) found = true; });
            return found;
        });
 
        if (student) {
            student.isSelected = !student.isSelected;
            student.group.traverse(child => {
                if (child.isMesh && child.material) {
                    if (!child.userData.hasClonedMaterial) {
                        child.material = child.material.clone();
                        child.userData.hasClonedMaterial = true;
                        child.userData.origColor = child.material.color.getHex();
                    }
                    if (student.isSelected) {
                        child.material.color.setHex(child.userData.origColor);
                    } else {
                        const c = new THREE.Color(child.userData.origColor);
                        c.multiplyScalar(0.3);
                        child.material.color.setHex(c.getHex());
                    }
                }
            });
            // é»æ“Šå¾Œç«‹å³æ›´æ–° UIï¼Œè§¸ç™¼å€ç‡è¦–è¦ºæ•ˆæœ
            updateUI();
        }
    }
}, false);
// ============================



// ==========================================
// æ–°å¢å‡½æ•¸ï¼šé¡¯ç¤ºå­¸å¹´éæ¸¡å ±å‘Š (æš‘æœŸçµç®—)
// ==========================================
function createNewYearReport(studentChanges) {
    const overlay = document.getElementById('report-overlay');
    const box = document.getElementById('report-box');
    
    // 1. ä¿®æ”¹æ¨™é¡Œ
    box.querySelector('.report-header').innerHTML = "ğŸ“… æš‘æœŸå­¸èƒ½è®ŠåŒ–å ±å‘Š";
    
    // 2. æš«æ™‚éš±è—åŸæœ¬çš„ã€Œå¿ƒåŠ›ã€èˆ‡ã€Œå¹¸ç¦æ„Ÿã€æ¬„ä½ (å› ç‚ºé€™æ˜¯è¢«å‹•è®ŠåŒ–)
    const rows = box.querySelectorAll('.report-row');
    rows.forEach(r => r.style.display = 'none');
    
    // 3. éš±è—å€ç‡æ¨™ç±¤
    const tag = document.getElementById('rpt-multiplier-tag');
    if(tag) tag.style.display = 'none';

    // 4. ç”Ÿæˆè¡¨æ ¼å…§å®¹
    const tbody = document.getElementById('rpt-tbody');
    tbody.innerHTML = '';
    
    studentChanges.forEach(item => {
        const s = item.student;
        const change = item.change;
        
        // åˆ¤æ–·å¢æ¸›æ¨£å¼
        let changeText = "";
        let colorStyle = "";
        
        if (change > 0) {
            changeText = `â–² +${change} (ç©æ¥µè‡ªå­¸)`;
            colorStyle = "color:#27ae60; font-weight:bold;";
        } else if (change < 0) {
            changeText = `â–¼ ${change} (è™›è€—å…‰é™°)`; 
            colorStyle = "color:#c0392b; font-weight:bold;";
        } else {
            changeText = "- ç¶­æŒæ°´å¹³ -";
            colorStyle = "color:#999;";
        }

        // è¨ˆç®—è®ŠåŒ–å¾Œçš„ç¸½é‡
        // 1. ç²å–ç›®å‰ç¸½é‡
        const currentTotal = s.landedParticles.length;
        // 2. æ–°å¢ï¼šç²å–å®¹é‡ä¸Šé™
        const capacity = s.getCurrentCapacity(); 

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="text-align:left; font-weight:bold; color:${s.type.color};">
                ${s.name} <span style="font-size:10px; color:#999;">(${s.type.name})</span>
            </td>
            <!-- 3. ä¿®æ”¹æ­¤è¡Œï¼šé¡¯ç¤º ç¾æœ‰å€¼ / ä¸Šé™å€¼ -->
            <td style="text-align:center;">${currentTotal} / ${capacity}</td>
            <td style="${colorStyle}">${changeText}</td>
        `;
        tbody.appendChild(tr);
    });
    
    // 5. é¡¯ç¤ºè¦–çª—
    overlay.style.display = 'flex';
    
    // 6. è¨­å®šé—œé–‰æ™‚çš„é‚„åŸå‹•ä½œ (é‡è¦ï¼šæ¢å¾©åŸæœ¬ä»‹é¢ä»¥å…å½±éŸ¿æ—¥å¸¸æ“ä½œ)
    // æˆ‘å€‘è¦†è“‹åŸæœ¬çš„ onclick äº‹ä»¶ï¼Œç¢ºä¿é—œé–‰æ™‚èƒ½é‚„åŸä»‹é¢
    overlay.onclick = function(e) {
        if (e.target === overlay) {
            overlay.style.display = 'none';
            
            // é‚„åŸæ¨™é¡Œèˆ‡æ¬„ä½é¡¯ç¤ºï¼Œä¾›æ—¥å¸¸æ•™å­¸ä½¿ç”¨
            box.querySelector('.report-header').innerText = "ğŸ“‹ æœ¬æ¬¡è¡Œå‹•çµç®—";
            rows.forEach(r => r.style.display = 'flex');
            
            // æ¢å¾©åŸæœ¬çš„ç°¡å–®é—œé–‰é‚è¼¯
            overlay.onclick = function() { this.style.display = 'none'; };
        }
    };
}


        
    </script>





    

        <footer class="copyright-footer">
<p>Copyright Â© 2025 é™³å† å¥. All rights reserved.</p>
</footer>

<!-- å­¸ç”Ÿæ„Ÿè¨€å°ˆç”¨è¦–çª— -->
    <div id="sentiment-overlay" onclick="document.getElementById('sentiment-overlay').style.display='none'">
        <div id="sentiment-box" onclick="event.stopPropagation()">
            <div class="sent-header" id="sent-header-bg">
                <span class="sent-avatar">ğŸ“</span>
                <div class="sent-name" id="sent-name">å­¸ç”Ÿå§“å</div>
                <span class="sent-type" id="sent-type">å¤©è³‡è°ç©</span>
            </div>
            <div class="sent-body">
                <span class="sent-category" id="sent-category">æ­£é¢æ„Ÿè¨€</span>
                <div class="sent-text" id="sent-text">é€™è£¡é¡¯ç¤ºæ„Ÿè¨€å…§å®¹...</div>
            </div>
            <div class="sent-footer">
                <button class="sent-close-btn" onclick="document.getElementById('sentiment-overlay').style.display='none'">é—œé–‰</button>
            </div>
        </div>
    </div>

<!-- ç´” HTML ç¡è¦ºé®ç½© (è§£æ±º Three.js å¡æ­»å•é¡Œ) -->
<div id="sleep-overlay">
    <div class="sleep-content">
        <div class="zzz-anim">Z z z ...</div>
        <div class="sleep-desc">ä¼‘æ¯æ˜¯ç‚ºäº†èµ°æ›´é•·çš„è·¯</div>
    </div>
</div>


            <!-- åœ‹å®¶é¸æ“‡ä»‹é¢ -->
    <div id="travel-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:400; display:none; justify-content:center; align-items:center; backdrop-filter:blur(5px);">
        <div style="background:#fff; width:80%; max-width:400px; padding:25px; border-radius:15px; text-align:center;">
            <h2 style="color:var(--accent-holiday); margin-top:0;">âœˆï¸ é¸æ“‡æ—…éŠç›®çš„åœ°</h2>
            <p style="font-size:12px; color:#666;">ä¸€è¶Ÿç¾å¥½çš„æ—…è¡Œå°‡å¤§å¹…æå‡ä½ çš„å¿ƒåŠ›ä¸Šé™èˆ‡å¹¸ç¦æ„Ÿï¼</p>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
                <button onclick="startTravel('japan')" style="padding:15px; border:1px solid #ddd; background:#f9f9f9; border-radius:10px; font-weight:bold; cursor:pointer;">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</button>
                <button onclick="startTravel('uk')" style="padding:15px; border:1px solid #ddd; background:#f9f9f9; border-radius:10px; font-weight:bold; cursor:pointer;">UK è‹±åœ‹</button>
                <button onclick="startTravel('korea')" style="padding:15px; border:1px solid #ddd; background:#f9f9f9; border-radius:10px; font-weight:bold; cursor:pointer;">ğŸ‡°ğŸ‡· éŸ“åœ‹</button>
                <button onclick="startTravel('china')" style="padding:15px; border:1px solid #ddd; background:#f9f9f9; border-radius:10px; font-weight:bold; cursor:pointer;">ğŸ‡¨ğŸ‡³ ä¸­åœ‹</button>
                <button onclick="startTravel('finland')" style="padding:15px; border:1px solid #ddd; background:#f9f9f9; border-radius:10px; font-weight:bold; cursor:pointer; grid-column: span 2;">ğŸ‡«ğŸ‡® èŠ¬è˜­</button>
            </div>
            <button onclick="document.getElementById('travel-overlay').style.display='none'" style="margin-top:20px; padding:10px 20px; background:#eee; border:none; border-radius:8px; cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>

</body>
</html>
